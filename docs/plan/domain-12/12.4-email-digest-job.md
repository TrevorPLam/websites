### 12.4 Email Digest Job

**File:** `apps/*/src/app/api/jobs/email/lead-digest/route.ts`

```typescript
import { createJobHandler } from '@repo/jobs/verify-qstash';
import { db } from '@repo/db';
import { sendLeadDigestEmail } from '@repo/email';
import { classifyLead } from '@repo/lead-capture/scoring';

export const maxDuration = 60; // 60s max on Vercel Pro

export const POST = createJobHandler<'email.lead_digest'>(async (payload) => {
  const { tenantId, date } = payload;

  const startOfDay = new Date(date);
  startOfDay.setHours(0, 0, 0, 0);

  const endOfDay = new Date(date);
  endOfDay.setHours(23, 59, 59, 999);

  // Fetch warm leads from the day
  const { data: leads } = await db
    .from('leads')
    .select('*')
    .eq('tenant_id', tenantId)
    .gte('created_at', startOfDay.toISOString())
    .lte('created_at', endOfDay.toISOString())
    .gte('score', 40) // Warm + qualified
    .lt('score', 70) // Warm only (qualified get immediate email)
    .order('score', { ascending: false });

  if (!leads || leads.length === 0) return; // Nothing to digest

  await sendLeadDigestEmail(tenantId, leads, date);
});
```

---
