### 12.5 CRM Sync Job (HubSpot + Zapier)

**File:** `apps/*/src/app/api/jobs/crm/sync-lead/route.ts`

```typescript
import { createJobHandler } from '@repo/jobs/verify-qstash';
import { db } from '@repo/db';
import { getTenantSecret } from '@repo/auth/secrets-manager';

export const maxDuration = 30;

export const POST = createJobHandler<'crm.sync_lead'>(async (payload) => {
  const { tenantId, leadId, crmType } = payload;

  // Fetch lead
  const { data: lead } = await db
    .from('leads')
    .select('*')
    .eq('id', leadId)
    .eq('tenant_id', tenantId)
    .single();

  if (!lead) {
    console.warn(`[CRM Sync] Lead ${leadId} not found`);
    return;
  }

  switch (crmType) {
    case 'hubspot':
      await syncToHubSpot(tenantId, lead);
      break;
    case 'zapier':
      await syncToZapier(tenantId, lead);
      break;
    case 'gohighlevel':
      await syncToGoHighLevel(tenantId, lead);
      break;
  }

  // Mark lead as synced
  await db
    .from('leads')
    .update({
      metadata: { ...lead.metadata, crm_synced: true, crm_synced_at: new Date().toISOString() },
    })
    .eq('id', leadId);
});

// ──────────────────────────────────────────────────────────────────────────────

async function syncToHubSpot(tenantId: string, lead: any): Promise<void> {
  const apiKey = await getTenantSecret(tenantId, 'HUBSPOT_PRIVATE_APP_TOKEN');
  if (!apiKey) {
    console.warn(`[CRM] HubSpot token not configured for tenant ${tenantId}`);
    return;
  }

  // Upsert contact in HubSpot (idempotent by email)
  const response = await fetch('https://api.hubapi.com/crm/v3/objects/contacts/batch/upsert', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      inputs: [
        {
          idProperty: 'email',
          id: lead.email,
          properties: {
            email: lead.email,
            firstname: lead.name.split(' ')[0] ?? lead.name,
            lastname: lead.name.split(' ').slice(1).join(' ') ?? '',
            phone: lead.phone ?? '',
            message: lead.message,
            hs_lead_status: lead.score >= 70 ? 'QUALIFIED' : 'NEW',
            // Custom properties (must be created in HubSpot first)
            lead_score: String(lead.score),
            utm_source: lead.utm_source ?? '',
            utm_campaign: lead.utm_campaign ?? '',
            lead_source: lead.source ?? 'contact_form',
          },
        },
      ],
    }),
  });

  if (!response.ok) {
    const error = await response.text();
    throw new Error(`HubSpot sync failed: ${response.status} — ${error}`);
  }
}

async function syncToZapier(tenantId: string, lead: any): Promise<void> {
  // Zapier webhook URL stored per-tenant
  const webhookUrl = await getTenantSecret(tenantId, 'ZAPIER_WEBHOOK_URL');
  if (!webhookUrl) return;

  const response = await fetch(webhookUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name: lead.name,
      email: lead.email,
      phone: lead.phone ?? '',
      message: lead.message,
      score: lead.score,
      source: lead.source,
      utm_source: lead.utm_source ?? '',
      utm_medium: lead.utm_medium ?? '',
      utm_campaign: lead.utm_campaign ?? '',
      first_touch_source: lead.utm_source_first ?? '',
      first_touch_campaign: lead.utm_campaign_first ?? '',
      landing_page: lead.landing_page ?? '/',
      created_at: lead.created_at,
    }),
  });

  if (!response.ok) {
    throw new Error(`Zapier webhook failed: ${response.status}`);
  }
}

async function syncToGoHighLevel(tenantId: string, lead: any): Promise<void> {
  const apiKey = await getTenantSecret(tenantId, 'GHL_API_KEY');
  const locationId = await getTenantSecret(tenantId, 'GHL_LOCATION_ID');
  if (!apiKey || !locationId) return;

  const nameParts = lead.name.split(' ');

  const response = await fetch('https://services.leadconnectorhq.com/contacts/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${apiKey}`,
      Version: '2021-07-28',
    },
    body: JSON.stringify({
      locationId,
      email: lead.email,
      phone: lead.phone ?? '',
      firstName: nameParts[0] ?? '',
      lastName: nameParts.slice(1).join(' ') ?? '',
      customField: {
        message: lead.message,
        lead_score: lead.score,
        utm_source: lead.utm_source ?? '',
        utm_campaign: lead.utm_campaign ?? '',
      },
      source: `website-${lead.source ?? 'contact_form'}`,
      tags: [
        lead.score >= 70 ? 'qualified-lead' : 'new-lead',
        `score-${Math.floor(lead.score / 10) * 10}`,
        lead.utm_source ? `source-${lead.utm_source}` : 'source-direct',
      ].filter(Boolean),
    }),
  });

  if (!response.ok) {
    throw new Error(`GoHighLevel sync failed: ${response.status}`);
  }
}
```

---
