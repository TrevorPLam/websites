### 12.7 GDPR Tenant Deletion Job

```typescript
// apps/*/src/app/api/jobs/gdpr/delete-tenant/route.ts
import { createJobHandler } from '@repo/jobs/verify-qstash';
import { db } from '@repo/db';
import { removeTenantDomain } from '@repo/multi-tenant/vercel-domains';
import { invalidateTenantCache } from '@repo/multi-tenant/resolve-tenant';

export const maxDuration = 60;

export const POST = createJobHandler<'gdpr.delete_tenant'>(async (payload) => {
  const { tenantId, reason } = payload;

  console.log(`[GDPR] Starting deletion for tenant: ${tenantId}, reason: ${reason}`);

  // 1. Mark deletion as in-progress (CANNOT be reversed after this point)
  const { error: queueError } = await db
    .from('deletion_queue')
    .update({ status: 'deleted', deleted_at: new Date().toISOString() })
    .eq('tenant_id', tenantId)
    .eq('status', 'pending');

  if (queueError) throw queueError;

  // 2. Delete PII data (leads, bookings — personal information)
  //    Audit logs are retained (legal requirement under most jurisdictions)
  await db.from('leads').delete().eq('tenant_id', tenantId);
  await db.from('bookings').delete().eq('tenant_id', tenantId);
  await db.from('phone_click_events').delete().eq('tenant_id', tenantId);
  await db.from('tenant_members').delete().eq('tenant_id', tenantId);
  await db.from('tenant_secrets').delete().eq('tenant_id', tenantId);
  await db.from('tenant_sso_providers').delete().eq('tenant_id', tenantId);

  // 3. Fetch custom domain before deleting tenant record
  const { data: tenant } = await db
    .from('tenants')
    .select('custom_domain, subdomain')
    .eq('id', tenantId)
    .single();

  // 4. Remove Vercel domain assignment
  if (tenant?.custom_domain) {
    try {
      await removeTenantDomain(tenant.custom_domain);
    } catch (err) {
      // Non-fatal — domain might already be removed
      console.warn(`[GDPR] Failed to remove domain: ${tenant.custom_domain}`, err);
    }
  }

  // 5. Delete tenant record
  await db.from('tenants').delete().eq('id', tenantId);

  // 6. Bust all caches
  await invalidateTenantCache(tenantId);

  // 7. Audit log (retained even after tenant deletion — use service role client)
  await db.from('audit_logs').insert({
    tenant_id: tenantId,
    action: 'tenant.gdpr_deleted',
    table_name: 'tenants',
    record_id: tenantId,
    new_data: { reason, deleted_at: new Date().toISOString() },
  });

  console.log(`[GDPR] Deletion complete: tenant=${tenantId}`);
});
```

---
