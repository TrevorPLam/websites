### 12.3 QStash Request Verification Middleware

**Every job endpoint MUST verify the QStash signature to prevent unauthorized calls.**

**File:** `packages/jobs/src/verify-qstash.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { qstashReceiver } from './client';

// ============================================================================
// WRAPPER: Verifies QStash signature and parses typed payload
// Usage:
//   export const POST = createJobHandler<'crm.sync_lead'>(async (payload) => {
//     // payload is typed as JobPayloadMap['crm.sync_lead']
//   });
// ============================================================================

export function createJobHandler<T extends keyof import('./client').JobPayloadMap>(
  handler: (payload: import('./client').JobPayloadMap[T], req: NextRequest) => Promise<void>
) {
  return async function POST(req: NextRequest): Promise<NextResponse> {
    // Verify signature
    const signature = req.headers.get('upstash-signature');
    if (!signature) {
      return NextResponse.json({ error: 'Missing signature' }, { status: 401 });
    }

    const body = await req.text();

    let isValid = false;
    try {
      isValid = await qstashReceiver.verify({
        signature,
        body,
        url: req.url,
      });
    } catch {
      isValid = false;
    }

    if (!isValid) {
      console.error('[QStash] Signature verification failed');
      return NextResponse.json({ error: 'Invalid signature' }, { status: 401 });
    }

    // Parse payload
    let payload: import('./client').JobPayloadMap[T];
    try {
      payload = JSON.parse(body);
    } catch {
      return NextResponse.json({ error: 'Invalid JSON body' }, { status: 400 });
    }

    // Execute handler
    try {
      await handler(payload, req);
      return NextResponse.json({ ok: true });
    } catch (err) {
      console.error('[Job Handler] Error:', err);
      // Return 500 â€” QStash will retry up to configured retry count
      return NextResponse.json(
        { error: err instanceof Error ? err.message : 'Unknown error' },
        { status: 500 }
      );
    }
  };
}
```

---
