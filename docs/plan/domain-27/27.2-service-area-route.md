### 27.2 Service Area Route

**File:** `apps/*/src/app/service-area/[slug]/page.tsx`

```typescript
import type { Metadata } from 'next';
import { notFound } from 'next/navigation';
import { headers } from 'next/headers';
import { cacheLife, cacheTag } from 'next/cache';
import { resolveTenant } from '@repo/multi-tenant/resolve-tenant';
import { db } from '@repo/db';
import { buildMetadata } from '@repo/seo/metadata-factory';
import {
  buildLocalBusinessSchema,
  buildServiceSchema,
  buildBreadcrumbSchema,
  JsonLd,
} from '@repo/seo/structured-data';
import { ServiceAreaHero } from '@/components/service-area/ServiceAreaHero';
import { ServiceAreaServices } from '@/components/service-area/ServiceAreaServices';
import { ServiceAreaTestimonials } from '@/components/service-area/ServiceAreaTestimonials';
import { ContactFormSection } from '@/components/sections/ContactFormSection';
import { BookingEmbedPopup } from '@repo/ui/booking/BookingEmbed';

// ============================================================================
// SERVICE AREA PAGE — Programmatic Local SEO
// URL: /service-area/[slug]   e.g. /service-area/plano-tx
// ============================================================================

interface PageProps {
  params: Promise<{ slug: string }>;
}

// Allow pages beyond the seeded static set (on-demand ISR)
export const dynamicParams = true;

// Seed top 10 service areas at build time per tenant
export async function generateStaticParams() {
  const allTenants = await db
    .from('tenants')
    .select('config')
    .eq('status', 'active');

  const params: { slug: string }[] = [];

  for (const tenant of allTenants.data ?? []) {
    const areas: string[] = (tenant.config as any)?.identity?.serviceAreas ?? [];
    // Seed the first 10 areas only — rest are on-demand ISR
    areas.slice(0, 10).forEach((area) => {
      params.push({ slug: slugifyArea(area) });
    });
  }

  return params;
}

export async function generateMetadata({ params }: PageProps): Promise<Metadata> {
  const { slug } = await params;
  const headersList = await headers();
  const tenantContext = await resolveTenant({ headers: headersList } as any);
  if (!tenantContext) return {};

  const { data: tenant } = await db
    .from('tenants')
    .select('config')
    .eq('id', tenantContext.tenantId)
    .single();

  if (!tenant?.config) return {};

  const config = tenant.config as any;
  const areaName = deslugifyArea(slug);
  const city = areaName.split(',')[0].trim();
  const state = areaName.split(',') [kreativekommit](https://kreativekommit.com/guides/2025/07/ssr-nextjs-local-seo)?.trim() ?? config.identity?.address?.state ?? '';
  const industry = config.identity?.industry ?? 'services';

  return buildMetadata({
    config,
    path: `/service-area/${slug}`,
    pageTitle: `${industry.charAt(0).toUpperCase() + industry.slice(1)} Services in ${city}${state ? `, ${state}` : ''}`,
    pageDescription: `${config.identity?.siteName} provides professional ${industry} services in ${city}, ${state}. ${config.identity?.tagline ?? ''} Licensed, insured, and locally trusted. Free estimates — call ${config.identity?.contact?.phone ?? 'today'}.`,
  });
}

export default async function ServiceAreaPage({ params }: PageProps) {
  'use cache';

  const { slug } = await params;
  const headersList = await headers();

  const tenantContext = await resolveTenant({ headers: headersList } as any);
  if (!tenantContext) return notFound();

  const { tenantId } = tenantContext;

  cacheTag(`tenant:${tenantId}:service-area:${slug}`);
  cacheLife({ revalidate: 86400 }); // 24h — static content rarely changes

  const { data: tenant } = await db
    .from('tenants')
    .select('config, custom_domain, subdomain')
    .eq('id', tenantId)
    .single();

  if (!tenant?.config) return notFound();

  const config = tenant.config as any;
  const identity = config.identity ?? {};
  const serviceAreas: string[] = identity.serviceAreas ?? [];
  const domain = tenant.custom_domain ?? `${tenant.subdomain}.${process.env.NEXT_PUBLIC_ROOT_DOMAIN}`;
  const siteUrl = `https://${domain}`;

  // Validate: area must be in the configured service areas
  const areaName = deslugifyArea(slug);
  const isValidArea = serviceAreas.some(
    (a: string) => slugifyArea(a) === slug || a.toLowerCase() === areaName.toLowerCase()
  );

  if (!isValidArea) return notFound();

  const city = areaName.split(',')[0].trim();
  const state = areaName.split(',') [kreativekommit](https://kreativekommit.com/guides/2025/07/ssr-nextjs-local-seo)?.trim() ?? identity.address?.state ?? '';
  const services = identity.services ?? [];
  const industry = identity.industry ?? 'services';

  // Build page-specific LocalBusiness schema (override city with service area city)
  const localSchema = {
    ...buildLocalBusinessSchema(config),
    name: `${identity.siteName} — ${city}`,
    description: `Professional ${industry} services in ${city}, ${state}. ${identity.tagline ?? ''}`,
    areaServed: [{ '@type': 'City', name: city }],
  };

  const breadcrumbSchema = buildBreadcrumbSchema(siteUrl, identity.siteName, [
    { name: 'Service Areas', url: `${siteUrl}/service-areas` },
    { name: city, url: `${siteUrl}/service-area/${slug}` },
  ]);

  const calUsername = null; // Fetched from secrets only if needed client-side

  return (
    <>
      {/* Structured Data */}
      <JsonLd schema={localSchema} />
      <JsonLd schema={breadcrumbSchema} />
      {services.slice(0, 3).map((service: any) => (
        <JsonLd
          key={service.slug}
          schema={buildServiceSchema(config, service)}
        />
      ))}

      {/* Page content */}
      <main id="main-content">
        <ServiceAreaHero
          city={city}
          state={state}
          businessName={identity.siteName}
          industry={industry}
          tagline={identity.tagline}
          phone={identity.contact?.phone}
          primaryColor={config.theme?.colors?.primary}
        />

        <ServiceAreaServices
          city={city}
          services={services}
          businessName={identity.siteName}
          industry={industry}
        />

        {identity.testimonials?.length > 0 && (
          <ServiceAreaTestimonials
            testimonials={identity.testimonials}
            city={city}
          />
        )}

        <section className="py-16 bg-gray-50" aria-label="Contact us">
          <div className="container mx-auto px-6">
            <h2 className="text-3xl font-bold text-gray-900 text-center mb-4">
              Get a Free Estimate in {city}
            </h2>
            <p className="text-gray-500 text-center mb-10 max-w-xl mx-auto">
              Serving {city} and the surrounding {state} area. Response within 1 business hour.
            </p>
            <ContactFormSection
              tenantId={tenantId}
              metadata={{ serviceArea: slug, city, state }}
            />
          </div>
        </section>

        {/* Internal links to other service areas (SEO: link equity distribution) */}
        <RelatedServiceAreas
          currentSlug={slug}
          areas={serviceAreas}
          siteUrl={siteUrl}
        />
      </main>
    </>
  );
}

// ── Related areas nav (internal linking) ─────────────────────────────────────

function RelatedServiceAreas({
  currentSlug,
  areas,
  siteUrl,
}: {
  currentSlug: string;
  areas: string[];
  siteUrl: string;
}) {
  const others = areas
    .filter((a) => slugifyArea(a) !== currentSlug)
    .slice(0, 8);

  if (others.length === 0) return null;

  return (
    <nav
      aria-label="Other service areas"
      className="py-12 bg-white border-t border-gray-100"
    >
      <div className="container mx-auto px-6">
        <h2 className="text-lg font-semibold text-gray-700 mb-4">
          Also Serving:
        </h2>
        <ul className="flex flex-wrap gap-3" role="list">
          {others.map((area) => (
            <li key={area}>
              <a
                href={`${siteUrl}/service-area/${slugifyArea(area)}`}
                className="px-4 py-2 bg-gray-100 hover:bg-primary/10 hover:text-primary text-gray-700 rounded-full text-sm transition-colors"
              >
                {area}
              </a>
            </li>
          ))}
        </ul>
      </div>
    </nav>
  );
}

// ── Helpers ───────────────────────────────────────────────────────────────────

function slugifyArea(area: string): string {
  return area
    .toLowerCase()
    .replace(/,\s*/g, '-')
    .replace(/\s+/g, '-')
    .replace(/[^a-z0-9-]/g, '');
}

function deslugifyArea(slug: string): string {
  // "plano-tx" → "Plano, TX"
  // "north-richland-hills-tx" → "North Richland Hills, TX"
  const parts = slug.split('-');
  const stateAbbr = parts[parts.length - 1]?.toUpperCase();
  const US_STATES = ['TX', 'CA', 'FL', 'NY', 'IL', 'PA', 'OH', 'GA', 'NC', 'MI',
    'NJ', 'VA', 'WA', 'AZ', 'MA', 'TN', 'IN', 'MO', 'MD', 'WI', 'CO', 'MN',
    'SC', 'AL', 'LA', 'KY', 'OR', 'OK', 'CT', 'UT', 'NV', 'AR', 'MS', 'KS',
    'NM', 'NE', 'WV', 'ID', 'HI', 'NH', 'ME', 'MT', 'RI', 'DE', 'SD', 'ND',
    'AK', 'VT', 'WY', 'DC'];

  if (US_STATES.includes(stateAbbr ?? '')) {
    const cityParts = parts.slice(0, -1);
    const city = cityParts
      .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
      .join(' ');
    return `${city}, ${stateAbbr}`;
  }

  // No state abbr detected — treat whole slug as city name
  return parts.map((w) => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
}
```

---
