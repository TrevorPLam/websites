# 26.4 Test Fixtures

**File:** `e2e/fixtures/index.ts`

```typescript
import { test as base, expect, type Page, type APIRequestContext } from '@playwright/test';
import { createClient } from '@supabase/supabase-js';

// ============================================================================
// CUSTOM FIXTURES
// Extend base Playwright test with typed fixtures for:
// - tenantId (seeded test tenant)
// - supabaseAdmin (for direct DB assertions)
// - leadCountBefore (before test, for delta assertions)
// ============================================================================

const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

interface CustomFixtures {
  tenantId: string;
  tenantDomain: string;
  supabase: typeof supabaseAdmin;
  leadCountBefore: number;

  // Helper: submit contact form and wait for lead creation
  submitContactForm: (options: {
    name: string;
    email: string;
    phone?: string;
    message: string;
  }) => Promise<{ leadId: string }>;
}

export const test = base.extend<CustomFixtures>({
  // Seed a fresh test tenant for each test (ensures isolation)
  tenantId: async ({}, use) => {
    const tenantId = process.env.TEST_TENANT_ID!;
    await use(tenantId);
  },

  tenantDomain: async ({ tenantId }, use) => {
    const { data } = await supabaseAdmin
      .from('tenants')
      .select('subdomain')
      .eq('id', tenantId)
      .single();

    const domain = `${data?.subdomain}.localhost:3000`;
    await use(domain);
  },

  supabase: async ({}, use) => {
    await use(supabaseAdmin);
  },

  leadCountBefore: async ({ tenantId }, use) => {
    const { count } = await supabaseAdmin
      .from('leads')
      .select('*', { count: 'exact', head: true })
      .eq('tenant_id', tenantId);
    await use(count ?? 0);
  },

  submitContactForm: async ({ page, tenantDomain }, use) => {
    const submit = async (options: {
      name: string;
      email: string;
      phone?: string;
      message: string;
    }): Promise<{ leadId: string }> => {
      // Navigate to the contact form
      await page.goto(`http://${tenantDomain}/contact`);

      // Fill form fields
      await page.getByLabel(/name/i).fill(options.name);
      await page.getByLabel(/email/i).fill(options.email);
      if (options.phone) {
        await page.getByLabel(/phone/i).fill(options.phone);
      }
      await page.getByLabel(/message/i).fill(options.message);

      // Submit
      const responsePromise = page.waitForResponse(
        (resp) => resp.url().includes('/api/contact') && resp.status() === 200
      );

      await page.getByRole('button', { name: /submit|send|contact/i }).click();

      const response = await responsePromise;
      const body = await response.json();

      return { leadId: body.leadId };
    };

    await use(submit);
  },
});

export { expect };
```
