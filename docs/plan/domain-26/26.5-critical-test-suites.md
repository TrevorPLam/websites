# 26.5 Critical Test Suites

**File:** `e2e/tests/public/contact-form.spec.ts`

```typescript
import { test, expect } from '../../fixtures';

test.describe('Contact form → Lead creation', () => {
  test('submitting form creates a lead in the database', async ({
    page,
    tenantDomain,
    tenantId,
    supabase,
    submitContactForm,
    leadCountBefore,
  }) => {
    const leadId = await submitContactForm({
      name: 'Test Visitor',
      email: `test+${Date.now()}@example.com`,
      phone: '555-867-5309',
      message: 'I need an emergency HVAC repair, my AC is broken',
    });

    // Success message appears
    await expect(page.getByRole('alert')).toContainText(/thank|received|follow/i);

    // Lead was created in DB
    const { data: lead } = await supabase
      .from('leads')
      .select('*')
      .eq('id', leadId.leadId)
      .single();

    expect(lead).not.toBeNull();
    expect(lead?.name).toBe('Test Visitor');
    expect(lead?.score).toBeGreaterThan(0);
    expect(lead?.tenant_id).toBe(tenantId);

    // Total lead count increased by exactly 1
    const { count: countAfter } = await supabase
      .from('leads')
      .select('*', { count: 'exact', head: true })
      .eq('tenant_id', tenantId);

    expect(countAfter).toBe(leadCountBefore + 1);
  });

  test('form blocks submission with invalid email', async ({ page, tenantDomain }) => {
    await page.goto(`http://${tenantDomain}/contact`);

    await page.getByLabel(/name/i).fill('Test User');
    await page.getByLabel(/email/i).fill('not-an-email');
    await page.getByLabel(/message/i).fill('Test message that is long enough');
    await page.getByRole('button', { name: /submit|send/i }).click();

    // Error message appears, no API call made
    await expect(page.getByRole('alert')).toBeVisible();
    await expect(page.getByRole('alert')).toContainText(/email|valid/i);
  });

  test('phone click is tracked as an event', async ({ page, tenantDomain, tenantId, supabase }) => {
    await page.goto(`http://${tenantDomain}/`);

    const phoneLink = page.getByRole('link', { name: /^\+?[\d\s\(\)\-]{7,}$/ }).first();
    await phoneLink.click();

    // Allow event to propagate
    await page.waitForTimeout(500);

    const { count } = await supabase
      .from('phone_click_events')
      .select('*', { count: 'exact', head: true })
      .eq('tenant_id', tenantId);

    expect(count).toBeGreaterThan(0);
  });
});
```

**File:** `e2e/tests/portal/billing.spec.ts`

```typescript
import { test, expect } from '../../fixtures';

test.describe('Billing portal', () => {
  test('displays current plan correctly', async ({ page }) => {
    await page.goto('/billing');

    // Current plan is highlighted
    const currentPlanBadge = page.getByText('Current Plan');
    await expect(currentPlanBadge).toBeVisible();

    // All three plans are shown
    await expect(page.getByRole('heading', { name: 'Starter' })).toBeVisible();
    await expect(page.getByRole('heading', { name: 'Professional' })).toBeVisible();
    await expect(page.getByRole('heading', { name: 'Enterprise' })).toBeVisible();
  });

  test('manage subscription button appears for current plan', async ({ page }) => {
    await page.goto('/billing');

    const manageButton = page.getByRole('button', { name: 'Manage Subscription' });
    await expect(manageButton).toBeVisible();
  });
});
```

**File:** `e2e/tests/a11y/homepage.spec.ts`

```typescript
import { test, expect } from '../../fixtures';
import AxeBuilder from '@axe-core/playwright';

test.describe('Accessibility — Marketing site', () => {
  test('homepage has no critical accessibility violations', async ({ page, tenantDomain }) => {
    await page.goto(`http://${tenantDomain}/`);

    const accessibilityScanResults = await new AxeBuilder({ page })
      .withTags(['wcag2a', 'wcag2aa', 'wcag21a', 'wcag21aa', 'wcag22aa'])
      .analyze();

    // Critical violations fail the test
    const critical = accessibilityScanResults.violations.filter(
      (v) => v.impact === 'critical' || v.impact === 'serious'
    );

    if (critical.length > 0) {
      console.error('Accessibility violations:', JSON.stringify(critical, null, 2));
    }

    expect(critical).toHaveLength(0);
  });

  test('contact form is keyboard navigable', async ({ page, tenantDomain }) => {
    await page.goto(`http://${tenantDomain}/contact`);

    // Tab through all form fields
    await page.keyboard.press('Tab'); // Skip to first field (after skip link)
    const firstField = page.getByLabel(/name/i);
    await expect(firstField).toBeFocused();

    await page.keyboard.press('Tab');
    const emailField = page.getByLabel(/email/i);
    await expect(emailField).toBeFocused();

    await page.keyboard.press('Tab');
    const phoneField = page.getByLabel(/phone/i);
    await expect(phoneField).toBeFocused();

    await page.keyboard.press('Tab');
    const messageField = page.getByLabel(/message/i);
    await expect(messageField).toBeFocused();

    await page.keyboard.press('Tab');
    const submitButton = page.getByRole('button', { name: /submit|send/i });
    await expect(submitButton).toBeFocused();
  });

  test('skip to content link is the first focusable element', async ({ page, tenantDomain }) => {
    await page.goto(`http://${tenantDomain}/`);

    await page.keyboard.press('Tab');
    const focused = page.locator(':focus');

    await expect(focused).toHaveText(/skip to/i);
    await expect(focused).toBeVisible();
  });
});
```
