### 32.3 Report Generation Job

**File:** `apps/*/src/app/api/jobs/reports/weekly/route.ts`

```typescript
import { createJobHandler } from '@repo/jobs/verify-qstash';
import { renderToBuffer } from '@react-pdf/renderer';
import { createElement } from 'react';
import { createClient } from '@supabase/supabase-js';
import { db } from '@repo/db';
import { sendEmail } from '@repo/email/send';
import { ReportEmailTemplate } from '@repo/email/templates/WeeklyReport';
import { WeeklyReportDocument } from '@repo/reports/templates/WeeklyReport';

export const maxDuration = 60; // PDF generation can take up to 60s for large datasets

const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

export const POST = createJobHandler<'report.weekly'>(async (payload) => {
  const { tenantId } = payload;

  const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
  const twoWeeksAgo = new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString();

  // Fetch tenant config
  const { data: tenant } = await db
    .from('tenants')
    .select('config, notification_config')
    .eq('id', tenantId)
    .single();

  const config = tenant?.config as any;
  const notifConfig = tenant?.notification_config as any;

  // Respect notification preference â€” skip if reports disabled
  if (notifConfig?.weeklyReport === false) return;

  const ownerEmail = config?.identity?.contact?.email;
  if (!ownerEmail) return;

  // â”€â”€ Fetch this week's leads â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const { data: leads, count: totalLeads } = await db
    .from('leads')
    .select('*', { count: 'exact' })
    .eq('tenant_id', tenantId)
    .gte('created_at', weekAgo)
    .order('score', { ascending: false });

  const { count: priorWeekLeads } = await db
    .from('leads')
    .select('*', { count: 'exact', head: true })
    .eq('tenant_id', tenantId)
    .gte('created_at', twoWeeksAgo)
    .lt('created_at', weekAgo);

  // â”€â”€ Fetch this week's bookings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const { data: bookings } = await db
    .from('bookings')
    .select('status')
    .eq('tenant_id', tenantId)
    .gte('created_at', weekAgo);

  // â”€â”€ Compute stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const allLeads = leads ?? [];
  const qualified = allLeads.filter((l) => l.score >= 70);
  const warm = allLeads.filter((l) => l.score >= 40 && l.score < 70);
  const cold = allLeads.filter((l) => l.score < 40);
  const avgScore =
    allLeads.length > 0
      ? Math.round(allLeads.reduce((sum, l) => sum + l.score, 0) / allLeads.length)
      : 0;

  // Source breakdown
  const sourceCounts: Record<string, number> = {};
  allLeads.forEach((l) => {
    const src = l.source ?? 'unknown';
    sourceCounts[src] = (sourceCounts[src] ?? 0) + 1;
  });

  const sourceBreakdown = Object.entries(sourceCounts)
    .map(([source, count]) => ({
      source,
      count,
      percentage: Math.round((count / Math.max(allLeads.length, 1)) * 100),
    }))
    .sort((a, b) => b.count - a.count);

  // Daily trend (last 7 days)
  const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const weeklyTrend = Array.from({ length: 7 }, (_, i) => {
    const d = new Date();
    d.setDate(d.getDate() - (6 - i));
    const dayLeads = allLeads.filter((l) => {
      const lDate = new Date(l.created_at);
      return lDate.toDateString() === d.toDateString();
    });
    return { day: dayLabels[d.getDay()]!, count: dayLeads.length };
  });

  const reportPeriod = `${new Date(weekAgo).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} â€“ ${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;

  // â”€â”€ Generate PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const pdfBuffer = await renderToBuffer(
    createElement(WeeklyReportDocument, {
      businessName: config?.identity?.siteName ?? 'Your Business',
      logoUrl: config?.assets?.logo,
      primaryColor: config?.theme?.colors?.primary ?? '#2563eb',
      reportPeriod,
      stats: {
        totalLeads: totalLeads ?? 0,
        qualifiedLeads: qualified.length,
        warmLeads: warm.length,
        coldLeads: cold.length,
        totalBookings: bookings?.length ?? 0,
        completedBookings: bookings?.filter((b) => b.status === 'completed').length ?? 0,
        newThisWeek: allLeads.length,
        avgScore,
      },
      topLeads: allLeads.slice(0, 8).map((l) => ({
        name: l.name,
        email: l.email,
        score: l.score,
        source: l.source ?? 'unknown',
        date: new Date(l.created_at).toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
        }),
      })),
      sourceBreakdown,
      weeklyTrend,
    })
  );

  // â”€â”€ Upload PDF to Supabase Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const fileName = `reports/${tenantId}/weekly-${new Date().toISOString().split('T')[0]}.pdf`;

  await supabaseAdmin.storage.from('tenant-documents').upload(fileName, pdfBuffer, {
    contentType: 'application/pdf',
    upsert: true,
  });

  // Create signed URL (7-day expiry)
  const { data: signedUrl } = await supabaseAdmin.storage
    .from('tenant-documents')
    .createSignedUrl(fileName, 7 * 24 * 60 * 60);

  if (!signedUrl?.signedUrl) {
    console.error(`[Report] Failed to create signed URL for ${fileName}`);
    return;
  }

  // â”€â”€ Email report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  await sendEmail({
    tenantId,
    to: ownerEmail,
    subject: `ðŸ“Š Your weekly report is ready â€” ${reportPeriod}`,
    template: ReportEmailTemplate({
      businessName: config?.identity?.siteName ?? 'Your Business',
      reportPeriod,
      totalLeads: totalLeads ?? 0,
      qualifiedLeads: qualified.length,
      totalBookings: bookings?.length ?? 0,
      downloadUrl: signedUrl.signedUrl,
      priorWeekLeads: priorWeekLeads ?? 0,
    }),
    emailType: 'lead_digest',
    idempotencyKey: `weekly-report-${tenantId}-${new Date().toISOString().split('T')[0]}`,
  });

  console.log(`[Report] Weekly report sent to ${ownerEmail} for tenant ${tenantId}`);
});
```

---
