### 14.5 Automated Accessibility Testing in CI

**File:** `e2e/a11y/homepage.spec.ts`

```typescript
import { test, expect } from '@playwright/test';
import AxeBuilder from '@axe-core/playwright';

const TEST_URLS = [
  { name: 'Homepage', url: 'http://localhost:3001' },
  { name: 'Contact Page', url: 'http://localhost:3001/contact' },
  { name: 'Services Page', url: 'http://localhost:3001/services' },
  { name: 'Blog Index', url: 'http://localhost:3001/blog' },
  { name: 'Portal Login', url: 'http://localhost:3000/auth/login' },
  { name: 'Portal Dashboard', url: 'http://localhost:3000/dashboard' },
];

for (const { name, url } of TEST_URLS) {
  test(`${name}: no WCAG 2.2 AA violations`, async ({ page }) => {
    await page.goto(url);
    await page.waitForLoadState('networkidle');

    const results = await new AxeBuilder({ page })
      .withTags([
        'wcag2a',
        'wcag2aa',
        'wcag22aa', // WCAG 2.2 AA rules
        'best-practice',
      ])
      .exclude('#cookie-banner') // Exclude third-party elements
      .analyze();

    // Group violations by impact for clear reporting
    const critical = results.violations.filter((v) => v.impact === 'critical');
    const serious = results.violations.filter((v) => v.impact === 'serious');

    // Zero tolerance for critical and serious violations
    if (critical.length || serious.length) {
      console.error('[A11y Violations]', JSON.stringify([...critical, ...serious], null, 2));
    }

    expect(critical).toHaveLength(0);
    expect(serious).toHaveLength(0);

    // Log moderate/minor for awareness (don't fail CI)
    const moderate = results.violations.filter((v) => v.impact === 'moderate');
    if (moderate.length) {
      console.warn(`[A11y Warning] ${moderate.length} moderate violations on ${name}`);
    }
  });

  test(`${name}: keyboard navigation completes without trap`, async ({ page }) => {
    await page.goto(url);
    await page.waitForLoadState('networkidle');

    // Tab through 20 elements — if focus is trapped, this will hang
    for (let i = 0; i < 20; i++) {
      await page.keyboard.press('Tab');
      const focusedEl = await page.evaluate(() => document.activeElement?.tagName);
      expect(focusedEl).not.toBeNull();
    }
  });

  test(`${name}: skip to content link works`, async ({ page }) => {
    await page.goto(url);

    // First Tab should focus the skip link
    await page.keyboard.press('Tab');
    const skipLink = await page.evaluate(() => {
      const el = document.activeElement;
      return { tagName: el?.tagName, text: el?.textContent?.trim() };
    });

    expect(skipLink.tagName).toBe('A');
    expect(skipLink.text?.toLowerCase()).toContain('skip');

    // Activate the skip link
    await page.keyboard.press('Enter');

    // Focus should now be on main content
    const focused = await page.evaluate(() => {
      const el = document.activeElement;
      return el?.id ?? el?.tagName;
    });
    expect(focused).toBe('main-content');
  });

  test(`${name}: all images have alt text`, async ({ page }) => {
    await page.goto(url);

    const imagesWithoutAlt = await page.evaluate(() => {
      const imgs = Array.from(document.querySelectorAll('img'));
      return imgs.filter((img) => img.getAttribute('alt') === null).map((img) => img.src);
    });

    expect(imagesWithoutAlt).toHaveLength(0);
  });

  test(`${name}: color contrast ratio ≥ 4.5:1 on body text`, async ({ page }) => {
    await page.goto(url);

    // Axe handles this programmatically
    const results = await new AxeBuilder({ page }).withRules(['color-contrast']).analyze();

    expect(results.violations).toHaveLength(0);
  });
}
```

---

## Priority Table for Domains 11–14

| Task                                              | Domain | Priority | Timeline | Success Metric                                    |
| ------------------------------------------------- | ------ | -------- | -------- | ------------------------------------------------- |
| Stripe webhook handler (idempotent)               | 11     | **P0**   | Day 5    | Duplicate events return 200, no double-processing |
| Checkout session + billing page                   | 11     | **P0**   | Week 1   | Client can subscribe and see plan                 |
| Customer portal (Manage Subscription)             | 11     | **P0**   | Week 1   | Client can update card, cancel, upgrade           |
| Payment failure graduated response                | 11     | **P1**   | Week 1   | Suspension fires on 3rd failed attempt only       |
| QStash job client + signature verification        | 12     | **P0**   | Week 1   | No job endpoint accepts unsigned requests         |
| Lead digest daily email job                       | 12     | **P1**   | Week 2   | Warm leads batched, sent at 8 AM tenant TZ        |
| CRM sync job (Zapier + HubSpot + GHL)             | 12     | **P1**   | Week 2   | Lead appears in CRM within 60s                    |
| Booking reminder jobs (24h + 1h)                  | 12     | **P1**   | Week 2   | Client receives reminder before appointment       |
| GDPR deletion job (30-day queued)                 | 12     | **P1**   | Week 2   | Tenant data deleted on cancellation + 30 days     |
| Sentry + OpenTelemetry instrumentation            | 13     | **P0**   | Day 3    | Errors appear in Sentry within 60s                |
| Tinybird analytics pipeline                       | 13     | **P1**   | Week 2   | Leads/day chart in portal                         |
| Per-tenant Tinybird JWT (row-locked)              | 13     | **P1**   | Week 2   | Tenant A cannot query Tenant B data               |
| Funnel analytics (visitor → lead)                 | 13     | **P2**   | Week 3   | Funnel visible in portal analytics                |
| SkipToContent + FocusTrap                         | 14     | **P0**   | Day 3    | Tab → "Skip to main content" on all sites         |
| FormField accessible wrapper                      | 14     | **P0**   | Day 3    | All forms pass axe: critical/serious = 0          |
| Playwright axe-core CI suite                      | 14     | **P0**   | Week 1   | CI fails on any new critical a11y violation       |
| WCAG 2.2 target size audit                        | 14     | **P1**   | Week 2   | All interactive elements ≥ 40px on mobile         |
| Accessible Modal + Keyboard navigation            | 14     | **P1**   | Week 2   | Modal passes FocusTrap + Escape key tests         |
| Full WCAG 2.2 AA checklist review                 | 14     | **P1**   | Week 2   | QA sign-off on all 20 checklist items             |
| Accessible authentication (OTP, no CAPTCHA block) | 14     | **P2**   | Week 3   | Login completes without visual CAPTCHA dependency |

---

**Cross-domain invariants for Domains 11–14:**

- Stripe webhooks always: (1) verify signature first, (2) check idempotency table, (3) insert idempotency record, (4) handle. Never skip any step. [digitalapplied](https://www.digitalapplied.com/blog/stripe-payment-integration-developer-guide-2026)
- Every QStash job endpoint verifies the `upstash-signature` header — unsigned requests return `401`, never execute. [upstash](https://upstash.com/docs/qstash/features/background-jobs)
- GDPR deletion is always delayed 30 days via QStash's `notBefore` parameter after cancellation — the grace period allows tenant to reactivate. [edpb.europa](https://www.edpb.europa.eu/news/news/2025/cef-2025-launch-coordinated-enforcement-right-erasure_en)
- Sentry's `beforeSend` hook scrubs email addresses and phone numbers before sending to Sentry's servers — GDPR compliance for error reporting. [compliancepoint](https://www.compliancepoint.com/privacy/gdpr-right-to-erasure-an-enforcement-priority-in-2025/)
- Tinybird tokens are scoped to a single tenant via `fixed_params` — a compromised portal session cannot access another tenant's analytics. [clerk](https://clerk.com/blog/tinybird-and-clerk)
- Accessibility is a day-one concern, not a post-launch audit — every component in `@repo/ui` is built accessible from the first commit. The ADA Title II April 2026 deadline makes this legally enforceable for government-serving clients. [briskventures](https://briskventures.us/blog/ada-compliance-in-2026-accessibility-that-drives-growth/)

---

Here are Domains 15–18 at complete production depth.

---
