### 21.3 Supabase Image Loader

**File:** `apps/*/src/lib/supabase-image-loader.ts`

```typescript
// Custom next/image loader for Supabase Storage
// Replaces Vercel's image optimization with Supabase's on-the-fly transform
// Reference: https://supabase.com/docs/guides/storage/serving/image-transformations

const SUPABASE_PROJECT_ID = process.env.NEXT_PUBLIC_SUPABASE_PROJECT_ID!;

interface LoaderParams {
  src: string;
  width: number;
  quality?: number;
}

export default function supabaseLoader({ src, width, quality }: LoaderParams): string {
  // src is relative to the bucket: "tenant-assets/tenant-id/logo.png"
  // Full URL for external images (e.g. Google avatar, Sanity CDN)
  if (src.startsWith('http')) {
    // External image: use Supabase's image transform proxy
    return `https://${SUPABASE_PROJECT_ID}.supabase.co/storage/v1/render/image/public/${src}?width=${width}&quality=${quality ?? 80}&format=origin`;
  }

  return [
    `https://${SUPABASE_PROJECT_ID}.supabase.co`,
    `/storage/v1/render/image/public/${src}`,
    `?width=${width}`,
    `&quality=${quality ?? 80}`,
    `&format=webp`, // Always serve WebP (Supabase handles fallback)
    `&resize=contain`, // Preserve aspect ratio
  ].join('');
}
```

**File:** `next.config.ts` (image loader configuration)

```typescript
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  images: {
    loader: 'custom',
    loaderFile: './src/lib/supabase-image-loader.ts',
    // Fallback domains for external images (Google avatars, Sanity)
    remotePatterns: [
      { protocol: 'https', hostname: '*.supabase.co' },
      { protocol: 'https', hostname: 'lh3.googleusercontent.com' },
      { protocol: 'https', hostname: 'cdn.sanity.io' },
      { protocol: 'https', hostname: 'avatars.githubusercontent.com' },
    ],
    // Device sizes for responsive images
    deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048],
    imageSizes: [16, 32, 48, 64, 96, 128, 256],
  },
};

export default nextConfig;
```

---
