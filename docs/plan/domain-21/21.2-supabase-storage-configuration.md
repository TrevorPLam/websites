### 21.2 Supabase Storage Configuration

**Buckets (created via migration, not manually):**

```sql
-- 1. Public assets bucket (logos, favicons, service images)
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
  'tenant-assets',
  'tenant-assets',
  TRUE,   -- Public: no auth required to VIEW; upload is restricted by RLS
  5242880, -- 5MB max per file
  ARRAY['image/jpeg', 'image/png', 'image/webp', 'image/svg+xml', 'image/gif', 'image/ico']
);

-- 2. Private documents bucket (PDFs, contracts, GDPR exports)
INSERT INTO storage.buckets (id, name, public, file_size_limit)
VALUES (
  'tenant-documents',
  'tenant-documents',
  FALSE,  -- Private: requires signed URL
  20971520 -- 20MB max
);

-- RLS: Tenants can only upload/delete their own assets
CREATE POLICY "Tenant asset upload"
ON storage.objects FOR INSERT TO authenticated
WITH CHECK (
  bucket_id = 'tenant-assets'
  AND (storage.foldername(name)) [blog.elest](https://blog.elest.io/cal-com-api-build-custom-booking-flows-and-integrate-with-your-stack/) = (
    SELECT id::text FROM tenants
    WHERE id = (auth.jwt() ->> 'tenantId')::uuid
    LIMIT 1
  )
);

CREATE POLICY "Tenant asset delete"
ON storage.objects FOR DELETE TO authenticated
USING (
  bucket_id = 'tenant-assets'
  AND (storage.foldername(name)) [blog.elest](https://blog.elest.io/cal-com-api-build-custom-booking-flows-and-integrate-with-your-stack/) = (
    SELECT id::text FROM tenants
    WHERE id = (auth.jwt() ->> 'tenantId')::uuid
    LIMIT 1
  )
);
```

---
