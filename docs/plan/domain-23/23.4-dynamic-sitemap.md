# 23.4 Dynamic Sitemap

**File:** `apps/*/src/app/sitemap.ts`

```typescript
import type { MetadataRoute } from 'next';
import { headers } from 'next/headers';
import { resolveTenant } from '@repo/multi-tenant/resolve-tenant';
import { db } from '@repo/db';
import { cacheTag, cacheLife } from 'next/cache';

// ============================================================================
// MULTI-TENANT DYNAMIC SITEMAP
// Reads hostname from request headers to determine tenant.
// Returns ONLY this tenant's URLs — not all tenants' pages.
// Reference: https://www.buildwithmatija.com/blog/dynamic-sitemap-robots-nextjs-payload-multi-tenant
// ============================================================================

export const dynamic = 'force-dynamic'; // Tenant-dependent — cannot be static

export default async function sitemap(): Promise<MetadataRoute.Sitemap> {
  'use cache';
  // Cache per tenant, revalidate every 24h or on sitemap:rebuild job
  const headersList = await headers();
  const host = headersList.get('host') ?? '';

  const tenantContext = await resolveTenant({ headers: headersList } as any);
  if (!tenantContext) return [];

  const { tenantId } = tenantContext;

  cacheTag(`tenant:${tenantId}:sitemap`);
  cacheLife({ revalidate: 86400 }); // 24h

  // Fetch site config
  const { data: tenant } = await db
    .from('tenants')
    .select('config, custom_domain, subdomain')
    .eq('id', tenantId)
    .single();

  if (!tenant) return [];

  const config = tenant.config as any;
  const domain =
    tenant.custom_domain ?? `${tenant.subdomain}.${process.env.NEXT_PUBLIC_ROOT_DOMAIN}`;
  const siteUrl = `https://${domain}`;
  const services = config?.identity?.services ?? [];

  const now = new Date();

  const urls: MetadataRoute.Sitemap = [
    // Homepage — highest priority, monthly change
    {
      url: `${siteUrl}/`,
      lastModified: now,
      changeFrequency: 'weekly',
      priority: 1.0,
    },

    // About page
    {
      url: `${siteUrl}/about`,
      lastModified: now,
      changeFrequency: 'monthly',
      priority: 0.7,
    },

    // Services index
    {
      url: `${siteUrl}/services`,
      lastModified: now,
      changeFrequency: 'weekly',
      priority: 0.9,
    },

    // Individual service pages (most important for local SEO)
    ...services.map((service: any) => ({
      url: `${siteUrl}/services/${service.slug}`,
      lastModified: now,
      changeFrequency: 'monthly' as const,
      priority: 0.85,
    })),

    // Contact page
    {
      url: `${siteUrl}/contact`,
      lastModified: now,
      changeFrequency: 'monthly',
      priority: 0.8,
    },

    // Area pages (SEO: "HVAC repair in [city]")
    ...(config?.identity?.serviceAreas ?? []).map((area: string) => ({
      url: `${siteUrl}/service-area/${area.toLowerCase().replace(/\s+/g, '-')}`,
      lastModified: now,
      changeFrequency: 'monthly' as const,
      priority: 0.75,
    })),
  ];

  return urls;
}
```
