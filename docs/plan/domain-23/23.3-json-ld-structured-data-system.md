# 23.3 JSON-LD Structured Data System

**File:** `packages/seo/src/structured-data.ts`

```typescript
import type { SiteConfig } from '@repo/config/types';

// ============================================================================
// JSON-LD STRUCTURED DATA
// Generates Schema.org markup from SiteConfig.
// Injected via <script type="application/ld+json"> in layout.tsx.
// All schemas validated against: https://validator.schema.org
// ============================================================================

// ── LocalBusiness (root schema for all service businesses) ──────────────────

export function buildLocalBusinessSchema(config: SiteConfig): Record<string, unknown> {
  const identity = config.identity;
  const siteUrl = config.siteUrl ?? `https://${config.domain}`;

  // Map industry to Schema.org type
  const schemaTypeMap: Record<string, string> = {
    hvac: 'HVACBusiness',
    plumbing: 'Plumber',
    electrical: 'Electrician',
    dental: 'Dentist',
    medical: 'MedicalBusiness',
    law: 'LegalService',
    realEstate: 'RealEstateAgent',
    accounting: 'AccountingService',
    restaurant: 'Restaurant',
    salon: 'HairSalon',
    general: 'LocalBusiness',
  };

  const schemaType = schemaTypeMap[identity.industry ?? 'general'] ?? 'LocalBusiness';

  const schema: Record<string, unknown> = {
    '@context': 'https://schema.org',
    '@type': [schemaType, 'LocalBusiness'],  // Dual type for broader coverage
    '@id': `${siteUrl}/#organization`,

    name: identity.siteName,
    description: identity.description ?? identity.tagline,
    url: siteUrl,

    // Contact
    ...(identity.contact?.phone ? {
      telephone: identity.contact.phone,
    } : {}),

    ...(identity.contact?.email ? {
      email: identity.contact.email,
    } : {}),

    // Address
    ...(identity.address ? {
      address: {
        '@type': 'PostalAddress',
        streetAddress: identity.address.street ?? undefined,
        addressLocality: identity.address.city,
        addressRegion: identity.address.state,
        postalCode: identity.address.zip ?? undefined,
        addressCountry: 'US',
      },
    } : {}),

    // Geo coordinates (if provided)
    ...(identity.coordinates ? {
      geo: {
        '@type': 'GeoCoordinates',
        latitude: identity.coordinates.lat,
        longitude: identity.coordinates.lng,
      },
    } : {}),

    // Opening hours
    ...(identity.hours?.length ? {
      openingHoursSpecification: identity.hours.flatMap((h) =>
        (h.days ?? []).map((day: string) => ({
          '@type': 'OpeningHoursSpecification',
          dayOfWeek: `https://schema.org/${day}`,
          opens: h.opens,
          closes: h.closes,
        }))
      ),
    } : {}),

    // Service areas
    ...(identity.serviceAreas?.length ? {
      areaServed: identity.serviceAreas.map((area: string) => ({
        '@type': 'City',
        name: area,
      })),
    } : {}),

    // Logo
    ...(config.assets?.logo ? {
      logo: {
        '@type': 'ImageObject',
        url: config.assets.logo,
        width: 400,
        height: 400,
      },
      image: config.assets.logo,
    } : {}),

    // Social profiles (sameAs)
    ...(identity.socialHandles ? {
      sameAs: [
        identity.socialHandles.facebook ? `https://www.facebook.com/${identity.socialHandles.facebook}` : null,
        identity.socialHandles.instagram ? `https://www.instagram.com/${identity.socialHandles.instagram}` : null,
        identity.socialHandles.twitter ? `https://twitter.com/${identity.socialHandles.twitter}` : null,
        identity.socialHandles.linkedin ? `https://www.linkedin.com/company/${identity.socialHandles.linkedin}` : null,
        identity.googleBusinessUrl ?? null,
        identity.yelpUrl ?? null,
      ].filter(Boolean),
    } : {}),

    // Payment methods
    paymentAccepted: 'Cash, Credit Card, Check',
    currenciesAccepted: 'USD',
    priceRange: identity.priceRange ?? '$$',
  };

  return schema;
}

// ── Service schema (one per service page) ───────────────────────────────────

export function buildServiceSchema(
  config: SiteConfig,
  service: { name: string; description: string; slug: string; priceDisplay?: string }
): Record<string, unknown> {
  const siteUrl = config.siteUrl ?? `https://${config.domain}`;

  return {
    '@context': 'https://schema.org',
    '@type': 'Service',
    '@id': `${siteUrl}/services/${service.slug}#service`,
    name: service.name,
    description: service.description,
    provider: {
      '@type': 'LocalBusiness',
      '@id': `${siteUrl}/#organization`,
      name: config.identity.siteName,
    },
    areaServed: config.identity.serviceAreas?.map((area: string) => ({
      '@type': 'City',
      name: area,
    })) ?? [],
    ...(service.priceDisplay ? {
      offers: {
        '@type': 'Offer',
        price: service.priceDisplay,
        priceCurrency: 'USD',
      },
    } : {}),
  };
}

// ── BreadcrumbList (navigation trail for rich results) ──────────────────────

export function buildBreadcrumbSchema(
  siteUrl: string,
  siteName: string,
  crumbs: Array<{ name: string; url: string }>
): Record<string, unknown> {
  return {
    '@context': 'https://schema.org',
    '@type': 'BreadcrumbList',
    itemListElement: [
      {
        '@type': 'ListItem',
        position: 1,
        name: 'Home',
        item: siteUrl,
      },
      ...crumbs.map((crumb, index) => ({
        '@type': 'ListItem',
        position: index + 2,
        name: crumb.name,
        item: crumb.url,
      })),
    ],
  };
}

// ── FAQPage (drives People Also Ask rich results) ───────────────────────────

export function buildFAQSchema(
  faqs: Array<{ question: string; answer: string }>
): Record<string, unknown> {
  return {
    '@context': 'https://schema.org',
    '@type': 'FAQPage',
    mainEntity: faqs.map((faq) => ({
      '@type': 'Question',
      name: faq.question,
      acceptedAnswer: {
        '@type': 'Answer',
        text: faq.answer,
      },
    })),
  };
}

// ── WebSite schema (enables Google Sitelinks Searchbox) ─────────────────────

export function buildWebsiteSchema(config: SiteConfig): Record<string, unknown> {
  const siteUrl = config.siteUrl ?? `https://${config.domain}`;
  return {
    '@context': 'https://schema.org',
    '@type': 'WebSite',
    '@id': `${siteUrl}/#website`,
    url: siteUrl,
    name: config.identity.siteName,
    description: config.identity.tagline,
    publisher: {
      '@id': `${siteUrl}/#organization`,
    },
    potentialAction: {
      '@type': 'SearchAction',
      target: {
        '@type': 'EntryPoint',
        urlTemplate: `${siteUrl}/?q={search_term_string}`,
      },
      'query-input': 'required name=search_term_string',
    },
  };
}

// ── JSON-LD script component (Server Component) ──────────────────────────────

export function JsonLd({ schema }: { schema: Record<string, unknown> }) {
  return (
    <script
      type="application/ld+json"
      // nonce is injected via server component from request headers
      dangerouslySetInnerHTML={{ __html: JSON.stringify(schema) }}
    />
  );
}

// ── Root layout: inject all global schemas ───────────────────────────────────

export function RootJsonLd({ config }: { config: SiteConfig }) {
  const schemas = [
    buildLocalBusinessSchema(config),
    buildWebsiteSchema(config),
  ];

  return (
    <>
      {schemas.map((schema, i) => (
        <JsonLd key={i} schema={schema} />
      ))}
    </>
  );
}
```
