# 23.2 Tenant Metadata Factory

**File:** `packages/seo/src/metadata-factory.ts`

```typescript
import type { Metadata } from 'next';
import type { SiteConfig } from '@repo/config/types';

// ============================================================================
// METADATA FACTORY
// Generates full Next.js Metadata object from SiteConfig.
// Called from every page's generateMetadata() — never inline in page files.
// ============================================================================

interface MetadataOptions {
  config: SiteConfig;
  path: string; // Current pathname, e.g. '/services/hvac-repair'
  pageTitle?: string; // Override: page-specific title prefix
  pageDescription?: string; // Override: page-specific description
  ogImage?: string; // Override: page-specific OG image URL
  noIndex?: boolean; // Force noindex (e.g. thank-you pages, portal pages)
  canonical?: string; // Explicit canonical (omit for auto-generation)
}

export function buildMetadata(options: MetadataOptions): Metadata {
  const { config, path, pageTitle, pageDescription, ogImage, noIndex = false, canonical } = options;

  const identity = config.identity;
  const siteUrl = config.siteUrl ?? `https://${config.domain}`;

  // Title template: "Service Name | Business Name — City, ST"
  const businessSuffix = identity.address?.city
    ? `${identity.siteName} — ${identity.address.city}, ${identity.address.state}`
    : identity.siteName;

  const title = pageTitle
    ? { default: `${pageTitle} | ${businessSuffix}`, template: `%s | ${businessSuffix}` }
    : { default: businessSuffix, template: `%s | ${businessSuffix}` };

  const description =
    pageDescription ??
    identity.tagline ??
    `${identity.siteName} serving ${identity.address?.city ?? 'your area'}. ${identity.industry ?? 'Professional'} services. Call ${identity.contact?.phone ?? 'us today'}.`;

  const resolvedCanonical = canonical ?? `${siteUrl}${path}`;
  const resolvedOgImage = ogImage ?? `${siteUrl}/og${path}`;

  return {
    metadataBase: new URL(siteUrl),

    title,
    description,

    // Canonical URL — critical for multi-tenant (same content, different domains)
    alternates: {
      canonical: resolvedCanonical,
    },

    // Robots
    robots: noIndex
      ? { index: false, follow: false }
      : {
          index: true,
          follow: true,
          googleBot: {
            index: true,
            follow: true,
            'max-video-preview': -1,
            'max-image-preview': 'large',
            'max-snippet': -1,
          },
        },

    // OpenGraph
    openGraph: {
      type: 'website',
      locale: 'en_US',
      url: resolvedCanonical,
      siteName: identity.siteName,
      title: pageTitle ?? identity.siteName,
      description,
      images: [
        {
          url: resolvedOgImage,
          width: 1200,
          height: 630,
          alt: `${identity.siteName} — ${identity.tagline ?? identity.industry ?? 'Professional Services'}`,
        },
      ],
    },

    // Twitter Card
    twitter: {
      card: 'summary_large_image',
      title: pageTitle ?? identity.siteName,
      description,
      images: [resolvedOgImage],
      creator: identity.socialHandles?.twitter ?? undefined,
      site: identity.socialHandles?.twitter ?? undefined,
    },

    // App links / theme
    other: {
      'theme-color': config.theme?.colors?.primary ?? '#2563eb',
    },

    // Verification tags (Google Search Console, Bing)
    verification: {
      google: identity.googleSiteVerification ?? undefined,
      other: identity.bingSiteVerification
        ? { 'msvalidate.01': [identity.bingSiteVerification] }
        : undefined,
    },
  };
}

// ── Service page metadata ─────────────────────────────────────────────────────

export function buildServiceMetadata(
  config: SiteConfig,
  service: { name: string; description: string; slug: string }
): Metadata {
  const city = config.identity.address?.city ?? '';
  const state = config.identity.address?.state ?? '';

  return buildMetadata({
    config,
    path: `/services/${service.slug}`,
    pageTitle: `${service.name}${city ? ` in ${city}, ${state}` : ''}`,
    pageDescription: `${service.description} Serving ${city}${config.identity.serviceAreas?.length ? ` and ${config.identity.serviceAreas.slice(0, 3).join(', ')}` : ''}. Call ${config.identity.contact?.phone ?? 'us'} for a free quote.`,
  });
}

// ── Homepage metadata ─────────────────────────────────────────────────────────

export function buildHomepageMetadata(config: SiteConfig): Metadata {
  const city = config.identity.address?.city ?? '';
  const state = config.identity.address?.state ?? '';
  const industry = config.identity.industry ?? 'services';

  return buildMetadata({
    config,
    path: '/',
    pageTitle: city
      ? `${config.identity.siteName} — ${industry.charAt(0).toUpperCase() + industry.slice(1)} in ${city}, ${state}`
      : config.identity.siteName,
    pageDescription:
      config.identity.tagline ??
      `${config.identity.siteName} provides professional ${industry} services in ${city}, ${state}. Licensed, insured, and locally trusted. Free estimates available.`,
  });
}
```
