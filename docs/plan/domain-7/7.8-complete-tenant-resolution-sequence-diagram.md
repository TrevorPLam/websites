### 7.8 Complete Tenant Resolution Sequence Diagram

```
Client Request
     │
     ▼
┌─────────────────────────────────────────────────────┐
│ Edge Network (Vercel CDN)                           │
│ - Check Cache-Control headers                       │
│ - Route based on domain/subdomain                   │
└──────────────────────┬──────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────┐
│ middleware.ts                                       │
│ 1. Strip bypass headers (CVE-2025-29927)            │
│ 2. Generate CSP nonce                               │
│ 3. Extract host: "acme-law.youragency.com"         │
│ 4. resolveTenant() → Redis cache check             │
│    └→ Cache miss? → Supabase DB lookup             │
│ 5. checkBillingStatus() → Redis cache              │
│    └→ "suspended"? → Rewrite to /suspended        │
│ 6. Rate limit check (Upstash sliding window)       │
│    └→ Over limit? → 429 response                  │
│ 7. Auth check (Supabase session)                   │
│    └→ Protected route + no session? → /login      │
│ 8. Set headers: X-Tenant-Id, X-Nonce              │
└──────────────────────┬──────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────┐
│ Server Component / Server Action                    │
│ 1. Read X-Tenant-Id from headers                   │
│ 2. createServerAction() wrapper:                   │
│    a. Zod input validation                         │
│    b. Re-verify Supabase session                   │
│    c. Read X-Tenant-Id (NOT user input)            │
│    d. verifyTenantMembership() IDOR check          │
│    e. Execute handler with ActionContext           │
└──────────────────────┬──────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────┐
│ Supabase (Postgres + RLS)                          │
│ 1. auth.tenant_id() resolves from JWT              │
│ 2. RLS policy: WHERE tenant_id = auth.tenant_id() │
│ 3. Composite index hit: (tenant_id, created_at)   │
│ 4. Returns only tenant-scoped rows                 │
└─────────────────────────────────────────────────────┘
```

---
