### 7.6 Vercel for Platforms — Programmatic Domain Lifecycle

**What it is:** Vercel for Platforms SDK automates custom domain assignment, SSL certificate provisioning, and domain verification for every new tenant. Instead of manual DNS configuration, the entire lifecycle is code-driven. [oreateai](https://www.oreateai.com/blog/unlocking-custom-domains-and-dynamic-deployments-a-look-at-vercels-domain-apis/053f659011a30e51ee264af59f6cc38d)

**File:** `packages/multi-tenant/src/vercel-domains.ts`

```typescript
import { Vercel } from '@vercel/sdk';

const vercel = new Vercel({
  bearerToken: process.env.VERCEL_API_TOKEN!,
});

const PROJECT_ID = process.env.VERCEL_PROJECT_ID!;
const TEAM_ID = process.env.VERCEL_TEAM_ID!;

// ============================================================================
// TYPES
// ============================================================================

export type DomainStatus = {
  name: string;
  verified: boolean;
  sslStatus: 'pending' | 'issued' | 'error';
  verificationRecords?: Array<{
    type: 'TXT' | 'CNAME' | 'A';
    name: string;
    value: string;
  }>;
};

// ============================================================================
// ADD CUSTOM DOMAIN FOR TENANT
// Called during client onboarding (Domain 15 §15.1)
// ============================================================================

export async function addTenantDomain(customDomain: string): Promise<DomainStatus> {
  try {
    // Step 1: Add domain to Vercel project
    const result = await vercel.projects.addProjectDomain({
      idOrName: PROJECT_ID,
      teamId: TEAM_ID,
      requestBody: {
        name: customDomain,
      },
    });

    // Step 2: Get verification records (for client's DNS setup instructions)
    const domainInfo = await vercel.domains.getDomain({
      domain: customDomain,
      teamId: TEAM_ID,
    });

    return {
      name: customDomain,
      verified: result.verified ?? false,
      sslStatus: result.verified ? 'issued' : 'pending',
      verificationRecords: domainInfo.verification?.map((v: any) => ({
        type: v.type,
        name: v.domain,
        value: v.value,
      })),
    };
  } catch (err: any) {
    // Domain already exists in project — not an error, check status
    if (err?.code === 'domain_already_in_use') {
      return checkDomainStatus(customDomain);
    }
    throw err;
  }
}

// ============================================================================
// POLL DOMAIN VERIFICATION STATUS
// DNS propagation takes 0–48 hours — poll with exponential backoff
// ============================================================================

export async function checkDomainStatus(customDomain: string): Promise<DomainStatus> {
  const config = await vercel.projects.getProjectDomain({
    idOrName: PROJECT_ID,
    domain: customDomain,
    teamId: TEAM_ID,
  });

  return {
    name: customDomain,
    verified: config.verified ?? false,
    // Vercel auto-provisions SSL once domain is verified [web:215]
    sslStatus: config.verified ? 'issued' : 'pending',
  };
}

// ============================================================================
// REMOVE DOMAIN (offboarding — Domain 15 §15.2)
// ============================================================================

export async function removeTenantDomain(customDomain: string): Promise<void> {
  await vercel.projects.removeProjectDomain({
    idOrName: PROJECT_ID,
    domain: customDomain,
    teamId: TEAM_ID,
  });
}

// ============================================================================
// DOMAIN VERIFICATION WEBHOOK HANDLER
// Vercel sends webhook events on domain verification and SSL issuance [web:216]
// ============================================================================

export async function handleVercelDomainWebhook(payload: {
  type: string;
  payload: { domain: string; projectId: string };
}): Promise<void> {
  const { domain } = payload.payload;

  if (payload.type === 'domain.verified') {
    // Update tenant record — domain is live
    const { db } = await import('@repo/db');
    await db.from('tenants').update({ status: 'active' }).eq('custom_domain', domain);

    // Bust tenant resolution cache
    const { invalidateTenantCache } = await import('./resolve-tenant');
    const { data: tenant } = await db
      .from('tenants')
      .select('id')
      .eq('custom_domain', domain)
      .single();

    if (tenant) await invalidateTenantCache(tenant.id);

    console.log(`[Domain] Verified: ${domain}`);
  }

  if (payload.type === 'domain.ssl_certificate.issued') {
    console.log(`[SSL] Certificate issued for: ${domain}`);
    // Could trigger welcome email to client
  }
}

// ============================================================================
// WILDCARD SUBDOMAIN SETUP (one-time, for agency root domain)
// Requires Vercel nameservers — sets up *.youragency.com
// Reference: https://vercel.com/docs/multi-tenant/domain-management
// ============================================================================

export async function setupWildcardDomain(apexDomain: string): Promise<void> {
  // Add apex domain first
  await vercel.projects.addProjectDomain({
    idOrName: PROJECT_ID,
    teamId: TEAM_ID,
    requestBody: { name: apexDomain },
  });

  // Add wildcard — requires Vercel nameservers (DNS-01 SSL challenge)
  await vercel.projects.addProjectDomain({
    idOrName: PROJECT_ID,
    teamId: TEAM_ID,
    requestBody: { name: `*.${apexDomain}` },
  });

  console.log(`[Wildcard] Set up *.${apexDomain} — ensure nameservers point to Vercel`);
}
```

**DNS Setup Instructions (provided to clients):**

```typescript
// packages/multi-tenant/src/generate-dns-instructions.ts
export function generateDNSInstructions(customDomain: string): string {
  return `
## DNS Setup for ${customDomain}

Add the following DNS record at your domain registrar:
```
