### 7.10 Per-Tenant Dynamic Data Flow Summary

| Layer                     | How Tenant Is Known                                 | Source                   | Can Be Spoofed?         |
| ------------------------- | --------------------------------------------------- | ------------------------ | ----------------------- |
| **Middleware**            | `extractTenantIdentifier(request)` from host header | HTTP Host (TLS-verified) | No (TLS)                |
| **Server Component**      | `headers().get('X-Tenant-Id')`                      | Set by middleware        | No (middleware sets it) |
| **Server Action wrapper** | `headers().get('X-Tenant-Id')`                      | Set by middleware        | No (same)               |
| **Supabase RLS**          | `auth.tenant_id()` from JWT                         | Supabase Auth JWT        | No (signed JWT)         |
| **Redis rate limiter**    | `tenantId:IP` composite key                         | Middleware-extracted     | No                      |
| **Billing check**         | `checkBillingStatus(tenantId)`                      | Redis → Supabase         | No                      |

The consistent principle: **tenant identity always flows from infrastructure (TLS hostname, signed JWT), never from user-supplied input.** This is the complete defense against tenant spoofing attacks.

---

## Priority Table for Domains 4–7

| Task                                                       | Domain | Priority | Timeline | Owner       | Success Metric                                          |
| ---------------------------------------------------------- | ------ | -------- | -------- | ----------- | ------------------------------------------------------- |
| Deploy `middleware.ts` with CVE-2025-29927 mitigations     | 4      | **P0**   | Day 1    | Claude Code | All bypass headers stripped in Edge logs                |
| `createServerAction()` wrapper on all Server Actions       | 4      | **P0**   | Day 1–2  | Claude Code | IDOR test suite passes                                  |
| Initial DB schema + RLS policies                           | 4/6    | **P0**   | Day 2    | Claude Code | RLS isolation Playwright suite passes                   |
| Supavisor connection pooling config                        | 6      | **P0**   | Day 2    | Claude Code | `max_connections` never exceeded in prod                |
| Rate limiting (Upstash, per-tier)                          | 4/7    | **P0**   | Day 3    | Claude Code | 429s fire correctly in load test                        |
| Tenant resolution (subdomain + custom domain)              | 7      | **P0**   | Day 3    | Claude Code | 10 test subdomains resolve correctly                    |
| Billing suspension flow                                    | 7      | **P0**   | Day 4    | Claude Code | Suspended tenant sees graceful page                     |
| `next.config.ts` with PPR + React Compiler annotation mode | 5      | **P0**   | Day 4    | Claude Code | Lighthouse performance ≥85                              |
| `use cache` on all static marketing page shells            | 5      | **P0**   | Day 5    | Claude Code | TTFB <200ms on cached pages                             |
| Vercel wildcard domain + SSL setup                         | 7      | **P0**   | Day 5    | Human       | `*.youragency.com` resolves on all browsers             |
| Core Web Vitals → Tinybird pipeline                        | 5      | **P1**   | Week 2   | Claude Code | CWV events appear in Tinybird dashboard                 |
| ElectricSQL offline form (home services clients)           | 6      | **P1**   | Week 2   | Claude Code | Form submits offline + syncs on reconnect               |
| PGlite session store for lead scoring                      | 6      | **P2**   | Week 3   | Claude Code | Session score computed client-side                      |
| Programmatic domain assignment via Vercel SDK              | 7      | **P1**   | Week 2   | Claude Code | New client domain live within 10 min of DNS propagation |
| SAML 2.0 enterprise SSO                                    | 7      | **P2**   | Month 2  | Claude Code | Enterprise client logs in via Azure AD                  |
| Composite index validation in CI                           | 4/6    | **P1**   | Week 2   | Claude Code | `EXPLAIN ANALYZE` in CI shows index scans               |
| ML-DSA phase 1 flag + provider abstraction                 | 4      | **P2**   | Month 2  | Claude Code | `CryptoProvider` interface passes all tests             |
| PGlite offline form for all clients                        | 6      | **P2**   | Month 2  | Claude Code | OfflineLeadForm deployed to all sites                   |
| Dynamic rate limit overrides for enterprise                | 7      | **P3**   | Month 3  | Claude Code | Per-tenant limit override stored in Redis               |

---

## Quick Reference — Domains 4–7

**Security chain:** Every request passes through: `middleware.ts` (header strip → CSP nonce → tenant resolve → billing check → rate limit → auth refresh) → `createServerAction()` (Zod validate → re-verify auth → IDOR check) → Supabase RLS (row-level tenant isolation). [securitylabs.datadoghq](https://securitylabs.datadoghq.com/articles/nextjs-middleware-auth-bypass/)

**Performance defaults:** All marketing page shells use `use cache` + `cacheTag`/`cacheLife`. Dynamic zones (forms, A/B variants, phone numbers) are wrapped in `<Suspense>`. React Compiler starts in `annotation` mode, graduates to global after `react-compiler-healthcheck` audit. [nextjs](https://nextjs.org/docs/app/getting-started/cache-components)

**Data safety invariants:** `tenant_id` is the first column in every composite index. RLS policies use `auth.tenant_id()` (a SECURITY DEFINER function) rather than inline subqueries. Every migration includes a `-- Down` block. Connection pooling via Supavisor transaction mode prevents `max_connections` exhaustion. [oneuptime](https://oneuptime.com/blog/post/2026-02-02-postgresql-pgbouncer-pooling/view)

**Tenant identity rule:** Tenant context travels through infrastructure only (TLS hostname → middleware header → signed JWT). Never from user-supplied input. This single principle prevents the entire class of tenant-spoofing and IDOR attacks.

---

I now have everything needed. Here are Domains 8–11 at full production depth.

---
