### 6.6 Schema Migration Safety

**Every migration follows this structure — down migration is required:**

**File:** `packages/db/src/migrations/0002_add_lead_attribution.sql`

```sql
-- ============================================================================
-- Migration: 0002_add_lead_attribution
-- Description: Add UTM attribution fields and first/last touch tracking to leads
-- Author: Claude Code
-- Date: 2026-02-23
-- Depends: 0001_initial_schema
-- ============================================================================

-- UP MIGRATION
-- ============================================================================

-- Add first-touch attribution columns (UTM parameters captured on first visit)
ALTER TABLE leads
  ADD COLUMN IF NOT EXISTS utm_source_first    TEXT,
  ADD COLUMN IF NOT EXISTS utm_medium_first    TEXT,
  ADD COLUMN IF NOT EXISTS utm_campaign_first  TEXT,
  ADD COLUMN IF NOT EXISTS utm_content_first   TEXT,
  ADD COLUMN IF NOT EXISTS utm_term_first      TEXT,
  ADD COLUMN IF NOT EXISTS first_touch_at      TIMESTAMPTZ,

  -- Last-touch attribution (UTM parameters at time of form submission)
  ADD COLUMN IF NOT EXISTS utm_source_last     TEXT,
  ADD COLUMN IF NOT EXISTS utm_medium_last     TEXT,
  ADD COLUMN IF NOT EXISTS utm_campaign_last   TEXT,
  ADD COLUMN IF NOT EXISTS utm_content_last    TEXT,
  ADD COLUMN IF NOT EXISTS utm_term_last       TEXT,
  ADD COLUMN IF NOT EXISTS last_touch_at       TIMESTAMPTZ,

  -- Referrer
  ADD COLUMN IF NOT EXISTS referrer_url        TEXT,
  ADD COLUMN IF NOT EXISTS landing_page        TEXT;

-- Index for attribution reporting
CREATE INDEX IF NOT EXISTS idx_leads_utm_source_first
  ON leads (tenant_id, utm_source_first);

CREATE INDEX IF NOT EXISTS idx_leads_utm_campaign_first
  ON leads (tenant_id, utm_campaign_first);

-- Backfill existing leads: copy utm_source → utm_source_first
UPDATE leads
SET
  utm_source_first   = utm_source,
  utm_medium_first   = utm_medium,
  utm_campaign_first = utm_campaign,
  utm_source_last    = utm_source,
  utm_medium_last    = utm_medium,
  utm_campaign_last  = utm_campaign,
  first_touch_at     = created_at,
  last_touch_at      = created_at
WHERE utm_source IS NOT NULL
  AND utm_source_first IS NULL;

-- ============================================================================
-- DOWN MIGRATION
-- ============================================================================

-- ALTER TABLE leads
--   DROP COLUMN IF EXISTS utm_source_first,
--   DROP COLUMN IF EXISTS utm_medium_first,
--   DROP COLUMN IF EXISTS utm_campaign_first,
--   DROP COLUMN IF EXISTS utm_content_first,
--   DROP COLUMN IF EXISTS utm_term_first,
--   DROP COLUMN IF EXISTS first_touch_at,
--   DROP COLUMN IF EXISTS utm_source_last,
--   DROP COLUMN IF EXISTS utm_medium_last,
--   DROP COLUMN IF EXISTS utm_campaign_last,
--   DROP COLUMN IF EXISTS utm_content_last,
--   DROP COLUMN IF EXISTS utm_term_last,
--   DROP COLUMN IF EXISTS last_touch_at,
--   DROP COLUMN IF EXISTS referrer_url,
--   DROP COLUMN IF EXISTS landing_page;
--
-- DROP INDEX IF EXISTS idx_leads_utm_source_first;
-- DROP INDEX IF EXISTS idx_leads_utm_campaign_first;
```

**Migration runner (Supabase CLI):**

```bash
# Apply migration
supabase db push --linked

# Generate TypeScript types from schema (run after every migration)
supabase gen types typescript --linked > packages/db/src/types.ts

# Dry-run check (CI step — see Domain 14)
supabase db diff --linked --schema public
```

**Migration Safety Checklist:**

| Rule                                               | Why                                          | Example                         |
| -------------------------------------------------- | -------------------------------------------- | ------------------------------- |
| Always include `-- Down` block                     | Enables rollback without data loss           | See above                       |
| Use `IF NOT EXISTS` / `IF EXISTS`                  | Idempotent — safe to re-run                  | `ADD COLUMN IF NOT EXISTS`      |
| Backfill before adding `NOT NULL`                  | Avoids constraint violation on existing rows | Backfill → `SET NOT NULL`       |
| Never `DROP COLUMN` without a sprint               | Gives apps time to stop reading column       | Feature flag → deprecate → drop |
| Index before `NOT NULL` constraint on large tables | Prevents table lock                          | `CONCURRENTLY` index → alter    |

---
