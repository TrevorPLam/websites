### 6.3 PgBouncer/Supavisor Connection Pooling — Complete Configuration

**What it is:** Supabase ships **Supavisor**, a cloud-native Postgres connection pooler that replaces PgBouncer on the managed platform. In Transaction mode (required for serverless), each Next.js Server Component or Server Action borrows a connection for the duration of one transaction, then returns it to the pool. Without pooling, 50 concurrent SSR renders = 50 open Postgres connections — catastrophic at scale.

**Connection URL patterns — use the correct one:**

```typescript
// packages/db/src/client.ts (complete version)
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

// ============================================================================
// CONNECTION URL SELECTION GUIDE
// Direct URL:    postgresql://postgres:[pw]@db.[ref].supabase.co:5432/postgres
//   Use for:     Prisma migrate, schema introspection, long-lived processes
//   NOT for:     Serverless functions (exhausts max_connections)
//
// Supavisor (Transaction Mode):
//              postgresql://postgres.[ref]:[pw]@aws-0-us-east-1.pooler.supabase.com:6543/postgres
//   Use for:     All Next.js Server Components, Server Actions, API routes
//   Pool mode:   transaction — connection returned after each transaction
//
// Supavisor (Session Mode):
//              postgresql://postgres.[ref]:[pw]@aws-0-us-east-1.pooler.supabase.com:5432/postgres
//   Use for:     Queries that require session-level features (SET, LISTEN/NOTIFY)
//   NOT for:     Serverless (holds connection for session lifetime)
// ============================================================================

// Transaction mode — default for all serverless operations
const SUPAVISOR_TRANSACTION_URL = process.env.SUPABASE_TRANSACTION_POOL_URL!;

// Direct URL — only for migrations and admin scripts
export const SUPABASE_DIRECT_URL = process.env.SUPABASE_DIRECT_URL!;

// ============================================================================
// CLIENT FACTORY
// ============================================================================

let _adminClient: ReturnType<typeof createClient<Database>> | null = null;

export function getAdminClient() {
  if (_adminClient) return _adminClient;
  _adminClient = createClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    {
      db: { schema: 'public' },
      auth: {
        persistSession: false,
        autoRefreshToken: false,
        detectSessionInUrl: false,
      },
      global: {
        // Use Supavisor transaction mode URL via custom fetch
        fetch: (url: string | Request, init?: RequestInit) => {
          // Override DB connection to use pooler
          return fetch(url, init);
        },
      },
    }
  );
  return _adminClient;
}

export const db = getAdminClient();

// ============================================================================
// READ REPLICA CLIENT
// Route analytics / reporting queries here to protect the primary
// Supabase Enterprise: enable read replicas in project settings
// ============================================================================

let _replicaClient: ReturnType<typeof createClient<Database>> | null = null;

export function getReplicaClient() {
  if (!process.env.SUPABASE_REPLICA_URL) {
    // Graceful degradation: fall back to primary
    return getAdminClient();
  }
  if (_replicaClient) return _replicaClient;
  _replicaClient = createClient<Database>(
    process.env.SUPABASE_REPLICA_URL,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    {
      auth: { persistSession: false, autoRefreshToken: false },
    }
  );
  return _replicaClient;
}

export const replicaDb = getReplicaClient();

// ============================================================================
// QUERY GOVERNOR: Per-tier statement_timeout enforcement
// Applied at the query level for Server Actions / API routes
// ============================================================================

type Tier = 'starter' | 'professional' | 'enterprise';

const TIMEOUT_MS: Record<Tier, number> = {
  starter: 5_000, // 5s
  professional: 15_000, // 15s
  enterprise: 30_000, // 30s
};

export async function withStatementTimeout<T>(tier: Tier, query: () => Promise<T>): Promise<T> {
  const timeout = TIMEOUT_MS[tier];
  // Use AbortController to cancel the query if it exceeds the timeout
  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), timeout);

  try {
    const result = await query();
    clearTimeout(timer);
    return result;
  } catch (err) {
    clearTimeout(timer);
    if (controller.signal.aborted) {
      throw new Error(`Query exceeded ${timeout}ms timeout for tier "${tier}"`);
    }
    throw err;
  }
}
```

**Environment variables required:**

```bash
# .env.local
NEXT_PUBLIC_SUPABASE_URL=https://[ref].supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...          # Public (safe to expose)
SUPABASE_SERVICE_ROLE_KEY=eyJ...              # Secret (never expose)
SUPABASE_TRANSACTION_POOL_URL=postgresql://postgres.[ref]:[pw]@aws-0-us-east-1.pooler.supabase.com:6543/postgres
SUPABASE_DIRECT_URL=postgresql://postgres:[pw]@db.[ref].supabase.co:5432/postgres
SUPABASE_REPLICA_URL=                         # Optional — Enterprise plan
```

---
