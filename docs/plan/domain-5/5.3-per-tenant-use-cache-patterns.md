### 5.3 Per-Tenant `use cache` Patterns

**Status:** ✅ Completed

**What it is:** Next.js 16's `use cache` directive caches async server components at function-level granularity, with per-tenant cache keys, tags, and lifetimes. [nextjs](https://nextjs.org/docs/app/getting-started/cache-components)

**File:** `sites/[law-firm-client]/src/pages/home/ui/HomePage.tsx`

```typescript
import { Suspense } from 'react';
import { use } from 'react';
import { cacheTag, cacheLife } from 'next/cache';
import { getHomePageContent } from '@/shared/api/content';
import { ContactFormWidget } from '@/widgets/contact-form-widget';
import { HeroSection } from './HeroSection';
import { ServicesSection } from './ServicesSection';
import config from '../../../../../../site.config'; // site.config.ts

// ============================================================================
// STATIC SHELL (Cache Component — cached indefinitely until revalidated)
// ============================================================================

async function HomePageShell({ tenantId }: { tenantId: string }) {
  'use cache'; // Marks this component as a Cache Component (Next.js 16)

  // Cache tagging: allows targeted revalidation
  cacheTag(`tenant:${tenantId}:homepage`);
  cacheTag(`tenant:${tenantId}:content`);

  // Cache lifetime: days profile = 24h TTL, 7-day stale-while-revalidate
  cacheLife('days');

  const content = await getHomePageContent(tenantId);

  return (
    <>
      <HeroSection
        headline={content.headline}
        subheadline={content.subheadline}
        ctaText={content.ctaText}
        ctaUrl={content.ctaUrl}
        backgroundImage={content.backgroundImage}
      />
      <ServicesSection services={content.services} />
    </>
  );
}

// ============================================================================
// DYNAMIC ZONE (Suspense boundary — rendered per-request)
// This prevents the contact form's CSRF token, A/B variant assignment,
// and user session from being cached.
// ============================================================================

function ContactFormZone() {
  // No 'use cache' here — this renders dynamically on every request
  return (
    <Suspense fallback={<ContactFormSkeleton />}>
      <ContactFormWidget />
    </Suspense>
  );
}

function ContactFormSkeleton() {
  return (
    <div
      className="animate-pulse bg-gray-100 rounded-lg h-96 w-full"
      aria-label="Loading contact form"
      aria-busy="true"
    />
  );
}

// ============================================================================
// PAGE COMPONENT
// The shell is cached; the dynamic zone streams in after initial load.
// Result: Lighthouse FCP = instant (cached shell), TTI = fast (dynamic form streams in)
// ============================================================================

export default async function HomePage() {
  // tenantId from headers (set by middleware — Domain 4 §4.2)
  const { headers } = await import('next/headers');
  const headersList = await headers();
  const tenantId = headersList.get('X-Tenant-Id') ?? config.identity.tenantId;

  return (
    <main>
      <HomePageShell tenantId={tenantId} />
      <ContactFormZone />
    </main>
  );
}
```

**Revalidation (cache invalidation on content update):**

```typescript
// packages/cms-adapter/src/sanity.ts (called by Sanity webhook)
import { revalidateTag } from 'next/cache';

export async function handleSanityWebhook(payload: SanityWebhookPayload) {
  const { _type, tenantId } = payload;

  // Invalidate specific page cache tags
  switch (_type) {
    case 'homePage':
      revalidateTag(`tenant:${tenantId}:homepage`);
      break;
    case 'blogPost':
      revalidateTag(`tenant:${tenantId}:blog`);
      revalidateTag(`tenant:${tenantId}:content`);
      break;
    default:
      // Invalidate all content for this tenant
      revalidateTag(`tenant:${tenantId}:content`);
  }
}
```

---
