### 5.7 Core Web Vitals → Tinybird Pipeline

**Status:** ✅ Completed

**File:** `packages/analytics/src/cwv-collector.ts`

```typescript
'use client';

import { onCLS, onINP, onLCP, onFCP, onTTFB, type Metric } from 'web-vitals';

const TINYBIRD_TOKEN = process.env.NEXT_PUBLIC_TINYBIRD_TOKEN!;
const TINYBIRD_HOST = 'https://api.tinybird.co';

interface CWVEvent {
  tenant_id: string;
  session_id: string;
  pathname: string;
  metric_name: string;
  metric_value: number;
  metric_rating: 'good' | 'needs-improvement' | 'poor';
  user_agent: string;
  connection_type: string | null;
  timestamp: string;
}

function sendToTinybird(event: CWVEvent): void {
  // Use sendBeacon for reliability (doesn't block page unload)
  const blob = new Blob([JSON.stringify(event)], { type: 'application/json' });
  navigator.sendBeacon(`${TINYBIRD_HOST}/v0/events?name=cwv_events&token=${TINYBIRD_TOKEN}`, blob);
}

export function initCWVCollection(tenantId: string, sessionId: string): void {
  if (typeof window === 'undefined') return;

  const baseEvent = {
    tenant_id: tenantId,
    session_id: sessionId,
    pathname: window.location.pathname,
    user_agent: navigator.userAgent,
    connection_type: (navigator as any).connection?.effectiveType ?? null,
    timestamp: new Date().toISOString(),
  };

  function report(metric: Metric): void {
    sendToTinybird({
      ...baseEvent,
      metric_name: metric.name,
      metric_value: metric.value,
      metric_rating: metric.rating,
    });
  }

  onCLS(report);
  onINP(report);
  onLCP(report);
  onFCP(report);
  onTTFB(report);
}
```

**Tinybird Data Source Schema:**

```sql
-- cwv_events.datasource (Tinybird schema file)
SCHEMA >
  `tenant_id` String `json:$.tenant_id`,
  `session_id` String `json:$.session_id`,
  `pathname` String `json:$.pathname`,
  `metric_name` String `json:$.metric_name`,
  `metric_value` Float64 `json:$.metric_value`,
  `metric_rating` String `json:$.metric_rating`,
  `user_agent` String `json:$.user_agent`,
  `connection_type` Nullable(String) `json:$.connection_type`,
  `timestamp` DateTime64(3) `json:$.timestamp`

ENGINE "MergeTree"
ENGINE_SORTING_KEY "tenant_id, metric_name, timestamp"
ENGINE_TTL "timestamp + interval 90 day"
```

**Tinybird API Endpoint (p75 per-tenant, last 30 days):**

```sql
-- cwv_p75_per_tenant.pipe (Tinybird endpoint)
%
SELECT
  tenant_id,
  metric_name,
  quantile(0.75)(metric_value) as p75_value,
  countIf(metric_rating = 'good') / count() * 100 as good_pct,
  countIf(metric_rating = 'needs-improvement') / count() * 100 as needs_improvement_pct,
  countIf(metric_rating = 'poor') / count() * 100 as poor_pct,
  count() as total_samples
FROM cwv_events
WHERE
  timestamp >= now() - INTERVAL 30 DAY
  {% if defined(tenant_id) %}
    AND tenant_id = {{ String(tenant_id, '') }}
  {% end %}
  {% if defined(metric_name) %}
    AND metric_name = {{ String(metric_name, '') }}
  {% end %}
GROUP BY tenant_id, metric_name
ORDER BY tenant_id, metric_name
```

---
