### 22.4 RAG — Site Content Embedding Job

**File:** `apps/*/src/app/api/jobs/sitemap/rebuild/route.ts`

```typescript
import { createJobHandler } from '@repo/jobs/verify-qstash';
import { db } from '@repo/db';
import { createClient } from '@supabase/supabase-js';

export const maxDuration = 60;

const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

export const POST = createJobHandler<'sitemap.rebuild'>(async (payload) => {
  const { tenantId } = payload;

  // Fetch site config for this tenant
  const { data: tenant } = await db.from('tenants').select('config').eq('id', tenantId).single();

  if (!tenant?.config) return;
  const config = tenant.config as any;
  const identity = config.identity ?? {};

  // Build chunks from site content (business info + services + FAQs)
  const chunks: Array<{ content: string; chunkType: string }> = [];

  // Business overview
  chunks.push({
    content: `${identity.siteName} is a ${identity.industry} business based in ${identity.address?.city}, ${identity.address?.state}. ${identity.description ?? ''}`,
    chunkType: 'about',
  });

  // Contact info
  chunks.push({
    content: `Contact ${identity.siteName}: Phone: ${identity.contact?.phone ?? 'N/A'}. Email: ${identity.contact?.email ?? 'N/A'}. Address: ${identity.address?.street ?? ''} ${identity.address?.city}, ${identity.address?.state} ${identity.address?.zip ?? ''}.`,
    chunkType: 'contact',
  });

  // Hours
  if (identity.hours?.length) {
    const hoursText = identity.hours
      .map((h: any) => `${h.days?.join(', ')}: ${h.opens} to ${h.closes}`)
      .join('. ');
    chunks.push({
      content: `Hours of operation for ${identity.siteName}: ${hoursText}.`,
      chunkType: 'hours',
    });
  }

  // Service areas
  if (identity.serviceAreas?.length) {
    chunks.push({
      content: `${identity.siteName} serves the following areas: ${identity.serviceAreas.join(', ')}.`,
      chunkType: 'service_areas',
    });
  }

  // Individual services
  for (const service of identity.services ?? []) {
    chunks.push({
      content: `Service: ${service.name}. ${service.description}${service.priceDisplay ? ` Pricing: ${service.priceDisplay}.` : ''}`,
      chunkType: 'service',
    });
  }

  // Generate embeddings in batch (max 20 inputs per OpenAI request)
  const batchSize = 20;
  for (let i = 0; i < chunks.length; i += batchSize) {
    const batch = chunks.slice(i, i + batchSize);

    const embeddingResponse = await fetch('https://api.openai.com/v1/embeddings', {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'text-embedding-3-small',
        input: batch.map((c) => c.content),
        dimensions: 1536,
      }),
    });

    const { data: embedData } = await embeddingResponse.json();

    // Upsert into pgvector table
    const upserts = batch.map((chunk, j) => ({
      tenant_id: tenantId,
      content: chunk.content,
      chunk_type: chunk.chunkType,
      embedding: embedData[j].embedding,
      updated_at: new Date().toISOString(),
    }));

    await supabaseAdmin.from('site_content_embeddings').upsert(upserts, {
      onConflict: 'tenant_id,chunk_type,content',
      ignoreDuplicates: false,
    });
  }

  console.log(`[RAG] Embedded ${chunks.length} content chunks for tenant ${tenantId}`);
});
```

**SQL function for vector similarity search:**

```sql
-- Supabase migration: match_site_content RPC
CREATE OR REPLACE FUNCTION match_site_content(
  query_embedding    vector(1536),
  match_tenant_id    uuid,
  match_threshold    float DEFAULT 0.78,
  match_count        int DEFAULT 4
)
RETURNS TABLE (
  id        uuid,
  content   text,
  chunk_type text,
  similarity float
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    e.id,
    e.content,
    e.chunk_type,
    1 - (e.embedding <=> query_embedding) AS similarity
  FROM site_content_embeddings e
  WHERE
    e.tenant_id = match_tenant_id
    AND 1 - (e.embedding <=> query_embedding) >= match_threshold
  ORDER BY e.embedding <=> query_embedding  -- Ascending cosine distance
  LIMIT match_count;
END;
$$;

-- Index for fast ANN search (HNSW — better for high-recall search)
CREATE INDEX ON site_content_embeddings
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);
```

---

## Priority Table for Domains 19–22

| Task                                               | Domain | Priority | Timeline | Success Metric                                           |
| -------------------------------------------------- | ------ | -------- | -------- | -------------------------------------------------------- |
| Cal.com webhook handler (all 6 events)             | 19     | **P0**   | Week 1   | `BOOKING_CREATED` creates lead + booking record          |
| Cal.com API v2 (not v1 — deprecated Feb 2026)      | 19     | **P0**   | Week 1   | All API calls use `api.cal.com/v2`                       |
| Booking embed popup on marketing site              | 19     | **P0**   | Week 1   | Visitor can schedule from site without redirect          |
| 24h + 1h reminder emails queued on booking         | 19     | **P0**   | Week 1   | QStash messages visible in Upstash console               |
| Post-appointment follow-up email (+30 min)         | 19     | **P1**   | Week 2   | Follow-up sends 30 min after booking end time            |
| Managed user provisioning (new tenant)             | 19     | **P2**   | Week 3   | New tenant gets Cal.com user + event types on complete   |
| Resend multi-tenant domain routing                 | 20     | **P0**   | Week 1   | Client emails send from `notifications@clientdomain.com` |
| Agency fallback domain when client unverified      | 20     | **P0**   | Week 1   | Unverified tenants still receive billing/lead emails     |
| Lead notification email (immediate)                | 20     | **P0**   | Week 1   | Email arrives < 30s after form submit                    |
| List-Unsubscribe header on all emails              | 20     | **P0**   | Week 1   | One-click unsubscribe compliant with CAN-SPAM            |
| Resend idempotency keys (prevent duplicates)       | 20     | **P0**   | Week 1   | No duplicate billing receipt on Stripe retry             |
| React Email 5 templates (lead + billing + booking) | 20     | **P0**   | Week 2   | All 13 email types have branded templates                |
| Supabase Storage buckets + RLS policies            | 21     | **P0**   | Week 1   | Tenant A cannot access Tenant B's assets                 |
| Client-side image compression before upload        | 21     | **P0**   | Week 1   | Logo upload ≤ 300KB regardless of source file size       |
| Supabase custom `next/image` loader                | 21     | **P0**   | Week 1   | All site images served as WebP via Supabase CDN          |
| Signed upload URL (file never passes server)       | 21     | **P1**   | Week 1   | 4MB Next.js API body limit never hit                     |
| AI chat widget on marketing site                   | 22     | **P1**   | Week 2   | Widget loads < 50ms above the fold (lazy)                |
| RAG content embedding job on tenant activate       | 22     | **P1**   | Week 2   | Chat answers questions from site content accurately      |
| Lead capture tool (AI auto-captures contact info)  | 22     | **P1**   | Week 2   | Lead appears in DB within 5s of chat capture             |
| Booking tool redirect in chat                      | 22     | **P2**   | Week 3   | Chat "schedule" intent surfaces Cal.com calendar         |

| Per-tenant chat rate limiting (20 msg/hr) | 22 | **P2** | Week 3 | Prevent abuse and ensure fair usage |
