### 36.3 Full CI/CD Pipeline (Complete)

**File:** `.github/workflows/deploy.yml`

```yaml
# ============================================================================
# FULL CI/CD PIPELINE
# PR â†’ checks â†’ preview â†’ staging â†’ production promotion
# ============================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main, staging]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true # Cancel stale PR runs

env:
  PNPM_VERSION: '9'
  NODE_VERSION: '22'

jobs:
  # â”€â”€ 1. Type check (fast gate â€” runs first) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  typecheck:
    name: TypeScript Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with: { version: '${{ env.PNPM_VERSION }}' }
      - uses: actions/setup-node@v4
        with: { node-version: '${{ env.NODE_VERSION }}', cache: 'pnpm' }
      - run: pnpm install --frozen-lockfile
      - run: pnpm typecheck
      - run: pnpm lint

  # â”€â”€ 2. Unit + integration tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: typecheck

    services:
      postgres:
        image: supabase/postgres:15.1.1.78
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports: ['5432:5432']

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with: { version: '${{ env.PNPM_VERSION }}' }
      - uses: actions/setup-node@v4
        with: { node-version: '${{ env.NODE_VERSION }}', cache: 'pnpm' }
      - run: pnpm install --frozen-lockfile

      # Apply migrations to test Postgres
      - name: Run Supabase migrations (test DB)
        run: pnpm supabase db push --local
        env:
          SUPABASE_DB_URL: postgresql://postgres:postgres@localhost:5432/postgres

      - name: Run unit tests
        run: pnpm test --coverage
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # â”€â”€ 3. Build check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: Build Check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: typecheck
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with: { version: '${{ env.PNPM_VERSION }}' }
      - uses: actions/setup-node@v4
        with: { node-version: '${{ env.NODE_VERSION }}', cache: 'pnpm' }
      - run: pnpm install --frozen-lockfile
      - name: Build all apps
        run: pnpm build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.STAGING_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.STAGING_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_ROOT_DOMAIN: 'staging.agency.com'
          NEXT_TELEMETRY_DISABLED: '1'

  # â”€â”€ 4. Migrate staging DB (on staging branch push) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  migrate-staging:
    name: Migrate Staging DB
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [test, build]
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with: { version: '${{ env.PNPM_VERSION }}' }
      - uses: actions/setup-node@v4
        with: { node-version: '${{ env.NODE_VERSION }}', cache: 'pnpm' }
      - run: pnpm install --frozen-lockfile

      - name: Apply migrations to staging Supabase
        run: pnpm supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.STAGING_SUPABASE_DB_PASSWORD }}
          SUPABASE_PROJECT_ID: ${{ secrets.STAGING_SUPABASE_PROJECT_ID }}

  # â”€â”€ 5. Deploy to staging (Vercel) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: migrate-staging
    environment:
      name: staging
      url: https://staging.agency.com
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Vercel (staging)
        run: |
          npx vercel --token=${{ secrets.VERCEL_TOKEN }} \
            --env=staging \
            --scope=${{ secrets.VERCEL_ORG_ID }} \
            2>&1 | tee deploy.log
          echo "DEPLOYMENT_URL=$(grep -o 'https://[^[:space:]]*' deploy.log | head -1)" >> $GITHUB_ENV

      - name: Run smoke tests against staging
        run: pnpm test:e2e:smoke
        env:
          BASE_URL: ${{ env.DEPLOYMENT_URL }}
          PLAYWRIGHT_TEST_BASE_URL: ${{ env.DEPLOYMENT_URL }}

  # â”€â”€ 6. Migrate production DB (on main push) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  migrate-production:
    name: Migrate Production DB
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [test, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production-db # Requires manual approval in GitHub Environments
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with: { version: '${{ env.PNPM_VERSION }}' }
      - uses: actions/setup-node@v4
        with: { node-version: '${{ env.NODE_VERSION }}', cache: 'pnpm' }
      - run: pnpm install --frozen-lockfile

      - name: Apply migrations to production Supabase
        run: pnpm supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.PROD_SUPABASE_DB_PASSWORD }}
          SUPABASE_PROJECT_ID: ${{ secrets.PROD_SUPABASE_PROJECT_ID }}

  # â”€â”€ 7. Deploy to production (staged â€” NOT auto-promoted) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-production-staged:
    name: Stage Production Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: migrate-production
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Vercel (staged, no domain assignment)
        run: |
          DEPLOYMENT_URL=$(npx vercel --prod --skip-domain \
            --token=${{ secrets.VERCEL_TOKEN }} \
            --scope=${{ secrets.VERCEL_ORG_ID }} \
            2>&1 | tail -1)
          echo "STAGED_URL=$DEPLOYMENT_URL" >> $GITHUB_ENV
          echo "DEPLOYMENT_ID=$(npx vercel inspect $DEPLOYMENT_URL --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }} | grep 'id:' | awk '{print $2}')" >> $GITHUB_ENV

      - name: Run smoke tests against staged deployment
        run: pnpm test:e2e:smoke
        env:
          BASE_URL: ${{ env.STAGED_URL }}
          PLAYWRIGHT_TEST_BASE_URL: ${{ env.STAGED_URL }}

      - name: Post staged deployment info to Slack
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_DEPLOYMENTS }} \
            -H 'Content-type: application/json' \
            -d '{
              "text": "ðŸš€ *Production deployment staged and smoke-tested*\nâ€¢ Staged URL: ${{ env.STAGED_URL }}\nâ€¢ Deployment ID: ${{ env.DEPLOYMENT_ID }}\nâ€¢ Commit: ${{ github.sha }}\nâ€¢ <https://vercel.com/${{ secrets.VERCEL_ORG_ID }}|Promote in Vercel dashboard>"
            }'
```

---
