### 36.6 Fresh Environment Setup

**File:** `scripts/setup-env.sh`

```bash
#!/usr/bin/env bash
# ============================================================
# FRESH ENVIRONMENT SETUP SCRIPT
# Run once to initialize a new developer's local environment
# or a new staging environment from scratch.
# ============================================================

set -euo pipefail

echo "üöÄ Setting up fresh environment..."

# 1. Install dependencies
echo "üì¶ Installing dependencies..."
pnpm install

# 2. Copy environment file
if [ ! -f .env.local ]; then
  cp .env.example .env.local
  echo "‚úÖ Created .env.local ‚Äî fill in your Supabase + Clerk credentials"
fi

# 3. Start Supabase locally
echo "üêò Starting local Supabase..."
npx supabase start

# 4. Apply all migrations
echo "üóÉÔ∏è  Applying database migrations..."
npx supabase db push --local

# 5. Seed database with fixture data
echo "üå± Seeding fixture data..."
npx tsx scripts/seed.ts

# 6. Install Playwright browsers
echo "üé≠ Installing Playwright browsers..."
npx playwright install chromium

# 7. Build packages (required before running apps)
echo "üèóÔ∏è  Building shared packages..."
pnpm --filter './packages/**' build

echo ""
echo "‚úÖ Environment setup complete!"
echo ""
echo "Next steps:"
echo "  pnpm dev          ‚Üí Start all apps in development mode"
echo "  pnpm test         ‚Üí Run unit tests"
echo "  pnpm test:e2e     ‚Üí Run Playwright E2E tests"
echo "  pnpm build        ‚Üí Production build"
echo "  ANALYZE=true pnpm build ‚Üí Bundle analysis"
echo ""
echo "Supabase Studio: http://localhost:54323"
echo "Marketing site:  http://localhost:3000"
echo "Portal:          http://localhost:3001"
echo "Super Admin:     http://localhost:3002"
```

**File:** `scripts/seed.ts`

```typescript
#!/usr/bin/env tsx
// ============================================================
// DATABASE SEEDER
// Creates fixture data for local development + staging.
// NEVER runs against production (guarded by NODE_ENV check).
// ============================================================

import { createClient } from '@supabase/supabase-js';
import { v4 as uuidv4 } from 'uuid';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

async function seed() {
  if (process.env.NODE_ENV === 'production') {
    throw new Error('‚ùå Seed script must never run against production database');
  }

  console.log('üå± Seeding database...');

  // ‚îÄ‚îÄ Create 3 demo tenants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  const tenants = [
    {
      id: uuidv4(),
      subdomain: 'demo-hvac',
      status: 'active',
      plan: 'pro',
      config: {
        siteUrl: 'https://demo-hvac.localhost:3000',
        identity: {
          siteName: 'Arctic Air HVAC',
          tagline: 'Keeping Plano cool since 2005',
          industry: 'hvac',
          contact: { phone: '(972) 555-0100', email: 'info@arcticairhvac.com' },
          address: { street: '123 Main St', city: 'Plano', state: 'TX', zip: '75024' },
          serviceAreas: ['Plano, TX', 'Frisco, TX', 'Allen, TX', 'McKinney, TX', 'Richardson, TX'],
          services: [
            { name: 'AC Repair', slug: 'ac-repair', description: 'Fast same-day AC repair' },
            {
              name: 'Furnace Installation',
              slug: 'furnace-install',
              description: 'Licensed furnace installation',
            },
            {
              name: 'HVAC Maintenance',
              slug: 'hvac-maintenance',
              description: 'Annual tune-up plans',
            },
          ],
          hours: [
            {
              days: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'],
              opens: '07:00',
              closes: '19:00',
            },
            { days: ['Saturday'], opens: '08:00', closes: '15:00' },
          ],
          priceRange: '$$',
        },
        theme: { colors: { primary: '#0ea5e9' } },
      },
    },
    {
      id: uuidv4(),
      subdomain: 'demo-plumbing',
      status: 'active',
      plan: 'starter',
      config: {
        siteUrl: 'https://demo-plumbing.localhost:3000',
        identity: {
          siteName: "Mike's Plumbing",
          tagline: 'No job too big, no leak too small',
          industry: 'plumbing',
          contact: { phone: '(214) 555-0200', email: 'mike@mikesplumbing.com' },
          address: { city: 'Dallas', state: 'TX', zip: '75201' },
          serviceAreas: ['Dallas, TX', 'Irving, TX', 'Garland, TX'],
          services: [
            {
              name: 'Drain Cleaning',
              slug: 'drain-cleaning',
              description: 'Emergency drain service',
            },
            { name: 'Water Heater', slug: 'water-heater', description: 'Repair and replacement' },
          ],
          priceRange: '$',
        },
        theme: { colors: { primary: '#16a34a' } },
      },
    },
    {
      id: uuidv4(),
      subdomain: 'demo-dental',
      status: 'active',
      plan: 'enterprise',
      config: {
        siteUrl: 'https://demo-dental.localhost:3000',
        identity: {
          siteName: 'Bright Smile Dental',
          tagline: 'Family dentistry with a gentle touch',
          industry: 'dental',
          contact: { phone: '(469) 555-0300', email: 'hello@brightsmile.com' },
          address: { street: '456 Oak Ave', city: 'Frisco', state: 'TX', zip: '75034' },
          serviceAreas: ['Frisco, TX', 'McKinney, TX', 'Prosper, TX'],
          services: [
            {
              name: 'Teeth Cleaning',
              slug: 'cleaning',
              description: 'Professional cleaning and exam',
            },
            { name: 'Teeth Whitening', slug: 'whitening', description: 'In-office Zoom whitening' },
            { name: 'Invisalign', slug: 'invisalign', description: 'Clear aligner treatment' },
          ],
          priceRange: '$$$',
        },
        theme: { colors: { primary: '#7c3aed' } },
        whiteLabel: {
          enabled: true,
          portalName: 'Bright Smile Patient Portal',
          portalPrimaryColor: '#7c3aed',
          hideAgencyBranding: true,
          hideSupportLink: false,
        },
      },
    },
  ];

  const { error: tenantError } = await supabase
    .from('tenants')
    .upsert(tenants, { onConflict: 'subdomain' });
  if (tenantError) throw tenantError;
  console.log(`  ‚úÖ Created ${tenants.length} demo tenants`);

  // ‚îÄ‚îÄ Create sample leads ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  const leads = tenants.flatMap((tenant) =>
    Array.from({ length: 12 }, (_, i) => ({
      id: uuidv4(),
      tenant_id: tenant.id,
      name: `Demo Lead ${i + 1}`,
      email: `lead${i + 1}@example.com`,
      phone: `(555) ${String(i).padStart(3, '0')}-0000`,
      message: 'Interested in a free estimate for services.',
      score: Math.floor(Math.random() * 100),
      source: ['contact_form', 'phone_click', 'booking', 'chat_widget'][
        Math.floor(Math.random() * 4)
      ]!,
      status: ['new', 'contacted', 'qualified', 'converted'][Math.floor(Math.random() * 4)]!,
      created_at: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
    }))
  );

  const { error: leadError } = await supabase.from('leads').upsert(leads, { onConflict: 'id' });
  if (leadError) throw leadError;
  console.log(`  ‚úÖ Created ${leads.length} sample leads`);

  console.log('\n‚úÖ Seed complete');
  console.log('\nDemo tenant subdomains:');
  tenants.forEach((t) => console.log(`  ‚Üí http://${t.subdomain}.localhost:3000`));
}

seed().catch((err) => {
  console.error('‚ùå Seed failed:', err);
  process.exit(1);
});
```

---

## Priority Table for Domains 35‚Äì36

| Task                                                                           | Domain | Priority | Timeline | Success Metric                                                |
| ------------------------------------------------------------------------------ | ------ | -------- | -------- | ------------------------------------------------------------- |
| `@next/bundle-analyzer` wired to `ANALYZE=true pnpm build`                     | 35     | **P0**   | Week 1   | Any dev can run `ANALYZE=true pnpm build` and see treemap     |
| `size-limit` config with per-route JS budgets                                  | 35     | **P0**   | Week 1   | CI fails if marketing homepage JS exceeds 85 KB gzip          |
| `size-limit` PR comment bot                                                    | 35     | **P1**   | Week 2   | Every PR shows delta table ‚Äî no surprise regressions          |
| `next/font` for all typefaces (Inter + client brand fonts)                     | 35     | **P0**   | Week 1   | CLS = 0.00 from font swap on all tenant sites                 |
| Hero images: `priority` + `fetchPriority="high"` + `placeholder="blur"`        | 35     | **P0**   | Week 1   | LCP < 2.5s on 90th percentile across all tenant sites         |
| All third-party scripts via `next/script` (`afterInteractive`/`lazyOnload`)    | 35     | **P0**   | Week 1   | Third-party scripts contribute 0ms to LCP                     |
| `optimizePackageImports` for `lucide-react`, `date-fns`, `lodash-es`           | 35     | **P1**   | Week 2   | Tree-shaking verified in bundle analyzer treemap              |
| Lighthouse CI GitHub Actions job                                               | 35     | **P1**   | Week 2   | PRs blocked when LCP > 2.5s or performance score < 0.85       |
| `.lighthouserc.ts` with Core Web Vitals + accessibility + SEO assertions       | 35     | **P1**   | Week 2   | 30+ Lighthouse assertions enforced on every PR                |
| Vercel Speed Insights + webhook to Slack                                       | 35     | **P2**   | Week 3   | Team alerted within 15 minutes of production RUM regression   |
| Expand/contract migration pattern documented and enforced via review checklist | 36     | **P0**   | Week 1   | Zero breaking schema changes ever deployed to production      |
| `migrate-staging` + `migrate-production` CI jobs with environment approval     | 36     | **P0**   | Week 1   | Database migrations require explicit GitHub approval for prod |
| Staged production deployment (`--skip-domain` ‚Üí manual `vercel promote`)       | 36     | **P0**   | Week 1   | Code never auto-promotes to production without smoke test     |
| 3-minute rollback runbook (`vercel promote <last-good-id>`)                    | 36     | **P0**   | Week 1   | Any engineer can rollback production in under 3 minutes       |
| `setup-env.sh` one-command fresh environment script                            | 36     | **P1**   | Week 2   | New developer fully running local env within 15 minutes       |
| Database seeder with 3 demo tenants + sample leads                             | 36     | **P1**   | Week 2   | Staging always has realistic fixture data for testing         |
| PITR (Point-in-Time Recovery) enabled on prod Supabase project                 | 36     | **P0**   | Week 1   | Data loss incident recoverable to any second in last 7 days   |
| Concurrency cancel-in-progress for PR workflows                                | 36     | **P1**   | Week 2   | Stale PR runs auto-cancelled when new commit pushed           |

---

## The Complete System ‚Äî All 36 Domains

| #     | Domain                                                                     | Layer      |
| ----- | -------------------------------------------------------------------------- | ---------- |
| 1‚Äì5   | Monorepo, DB Schema, Auth, Multi-Tenant Routing, Site Config               | Foundation |
| 6‚Äì10  | Lead Capture, Lead Notifications, Marketing Site, Phone Tracking, LLMs.txt | Revenue    |
| 11‚Äì16 | Billing, Background Jobs, Observability, Accessibility, Security, CI/CD    | Platform   |
| 17‚Äì22 | Onboarding Wizard, Super Admin, Booking Calendar, Email, Assets, AI Chat   | Product    |
| 23‚Äì26 | SEO Engine, Realtime Lead Feed, A/B Testing, E2E Testing                   | Growth     |
| 27‚Äì30 | Service Area Pages, Blog/CMS, Portal Settings, Domain Management           | Scale      |
| 31‚Äì34 | PWA/Offline, Report Generation, GDPR Tools, White-Label Portal             | Enterprise |
| 35‚Äì36 | Performance Budget, Deployment Runbook                                     | Operations |

Every domain is implemented, every cross-domain invariant is documented, and every priority table gives you a week-by-week execution order. The system is complete. [vercel](https://vercel.com/kb/guide/set-up-a-staging-environment-on-vercel)
