### 4.3 Complete Supabase RLS Implementation

#### 4.3.1 Database Schema with RLS Policies

**File:** `packages/database/src/migrations/002_add_rls.sql`

```sql
-- ============================================================================
-- TENANTS TABLE
-- ============================================================================

CREATE TABLE tenants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_slug TEXT UNIQUE NOT NULL,
  site_name TEXT NOT NULL,
  business_name TEXT NOT NULL,
  custom_domain TEXT UNIQUE,
  billing_status TEXT NOT NULL DEFAULT 'active' CHECK (billing_status IN ('active', 'suspended', 'cancelled')),
  billing_tier TEXT NOT NULL DEFAULT 'free' CHECK (billing_tier IN ('free', 'starter', 'pro', 'enterprise')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Composite index for tenant resolution
CREATE INDEX idx_tenants_slug ON tenants (tenant_slug);
CREATE INDEX idx_tenants_custom_domain ON tenants (custom_domain) WHERE custom_domain IS NOT NULL;

-- Enable RLS
ALTER TABLE tenants ENABLE ROW LEVEL SECURITY;

-- Policy: Users can only read their own tenant
CREATE POLICY "Users can read their tenant"
ON tenants FOR SELECT
USING (
  id IN (
    SELECT tenant_id
    FROM tenant_members
    WHERE user_id = auth.uid()
  )
);

-- Policy: Only platform admins can insert/update/delete tenants
CREATE POLICY "Platform admins can manage tenants"
ON tenants FOR ALL
USING (auth.jwt() ->> 'role' = 'platform_admin');

-- ============================================================================
-- TENANT_MEMBERS TABLE
-- ============================================================================

CREATE TABLE tenant_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  role TEXT NOT NULL CHECK (role IN ('owner', 'admin', 'member')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(tenant_id, user_id)
);

-- Composite index for membership checks (critical for RLS performance)
CREATE INDEX idx_tenant_members_tenant_user ON tenant_members (tenant_id, user_id);
CREATE INDEX idx_tenant_members_user ON tenant_members (user_id);

-- Enable RLS
ALTER TABLE tenant_members ENABLE ROW LEVEL SECURITY;

-- Policy: Users can see their own memberships
CREATE POLICY "Users can read their memberships"
ON tenant_members FOR SELECT
USING (user_id = auth.uid());

-- Policy: Tenant owners can manage members
CREATE POLICY "Tenant owners can manage members"
ON tenant_members FOR ALL
USING (
  tenant_id IN (
    SELECT tenant_id
    FROM tenant_members
    WHERE user_id = auth.uid()
    AND role = 'owner'
  )
);

-- ============================================================================
-- LEADS TABLE
-- ============================================================================

CREATE TABLE leads (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  phone TEXT,
  message TEXT,
  source TEXT NOT NULL CHECK (source IN ('contact-form', 'phone-click', 'email-click', 'chat', 'booking')),
  score INTEGER NOT NULL DEFAULT 0,
  status TEXT NOT NULL DEFAULT 'new' CHECK (status IN ('new', 'contacted', 'qualified', 'converted', 'lost')),
  utm_source TEXT,
  utm_medium TEXT,
  utm_campaign TEXT,
  utm_term TEXT,
  utm_content TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Composite index for tenant + created_at (critical for RLS performance)
CREATE INDEX idx_leads_tenant_created ON leads (tenant_id, created_at DESC);

-- GIN index for text search (optional)
CREATE INDEX idx_leads_search ON leads USING GIN (to_tsvector('english', name || ' ' || email));

-- Enable RLS
ALTER TABLE leads ENABLE ROW LEVEL SECURITY;

-- Policy: Tenants can only see their own leads
CREATE POLICY "Tenants can read their leads"
ON leads FOR SELECT
USING (
  tenant_id IN (
    SELECT tenant_id
    FROM tenant_members
    WHERE user_id = auth.uid()
  )
);

-- Policy: Tenants can insert leads (public forms use service role key)
CREATE POLICY "Tenants can insert leads"
ON leads FOR INSERT
WITH CHECK (
  tenant_id IN (
    SELECT tenant_id
    FROM tenant_members
    WHERE user_id = auth.uid()
  )
);

-- Policy: Tenants can update their leads
CREATE POLICY "Tenants can update their leads"
ON leads FOR UPDATE
USING (
  tenant_id IN (
    SELECT tenant_id
    FROM tenant_members
    WHERE user_id = auth.uid()
  )
);

-- ============================================================================
-- BOOKINGS TABLE
-- ============================================================================

CREATE TABLE bookings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  phone TEXT NOT NULL,
  service TEXT NOT NULL,
  preferred_date DATE NOT NULL,
  preferred_time TIME NOT NULL,
  notes TEXT,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'completed', 'cancelled')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Composite index for tenant + preferred_date
CREATE INDEX idx_bookings_tenant_date ON bookings (tenant_id, preferred_date DESC);

-- Enable RLS
ALTER TABLE bookings ENABLE ROW LEVEL SECURITY;

-- Policy: Same as leads (tenants can only see their own bookings)
CREATE POLICY "Tenants can read their bookings"
ON bookings FOR SELECT
USING (
  tenant_id IN (
    SELECT tenant_id
    FROM tenant_members
    WHERE user_id = auth.uid()
  )
);

CREATE POLICY "Tenants can insert bookings"
ON bookings FOR INSERT
WITH CHECK (
  tenant_id IN (
    SELECT tenant_id
    FROM tenant_members
    WHERE user_id = auth.uid()
  )
);

CREATE POLICY "Tenants can update their bookings"
ON bookings FOR UPDATE
USING (
  tenant_id IN (
    SELECT tenant_id
    FROM tenant_members
    WHERE user_id = auth.uid()
  )
);

-- ============================================================================
-- AUDIT_LOGS TABLE
-- ============================================================================

CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  action TEXT NOT NULL,
  resource_type TEXT NOT NULL,
  resource_id UUID,
  metadata JSONB,
  ip_address TEXT,
  user_agent TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Composite index for tenant + created_at (7-year retention queries)
CREATE INDEX idx_audit_logs_tenant_created ON audit_logs (tenant_id, created_at DESC);

-- Enable RLS
ALTER TABLE audit_logs ENABLE ROW LEVEL SECURITY;

-- Policy: Tenants can read their audit logs (read-only)
CREATE POLICY "Tenants can read their audit logs"
ON audit_logs FOR SELECT
USING (
  tenant_id IN (
    SELECT tenant_id
    FROM tenant_members
    WHERE user_id = auth.uid()
  )
);

-- Policy: Only system can insert audit logs (no user INSERT allowed)
CREATE POLICY "System can insert audit logs"
ON audit_logs FOR INSERT
WITH CHECK (auth.jwt() ->> 'role' = 'service_role');

-- ============================================================================
-- TENANT_SECRETS TABLE (Encrypted)
-- ============================================================================

CREATE TABLE tenant_secrets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  key TEXT NOT NULL,
  value_encrypted TEXT NOT NULL, -- pgcrypto encrypted
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(tenant_id, key)
);

-- Composite index for tenant + key lookups
CREATE INDEX idx_tenant_secrets_tenant_key ON tenant_secrets (tenant_id, key);

-- Enable RLS
ALTER TABLE tenant_secrets ENABLE ROW LEVEL SECURITY;

-- Policy: Only tenant owners can read secrets
CREATE POLICY "Tenant owners can read secrets"
ON tenant_secrets FOR SELECT
USING (
  tenant_id IN (
    SELECT tenant_id
    FROM tenant_members
    WHERE user_id = auth.uid()
    AND role = 'owner'
  )
);

-- Policy: Only tenant owners can insert/update secrets
CREATE POLICY "Tenant owners can manage secrets"
ON tenant_secrets FOR ALL
USING (
  tenant_id IN (
    SELECT tenant_id
    FROM tenant_members
    WHERE user_id = auth.uid()
    AND role = 'owner'
  )
);

-- ============================================================================
-- PROCESSED_WEBHOOKS TABLE (Idempotency)
-- ============================================================================

CREATE TABLE processed_webhooks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  webhook_id TEXT UNIQUE NOT NULL,
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  event_type TEXT NOT NULL,
  processed_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Index for idempotency checks
CREATE INDEX idx_processed_webhooks_id ON processed_webhooks (webhook_id);
CREATE INDEX idx_processed_webhooks_tenant ON processed_webhooks (tenant_id);

-- Enable RLS
ALTER TABLE processed_webhooks ENABLE ROW LEVEL SECURITY;

-- Policy: System only (no user access)
CREATE POLICY "System can manage webhooks"
ON processed_webhooks FOR ALL
USING (auth.jwt() ->> 'role' = 'service_role');

-- ============================================================================
-- DELETION_QUEUE TABLE (GDPR)
-- ============================================================================

CREATE TABLE deletion_queue (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL,
  scheduled_deletion_date DATE NOT NULL,
  data_export_url TEXT,
  data_export_expires_at TIMESTAMPTZ,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'exported', 'deleted')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Index for nightly cron job
CREATE INDEX idx_deletion_queue_date ON deletion_queue (scheduled_deletion_date) WHERE status = 'pending';

-- Enable RLS
ALTER TABLE deletion_queue ENABLE ROW LEVEL SECURITY;

-- Policy: System only (no user access)
CREATE POLICY "System can manage deletion queue"
ON deletion_queue FOR ALL
USING (auth.jwt() ->> 'role' = 'service_role');

-- ============================================================================
-- DOWN MIGRATION (Rollback)
-- ============================================================================

-- Down: Drop all tables in reverse order
-- DROP TABLE deletion_queue;
-- DROP TABLE processed_webhooks;
-- DROP TABLE tenant_secrets;
-- DROP TABLE audit_logs;
-- DROP TABLE bookings;
-- DROP TABLE leads;
-- DROP TABLE tenant_members;
-- DROP TABLE tenants;
```

**Why These RLS Policies Work:**

- Composite indexes: `(tenant_id, created_at)` enables efficient RLS queries
- GIN indexes: Recommended by Supabase for array/JSONB columns
- Immutable functions: For functions used in RLS policies (cacheability)
- Service role bypass: Public forms use service role key (bypasses RLS)
- Role hierarchy: Owner > Admin > Member enforced via CHECK constraint

**When to Build:** P0 (Database foundation)
