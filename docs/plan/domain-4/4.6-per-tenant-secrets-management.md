### 4.6 Per-Tenant Secrets Management

**File:** `packages/auth/src/secrets-manager.ts`

```typescript
import { createClient } from '@supabase/supabase-js';

// ============================================================================
// Per-tenant secrets are encrypted with pgcrypto in Postgres.
// The master encryption key lives in Supabase Vault (never in code).
// Rotation: see docs/runbooks/rotate-secrets.md
// ============================================================================

const adminClient = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

export async function setTenantSecret(
  tenantId: string,
  keyName: string,
  value: string
): Promise<void> {
  // Encrypt with pgcrypto symmetric encryption using master key from env
  const masterKey = process.env.TENANT_SECRETS_MASTER_KEY!;

  const { error } = await adminClient.rpc('upsert_tenant_secret', {
    p_tenant_id: tenantId,
    p_key_name: keyName,
    p_plain_value: value,
    p_master_key: masterKey,
  });

  if (error) throw error;
}

export async function getTenantSecret(tenantId: string, keyName: string): Promise<string | null> {
  const masterKey = process.env.TENANT_SECRETS_MASTER_KEY!;

  const { data, error } = await adminClient.rpc('get_tenant_secret', {
    p_tenant_id: tenantId,
    p_key_name: keyName,
    p_master_key: masterKey,
  });

  if (error) return null;
  return data as string | null;
}

export async function rotateTenantSecret(
  tenantId: string,
  keyName: string,
  newValue: string
): Promise<void> {
  await setTenantSecret(tenantId, keyName, newValue);

  // Record rotation in audit log
  await adminClient.from('audit_logs').insert({
    tenant_id: tenantId,
    action: 'secret.rotated',
    table_name: 'tenant_secrets',
    new_data: { key_name: keyName, rotated_at: new Date().toISOString() },
  });
}
```

**File:** SQL functions for encrypted storage

```sql
-- Upsert encrypted tenant secret (pgcrypto)
CREATE OR REPLACE FUNCTION upsert_tenant_secret(
  p_tenant_id UUID,
  p_key_name TEXT,
  p_plain_value TEXT,
  p_master_key TEXT
)
RETURNS VOID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  INSERT INTO tenant_secrets (tenant_id, key_name, encrypted_value, rotated_at)
  VALUES (
    p_tenant_id,
    p_key_name,
    encode(encrypt(p_plain_value::bytea, p_master_key::bytea, 'aes-cbc'), 'base64'),
    now()
  )
  ON CONFLICT (tenant_id, key_name)
  DO UPDATE SET
    encrypted_value = encode(encrypt(p_plain_value::bytea, p_master_key::bytea, 'aes-cbc'), 'base64'),
    rotated_at = now();
END;
$$;

-- Decrypt tenant secret
CREATE OR REPLACE FUNCTION get_tenant_secret(
  p_tenant_id UUID,
  p_key_name TEXT,
  p_master_key TEXT
)
RETURNS TEXT
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_encrypted TEXT;
BEGIN
  SELECT encrypted_value INTO v_encrypted
  FROM tenant_secrets
  WHERE tenant_id = p_tenant_id AND key_name = p_key_name;

  IF v_encrypted IS NULL THEN
    RETURN NULL;
  END IF;

  RETURN convert_from(
    decrypt(decode(v_encrypted, 'base64'), p_master_key::bytea, 'aes-cbc'),
    'UTF8'
  );
END;
$$;
```

---

---

## Task Status

- **Task ID:** `DOMAIN-4-005`
- **Status:** âœ… Complete
- **Implementation references:** `packages/infra/security/tenant-secrets.ts`, `packages/infra/__tests__/tenant-secrets.test.ts`
- **Focused QA:** `pnpm vitest run packages/infra/__tests__/tenant-secrets.test.ts`
