### 4.4 Automated RLS Isolation Test Suite

**File:** `e2e/tests/multi-tenant.spec.ts`

```typescript
import { test, expect } from '@playwright/test';
import { createClient } from '@supabase/supabase-js';

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const SUPABASE_ANON_KEY = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

// ============================================================================
// TEST SETUP: Create Test Tenants and Users
// ============================================================================

test.describe('RLS Isolation Tests', () => {
  let tenantAId: string;
  let tenantBId: string;
  let userAId: string;
  let userBId: string;

  test.beforeAll(async () => {
    // Create test tenants (using service role)
    // In production, this would use admin API
    tenantAId = 'test-tenant-a';
    tenantBId = 'test-tenant-b';

    // Create test users
    userAId = 'user-a@test.com';
    userBId = 'user-b@test.com';
  });

  // ==========================================================================
  // TEST 1: Users cannot read leads from other tenants
  // ==========================================================================

  test('User A cannot read Tenant B leads', async () => {
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Authenticate as User A (Tenant A member)
    await supabase.auth.signInWithPassword({
      email: userAId,
      password: 'test-password',
    });

    // Attempt to read Tenant B leads
    const { data, error } = await supabase.from('leads').select('*').eq('tenant_id', tenantBId);

    // Should return empty array (RLS filters out)
    expect(data).toEqual([]);
    expect(error).toBeNull();
  });

  // ==========================================================================
  // TEST 2: Users cannot insert leads for other tenants
  // ==========================================================================

  test('User A cannot insert lead for Tenant B', async () => {
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    await supabase.auth.signInWithPassword({
      email: userAId,
      password: 'test-password',
    });

    // Attempt to insert lead for Tenant B
    const { data, error } = await supabase
      .from('leads')
      .insert({
        tenant_id: tenantBId,
        name: 'Malicious Lead',
        email: 'hack@example.com',
        source: 'contact-form',
      })
      .select();

    // Should fail (RLS blocks)
    expect(data).toBeNull();
    expect(error).not.toBeNull();
    expect(error!.code).toBe('42501'); // PostgreSQL: insufficient privilege
  });

  // ==========================================================================
  // TEST 3: Users cannot update leads for other tenants
  // ==========================================================================

  test('User A cannot update Tenant B leads', async () => {
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    await supabase.auth.signInWithPassword({
      email: userAId,
      password: 'test-password',
    });

    // First, get a Tenant B lead ID (using service role in real test)
    const tenantBLeadId = 'some-uuid-from-tenant-b';

    // Attempt to update Tenant B lead
    const { data, error } = await supabase
      .from('leads')
      .update({ status: 'converted' })
      .eq('id', tenantBLeadId)
      .select();

    // Should fail (RLS blocks)
    expect(data).toEqual([]);
    expect(error).toBeNull(); // No error, just no rows updated
  });

  // ==========================================================================
  // TEST 4: Users can read their own tenant's leads
  // ==========================================================================

  test('User A can read Tenant A leads', async () => {
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    await supabase.auth.signInWithPassword({
      email: userAId,
      password: 'test-password',
    });

    // Read Tenant A leads
    const { data, error } = await supabase.from('leads').select('*').eq('tenant_id', tenantAId);

    // Should succeed
    expect(error).toBeNull();
    expect(Array.isArray(data)).toBe(true);

    // All returned leads should belong to Tenant A
    data!.forEach((lead) => {
      expect(lead.tenant_id).toBe(tenantAId);
    });
  });

  // ==========================================================================
  // TEST 5: Service role can bypass RLS (admin operations)
  // ==========================================================================

  test('Service role can read all tenants', async () => {
    const supabaseAdmin = createClient(SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY!);

    // Read all leads (no tenant filter)
    const { data, error } = await supabaseAdmin.from('leads').select('*').limit(100);

    // Should succeed and return leads from multiple tenants
    expect(error).toBeNull();
    expect(Array.isArray(data)).toBe(true);

    // Should have leads from both tenants (if seed data exists)
    const tenantIds = new Set(data!.map((lead) => lead.tenant_id));
    expect(tenantIds.size).toBeGreaterThan(0);
  });
});
```

**CI Integration:**

**File:** `.github/workflows/ci.yml` (excerpt)

```yaml
jobs:
  test-rls:
    name: RLS Isolation Tests
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - run: pnpm install --frozen-lockfile

      - name: Run RLS tests
        run: pnpm --filter=e2e run test:rls
```

**When to Build:** P0.5 (After database and RLS policies are in place)
