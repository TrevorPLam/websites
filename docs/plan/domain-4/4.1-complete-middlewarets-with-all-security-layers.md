### 4.1 Complete Middleware.ts with All Security Layers

**File:** `apps/web/app/middleware.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { Ratelimit } from '@upstash/ratelimit';
import { Redis } from '@upstash/redis';
import { createClient } from '@/lib/supabase/middleware';

// ============================================================================
// UPSTASH RATE LIMITING
// ============================================================================

const redis = Redis.fromEnv();

const rateLimit = new Ratelimit({
  redis,
  limiter: Ratelimit.slidingWindow(100, '10 s'), // Default: 100 req/10s
  analytics: true,
  prefix: '@tenant-ratelimit',
});

// ============================================================================
// TENANT RESOLUTION
// ============================================================================

function resolveTenant(request: NextRequest): {
  tenantSlug: string | null;
  strategy: 'subdomain' | 'path' | 'custom-domain' | null;
} {
  const hostname = request.headers.get('host') || '';
  const pathname = request.nextUrl.pathname;

  // Strategy 1: Custom Domain
  // Example: clientdomain.com → tenantSlug from database lookup
  if (!hostname.includes('platform.com')) {
    return {
      tenantSlug: null, // Must lookup in database
      strategy: 'custom-domain',
    };
  }

  // Strategy 2: Subdomain
  // Example: tenant-slug.platform.com → tenant-slug
  const subdomainMatch = hostname.match(/^([a-z0-9-]+)\.platform\.com$/);
  if (subdomainMatch) {
    return {
      tenantSlug: subdomainMatch[1],
      strategy: 'subdomain',
    };
  }

  // Strategy 3: Path-based (not recommended for marketing)
  // Example: platform.com/tenant-slug → tenant-slug
  const pathMatch = pathname.match(/^\/([a-z0-9-]+)/);
  if (pathMatch && !['api', '_next', 'admin', 'portal'].includes(pathMatch[1])) {
    return {
      tenantSlug: pathMatch[1],
      strategy: 'path',
    };
  }

  return { tenantSlug: null, strategy: null };
}

// ============================================================================
// CSP NONCE GENERATION
// ============================================================================

function generateNonce(): string {
  const array = new Uint8Array(16);
  crypto.getRandomValues(array);
  return Array.from(array, (byte) => byte.toString(16).padStart(2, '0')).join('');
}

// ============================================================================
// SECURITY HEADERS
// ============================================================================

function applySecurityHeaders(response: NextResponse, nonce: string): NextResponse {
  const cspDirectives = [
    "default-src 'self'",
    `script-src 'self' 'nonce-${nonce}' 'strict-dynamic' https://www.googletagmanager.com https://www.google-analytics.com`,
    "style-src 'self' 'unsafe-inline'", // Tailwind requires unsafe-inline
    "img-src 'self'  https: blob:",
    "font-src 'self' ",
    "connect-src 'self' https://*.supabase.co https://*.vercel-insights.com",
    "frame-ancestors 'none'",
    "base-uri 'self'",
    "form-action 'self'",
  ];

  response.headers.set('Content-Security-Policy', cspDirectives.join('; '));
  response.headers.set('X-Content-Type-Options', 'nosniff');
  response.headers.set('X-Frame-Options', 'DENY');
  response.headers.set('X-XSS-Protection', '0'); // Modern browsers ignore this
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');
  response.headers.set('Permissions-Policy', 'camera=(), microphone=(), geolocation=()');

  // HSTS (1 year, includeSubDomains)
  if (process.env.NODE_ENV === 'production') {
    response.headers.set('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');
  }

  return response;
}

// ============================================================================
// BILLING SUSPENSION CHECK
// ============================================================================

async function checkBillingSuspension(tenantSlug: string): Promise<boolean> {
  const supabase = createClient();

  const { tenant, error } = await supabase
    .from('tenants')
    .select('billing_status')
    .eq('tenant_slug', tenantSlug)
    .single();

  if (error || !tenant) {
    return false; // Fail open (don't block on database errors)
  }

  return tenant.billing_status === 'suspended';
}

// ============================================================================
// MAIN MIDDLEWARE
// ============================================================================

export async function middleware(request: NextRequest) {
  const nonce = generateNonce();

  // Step 1: Tenant Resolution
  const { tenantSlug, strategy } = resolveTenant(request);

  if (!tenantSlug) {
    // No tenant found → 404 or redirect to marketing homepage
    return NextResponse.rewrite(new URL('/404', request.url));
  }

  // Step 2: Custom Domain → Database Lookup
  if (strategy === 'custom-domain') {
    const supabase = createClient();
    const { tenant } = await supabase
      .from('tenants')
      .select('tenant_slug')
      .eq('custom_domain', request.headers.get('host'))
      .single();

    if (!tenant) {
      return NextResponse.rewrite(new URL('/404', request.url));
    }

    // Store resolved tenantSlug in header for app consumption
    request.headers.set('x-tenant-slug', tenant.tenant_slug);
  } else {
    request.headers.set('x-tenant-slug', tenantSlug);
  }

  // Step 3: Billing Suspension Check
  const isSuspended = await checkBillingSuspension(tenantSlug);
  if (isSuspended) {
    return NextResponse.rewrite(new URL('/suspended', request.url));
  }

  // Step 4: Rate Limiting (Per-Tenant)
  const identifier = `tenant:${tenantSlug}`;
  const { success, limit, remaining, reset } = await rateLimit.limit(identifier);

  if (!success) {
    return NextResponse.json(
      { error: 'Rate limit exceeded' },
      {
        status: 429,
        headers: {
          'X-RateLimit-Limit': limit.toString(),
          'X-RateLimit-Remaining': remaining.toString(),
          'X-RateLimit-Reset': reset.toString(),
        },
      }
    );
  }

  // Step 5: Create Response
  const response = NextResponse.next();

  // Step 6: Apply Security Headers
  applySecurityHeaders(response, nonce);

  // Step 7: Inject Nonce for Client
  response.headers.set('x-nonce', nonce);

  // Step 8: Rate Limit Headers
  response.headers.set('X-RateLimit-Limit', limit.toString());
  response.headers.set('X-RateLimit-Remaining', remaining.toString());
  response.headers.set('X-RateLimit-Reset', reset.toString());

  return response;
}

// ============================================================================
// MIDDLEWARE CONFIG
// ============================================================================

export const config = {
  matcher: [
    /*
     * Match all request paths except:
     * - _next/static (static files)
     * - _next/image (image optimization)
     * - favicon.ico (favicon file)
     * - public folder files
     */
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
};
```

**Why This Middleware:**

- Tenant resolution: Supports subdomain, path, and custom domain strategies
- Rate limiting: Per-tenant (prevents noisy neighbor attacks)
- CSP nonce: Enables strict CSP without blocking inline scripts
- Security headers: HSTS, X-Frame-Options, Referrer-Policy, etc.
- Billing suspension: Gracefully handles suspended accounts
- CVE-2025-29927 mitigation: Doesn't rely on `x-middleware-subrequest` (Next.js fixed in 15.2.3+, but defense in depth)

**When to Build:** P0 (Security foundation)
