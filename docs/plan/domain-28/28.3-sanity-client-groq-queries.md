### 28.3 Sanity Client + GROQ Queries

**File:** `packages/content/src/sanity-client.ts`

```typescript
import { createClient } from 'next-sanity';
import imageUrlBuilder from '@sanity/image-url';
import type { SanityImageSource } from '@sanity/image-url/lib/types/types';

export const sanityClient = createClient({
  projectId: process.env.NEXT_PUBLIC_SANITY_PROJECT_ID!,
  dataset: process.env.NEXT_PUBLIC_SANITY_DATASET ?? 'production',
  apiVersion: '2025-01-01',
  useCdn: true, // CDN for public reads; disabled for preview mode
  // Stega encoding disabled in production (for Visual Editing in Studio only)
  stega: {
    enabled: process.env.NEXT_PUBLIC_SANITY_STEGA === 'true',
    studioUrl: process.env.NEXT_PUBLIC_SANITY_STUDIO_URL,
  },
});

// Stega-disabled client for non-preview reads (faster)
export const sanityClientPublic = sanityClient.withConfig({ stega: false });

// Image URL builder
const builder = imageUrlBuilder(sanityClient);
export function urlFor(source: SanityImageSource) {
  return builder.image(source);
}

// ============================================================================
// GROQ QUERIES
// All queries include tenantId filter â€” non-negotiable for multi-tenant
// ============================================================================

// Projection shared across list and detail views
const POST_CARD_PROJECTION = `{
  _id,
  title,
  "slug": slug.current,
  publishedAt,
  excerpt,
  estimatedReadingTime,
  categories,
  mainImage { asset->, alt },
  author { name, role, "avatarUrl": avatar.asset->url }
}`;

export const POSTS_LIST_QUERY = `
  *[_type == "post" && tenantId == $tenantId && !(_id in path("drafts.**")) && !coalesce(seo.noIndex, false)]
  | order(publishedAt desc)
  [$from...$to]
  ${POST_CARD_PROJECTION}
`;

export const POSTS_COUNT_QUERY = `
  count(*[_type == "post" && tenantId == $tenantId && !(_id in path("drafts.**"))])
`;

export const POST_BY_SLUG_QUERY = `
  *[_type == "post" && tenantId == $tenantId && slug.current == $slug && !(_id in path("drafts.**"))][0] {
    _id,
    title,
    "slug": slug.current,
    publishedAt,
    excerpt,
    estimatedReadingTime,
    categories,
    mainImage { asset->, alt, caption },
    author { name, role, "avatarUrl": avatar.asset->url },
    body[] {
      ...,
      _type == "image" => {
        asset->,
        alt,
        caption
      }
    },
    seo
  }
`;

export const RELATED_POSTS_QUERY = `
  *[
    _type == "post"
    && tenantId == $tenantId
    && slug.current != $currentSlug
    && !(_id in path("drafts.**"))
    && count(categories[@ in $categories]) > 0
  ]
  | order(publishedAt desc)
  [0...3]
  ${POST_CARD_PROJECTION}
`;

export const ALL_POST_SLUGS_QUERY = `
  *[_type == "post" && tenantId == $tenantId && !(_id in path("drafts.**"))] {
    "slug": slug.current
  }
`;
```

---
