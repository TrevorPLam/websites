### 28.4 Blog Post Page (ISR + On-Demand Revalidation)

**File:** `apps/*/src/app/blog/[slug]/page.tsx`

```typescript
import type { Metadata } from 'next';
import { notFound } from 'next/navigation';
import { headers } from 'next/headers';
import { cacheLife, cacheTag } from 'next/cache';
import { PortableText } from '@portabletext/react';
import { resolveTenant } from '@repo/multi-tenant/resolve-tenant';
import { db } from '@repo/db';
import {
  sanityClientPublic,
  POST_BY_SLUG_QUERY,
  RELATED_POSTS_QUERY,
  ALL_POST_SLUGS_QUERY,
  urlFor,
} from '@repo/content/sanity-client';
import { buildMetadata } from '@repo/seo/metadata-factory';
import { buildBreadcrumbSchema, JsonLd } from '@repo/seo/structured-data';
import Image from 'next/image';

export const dynamicParams = true;

// Seed existing post slugs at build time
export async function generateStaticParams() {
  // Minimal: generate for the first 50 posts across all active tenants
  // Long-tail posts use on-demand ISR
  const allTenants = await db
    .from('tenants')
    .select('id')
    .eq('status', 'active')
    .limit(100);

  const params: { slug: string }[] = [];

  for (const tenant of allTenants.data ?? []) {
    const slugs = await sanityClientPublic.fetch<{ slug: string }[]>(
      ALL_POST_SLUGS_QUERY,
      { tenantId: tenant.id }
    );
    slugs.slice(0, 10).forEach((s) => params.push({ slug: s.slug }));
  }

  return params;
}

export async function generateMetadata({
  params,
}: {
  params: Promise<{ slug: string }>;
}): Promise<Metadata> {
  const { slug } = await params;
  const headersList = await headers();
  const tenantContext = await resolveTenant({ headers: headersList } as any);
  if (!tenantContext) return {};

  const { data: tenant } = await db
    .from('tenants')
    .select('config')
    .eq('id', tenantContext.tenantId)
    .single();

  const config = tenant?.config as any;
  if (!config) return {};

  const post = await sanityClientPublic.fetch(
    POST_BY_SLUG_QUERY,
    { tenantId: tenantContext.tenantId, slug }
  );

  if (!post) return {};

  const ogImage = post.mainImage?.asset?.url
    ? urlFor(post.mainImage).width(1200).height(630).fit('crop').url()
    : undefined;

  return buildMetadata({
    config,
    path: `/blog/${slug}`,
    pageTitle: post.seo?.title ?? post.title,
    pageDescription: post.seo?.description ?? post.excerpt,
    ogImage,
    noIndex: post.seo?.noIndex ?? false,
  });
}

export default async function BlogPostPage({
  params,
}: {
  params: Promise<{ slug: string }>;
}) {
  'use cache';

  const { slug } = await params;
  const headersList = await headers();

  const tenantContext = await resolveTenant({ headers: headersList } as any);
  if (!tenantContext) return notFound();

  const { tenantId } = tenantContext;

  cacheTag(`tenant:${tenantId}:blog:${slug}`);
  cacheLife({ revalidate: 3600 }); // 1h fallback; on-demand webhook busts earlier

  const { data: tenant } = await db
    .from('tenants')
    .select('config, custom_domain, subdomain')
    .eq('id', tenantId)
    .single();

  const config = tenant?.config as any;
  const domain = tenant?.custom_domain ?? `${tenant?.subdomain}.${process.env.NEXT_PUBLIC_ROOT_DOMAIN}`;
  const siteUrl = `https://${domain}`;

  const [post, relatedPosts] = await Promise.all([
    sanityClientPublic.fetch(POST_BY_SLUG_QUERY, { tenantId, slug }),
    sanityClientPublic.fetch(RELATED_POSTS_QUERY, {
      tenantId,
      currentSlug: slug,
      categories: [],
    }),
  ]);

  if (!post) return notFound();

  const articleSchema = {
    '@context': 'https://schema.org',
    '@type': 'BlogPosting',
    headline: post.title,
    description: post.excerpt,
    datePublished: post.publishedAt,
    dateModified: post.publishedAt,
    author: {
      '@type': 'Person',
      name: post.author?.name ?? config?.identity?.siteName,
    },
    publisher: {
      '@type': 'Organization',
      name: config?.identity?.siteName,
      logo: {
        '@type': 'ImageObject',
        url: config?.assets?.logo,
      },
    },
    image: post.mainImage?.asset?.url,
    url: `${siteUrl}/blog/${slug}`,
    mainEntityOfPage: { '@type': 'WebPage', '@id': `${siteUrl}/blog/${slug}` },
    ...(post.estimatedReadingTime ? {
      timeRequired: `PT${post.estimatedReadingTime}M`,
    } : {}),
  };

  const breadcrumbSchema = buildBreadcrumbSchema(
    siteUrl,
    config?.identity?.siteName ?? '',
    [
      { name: 'Blog', url: `${siteUrl}/blog` },
      { name: post.title, url: `${siteUrl}/blog/${slug}` },
    ]
  );

  return (
    <>
      <JsonLd schema={articleSchema} />
      <JsonLd schema={breadcrumbSchema} />

      <main id="main-content" className="py-12 px-6">
        <article className="max-w-3xl mx-auto" aria-label={post.title}>
          {/* Breadcrumb */}
          <nav aria-label="Breadcrumb" className="text-sm text-gray-500 mb-8 flex items-center gap-2">
            <a href={siteUrl} className="hover:text-primary">Home</a>
            <span aria-hidden="true">›</span>
            <a href={`${siteUrl}/blog`} className="hover:text-primary">Blog</a>
            <span aria-hidden="true">›</span>
            <span className="text-gray-900 truncate">{post.title}</span>
          </nav>

          {/* Categories */}
          {post.categories?.length > 0 && (
            <div className="flex gap-2 flex-wrap mb-4">
              {post.categories.map((cat: string) => (
                <span
                  key={cat}
                  className="bg-primary/10 text-primary text-xs font-semibold px-3 py-1 rounded-full capitalize"
                >
                  {cat.replace(/-/g, ' ')}
                </span>
              ))}
            </div>
          )}

          {/* Title */}
          <h1 className="text-4xl font-extrabold text-gray-900 leading-tight mb-4">
            {post.title}
          </h1>

          {/* Meta row */}
          <div className="flex items-center gap-4 text-sm text-gray-500 mb-8">
            {post.author?.name && (
              <div className="flex items-center gap-2">
                {post.author.avatarUrl && (
                  <Image
                    src={post.author.avatarUrl}
                    alt={post.author.name}
                    width={28}
                    height={28}
                    className="rounded-full"
                  />
                )}
                <span>{post.author.name}</span>
              </div>
            )}
            {post.publishedAt && (
              <time dateTime={post.publishedAt}>
                {new Date(post.publishedAt).toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                })}
              </time>
            )}
            {post.estimatedReadingTime && (
              <span>{post.estimatedReadingTime} min read</span>
            )}
          </div>

          {/* Hero image */}
          {post.mainImage?.asset && (
            <div className="relative aspect-video mb-10 rounded-2xl overflow-hidden">
              <Image
                src={urlFor(post.mainImage).width(1200).height(630).url()}
                alt={post.mainImage.alt ?? post.title}
                fill
                className="object-cover"
                priority
                sizes="(max-width: 768px) 100vw, 768px"
              />
              {post.mainImage.caption && (
                <p className="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs px-4 py-2">
                  {post.mainImage.caption}
                </p>
              )}
            </div>
          )}

          {/* Portable Text body */}
          <div className="prose prose-lg prose-gray max-w-none prose-headings:font-extrabold prose-a:text-primary">
            <PortableText
              value={post.body}
              components={portableTextComponents}
            />
          </div>
        </article>

        {/* Related posts */}
        {relatedPosts?.length > 0 && (
          <aside className="max-w-3xl mx-auto mt-16 pt-12 border-t border-gray-200" aria-label="Related posts">
            <h2 className="text-2xl font-bold text-gray-900 mb-6">Related Articles</h2>
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-6">
              {relatedPosts.map((rp: any) => (
                <a key={rp._id} href={`${siteUrl}/blog/${rp.slug}`} className="group block">
                  <p className="font-semibold text-gray-900 group-hover:text-primary transition-colors line-clamp-2">
                    {rp.title}
                  </p>
                  <p className="text-sm text-gray-500 mt-1">
                    {new Date(rp.publishedAt).toLocaleDateString()}
                  </p>
                </a>
              ))}
            </div>
          </aside>
        )}
      </main>
    </>
  );
}

// ── Portable Text custom components ──────────────────────────────────────────

const portableTextComponents = {
  types: {
    image: ({ value }: any) => (
      <figure className="my-8">
        <div className="relative rounded-xl overflow-hidden">
          <Image
            src={urlFor(value).width(800).url()}
            alt={value.alt ?? ''}
            width={800}
            height={450}
            className="w-full h-auto"
          />
        </div>
        {value.caption && (
          <figcaption className="text-sm text-gray-500 text-center mt-2">
            {value.caption}
          </figcaption>
        )}
      </figure>
    ),
    cta: ({ value }: any) => (
      <div className="my-8 flex justify-center">
        <a
          href={value.href}
          className="inline-flex items-center gap-2 px-6 py-3 bg-primary text-white rounded-xl font-semibold hover:opacity-90 transition-opacity"
        >
          {value.text}
        </a>
      </div>
    ),
  },
  marks: {
    link: ({ children, value }: any) => (
      <a
        href={value.href}
        target={value.href?.startsWith('http') ? '_blank' : undefined}
        rel={value.href?.startsWith('http') ? 'noopener noreferrer' : undefined}
      >
        {children}
      </a>
    ),
  },
};
```

---
