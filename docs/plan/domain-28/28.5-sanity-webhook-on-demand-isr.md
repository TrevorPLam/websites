### 28.5 Sanity Webhook â†’ On-Demand ISR

**File:** `apps/*/src/app/api/webhooks/sanity/route.ts`

```typescript
import { type NextRequest, NextResponse } from 'next/server';
import { parseBody } from 'next-sanity/webhook';
import { revalidateTag, revalidatePath } from 'next/cache';

// ============================================================================
// SANITY WEBHOOK HANDLER
// Triggered by GROQ-powered webhook in Sanity project settings.
// Webhook filter: _type == "post"
// Payload: { _type, slug: { current }, tenantId }
// Reference: https://www.sanity.io/learn/course/controlling-cached-content-in-next-js/tag-based-revalidation
// ============================================================================

export const dynamic = 'force-dynamic';

export async function POST(req: NextRequest) {
  try {
    const { body, isValidSignature } = await parseBody<SanityWebhookBody>(
      req,
      process.env.SANITY_REVALIDATE_SECRET!
    );

    if (!isValidSignature) {
      return NextResponse.json({ message: 'Invalid signature' }, { status: 401 });
    }

    if (!body?._type) {
      return NextResponse.json({ message: 'Invalid body' }, { status: 400 });
    }

    const { _type, slug, tenantId } = body;

    switch (_type) {
      case 'post': {
        const slugCurrent = slug?.current;
        if (slugCurrent && tenantId) {
          // Bust the specific post
          revalidateTag(`tenant:${tenantId}:blog:${slugCurrent}`);
        }
        // Bust the blog index (post list order/count changed)
        if (tenantId) {
          revalidateTag(`tenant:${tenantId}:blog`);
          // Also bust sitemap (new/removed post affects sitemap.xml)
          revalidateTag(`tenant:${tenantId}:sitemap`);
        }
        break;
      }
      default:
        console.log(`[Sanity Webhook] Unhandled type: ${_type}`);
    }

    return NextResponse.json({
      revalidated: true,
      now: Date.now(),
      type: _type,
    });
  } catch (err: any) {
    console.error('[Sanity Webhook] Error:', err.message);
    return NextResponse.json({ message: err.message }, { status: 500 });
  }
}

interface SanityWebhookBody {
  _type: string;
  slug?: { current: string };
  tenantId?: string;
}
```

---
