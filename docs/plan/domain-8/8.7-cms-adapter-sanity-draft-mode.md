### 8.7 CMS Adapter â€” Sanity Draft Mode

**File:** `packages/cms-adapter/src/sanity/client.ts`

```typescript
import { createClient, type SanityClient } from '@sanity/client';
import { draftMode } from 'next/headers';

const SANITY_PROJECT_ID = process.env.SANITY_PROJECT_ID!;
const SANITY_DATASET = process.env.SANITY_DATASET ?? 'production';
const SANITY_API_VERSION = '2024-11-01';

// ============================================================================
// DUAL CLIENT: Draft Mode aware
// Published: uses public read token (safe to expose)
// Draft: uses editor token (server-side only, never to client)
// Reference: https://www.sanity.io/docs/visual-editing/visual-editing-with-next-js-app-router
// ============================================================================

export function getSanityClient(): SanityClient {
  // Preview token â€” only used server-side when draft mode is active
  const token = process.env.SANITY_API_READ_TOKEN;

  return createClient({
    projectId: SANITY_PROJECT_ID,
    dataset: SANITY_DATASET,
    apiVersion: SANITY_API_VERSION,
    useCdn: false, // Always fresh in server context
    stega: {
      enabled: false, // Only enable in visual editor context
    },
    ...(token ? { token } : {}),
  });
}

// Server Component usage (auto-detects draft mode)
export async function getSanityClientForRequest(): Promise<{
  client: SanityClient;
  isDraft: boolean;
}> {
  const { isEnabled: isDraft } = await draftMode();

  const client = createClient({
    projectId: SANITY_PROJECT_ID,
    dataset: SANITY_DATASET,
    apiVersion: SANITY_API_VERSION,
    useCdn: !isDraft, // CDN for published, direct for drafts
    perspective: isDraft ? 'previewDrafts' : 'published', // Draft mode toggle [web:238]
    token: isDraft ? process.env.SANITY_API_READ_TOKEN : undefined,
    stega: {
      // Enable Sanity Visual Editing overlays only in draft mode
      enabled: isDraft,
      studioUrl: process.env.SANITY_STUDIO_URL ?? 'http://localhost:3333',
    },
  });

  return { client, isDraft };
}
```

**Draft Mode enable/disable API routes:** [nextjs](https://nextjs.org/docs/app/guides/draft-mode)

```typescript
// sites/*/src/app/api/draft-mode/enable/route.ts
import { draftMode } from 'next/headers';
import { NextRequest, NextResponse } from 'next/server';
import { validatePreviewUrl } from '@sanity/preview-url-secret';
import { getSanityClient } from '@repo/cms-adapter/sanity';

export async function GET(req: NextRequest) {
  // Validate the secret token from Sanity Studio
  const { isValid, redirectTo = '/' } = await validatePreviewUrl(getSanityClient(), req.url);

  if (!isValid) {
    return new NextResponse('Invalid secret', { status: 401 });
  }

  // Enable draft mode (sets __prerender_bypass cookie)
  (await draftMode()).enable();

  // Redirect to the page being previewed
  return NextResponse.redirect(new URL(redirectTo, req.url));
}

// sites/*/src/app/api/draft-mode/disable/route.ts
export async function GET() {
  (await draftMode()).disable();
  return NextResponse.redirect(new URL('/', process.env.NEXT_PUBLIC_SITE_URL!));
}
```

**Draft Mode toolbar (shown to Sanity editors only):** [storyblok](https://www.storyblok.com/tp/nextjs-draft-mode-visual-editor)

```typescript
// packages/ui/src/shared/DraftModeBanner.tsx
import { draftMode } from 'next/headers';

export async function DraftModeBanner() {
  const { isEnabled } = await draftMode();

  if (!isEnabled) return null;

  return (
    <div
      role="alert"
      className="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 flex items-center gap-4 bg-amber-500 text-black px-6 py-3 rounded-full shadow-xl font-semibold"
    >
      <span>ðŸ”¶ Draft Mode Active</span>
      <a
        href="/api/draft-mode/disable"
        className="underline text-sm hover:text-amber-900 focus-visible:ring-2 focus-visible:ring-black rounded"
      >
        Exit Preview
      </a>
    </div>
  );
}
```

**CMS content fetch with automatic draft/publish switching:**

```typescript
// packages/cms-adapter/src/sanity/queries.ts
import { getSanityClientForRequest } from './client';
import { groq } from 'next-sanity';

export async function getHomePageContent(tenantId: string) {
  const { client, isDraft } = await getSanityClientForRequest();

  // In draft mode: fetches unpublished changes
  // In published mode: fetches only live content
  const query = groq`
    *[_type == "homePage" && tenant._ref == $tenantId][0] {
      headline,
      subheadline,
      ctaText,
      ctaUrl,
      "backgroundImage": backgroundImage.asset->url,
      "services": services[] {
        name,
        description,
        "icon": icon.asset->url,
        slug
      },
      faqs[] {
        question,
        answer
      }
    }
  `;

  return client.fetch(
    query,
    { tenantId },
    {
      // Cache bust in draft mode; cache in production
      cache: isDraft ? 'no-store' : 'force-cache',
      next: isDraft ? undefined : { revalidate: 3600, tags: [`tenant:${tenantId}:content`] },
    }
  );
}
```

---
