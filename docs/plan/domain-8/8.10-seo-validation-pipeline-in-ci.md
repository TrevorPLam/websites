### 8.10 SEO Validation Pipeline in CI

**File:** `packages/seo/src/__tests__/structured-data.test.ts`

```typescript
import { buildLocalBusinessSchema, buildFAQSchema } from '../structured-data';
import { SITE_CONFIGS } from '@repo/test-fixtures';

describe('Structured Data Validity', () => {
  describe('LocalBusiness schema', () => {
    it('produces valid @context and @type for law industry', () => {
      const schema = buildLocalBusinessSchema(SITE_CONFIGS.sterlingLaw);
      expect(schema['@context']).toBe('https://schema.org');
      expect(schema['@type']).toBe('LegalService');
      expect(schema.name).toBeTruthy();
      expect(schema.address?.['@type']).toBe('PostalAddress');
      expect(schema.address?.addressLocality).toBeTruthy();
    });

    it('includes aggregateRating only when review count > 0', () => {
      const configWithReviews = {
        ...SITE_CONFIGS.sterlingLaw,
        identity: {
          ...SITE_CONFIGS.sterlingLaw.identity,
          reviewSummary: { average: 4.8, count: 127 },
        },
      };
      const schema = buildLocalBusinessSchema(configWithReviews);
      expect(schema.aggregateRating).toBeDefined();
      expect(Number(schema.aggregateRating?.ratingValue)).toBeGreaterThan(0);
    });

    it('excludes aggregateRating when no reviews', () => {
      const configNoReviews = {
        ...SITE_CONFIGS.sterlingLaw,
        identity: { ...SITE_CONFIGS.sterlingLaw.identity, reviewSummary: undefined },
      };
      const schema = buildLocalBusinessSchema(configNoReviews);
      expect(schema.aggregateRating).toBeUndefined();
    });
  });

  describe('FAQ schema', () => {
    const faqs = [
      { question: 'Do you offer free consultations?', answer: 'Yes, call us.' },
      { question: 'What areas do you serve?', answer: 'DFW metroplex.' },
    ];

    it('produces valid FAQPage schema', () => {
      const schema = buildFAQSchema(faqs);
      expect(schema['@type']).toBe('FAQPage');
      expect(schema.mainEntity).toHaveLength(2);
      expect(schema.mainEntity[0]['@type']).toBe('Question');
      expect(schema.mainEntity[0].acceptedAnswer['@type']).toBe('Answer');
    });

    it('never nests HTML in answer text', () => {
      const schemaWithHtml = buildFAQSchema([
        { question: 'Test?', answer: '<p>Answer with <b>HTML</b></p>' },
      ]);
      // Google strips HTML â€” return plain text
      expect(schemaWithHtml.mainEntity[0].acceptedAnswer.text).not.toContain('<');
    });
  });

  describe('Sitemap', () => {
    it('every URL is absolute and starts with https', async () => {
      const { default: sitemap } = await import('../../../sites/sterling-law/src/app/sitemap');
      const entries = await sitemap();
      for (const entry of entries) {
        expect(entry.url).toMatch(/^https:\/\//);
      }
    });

    it('no duplicate URLs', async () => {
      const { default: sitemap } = await import('../../../sites/sterling-law/src/app/sitemap');
      const entries = await sitemap();
      const urls = entries.map((e: { url: string }) => e.url);
      expect(new Set(urls).size).toBe(urls.length);
    });
  });
});
```

---
