### 8.9 Edge A/B Testing (Zero-CLS)

**What it is:** A/B tests run entirely in Next.js middleware, assigning variants via cookies and rewriting at the edge before HTML is generated. No layout shift because the variant is determined before any rendering. [vercel](https://vercel.com/blog/zero-cls-experiments-nextjs-edge-config)

**File:** `packages/analytics/src/ab-testing.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { Redis } from '@upstash/redis';

const redis = Redis.fromEnv();

// ============================================================================
// EXPERIMENT DEFINITION
// All experiments defined here — one source of truth
// ============================================================================

export type Experiment = {
  id: string;
  name: string;
  variants: Array<{ id: string; weight: number; path?: string }>;
  trafficAllocation: number; // 0–1 (1 = 100% of traffic)
  enabled: boolean;
  tenantIds?: string[]; // null = all tenants; array = specific tenants only
};

export const EXPERIMENTS: Experiment[] = [
  {
    id: 'homepage-cta-text',
    name: 'Homepage CTA Button Text',
    variants: [
      { id: 'control', weight: 0.5 }, // "Schedule Service Today"
      { id: 'variant-a', weight: 0.5 }, // "Get Your Free Estimate Now"
    ],
    trafficAllocation: 1.0, // 100% of traffic
    enabled: true,
  },
  {
    id: 'contact-form-layout',
    name: 'Contact Form: Vertical vs Horizontal',
    variants: [
      { id: 'vertical', weight: 0.5, path: '/contact' },
      { id: 'horizontal', weight: 0.5, path: '/contact-v2' },
    ],
    trafficAllocation: 0.5, // 50% of traffic
    enabled: true,
  },
];

// ============================================================================
// ASSIGN VARIANT
// Uses cookie for persistence; assigns randomly on first visit
// ============================================================================

function pickVariant(experiment: Experiment): string {
  if (!experiment.enabled) return experiment.variants[0].id;

  // Traffic allocation gate (only enroll % of visitors)
  if (Math.random() > experiment.trafficAllocation) {
    return experiment.variants[0].id; // Control for non-enrolled
  }

  // Weighted random assignment
  const rand = Math.random();
  let cumulative = 0;
  for (const variant of experiment.variants) {
    cumulative += variant.weight;
    if (rand < cumulative) return variant.id;
  }
  return experiment.variants[0].id;
}

const COOKIE_PREFIX = 'ab_';
const COOKIE_MAX_AGE = 60 * 60 * 24 * 90; // 90-day assignment persistence

// ============================================================================
// MIDDLEWARE INTEGRATION
// Called inside middleware.ts before returning the response
// ============================================================================

export async function applyABTests(
  request: NextRequest,
  response: NextResponse,
  tenantId: string
): Promise<NextResponse> {
  let modifiedResponse = response;

  for (const experiment of EXPERIMENTS) {
    // Skip experiments not targeting this tenant
    if (experiment.tenantIds && !experiment.tenantIds.includes(tenantId)) {
      continue;
    }

    if (!experiment.enabled) continue;

    const cookieName = `${COOKIE_PREFIX}${experiment.id}`;
    const existingVariant = request.cookies.get(cookieName)?.value;

    // Already assigned — use existing assignment
    const assignedVariant = existingVariant ?? pickVariant(experiment);

    // Set cookie for persistence (edge-set cookies are instant — no FOUC)
    modifiedResponse.cookies.set(cookieName, assignedVariant, {
      maxAge: COOKIE_MAX_AGE,
      httpOnly: false, // Client-readable (for analytics attribution)
      sameSite: 'lax',
      path: '/',
    });

    // Path rewrite for layout variants (zero-CLS — happens before rendering)
    const variant = experiment.variants.find((v) => v.id === assignedVariant);
    if (variant?.path && !existingVariant) {
      const url = request.nextUrl.clone();
      const currentVariantPath = experiment.variants.find(
        (v) => request.nextUrl.pathname === v.path
      );

      // Only rewrite if on the default/control path
      if (!currentVariantPath || currentVariantPath.id === 'control') {
        url.pathname = variant.path;
        modifiedResponse = NextResponse.rewrite(url);
      }
    }

    // Track assignment event to Tinybird (fire-and-forget)
    if (!existingVariant) {
      // Only track on first assignment, not repeat visits
      trackExperimentAssignment({
        tenantId,
        experimentId: experiment.id,
        variantId: assignedVariant,
        sessionId: request.cookies.get('session_id')?.value ?? 'unknown',
      }).catch(() => {
        // Non-blocking — never let analytics fail the request
      });
    }
  }

  return modifiedResponse;
}

// ============================================================================
// ANALYTICS: Track assignment to Tinybird
// ============================================================================

async function trackExperimentAssignment(event: {
  tenantId: string;
  experimentId: string;
  variantId: string;
  sessionId: string;
}): Promise<void> {
  const TINYBIRD_TOKEN = process.env.TINYBIRD_TOKEN;
  if (!TINYBIRD_TOKEN) return;

  await fetch(`https://api.tinybird.co/v0/events?name=ab_assignments&token=${TINYBIRD_TOKEN}`, {
    method: 'POST',
    body: JSON.stringify({
      ...event,
      timestamp: new Date().toISOString(),
    }),
  });
}

// ============================================================================
// CLIENT HOOK: Read assigned variant in components
// ============================================================================

export function useVariant(experimentId: string): string {
  if (typeof document === 'undefined') return 'control';

  const cookieName = `${COOKIE_PREFIX}${experimentId}`;
  const cookies = document.cookie.split(';');

  for (const cookie of cookies) {
    const [name, value] = cookie.trim().split('=');
    if (name === cookieName) return decodeURIComponent(value);
  }

  return 'control';
}
```

**Client-side variant application (no layout shift):**

```typescript
// packages/ui/src/marketing/CTAButton.tsx
'use client';

import { useVariant } from '@repo/analytics/ab-testing';

const CTA_VARIANTS: Record<string, string> = {
  control: 'Schedule Service Today',
  'variant-a': 'Get Your Free Estimate Now',
};

export function CTAButton({ href, className }: { href: string; className?: string }) {
  const variant = useVariant('homepage-cta-text');
  const text = CTA_VARIANTS[variant] ?? CTA_VARIANTS.control;

  return (
    <a
      href={href}
      className={className}
      data-experiment="homepage-cta-text"
      data-variant={variant}
    >
      {text}
    </a>
  );
}
```

---
