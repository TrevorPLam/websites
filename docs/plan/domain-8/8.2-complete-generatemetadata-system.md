### 8.2 Complete `generateMetadata()` System

**File:** `packages/seo/src/generate-metadata.ts`

```typescript
import type { Metadata } from 'next';
import type { SiteConfig } from '@repo/config-schema';

// ============================================================================
// METADATA FACTORY
// Generates type-safe Next.js 16 Metadata for every page type.
// Usage: import { generateTenantMetadata } from '@repo/seo';
// ============================================================================

export type PageMetadataInput = {
  tenantConfig: SiteConfig;
  page: 'home' | 'about' | 'services' | 'contact' | 'blog' | 'blog-post' | 'service-detail';
  override?: Partial<{
    title: string;
    description: string;
    image: string;
    canonical: string;
    noIndex: boolean;
    publishedAt: string;
    updatedAt: string;
    author: string;
    keywords: string[];
  }>;
};

export function generateTenantMetadata(input: PageMetadataInput): Metadata {
  const { tenantConfig, page, override = {} } = input;

  const {
    identity: { siteName, tagline, contact, address },
    seo: seoConfig,
    assets: { favicon, ogImage },
  } = tenantConfig;

  const baseUrl = tenantConfig.deployment.canonicalUrl;

  // -------------------------------------------------------------------------
  // Page-level defaults
  // -------------------------------------------------------------------------
  const defaults: Record<typeof page, { title: string; description: string; path: string }> = {
    home: {
      title: `${siteName} — ${tagline}`,
      description:
        seoConfig?.metaDescription ??
        `${siteName}. ${tagline}. Serving ${address?.city}, ${address?.state}.`,
      path: '/',
    },
    about: {
      title: `About Us — ${siteName}`,
      description: `Learn about ${siteName}, our team, and our mission serving ${address?.city}.`,
      path: '/about',
    },
    services: {
      title: `Services — ${siteName}`,
      description: `Explore the full range of services offered by ${siteName} in ${address?.city}, ${address?.state}.`,
      path: '/services',
    },
    contact: {
      title: `Contact ${siteName} — ${address?.city}, ${address?.state}`,
      description: `Get in touch with ${siteName}. Call ${contact?.phone ?? ''} or fill out our contact form.`,
      path: '/contact',
    },
    blog: {
      title: `Blog & Resources — ${siteName}`,
      description: `Expert tips and insights from ${siteName} in ${address?.city}.`,
      path: '/blog',
    },
    'blog-post': {
      title: override.title ?? siteName,
      description: override.description ?? tagline,
      path: override.canonical ?? '/blog',
    },
    'service-detail': {
      title: override.title ?? `Services — ${siteName}`,
      description: override.description ?? `Professional services from ${siteName}.`,
      path: override.canonical ?? '/services',
    },
  };

  const pageDefaults = defaults[page];
  const title = override.title ?? pageDefaults.title;
  const description = override.description ?? pageDefaults.description;
  const canonicalUrl = override.canonical ?? `${baseUrl}${pageDefaults.path}`;
  const ogImageUrl =
    override.image ?? ogImage ?? `${baseUrl}/og?title=${encodeURIComponent(title)}`;

  return {
    // -------------------------------------------------------------------------
    // Core
    // -------------------------------------------------------------------------
    title,
    description,

    // Template: appended to all child pages automatically
    // Only set at root layout level; override.title replaces entirely on specific pages
    ...(page === 'home'
      ? {
          title: {
            default: title,
            template: `%s — ${siteName}`,
          },
        }
      : { title }),

    // -------------------------------------------------------------------------
    // Canonical URL (critical for multi-tenant: prevents duplicate content)
    // -------------------------------------------------------------------------
    alternates: {
      canonical: canonicalUrl,
    },

    // -------------------------------------------------------------------------
    // Open Graph
    // -------------------------------------------------------------------------
    openGraph: {
      type: page === 'blog-post' ? 'article' : 'website',
      title,
      description,
      url: canonicalUrl,
      siteName,
      images: [
        {
          url: ogImageUrl,
          width: 1200,
          height: 630,
          alt: `${title} — ${siteName}`,
        },
      ],
      locale: 'en_US',

      // Article-specific (blog posts)
      ...(page === 'blog-post' && override.publishedAt
        ? {
            publishedTime: override.publishedAt,
            modifiedTime: override.updatedAt ?? override.publishedAt,
            authors: override.author ? [override.author] : [siteName],
          }
        : {}),
    },

    // -------------------------------------------------------------------------
    // Twitter / X Card
    // -------------------------------------------------------------------------
    twitter: {
      card: 'summary_large_image',
      title,
      description,
      images: [ogImageUrl],
      creator: seoConfig?.twitterHandle ?? undefined,
      site: seoConfig?.twitterHandle ?? undefined,
    },

    // -------------------------------------------------------------------------
    // Robots directive
    // -------------------------------------------------------------------------
    robots: override.noIndex
      ? {
          index: false,
          follow: false,
          googleBot: { index: false, follow: false },
        }
      : {
          index: true,
          follow: true,
          googleBot: {
            index: true,
            follow: true,
            'max-video-preview': -1,
            'max-image-preview': 'large',
            'max-snippet': -1,
          },
        },

    // -------------------------------------------------------------------------
    // Favicons & Icons
    // -------------------------------------------------------------------------
    icons: {
      icon: favicon ?? '/favicon.ico',
      shortcut: favicon ?? '/favicon.ico',
      apple: tenantConfig.assets.appleTouchIcon ?? '/apple-touch-icon.png',
    },

    // -------------------------------------------------------------------------
    // Keywords (legacy but still used by Bing)
    // -------------------------------------------------------------------------
    keywords: override.keywords ?? seoConfig?.keywords ?? [],

    // -------------------------------------------------------------------------
    // Verification tokens (per-tenant — stored in site.config.ts)
    // -------------------------------------------------------------------------
    verification: {
      google: seoConfig?.googleVerification ?? undefined,
      other: seoConfig?.bingVerification
        ? { 'msvalidate.01': seoConfig.bingVerification }
        : undefined,
    },

    // -------------------------------------------------------------------------
    // Category (helps AI categorize the page)
    // -------------------------------------------------------------------------
    category: tenantConfig.identity.industry ?? 'business',
  };
}
```

**Usage in a page:**

```typescript
// sites/sterling-law/src/app/page.tsx
import { generateTenantMetadata } from '@repo/seo';
import config from '../../../../../site.config';

export async function generateMetadata() {
  return generateTenantMetadata({
    tenantConfig: config,
    page: 'home',
  });
}

export default function HomePage() {
  return <main>...</main>;
}
```

**Usage for a dynamic blog post:**

```typescript
// sites/*/src/app/blog/[slug]/page.tsx
import type { Metadata } from 'next';
import { generateTenantMetadata } from '@repo/seo';
import { getBlogPost } from '@/shared/api/content';
import config from '../../../../../../site.config';

export async function generateMetadata({
  params,
}: {
  params: Promise<{ slug: string }>;
}): Promise<Metadata> {
  const { slug } = await params;
  const post = await getBlogPost(config.identity.tenantId, slug);

  if (!post) {
    return generateTenantMetadata({ tenantConfig: config, page: 'blog' });
  }

  return generateTenantMetadata({
    tenantConfig: config,
    page: 'blog-post',
    override: {
      title: post.title,
      description: post.excerpt,
      image: post.coverImage?.url,
      canonical: `${config.deployment.canonicalUrl}/blog/${slug}`,
      publishedAt: post.publishedAt,
      updatedAt: post.updatedAt,
      author: post.author?.name,
      keywords: post.tags,
    },
  });
}
```

---
