### 34.5 White-Label Settings (Enterprise Admin)

**File:** `apps/portal/src/features/settings/ui/WhiteLabelSettings.tsx`

```typescript
'use client';

import { useState, useTransition } from 'react';
import { AssetUploader } from '@/features/assets/ui/AssetUploader';
import { updateWhiteLabelSettings } from '../model/settings-actions';

interface WhiteLabelSettingsProps {
  tenantId: string;
  initialConfig: {
    portalName?: string;
    portalLogoUrl?: string;
    portalPrimaryColor?: string;
    hideAgencyBranding?: boolean;
    hideSupportLink?: boolean;
    privacyPolicyUrl?: string;
  };
  isPlanEnterprise: boolean;
}

export function WhiteLabelSettings({
  tenantId,
  initialConfig,
  isPlanEnterprise,
}: WhiteLabelSettingsProps) {
  const [portalName, setPortalName] = useState(initialConfig.portalName ?? '');
  const [primaryColor, setPrimaryColor] = useState(initialConfig.portalPrimaryColor ?? '#2563eb');
  const [hideAgencyBranding, setHideAgencyBranding] = useState(initialConfig.hideAgencyBranding ?? false);
  const [hideSupportLink, setHideSupportLink] = useState(initialConfig.hideSupportLink ?? false);
  const [privacyPolicyUrl, setPrivacyPolicyUrl] = useState(initialConfig.privacyPolicyUrl ?? '');
  const [isPending, startTransition] = useTransition();
  const [saved, setSaved] = useState(false);

  if (!isPlanEnterprise) {
    return (
      <div className="rounded-xl border-2 border-dashed border-gray-200 p-8 text-center">
        <p className="text-2xl mb-3">üè∑Ô∏è</p>
        <p className="font-semibold text-gray-900 mb-1">White-Label is an Enterprise feature</p>
        <p className="text-sm text-gray-500 mb-4">
          Remove all platform branding and use your own logo, colors, and domain.
        </p>
        <a
          href="/billing"
          className="inline-flex px-5 py-2.5 bg-primary text-white rounded-xl text-sm font-semibold hover:opacity-90"
        >
          Upgrade to Enterprise
        </a>
      </div>
    );
  }

  const handleSave = (e: React.FormEvent) => {
    e.preventDefault();
    startTransition(async () => {
      await updateWhiteLabelSettings({
        portalName,
        portalPrimaryColor: primaryColor,
        hideAgencyBranding,
        hideSupportLink,
        privacyPolicyUrl: privacyPolicyUrl || undefined,
      });
      setSaved(true);
      setTimeout(() => setSaved(false), 3000);
    });
  };

  return (
    <form onSubmit={handleSave} className="space-y-6" aria-label="White-label portal settings">
      <div>
        <h2 className="text-lg font-bold text-gray-900 mb-1">White-Label Portal</h2>
        <p className="text-sm text-gray-500">
          Customize the portal to match your brand. Changes take effect immediately.
        </p>
      </div>

      <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div>
          <label htmlFor="portal-name" className="block text-sm font-medium text-gray-700 mb-1.5">
            Portal Name
          </label>
          <input
            id="portal-name"
            type="text"
            value={portalName}
            onChange={(e) => setPortalName(e.target.value)}
            placeholder="Acme Co. Client Portal"
            maxLength={60}
            className="w-full border border-gray-300 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
          />
        </div>

        <div>
          <label htmlFor="primary-color" className="block text-sm font-medium text-gray-700 mb-1.5">
            Portal Primary Color
          </label>
          <div className="flex items-center gap-3">
            <input
              id="primary-color"
              type="color"
              value={primaryColor}
              onChange={(e) => setPrimaryColor(e.target.value)}
              className="h-10 w-14 border border-gray-300 rounded-lg cursor-pointer p-0.5"
              aria-label="Choose primary color"
            />
            <input
              type="text"
              value={primaryColor}
              onChange={(e) => setPrimaryColor(e.target.value)}
              placeholder="#2563eb"
              maxLength={7}
              className="flex-1 border border-gray-300 rounded-xl px-4 py-2.5 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-primary"
              aria-label="Hex color value"
            />
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <AssetUploader
          assetType="logo"
          currentUrl={initialConfig.portalLogoUrl}
          label="Portal Logo"
          aspectHint="horizontal (3:1 recommended)"
          tenantId={tenantId}
        />
      </div>

      {/* Toggle options */}
      <div className="space-y-4 pt-4 border-t border-gray-100">
        {[
          {
            id: 'hide-agency',
            label: 'Remove "Powered by" branding',
            description: 'Hides the platform attribution in the footer.',
            value: hideAgencyBranding,
            onChange: setHideAgencyBranding,
          },
          {
            id: 'hide-support',
            label: 'Hide support link',
            description: 'Removes the platform support link from the footer.',
            value: hideSupportLink,
            onChange: setHideSupportLink,
          },
        ].map((toggle) => (
          <div key={toggle.id} className="flex items-start justify-between">
            <div>
              <p className="text-sm font-medium text-gray-900">{toggle.label}</p>
              <p className="text-xs text-gray-500 mt-0.5">{toggle.description}</p>
            </div>
            <button
              type="button"
              role="switch"
              aria-checked={toggle.value}
              id={toggle.id}
              onClick={() => toggle.onChange(!toggle.value)}
              className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors flex-shrink-0 ml-4 ${
                toggle.value ? 'bg-primary' : 'bg-gray-300'
              }`}
              aria-label={toggle.label}
            >
              <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                toggle.value ? 'translate-x-6' : 'translate-x-1'
              }`} />
            </button>
          </div>
        ))}
      </div>

      <div className="flex items-center gap-4">
        <button
          type="submit"
          disabled={isPending}
          className="px-6 py-2.5 bg-primary text-white rounded-xl font-semibold text-sm disabled:opacity-50 hover:opacity-90 transition-opacity"
        >
          {isPending ? 'Saving‚Ä¶' : 'Save White-Label Settings'}
        </button>
        {saved && (
          <p role="status" className="text-sm text-green-600 font-medium">‚úì Settings saved</p>
        )}
      </div>
    </form>
  );
}
```

---

## Priority Table for Domains 31‚Äì34

| Task                                                         | Domain | Priority | Timeline | Success Metric                                                    |
| ------------------------------------------------------------ | ------ | -------- | -------- | ----------------------------------------------------------------- |
| Service worker registration + app shell caching              | 31     | **P1**   | Week 2   | Marketing site loads offline after first visit                    |
| BackgroundSync plugin for contact form POSTs                 | 31     | **P1**   | Week 2   | Form submitted offline fires when reconnected                     |
| `useOfflineForm` hook with IndexedDB fallback                | 31     | **P1**   | Week 2   | Offline submission stored, synced on reconnect                    |
| Per-tenant `manifest.ts` (name, color, icons)                | 31     | **P1**   | Week 2   | "Add to Home Screen" installs with correct branding               |
| Offline banner (online/offline status indicator)             | 31     | **P2**   | Week 3   | Visitor sees yellow bar when offline                              |
| `@react-pdf/renderer` weekly report template                 | 32     | **P1**   | Week 2   | PDF renders with logo, bar chart, top leads table                 |
| QStash weekly report job (Sunday 11PM CST)                   | 32     | **P1**   | Week 2   | Cron triggers per active tenant with reports enabled              |
| PDF upload to Supabase Storage (private bucket)              | 32     | **P1**   | Week 2   | PDF accessible via 7-day signed URL                               |
| Report email with download link                              | 32     | **P1**   | Week 2   | Email arrives Sunday evening with correct stats                   |
| Notification preference to disable reports                   | 32     | **P2**   | Week 3   | Client can opt out of weekly report                               |
| Cookie consent banner (server-side, no FOUC)                 | 33     | **P0**   | Week 1   | Banner shows on first visit, hidden on return                     |
| Accept/Reject/Customize consent flows                        | 33     | **P0**   | Week 1   | All three paths set correct cookie and fire GA consent mode       |
| GDPR Article 17 erasure endpoint + job                       | 33     | **P0**   | Week 1   | Erasure request queued and processed within 30 days               |
| PII anonymization for bookings (hard delete for leads)       | 33     | **P0**   | Week 1   | Booking records retained, PII replaced with pseudonyms            |
| Erasure request audit log (`erasure_requests` table)         | 33     | **P0**   | Week 1   | Every request traceable with timestamp and result                 |
| GDPR Article 20 data export endpoint                         | 33     | **P1**   | Week 2   | Subject can download all their data as JSON                       |
| White-label CSS variable injection (server-side)             | 34     | **P1**   | Week 2   | No flash of wrong brand color on portal load                      |
| White-label portal name + logo in header                     | 34     | **P1**   | Week 2   | Agency logo replaced with client logo on Enterprise plan          |
| Hide "Powered by" on Enterprise plan                         | 34     | **P1**   | Week 2   | No platform attribution visible in footer                         |
| White-label settings UI (Enterprise-gated)                   | 34     | **P2**   | Week 3   | Non-Enterprise sees upgrade prompt; Enterprise sees full settings |
| White-label portal domain support (custom `portal.*` domain) | 34     | **P2**   | Week 3   | `portal.johnsplumbing.com` routes to correct tenant portal        |

---

**Cross-domain invariants for Domains 31‚Äì34:**

- The BackgroundSync queue tag (`contact-form-queue`) is hardcoded in both the service worker and the form hook. A mismatch means queued requests are never replayed. They must be identical strings. [youtube](https://www.youtube.com/watch?v=unnBfDeQYQM)
- `@react-pdf/renderer`'s `renderToBuffer` must be called in a Node.js Route Handler, **not** an Edge Runtime function ‚Äî the library has no Edge-compatible build. The `maxDuration = 60` directive is required because PDF generation with fonts can take 10‚Äì40 seconds on cold starts. [reddit](https://www.reddit.com/r/nextjs/comments/1pqkmeu/anyone_generating_pdfs_serverside_in_nextjs/)
- GDPR erasure of booking records uses **anonymization not hard deletion** because financial records (booking history, payment correlation) may have a legitimate retention basis under accounting law. The legal distinction: hard deletion where no retention basis exists (leads), anonymization where a retention basis exists but PII must be removed (bookings). [rgpd](https://rgpd.com/gdpr/chapter-3-rights-of-the-data-subject/article-17-right-to-erasure-right-to-be-forgotten/)
- The cookie consent cookie is `httpOnly: false` ‚Äî this is intentional. Google's Consent Mode v2 requires the page's JavaScript to read the consent state to conditionally fire gtag commands. An `httpOnly` cookie would prevent this. [buildwithmatija](https://www.buildwithmatija.com/blog/build-cookie-consent-banner-nextjs-15-server-client)
- White-label CSS variables are injected as an inline `<style>` tag in the server-rendered HTML, **not** via a `useEffect` or client-side CSS-in-JS. This eliminates the flash of wrong brand color on first paint ‚Äî critical for Enterprise clients doing demos to their own customers. [youtube](https://www.youtube.com/watch?v=GdUqkgBW6cQ)
