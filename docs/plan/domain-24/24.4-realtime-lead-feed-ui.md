# 24.4 Realtime Lead Feed UI

**File:** `apps/portal/src/features/leads/ui/LeadFeed.tsx`

```typescript
'use client';

import { useState, useCallback, useOptimistic } from 'react';
import { useRealtimeLeads, type RealtimeLead } from '@repo/realtime/use-realtime-leads';
import { markLeadContacted } from '../model/lead-actions';

interface LeadFeedProps {
  tenantId: string;
  initialLeads: RealtimeLead[];
  realtimeEnabled: boolean; // Feature flag: Professional+ only
}

export function LeadFeed({ tenantId, initialLeads, realtimeEnabled }: LeadFeedProps) {
  const [leads, setLeads] = useState<RealtimeLead[]>(initialLeads);
  const [newLeadIds, setNewLeadIds] = useState<Set<string>>(new Set());
  const [hasNewLeads, setHasNewLeads] = useState(false);

  const handleNewLead = useCallback((lead: RealtimeLead) => {
    setLeads((prev) => [lead, ...prev]);
    setNewLeadIds((prev) => new Set([...prev, lead.id]));
    setHasNewLeads(true);

    // Browser notification (if permission granted)
    if (
      typeof Notification !== 'undefined' &&
      Notification.permission === 'granted'
    ) {
      new Notification(`ðŸ”¥ New lead: ${lead.name}`, {
        body: `Score: ${lead.score}/100 â€” ${lead.message.slice(0, 80)}`,
        icon: '/favicon.ico',
        tag: lead.id, // Deduplicate same lead
      });
    }

    // Auto-clear "new" badge after 30 seconds
    setTimeout(() => {
      setNewLeadIds((prev) => {
        const next = new Set(prev);
        next.delete(lead.id);
        return next;
      });
    }, 30_000);
  }, []);

  const handleLeadUpdated = useCallback((updated: RealtimeLead) => {
    setLeads((prev) =>
      prev.map((l) => (l.id === updated.id ? updated : l))
    );
  }, []);

  useRealtimeLeads({
    tenantId,
    onNewLead: handleNewLead,
    onLeadUpdated: handleLeadUpdated,
    enabled: realtimeEnabled,
  });

  return (
    <div>
      {/* Live indicator */}
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-xl font-bold text-gray-900">Lead Feed</h2>
        <div className="flex items-center gap-2">
          {realtimeEnabled ? (
            <>
              <span className="relative flex h-2.5 w-2.5">
                <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75" />
                <span className="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500" />
              </span>
              <span className="text-sm text-green-700 font-medium">Live</span>
            </>
          ) : (
            <span className="text-sm text-gray-400 flex items-center gap-1">
              <span className="h-2.5 w-2.5 rounded-full bg-gray-300 inline-block" />
              Upgrade to Professional for live feed
            </span>
          )}
        </div>
      </div>

      {/* New leads toast */}
      {hasNewLeads && (
        <button
          type="button"
          onClick={() => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            setHasNewLeads(false);
          }}
          className="w-full mb-4 py-2.5 bg-green-500 text-white rounded-xl text-sm font-semibold animate-bounce"
          aria-live="polite"
        >
          â†‘ New leads arrived â€” tap to view
        </button>
      )}

      {/* Lead cards */}
      <div
        className="space-y-3"
        role="feed"
        aria-label="Lead feed"
        aria-busy={false}
      >
        {leads.length === 0 ? (
          <div className="text-center py-16 text-gray-400">
            <p className="text-5xl mb-4">ðŸ“­</p>
            <p className="font-medium">No leads yet</p>
            <p className="text-sm">Your leads will appear here in real-time</p>
          </div>
        ) : (
          leads.map((lead) => (
            <LeadCard
              key={lead.id}
              lead={lead}
              isNew={newLeadIds.has(lead.id)}
            />
          ))
        )}
      </div>
    </div>
  );
}

// â”€â”€ Lead Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function LeadCard({ lead, isNew }: { lead: RealtimeLead; isNew: boolean }) {
  const [optimisticStatus, setOptimisticStatus] = useState(lead.status);
  const [isExpanded, setIsExpanded] = useState(false);

  const scoreColor =
    lead.score >= 70 ? 'text-green-700 bg-green-100' :
    lead.score >= 40 ? 'text-yellow-700 bg-yellow-100' :
    'text-gray-600 bg-gray-100';

  const scoreLabel =
    lead.score >= 70 ? 'Qualified' :
    lead.score >= 40 ? 'Warm' : 'Cold';

  const timeAgo = formatTimeAgo(new Date(lead.created_at));

  return (
    <article
      className={`
        bg-white border rounded-xl p-4 transition-all duration-500
        ${isNew ? 'border-green-400 shadow-lg shadow-green-100 ring-1 ring-green-300' : 'border-gray-200 shadow-sm'}
      `}
      aria-label={`Lead from ${lead.name}, score ${lead.score}`}
    >
      <div className="flex items-start justify-between gap-3">
        <div className="flex items-start gap-3 min-w-0">
          {/* Avatar */}
          <div
            className="h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold flex-shrink-0"
            aria-hidden="true"
          >
            {lead.name.charAt(0).toUpperCase()}
          </div>

          <div className="min-w-0">
            <div className="flex items-center gap-2 flex-wrap">
              <p className="font-semibold text-gray-900">{lead.name}</p>
              {isNew && (
                <span className="text-xs bg-green-500 text-white px-2 py-0.5 rounded-full font-semibold animate-pulse">
                  NEW
                </span>
              )}
            </div>

            <div className="flex items-center gap-2 mt-0.5 flex-wrap">
              <a
                href={`mailto:${lead.email}`}
                className="text-sm text-blue-600 hover:underline truncate max-w-[180px]"
              >
                {lead.email}
              </a>
              {lead.phone && (
                <a href={`tel:${lead.phone}`} className="text-sm text-gray-500 hover:text-primary">
                  {lead.phone}
                </a>
              )}
            </div>
          </div>
        </div>

        {/* Score badge */}
        <div className={`flex-shrink-0 text-center rounded-lg px-3 py-1.5 ${scoreColor}`}>
          <p className="text-lg font-extrabold leading-none">{lead.score}</p>
          <p className="text-xs font-medium mt-0.5">{scoreLabel}</p>
        </div>
      </div>

      {/* Message preview */}
      <div className="mt-3">
        <p
          className={`text-sm text-gray-600 ${!isExpanded ? 'line-clamp-2' : ''}`}
          onClick={() => setIsExpanded((v) => !v)}
          style={{ cursor: 'pointer' }}
          aria-expanded={isExpanded}
        >
          {lead.message}
        </p>
      </div>

      {/* Footer */}
      <div className="mt-3 pt-3 border-t border-gray-100 flex items-center justify-between">
        <div className="flex items-center gap-3 text-xs text-gray-400">
          <span>{timeAgo}</span>
          {lead.metadata?.utmSource && (
            <span className="bg-gray-100 px-2 py-0.5 rounded-full">
              {String(lead.metadata.utmSource)}
            </span>
          )}
          {lead.source && lead.source !== 'contact_form' && (
            <span className="bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full capitalize">
              {lead.source.replace(/_/g, ' ')}
            </span>
          )}
        </div>

        <div className="flex items-center gap-2">
          <a
            href={`mailto:${lead.email}?subject=Re: Your inquiry`}
            className="text-xs font-medium text-primary hover:underline"
            aria-label={`Reply to ${lead.name}`}
          >
            Reply
          </a>
          {lead.phone && (
            <a
              href={`tel:${lead.phone}`}
              className="text-xs font-medium text-green-600 hover:underline"
              aria-label={`Call ${lead.name}`}
            >
              Call
            </a>
          )}
          {optimisticStatus !== 'contacted' && (
            <button
              type="button"
              onClick={async () => {
                setOptimisticStatus('contacted');
                await markLeadContacted(lead.id);
              }}
              className="text-xs text-gray-400 hover:text-gray-600"
              aria-label="Mark as contacted"
            >
              Mark contacted
            </button>
          )}
          {optimisticStatus === 'contacted' && (
            <span className="text-xs text-green-600">âœ“ Contacted</span>
          )}
        </div>
      </div>
    </article>
  );
}

function formatTimeAgo(date: Date): string {
  const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
  if (seconds < 60) return 'just now';
  if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
  if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
  return `${Math.floor(seconds / 86400)}d ago`;
}
```
