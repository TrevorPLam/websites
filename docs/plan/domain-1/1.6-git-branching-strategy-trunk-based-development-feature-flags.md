### 1.6 Git Branching Strategy: Trunk-Based Development + Feature Flags

**Branch Model:**

```
main (protected, production)
  ↑
  └── feature/feature-name (short-lived, 1–3 days max)
```

**Rules:**

- Main is always deployable: Every commit to `main` goes to production
- No long-lived branches: Feature branches merged within 1–3 days
- Feature flags for incomplete work: Use `site.config.ts` feature toggles for gradual rollout
- Fast-forward merges preferred: Keeps history clean

**Branch Protection Rules (.github/branch-protection.yml):**

```yaml
branches:
  main:
    protection:
      required_status_checks:
        strict: true
        contexts:
          - 'ci/typecheck'
          - 'ci/lint'
          - 'ci/test'
          - 'ci/e2e'
          - 'ci/validate-configs'
          - 'ci/accessibility'
          - 'ci/lighthouse'
          - 'ci/bundle-size'
      required_pull_request_reviews:
        required_approving_review_count: 1
        dismiss_stale_reviews: true
        require_code_owner_reviews: true
      enforce_admins: true
      required_linear_history: true
      allow_force_pushes: false
      allow_deletions: false
      restrictions:
        users: []
        teams: ['platform-team']
```

**Feature Flag Pattern:**

**File:** `packages/feature-flags/src/index.ts`

```typescript
import { z } from 'zod';

const flagSchema = z.object({
  enabled: z.boolean(),
  rollout: z.number().min(0).max(100).optional(), // Percentage
  tenantIds: z.array(z.string()).optional(), // Specific tenants
  tiers: z.array(z.enum(['starter', 'professional', 'enterprise'])).optional(),
});

export const featureFlags = {
  newLeadScoringEngine: {
    enabled: true,
    rollout: 10, // 10% of tenants
    tiers: ['enterprise'], // Only enterprise tier
  },

  experimentalPPR: {
    enabled: true,
    tenantIds: ['client-001', 'client-005'], // Specific beta testers
  },

  newDesignSystem: {
    enabled: false, // Not yet launched
  },

  NEW_CHECKOUT_FLOW: process.env.NEXT_PUBLIC_FF_NEW_CHECKOUT === 'true',
  REACT_COMPILER: process.env.NEXT_PUBLIC_FF_REACT_COMPILER === 'true',
  PPR_ENABLED: process.env.NEXT_PUBLIC_FF_PPR === 'true',
} as const;

// Usage in code
export function useFeatureFlag(flag: keyof typeof featureFlags, tenantId: string, tier: string) {
  const config = featureFlags[flag];

  if (!config.enabled) return false;

  if (config.tenantIds && !config.tenantIds.includes(tenantId)) {
    return false;
  }

  if (config.tiers && !config.tiers.includes(tier as any)) {
    return false;
  }

  if (config.rollout) {
    // Deterministic hash-based rollout
    const hash = hashString(`${tenantId}-${flag}`);
    return hash % 100 < config.rollout;
  }

  return true;
}
```

**Example Feature Flag in `site.config.ts`:**

```typescript
export const config: SiteConfig = {
  // ... other config
  features: {
    enableA/BTesting: true,
    enableCookieConsent: true,
    enableNewContactForm: false, // <-- Feature flag for incomplete feature
  },
};
```

**Why Trunk-Based:** Minimizes merge conflicts, enables continuous deployment, aligns with AI agent workflow (agents commit directly to main after CI passes).

**When to Build:** P0 (Configure branch protection settings in GitHub)
