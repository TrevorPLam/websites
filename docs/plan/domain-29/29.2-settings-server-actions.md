### 29.2 Settings Server Actions

**File:** `apps/portal/src/features/settings/model/settings-actions.ts`

```typescript
'use server';

import { z } from 'zod';
import { revalidateTag } from 'next/cache';
import { createServerAction } from '@repo/auth/server-action-wrapper';
import { db } from '@repo/db';
import { invalidateTenantServiceAreas } from '@repo/cache/invalidate-tenant';

// ============================================================================
// SETTINGS ACTIONS
// Each action handles one settings section independently.
// All use deep-merge: only specified fields are updated, rest preserved.
// ============================================================================

// ── 1. Identity settings ──────────────────────────────────────────────────────

const IdentitySchema = z.object({
  siteName: z.string().min(2).max(80),
  tagline: z.string().max(160).optional(),
  description: z.string().max(500).optional(),
  industry: z.enum(['hvac', 'plumbing', 'electrical', 'dental', 'medical',
    'law', 'realEstate', 'accounting', 'restaurant', 'salon', 'general']),
  priceRange: z.enum(['$', '$$', '$$$', '$$$$']).optional(),
  yearEstablished: z.number().min(1800).max(new Date().getFullYear()).optional(),
});

export const updateIdentitySettings = createServerAction(
  IdentitySchema,
  async (input, ctx) => {
    const { tenantId } = ctx;

    await db.rpc('deep_merge_config', {
      p_tenant_id: tenantId,
      p_path: '{identity}',
      p_value: input,
    });

    revalidateTag(`tenant:${tenantId}`);
    revalidateTag(`tenant:${tenantId}:sitemap`);

    return { success: true };
  }
);

// ── 2. Contact settings ───────────────────────────────────────────────────────

const ContactSchema = z.object({
  phone: z.string().regex(/^[\+]?[\d\s\-\(\)]{7,20}$/, 'Invalid phone number').optional(),
  email: z.string().email().optional(),
  address: z.object({
    street: z.string().max(100).optional(),
    city: z.string().max(80),
    state: z.string().length(2).toUpperCase(),
    zip: z.string().regex(/^\d{5}(-\d{4})?$/).optional(),
  }).optional(),
  coordinates: z.object({
    lat: z.number().min(-90).max(90),
    lng: z.number().min(-180).max(180),
  }).optional(),
});

export const updateContactSettings = createServerAction(
  ContactSchema,
  async (input, ctx) => {
    const { tenantId } = ctx;

    await db.rpc('deep_merge_config', {
      p_tenant_id: tenantId,
      p_path: '{identity,contact}',
      p_value: { ...input.address ? { address: input.address } : {},
                 ...input.coordinates ? { coordinates: input.coordinates } : {},
                 ...input.phone ? { contact: { phone: input.phone, email: input.email } } : {} },
    });

    revalidateTag(`tenant:${tenantId}`);
    return { success: true };
  }
);

// ── 3. Service areas settings ─────────────────────────────────────────────────

const ServiceAreasSchema = z.object({
  serviceAreas: z.array(z.string().min(2).max(60)).min(1).max(50),
});

export const updateServiceAreasSettings = createServerAction(
  ServiceAreasSchema,
  async (input, ctx) => {
    const { tenantId } = ctx;

    // Fetch current areas before update (for cache invalidation delta)
    const { data: current } = await db
      .from('tenants')
      .select('config->identity->serviceAreas')
      .eq('id', tenantId)
      .single();

    const previousAreas: string[] = (current as any)?.['config->identity->serviceAreas'] ?? [];

    await db.rpc('deep_merge_config', {
      p_tenant_id: tenantId,
      p_path: '{identity}',
      p_value: { serviceAreas: input.serviceAreas },
    });

    // Invalidate only removed areas (added areas have no cache to bust)
    const removedAreas = previousAreas.filter((a) => !input.serviceAreas.includes(a));
    await invalidateTenantServiceAreas(tenantId, removedAreas.map(slugifyArea));

    revalidateTag(`tenant:${tenantId}:sitemap`);

    return { success: true };
  }
);

// ── 4. Business hours settings ────────────────────────────────────────────────

const HoursSchema = z.object({
  hours: z.array(z.object({
    days: z.array(z.enum(['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'])),
    opens: z.string().regex(/^( [kreativekommit](https://kreativekommit.com/guides/2025/07/ssr-nextjs-local-seo)\d|2[0-3]):([0-5]\d)$/, 'Use HH:MM format'),
    closes: z.string().regex(/^( [kreativekommit](https://kreativekommit.com/guides/2025/07/ssr-nextjs-local-seo)\d|2[0-3]):([0-5]\d)$/, 'Use HH:MM format'),
  })).max(7),
});

export const updateHoursSettings = createServerAction(
  HoursSchema,
  async (input, ctx) => {
    await db.rpc('deep_merge_config', {
      p_tenant_id: ctx.tenantId,
      p_path: '{identity}',
      p_value: { hours: input.hours },
    });

    revalidateTag(`tenant:${ctx.tenantId}`);
    return { success: true };
  }
);

// ── 5. Notification preferences ───────────────────────────────────────────────

const NotificationsSchema = z.object({
  leadEmail: z.object({
    enabled: z.boolean(),
    scoreThreshold: z.number().min(0).max(100),
    digestEnabled: z.boolean(),
    digestTime: z.string().regex(/^( [kreativekommit](https://kreativekommit.com/guides/2025/07/ssr-nextjs-local-seo)\d|2[0-3]):([0-5]\d)$/),
  }),
  bookingEmail: z.object({
    confirmationEnabled: z.boolean(),
    reminderEnabled: z.boolean(),
    followUpEnabled: z.boolean(),
  }),
  smsEnabled: z.boolean().optional(),
  smsPhone: z.string().optional(),
});

export const updateNotificationsSettings = createServerAction(
  NotificationsSchema,
  async (input, ctx) => {
    await db
      .from('tenants')
      .update({
        notification_config: input,
        updated_at: new Date().toISOString(),
      })
      .eq('id', ctx.tenantId);

    return { success: true };
  }
);

// ── 6. Integrations settings ──────────────────────────────────────────────────

const IntegrationsSchema = z.object({
  googleAnalyticsId: z.string().regex(/^G-[A-Z0-9]+$/).optional().or(z.literal('')),
  googleTagManagerId: z.string().regex(/^GTM-[A-Z0-9]+$/).optional().or(z.literal('')),
  facebookPixelId: z.string().regex(/^\d+$/).optional().or(z.literal('')),
  googleSiteVerification: z.string().optional(),
  bingSiteVerification: z.string().optional(),
});

export const updateIntegrationsSettings = createServerAction(
  IntegrationsSchema,
  async (input, ctx) => {
    // Store non-empty values only
    const cleaned = Object.fromEntries(
      Object.entries(input).filter(([, v]) => v !== '' && v !== undefined)
    );

    await db.rpc('deep_merge_config', {
      p_tenant_id: ctx.tenantId,
      p_path: '{identity}',
      p_value: cleaned,
    });

    revalidateTag(`tenant:${ctx.tenantId}`);
    return { success: true };
  }
);

function slugifyArea(area: string): string {
  return area.toLowerCase().replace(/,\s*/g, '-').replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
}
```

---
