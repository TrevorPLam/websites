### 29.3 Deep Merge Config SQL Function

```sql
-- Supabase migration: deep_merge_config RPC
-- Used by all settings actions to surgically update config paths
-- without overwriting sibling keys

CREATE OR REPLACE FUNCTION deep_merge_config(
  p_tenant_id  uuid,
  p_path       text[],         -- e.g. '{identity}' or '{identity,contact}'
  p_value      jsonb           -- New values to merge at this path
)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_current jsonb;
  v_merged  jsonb;
BEGIN
  -- Get current config (locked for update)
  SELECT config INTO v_current
  FROM tenants
  WHERE id = p_tenant_id
  FOR UPDATE;

  IF v_current IS NULL THEN
    RAISE EXCEPTION 'Tenant % not found', p_tenant_id;
  END IF;

  -- Deep merge: existing value at path is merged with new value
  -- jsonb_set replaces; we use || (concat) for shallow merge at the path
  v_merged := jsonb_set(
    v_current,
    p_path,
    COALESCE(v_current #> p_path, '{}') || p_value,
    true  -- create missing path
  );

  UPDATE tenants
  SET config     = v_merged,
      updated_at = now()
  WHERE id = p_tenant_id;
END;
$$;

-- Grant execute to authenticated users (RLS still enforced by row ownership)
GRANT EXECUTE ON FUNCTION deep_merge_config TO authenticated;
```

---
