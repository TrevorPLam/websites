### 11.1 Philosophy

**What it is:** Stripe Billing manages recurring subscriptions for the platform itself (agency charging clients) and, optionally, pass-through billing where clients charge their own customers. The critical engineering challenge is webhook idempotency — Stripe retries failed webhooks for up to 3 days with exponential backoff, so every handler must be safe to execute multiple times with the same event. [docs.stripe](https://docs.stripe.com/billing/subscriptions/webhooks)

**Why it matters:** A non-idempotent webhook handler can suspend an active tenant when a `customer.subscription.deleted` event fires twice, or charge a client twice when `invoice.payment_succeeded` processes a retry. A single production incident of either type destroys client trust.

**Architecture:** Every Stripe event is written to `processed_webhooks` before processing (Domain 4 §4.4). Handler reads the record first — if it exists, returns `200` immediately without re-executing. This is the only reliable solution. [dev](https://dev.to/aniefon_umanah_ac5f21311c/building-reliable-stripe-subscriptions-in-nestjs-webhook-idempotency-and-optimistic-locking-3o91)

---
