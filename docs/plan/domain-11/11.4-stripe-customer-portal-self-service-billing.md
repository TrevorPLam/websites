### 11.4 Stripe Customer Portal (Self-Service Billing)

```typescript
// apps/portal/src/features/billing/model/open-portal.ts
'use server';

import Stripe from 'stripe';
import { z } from 'zod';
import { createServerAction } from '@repo/auth/server-action-wrapper';
import { db } from '@repo/db';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2025-11-27.acacia',
});

const OpenPortalSchema = z.object({
  returnUrl: z.string().url().optional(),
});

export const openBillingPortal = createServerAction(OpenPortalSchema, async (input, ctx) => {
  const { data: tenant } = await db
    .from('tenants')
    .select('stripe_customer_id')
    .eq('id', ctx.tenantId)
    .single();

  if (!tenant?.stripe_customer_id) {
    return { error: 'No billing account found. Please subscribe first.' };
  }

  // Create a short-lived portal session (link expires in 5 minutes)
  const portalSession = await stripe.billingPortal.sessions.create({
    customer: tenant.stripe_customer_id,
    return_url: input.returnUrl ?? `${process.env.NEXT_PUBLIC_PORTAL_URL}/billing`,
    // Configure which actions are available in the portal
    // Set via Stripe Dashboard: portal config ID
    // configuration: process.env.STRIPE_PORTAL_CONFIG_ID,
  });

  return { portalUrl: portalSession.url };
});
```

---
