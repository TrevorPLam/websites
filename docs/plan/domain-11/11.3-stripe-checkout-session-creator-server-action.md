### 11.3 Stripe Checkout Session Creator (Server Action)

```typescript
// apps/portal/src/features/billing/model/create-checkout.ts
'use server';

import Stripe from 'stripe';
import { z } from 'zod';
import { createServerAction } from '@repo/auth/server-action-wrapper';
import { db } from '@repo/db';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2025-11-27.acacia',
});

const CheckoutSchema = z.object({
  priceId: z.string().startsWith('price_'),
  successUrl: z.string().url().optional(),
  cancelUrl: z.string().url().optional(),
});

export const createCheckoutSession = createServerAction(CheckoutSchema, async (input, ctx) => {
  // Fetch or create Stripe customer for this tenant
  const { data: tenant } = await db
    .from('tenants')
    .select('stripe_customer_id, config')
    .eq('id', ctx.tenantId)
    .single();

  const config = tenant?.config as any;
  let customerId = tenant?.stripe_customer_id;

  if (!customerId) {
    // Create Stripe customer (first time)
    const customer = await stripe.customers.create({
      email: config?.identity?.contact?.email,
      name: config?.identity?.siteName,
      metadata: {
        tenantId: ctx.tenantId,
        userId: ctx.userId,
      },
    });

    customerId = customer.id;

    await db.from('tenants').update({ stripe_customer_id: customerId }).eq('id', ctx.tenantId);
  }

  // Create Checkout Session
  const session = await stripe.checkout.sessions.create({
    customer: customerId,
    mode: 'subscription',
    payment_method_types: ['card'],
    line_items: [{ price: input.priceId, quantity: 1 }],
    // 14-day trial for new subscriptions
    subscription_data: {
      trial_period_days: 14,
      metadata: { tenantId: ctx.tenantId },
    },
    success_url: input.successUrl ?? `${process.env.NEXT_PUBLIC_PORTAL_URL}/billing?success=1`,
    cancel_url: input.cancelUrl ?? `${process.env.NEXT_PUBLIC_PORTAL_URL}/billing?cancelled=1`,
    metadata: {
      tenantId: ctx.tenantId,
      userId: ctx.userId,
    },
    // Allow promo codes
    allow_promotion_codes: true,
    // Collect tax automatically
    automatic_tax: { enabled: true },
    customer_update: { address: 'auto' },
  });

  return { checkoutUrl: session.url! };
});
```

---
