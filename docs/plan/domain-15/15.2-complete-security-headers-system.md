### 15.2 Complete Security Headers System

**File:** `packages/security/src/headers.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { v4 as uuidv4 } from 'uuid';

// ============================================================================
// SECURITY HEADERS
// Applied in middleware on EVERY response — both marketing sites and portal.
// Nonce-based CSP: prevents XSS by requiring all inline scripts to carry
// a per-request random token. Script tags in RSC must read nonce from headers.
// Reference: https://nextjs.org/docs/app/guides/content-security-policy
// ============================================================================

export type SecurityHeadersConfig = {
  environment: 'production' | 'staging' | 'development';
  isDashboard: boolean; // Portal routes get stricter CSP than marketing sites
  customDomain?: string; // For frame-ancestors if embedded in CMS
};

export function buildSecurityHeaders(
  request: NextRequest,
  config: SecurityHeadersConfig
): { nonce: string; headers: Record<string, string> } {
  const nonce = Buffer.from(uuidv4()).toString('base64');
  const isDev = config.environment === 'development';

  // ── Content Security Policy ───────────────────────────────────────────────
  // Per-request nonce enables strict-dynamic without unsafe-inline.
  // Every <Script nonce={nonce}> tag is allowed. All others blocked.

  const scriptSrc = [
    "'self'",
    `'nonce-${nonce}'`,
    "'strict-dynamic'", // Trusts scripts loaded by nonced scripts
    ...(isDev ? ["'unsafe-eval'"] : []), // Next.js dev mode requires eval
    'https://js.stripe.com', // Stripe.js
    'https://*.googleapis.com', // Google Tag Manager (if enabled by client)
    'https://*.googletagmanager.com',
  ].join(' ');

  const connectSrc = [
    "'self'",
    'https://*.supabase.co', // Supabase Realtime + REST
    'https://*.supabase.in',
    'wss://*.supabase.co', // WebSocket for Realtime
    'https://api.stripe.com',
    'https://api.tinybird.co',
    'https://*.sentry.io',
    'https://o0.ingest.sentry.io',
    ...(isDev ? ['ws://localhost:*', 'http://localhost:*'] : []),
  ].join(' ');

  const frameSrc = [
    "'self'",
    'https://js.stripe.com', // Stripe payment iframe
    'https://hooks.stripe.com',
    ...(config.customDomain ? [`https://${config.customDomain}`] : []),
  ].join(' ');

  const imgSrc = [
    "'self'",
    'blob:',
    'data:',
    'https://*.supabase.co', // Supabase storage images
    'https://*.supabase.in',
    'https://lh3.googleusercontent.com', // Google avatar
    'https://avatars.githubusercontent.com',
    'https://placehold.co', // Placeholder images (dev only)
    'https://*.sanity.io', // Sanity CMS images
    'https://cdn.sanity.io',
  ].join(' ');

  const csp = [
    `default-src 'self'`,
    `script-src ${scriptSrc}`,
    `style-src 'self' 'unsafe-inline' https://fonts.googleapis.com`, // unsafe-inline needed for Tailwind
    `img-src ${imgSrc}`,
    `font-src 'self' https://fonts.gstatic.com`,
    `object-src 'none'`,
    `base-uri 'self'`,
    `form-action 'self'`,
    `frame-ancestors ${config.isDashboard ? "'self'" : "'none'"}`, // Clickjacking prevention
    `frame-src ${frameSrc}`,
    `connect-src ${connectSrc}`,
    `media-src 'self'`,
    `worker-src 'self' blob:`,
    `manifest-src 'self'`,
    `upgrade-insecure-requests`,
    ...(config.environment === 'production' ? [`block-all-mixed-content`] : []),
  ]
    .join('; ')
    .replace(/\n/g, '');

  const headers: Record<string, string> = {
    // CSP (nonce-based, per-request)
    'Content-Security-Policy': csp,

    // Strict Transport Security (HSTS)
    // max-age=31536000 = 1 year. includeSubDomains covers *.youragency.com.
    // preload: eligible for HSTS preload list (https://hstspreload.org)
    'Strict-Transport-Security': 'max-age=31536000; includeSubDomains; preload',

    // X-Frame-Options (legacy clickjacking prevention, supplement to CSP frame-ancestors)
    'X-Frame-Options': config.isDashboard ? 'SAMEORIGIN' : 'DENY',

    // X-Content-Type-Options: prevents MIME-type sniffing
    'X-Content-Type-Options': 'nosniff',

    // Referrer-Policy: limits referrer info sent to third parties
    // strict-origin-when-cross-origin: sends full URL within same origin, origin only to HTTPS, nothing to HTTP
    'Referrer-Policy': 'strict-origin-when-cross-origin',

    // Permissions-Policy: disable browser features we never use
    'Permissions-Policy': [
      'camera=()', // No webcam access
      'microphone=()', // No mic access
      'geolocation=(self)', // Geolocation only from self (service locator feature)
      'payment=()', // No Payment Request API (using Stripe iframe)
      'usb=()',
      'bluetooth=()',
      'midi=()',
      'magnetometer=()',
      'gyroscope=()',
      'accelerometer=()',
      'interest-cohort=()', // Disable FLoC
    ].join(', '),

    // Cross-Origin-Embedder-Policy + Cross-Origin-Opener-Policy
    // Needed for SharedArrayBuffer (not used, but good practice)
    'Cross-Origin-Embedder-Policy': 'unsafe-none', // 'require-corp' breaks Stripe
    'Cross-Origin-Opener-Policy': 'same-origin-allow-popups', // Allows Stripe popup
    'Cross-Origin-Resource-Policy': 'cross-origin', // Allows CDN assets

    // Pass nonce to Server Components via request header
    'X-Nonce': nonce,

    // Remove fingerprinting headers
    'X-Powered-By': '', // Remove "X-Powered-By: Next.js"
    Server: '', // Remove "Server: Vercel"
  };

  return { nonce, headers };
}

// ============================================================================
// APPLY TO RESPONSE
// ============================================================================

export function applySecurityHeaders(
  request: NextRequest,
  response: NextResponse,
  config: SecurityHeadersConfig
): { response: NextResponse; nonce: string } {
  const { nonce, headers } = buildSecurityHeaders(request, config);

  for (const [key, value] of Object.entries(headers)) {
    if (value === '') {
      // Delete header (remove fingerprinting)
      response.headers.delete(key);
    } else {
      response.headers.set(key, value);
    }
  }

  return { response, nonce };
}
```

---
