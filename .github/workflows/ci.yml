# CI â€” Marketing Website Monorepo
#
# [Task 0.13] Strengthened quality gates with clear pass/fail separation,
# affected-package optimization for PRs, and nightly full-repo validation.
#
# Blocking checks: lint, type-check, validate-exports, syncpack, build, test
# Non-blocking: knip, SBOM, dependency audit (informative)
#
# Branch protection: Require "quality-gates" job to pass before merge.
# See docs/ci/required-checks.md for configuration details.

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# [Task 2.7.2] Cancel stale CI runs for the same branch/PR
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pages: read
  deployments: read

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Blocking quality gates â€” must pass for merge
  # Map this job name to branch protection "Require status checks"
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  quality-gates:
    name: quality-gates
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        node-version: [22.x]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # [Task 0.13] Full history required for turbo affected-package detection
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.29.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # [Task 0.7] Workspace sync validation â€” ensures package.json and pnpm-workspace.yaml match
      - name: Validate workspaces
        run: pnpm validate:workspaces

      # [Task 0.11] Lint enforces module boundaries â€” docs/architecture/module-boundaries.md
      # [Task 0.13] PRs use affected-package filter for speed; push runs full pipeline
      - name: Lint
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            pnpm turbo run lint --filter="...[origin/main]"
          else
            pnpm turbo run lint
          fi

      # Code formatting check â€” ensures consistent style
      - name: Format check
        run: pnpm format:check

      - name: Type check
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            pnpm turbo run typecheck --filter="...[origin/main]"
          else
            pnpm turbo run typecheck
          fi

      # [Task 0.19] Export map validation â€” prevents broken package export paths
      - name: Validate exports
        run: pnpm validate-exports

      # @repo/marketing-components index.ts â†’ component family validation
      - name: Validate marketing exports
        run: pnpm validate-marketing-exports

      # [Task 5-*] Validate all clients (CaCA contract, site.config, routes, cross-client imports)
      - name: Validate clients
        run: pnpm validate-all-clients

      # [Task DOMAIN-2-002] Validate config schemas + detect duplicate tenant/domain conflicts
      - name: Validate site configs
        run: pnpm validate:configs

      # Circular dependency detection â€” blocks merge if cycles exist
      - name: Madge (circular deps)
        run: pnpm madge:circular

      # [Task 0.18] Dependency version consistency across workspace
      - name: Syncpack
        run: pnpm syncpack:check

      # [Task security-5] pnpm 10 supply chain security validation
      - name: Validate pnpm security configuration
        run: |
          echo "ğŸ”’ Validating pnpm security configuration..."
          # Validate workspace configuration
          pnpm list --depth=0
          # Check for security configuration in pnpm-workspace.yaml
          if grep -q "allowBuilds:" pnpm-workspace.yaml && grep -q "blockExoticSubdeps: true" pnpm-workspace.yaml; then
            echo "âœ… pnpm security configuration is present"
          else
            echo "âŒ pnpm security configuration missing"
            exit 1
          fi

      - name: Build
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            pnpm turbo run build --filter="...[origin/main]"
          else
            pnpm turbo run build
          fi

      # Optimized test execution with parallelization and caching
      - name: Test
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # Run tests in parallel for PRs with affected packages only
            pnpm turbo run test --filter="...[origin/main]" --parallel
          else
            # Full test suite with parallel execution and coverage
            pnpm test:coverage --reporter=verbose
          fi

      # [SECURITY] Automated vulnerability scanning - FAIL on high/critical vulnerabilities
      # This implements 2026 security best practices for supply chain security
      - name: Dependency vulnerability scan (Blocking)
        run: |
          echo "ğŸ”’ Running security vulnerability scan..."
          pnpm audit --audit-level high
          echo "âœ… No high or critical vulnerabilities found"

      # Accessibility tests â€” ensures WCAG 2.2 AA compliance
      - name: Accessibility (a11y)
        run: pnpm test:a11y

  security-gates:
    name: security-gates
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.29.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Semgrep security scan (blocking)
        run: pnpm lint:security

      - name: Dependency SCA scan (blocking)
        run: pnpm audit --audit-level high

      - name: Build security SAST workflow validation
        run: |
          test -f .github/workflows/security-sast.yml
          test -f .semgrep/security-rules.yml

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Informative audit steps â€” non-blocking, continue-on-error
  # Run in parallel with quality-gates for visibility without blocking merge
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  quality-audit:
    name: quality-audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.29.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # [Task 0.17] Dead code/dependency detection
      - name: Knip
        continue-on-error: true
        run: pnpm knip

      # [Task 2.7.4] SBOM generation for supply chain visibility
      - name: Generate SBOM
        continue-on-error: true
        uses: anchore/sbom-action@v0
        with:
          path: '.'
          format: 'spdx-json'
          output-file: 'sbom.spdx.json'

      - name: Upload SBOM artifact
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: sbom-spdx
          path: sbom.spdx.json

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # E2E Testing â€” comprehensive end-to-end validation
  # Runs after quality gates pass, non-blocking for PRs but required for main
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  e2e-tests:
    name: e2e-tests
    needs: [quality-gates, security-gates]
    runs-on: ubuntu-latest
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        # Run on main branch, on PRs only if files changed
        shard: [1, 2, 3]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.29.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps

      - name: Build application
        run: pnpm build

      - name: Start application
        run: |
          pnpm dev &
          sleep 10

      - name: Wait for application to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3101/api/health; do sleep 2; done'

      - name: Run E2E tests (shard ${{ matrix.shard }})
        run: pnpm test:e2e --shard=${{ matrix.shard }} --reporter=json --reporter=html

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results-shard-${{ matrix.shard }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7

      - name: Upload E2E test videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-videos-shard-${{ matrix.shard }}
          path: test-results/
          retention-days: 3

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # E2E Test Summary â€” aggregates results from all shards
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  e2e-summary:
    name: e2e-summary
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: always() && needs.e2e-tests.result != 'skipped'
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all E2E test results
        uses: actions/download-artifact@v4
        with:
          pattern: e2e-results-shard-*
          merge-multiple: true

      - name: Merge test results
        run: |
          npx playwright merge-reports test-results/ --reporter=html

      - name: Upload merged E2E report
        uses: actions/upload-artifact@v4
        with:
          name: e2e-report-merged
          path: playwright-report/
          retention-days: 7

      - name: Check E2E test status
        run: |
          # Check if any tests failed
          if [ -f "test-results.json" ]; then
            failed=$(cat test-results.json | jq '.suites[].specs[].tests[] | select(.results[].status == "failed") | length')
            echo "Failed E2E tests: $failed"
            if [ "$failed" -gt 0 ]; then
              echo "::error::E2E tests failed"
              exit 1
            fi
          else
            echo "No test results found"
            exit 1
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # License compliance audit (informative)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  license-audit:
    name: license-audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.29.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: License audit
        continue-on-error: true
        run: pnpm dlx license-checker --summary
