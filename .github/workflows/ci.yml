# CI — Marketing Website Monorepo
#
# [Task 0.13] Strengthened quality gates with clear pass/fail separation,
# affected-package optimization for PRs, and nightly full-repo validation.
#
# Blocking checks: lint, type-check, validate-exports, syncpack, build, test
# Non-blocking: knip, SBOM, dependency audit (informative)
#
# Branch protection: Require "quality-gates" job to pass before merge.
# See docs/ci/required-checks.md for configuration details.

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# [Task 2.7.2] Cancel stale CI runs for the same branch/PR
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  # Blocking quality gates — must pass for merge
  # Map this job name to branch protection "Require status checks"
  # ─────────────────────────────────────────────────────────────────────────
  quality-gates:
    name: quality-gates
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        node-version: [22.x]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # [Task 0.13] Full history required for turbo affected-package detection
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.29.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # [Task 0.7] Workspace sync validation — ensures package.json and pnpm-workspace.yaml match
      - name: Validate workspaces
        run: pnpm validate:workspaces

      # [Task 0.11] Lint enforces module boundaries — docs/architecture/module-boundaries.md
      # [Task 0.13] PRs use affected-package filter for speed; push runs full pipeline
      - name: Lint
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            pnpm turbo run lint --filter="...[origin/main]"
          else
            pnpm turbo run lint
          fi

      # Code formatting check — ensures consistent style
      - name: Format check
        run: pnpm format:check

      - name: Type check
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            pnpm turbo run type-check --filter="...[origin/main]"
          else
            pnpm turbo run type-check
          fi

      # [Task 0.19] Export map validation — prevents broken package export paths
      - name: Validate exports
        run: pnpm validate-exports

      # @repo/marketing-components index.ts → component family validation
      - name: Validate marketing exports
        run: pnpm validate-marketing-exports

      # [Task 5-*] Validate all clients (CaCA contract, site.config, routes, cross-client imports)
      - name: Validate clients
        run: pnpm validate-all-clients

      # Circular dependency detection — blocks merge if cycles exist
      - name: Madge (circular deps)
        run: pnpm madge:circular

      # [Task 0.18] Dependency version consistency across workspace
      - name: Syncpack
        run: pnpm syncpack:check

      - name: Build
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            pnpm turbo run build --filter="...[origin/main]"
          else
            pnpm turbo run build
          fi

      # Root jest runs full monorepo test suite (jest.config.js discovers all __tests__)
      - name: Test
        run: pnpm test:coverage

      # Accessibility tests — ensures WCAG 2.2 AA compliance
      - name: Accessibility (a11y)
        run: pnpm test:a11y

  # ─────────────────────────────────────────────────────────────────────────
  # Informative audit steps — non-blocking, continue-on-error
  # Run in parallel with quality-gates for visibility without blocking merge
  # ─────────────────────────────────────────────────────────────────────────
  quality-audit:
    name: quality-audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.29.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # [Task 0.17] Dead code/dependency detection
      - name: Knip
        continue-on-error: true
        run: pnpm knip

      # [Task 2.7.4] SBOM generation for supply chain visibility
      - name: Generate SBOM
        continue-on-error: true
        uses: anchore/sbom-action@v0
        with:
          path: '.'
          format: 'spdx-json'
          output-file: 'sbom.spdx.json'

      - name: Upload SBOM artifact
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: sbom-spdx
          path: sbom.spdx.json
          retention-days: 90

      # OWASP-aligned dependency vulnerability scan
      - name: Dependency vulnerability scan
        continue-on-error: true
        run: |
          pnpm audit --audit-level high || echo "⚠️ High or critical vulnerabilities detected"

      # License compliance audit (informative)
      - name: License audit
        continue-on-error: true
        run: pnpm dlx license-checker --summary
