# Task: [D.8] Dependency provenance and integrity checks
# Runs: pnpm audit (fail on high+), syncpack (version consistency), lockfile verification

name: Dependency Integrity

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 8 * * 1' # Weekly Monday 8am

jobs:
  dependency-integrity:
    name: Dependency integrity
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 10.29.2
      - uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: pnpm
      - name: Install (frozen lockfile)
        run: pnpm install --frozen-lockfile
      - name: Version consistency (syncpack)
        run: pnpm syncpack:check
      - name: Vulnerability audit
        run: pnpm audit --audit-level high

  # [SECURITY] Vulnerability alert notifications for high/critical findings
  vulnerability-alerts:
    name: Vulnerability Alerts
    runs-on: ubuntu-latest
    needs: dependency-integrity
    if: failure() && github.event_name == 'schedule'

    steps:
      - name: Notify security team of vulnerabilities
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#security'
          text: |
            ðŸš¨ **SECURITY ALERT** ðŸš¨

            High or critical vulnerabilities detected in marketing-websites repository!

            **Action Required:** Immediate review and remediation needed
            **Workflow:** Dependency Integrity Scan
            **Branch:** ${{ github.ref_name }}
            **Time:** ${{ github.event.head_commit.timestamp }}

            Please review the workflow results and address vulnerabilities immediately.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SECURITY_SLACK_WEBHOOK_URL }}

      - name: Create security issue for tracking
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Security Vulnerabilities Detected - ${new Date().toISOString().split('T')[0]}`,
              body: `
            ## ðŸš¨ Security Vulnerability Alert
            **Date:** ${new Date().toISOString()}
            **Workflow:** Dependency Integrity Scan
            **Branch:** ${context.ref}
            **Commit:** ${context.sha}

            ### Action Required
            High or critical vulnerabilities have been detected in the dependency chain.
            Immediate review and remediation is required.

            ### Next Steps
            1. Review the failed workflow: ${context.payload.repository.html_url}/actions/runs/${context.runId}
            2. Run \`pnpm audit\` locally to identify affected packages
            3. Update dependencies to secure versions
            4. Test updates thoroughly before deployment
            5. Monitor for any breaking changes

            ### Security Policy
            This alert is generated automatically as part of our 2026 security compliance program.
            All high/critical vulnerabilities must be addressed within 7 days.

            ---
            *This issue was created automatically by the dependency integrity workflow.*
            `,
              labels: ['security', 'vulnerability', 'high-priority']
            });

            console.log(`Created security issue: #${issue.data.number}`);
