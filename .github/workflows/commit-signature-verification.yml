name: Commit Signature Verification

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

permissions:
  contents: read

jobs:
  verify-signatures:
    name: Verify commit signatures
    runs-on: ubuntu-latest
    steps:
      - name: Check commit signature status via GitHub API
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo;
            let commits = [];

            if (context.eventName === 'pull_request') {
              const prNumber = context.payload.pull_request.number;
              commits = await github.paginate(github.rest.pulls.listCommits, {
                owner: repo.owner,
                repo: repo.repo,
                pull_number: prNumber,
                per_page: 100,
              });
            } else {
              commits = await github.paginate(github.rest.repos.listCommits, {
                owner: repo.owner,
                repo: repo.repo,
                sha: context.ref.replace('refs/heads/', ''),
                per_page: 20,
              });
              commits = commits.filter((commit) => commit.sha === context.sha);
            }

            if (!commits.length) {
              core.setFailed('No commits found to verify.');
              return;
            }

            const invalid = commits
              .map((commit) => ({
                sha: commit.sha,
                verified: commit.commit?.verification?.verified,
                reason: commit.commit?.verification?.reason,
              }))
              .filter((entry) => !entry.verified);

            if (invalid.length) {
              core.setFailed(
                `Unsigned or unverified commits detected:\n${invalid
                  .map((entry) => `${entry.sha} (${entry.reason || 'unknown'})`)
                  .join('\n')}`,
              );
              return;
            }

            core.info(`All ${commits.length} commit(s) are signature-verified.`);
