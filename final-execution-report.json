{
  "timestamp": "2026-02-23T21:19:06.072Z",
  "domainsProcessed": 28,
  "successfulDomains": 28,
  "totalTasksCreated": 123,
  "averageQualityScore": 100,
  "duration": 14.69,
  "results": [
    {
      "domainNumber": 9,
      "success": true,
      "tasksCreated": 5,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 9,
          "fileName": "DOMAIN-9-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-9\\DOMAIN-9-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "9.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 9 section philosophy.md",
            "topics": ["Domain 9 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 9.1 Philosophy\n\n**What it is:** Every marketing site generates leads â€” form submissions, phone clicks, booking requests, live chat messages. The attribution system captures first-touch and last-touch UTM data, assigns a score (0â€“100) to each lead, and routes high-scoring leads to immediate notification. [tdstats](https://www.tdstats.com/posts/practical-multi-touch-attribution-for-smbs/)\n\n**Why it matters:** Without attribution, clients cannot tell which marketing spend generates leads. A lead from Google Ads has different ROI than one from organic search. The platform captures full UTM data at session start (first touch) and at form submission (last touch) â€” enabling both models without a third-party attribution service.\n\n**Lead scoring model:** 100-point scale. Score â‰¥ 70 = qualified (immediate notification + Zapier/HubSpot push). Score 40â€“69 = warm (daily digest email). Score < 40 = cold (weekly report).\n\n---\n",
            "domainNumber": 9
          }
        },
        {
          "domainNumber": 9,
          "fileName": "DOMAIN-9-session-section-session.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-9\\DOMAIN-9-session-section-session.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "9.2-session-attribution-store.md",
            "title": "Section session",
            "description": "Implementation for domain 9 section session",
            "topics": ["Domain 9 implementation"],
            "sectionNumber": "session",
            "content": "### 9.2 Session Attribution Store\n\n**File:** `packages/analytics/src/session-attribution.ts`\n\n```typescript\n'use client';\n\n// ============================================================================\n// SESSION ATTRIBUTION MANAGER\n// Captures UTM parameters and referrer on landing, stores in sessionStorage.\n// On form submission, reads stored data as \"last touch.\"\n// On first visit ONLY, persists to localStorage as \"first touch.\"\n// ============================================================================\n\nexport type AttributionData = {\n  utmSource: string | null;\n  utmMedium: string | null;\n  utmCampaign: string | null;\n  utmContent: string | null;\n  utmTerm: string | null;\n  referrerUrl: string | null;\n  landingPage: string;\n  capturedAt: string;\n};\n\nconst FIRST_TOUCH_KEY = 'attribution_first_touch';\nconst LAST_TOUCH_KEY = 'attribution_last_touch';\n\nfunction extractUTMFromURL(\n  url: URL\n): Omit<AttributionData, 'referrerUrl' | 'landingPage' | 'capturedAt'> {\n  return {\n    utmSource: url.searchParams.get('utm_source'),\n    utmMedium: url.searchParams.get('utm_medium'),\n    utmCampaign: url.searchParams.get('utm_campaign'),\n    utmContent: url.searchParams.get('utm_content'),\n    utmTerm: url.searchParams.get('utm_term'),\n  };\n}\n\nexport function captureAttribution(): void {\n  if (typeof window === 'undefined') return;\n\n  const url = new URL(window.location.href);\n  const utmData = extractUTMFromURL(url);\n  const hasUTM = Object.values(utmData).some(Boolean);\n\n  const attribution: AttributionData = {\n    ...utmData,\n    referrerUrl: document.referrer || null,\n    landingPage: window.location.pathname + window.location.search,\n    capturedAt: new Date().toISOString(),\n  };\n\n  // Last touch: always update (every page load with UTM data)\n  if (hasUTM) {\n    sessionStorage.setItem(LAST_TOUCH_KEY, JSON.stringify(attribution));\n  }\n\n  // First touch: only set once per browser (never overwrite)\n  const existingFirstTouch = localStorage.getItem(FIRST_TOUCH_KEY);\n  if (!existingFirstTouch && (hasUTM || document.referrer)) {\n    localStorage.setItem(FIRST_TOUCH_KEY, JSON.stringify(attribution));\n  }\n}\n\nexport function getFirstTouch(): AttributionData | null {\n  if (typeof window === 'undefined') return null;\n  try {\n    const raw = localStorage.getItem(FIRST_TOUCH_KEY);\n    return raw ? JSON.parse(raw) : null;\n  } catch {\n    return null;\n  }\n}\n\nexport function getLastTouch(): AttributionData | null {\n  if (typeof window === 'undefined') return null;\n  try {\n    const raw = sessionStorage.getItem(LAST_TOUCH_KEY);\n    return raw ? JSON.parse(raw) : null;\n  } catch {\n    return null;\n  }\n}\n\nexport function getAttributionForSubmission(): {\n  firstTouch: AttributionData | null;\n  lastTouch: AttributionData | null;\n} {\n  return {\n    firstTouch: getFirstTouch(),\n    lastTouch: getLastTouch(),\n  };\n}\n```\n\n---\n",
            "domainNumber": 9
          }
        },
        {
          "domainNumber": 9,
          "fileName": "DOMAIN-9-lead-section-lead.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-9\\DOMAIN-9-lead-section-lead.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "9.3-lead-scoring-engine.md",
            "title": "Section lead",
            "description": "Implementation for domain 9 section lead",
            "topics": ["Domain 9 implementation"],
            "sectionNumber": "lead",
            "content": "### 9.3 Lead Scoring Engine\n\n**File:** `packages/lead-capture/src/scoring.ts`\n\n```typescript\nimport { Redis } from '@upstash/redis';\nimport type { SiteConfig } from '@repo/config-schema';\nimport type { AttributionData } from '@repo/analytics/session-attribution';\n\nconst redis = Redis.fromEnv();\n\n// ============================================================================\n// SCORING MODEL (0â€“100)\n// Designed to mimic intent signals used by enterprise marketing automation\n// without requiring a third-party service\n// ============================================================================\n\nexport type ScoringInput = {\n  tenantId: string;\n  // Behavioral signals\n  sessionPageViews: number;\n  sessionDurationSeconds: number;\n  hasPhoneClick: boolean;\n  hasBookingClick: boolean;\n  hasLiveChat: boolean;\n  isRepeatVisitor: boolean;\n  // Attribution signals\n  attribution: {\n    firstTouch: AttributionData | null;\n    lastTouch: AttributionData | null;\n  };\n  // Demographic/firmographic signals (from form data)\n  hasPhone: boolean;\n  messageLength: number; // Characters â€” longer = higher intent\n  // Time signals\n  submittedAt: Date;\n};\n\n// Source value map (calibrated from industry benchmarks)\nconst SOURCE_SCORES: Record<string, number> = {\n  // Paid intent-rich sources = highest score\n  'google-ads': 20,\n  google: 20,\n  cpc: 20,\n  ppc: 20,\n\n  // Social paid\n  'facebook-ads': 15,\n  'instagram-ads': 15,\n  'linkedin-ads': 18,\n\n  // Organic (moderate intent â€” user found you naturally)\n  organic: 10,\n  seo: 10,\n\n  // Referral (trusted recommendation)\n  referral: 12,\n\n  // Email (warm â€” existing relationship)\n  email: 14,\n\n  // Direct (returning, knows the brand)\n  direct: 8,\n\n  // Social organic (lower intent)\n  social: 5,\n  facebook: 5,\n  instagram: 5,\n\n  // Default (unknown source)\n  default: 5,\n};\n\nexport function scoreLeadSync(input: ScoringInput): number {\n  let score = 0;\n\n  // â”€â”€ Behavioral signals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // Each page view beyond 1 adds points (shows research intent)\n  score += Math.min(input.sessionPageViews * 3, 15);\n\n  // Session duration (2+ minutes = engaged visitor)\n  if (input.sessionDurationSeconds >= 120) score += 5;\n  if (input.sessionDurationSeconds >= 300) score += 5;\n  if (input.sessionDurationSeconds >= 600) score += 5;\n\n  // High-intent actions\n  if (input.hasPhoneClick) score += 20; // Called = highest intent\n  if (input.hasBookingClick) score += 15; // Booked = very high intent\n  if (input.hasLiveChat) score += 10; // Chatted = engaged\n\n  // Return visitor (knows the brand)\n  if (input.isRepeatVisitor) score += 5;\n\n  // â”€â”€ Attribution signals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const lastTouchSource = input.attribution.lastTouch?.utmSource?.toLowerCase() ?? 'default';\n  const lastTouchMedium = input.attribution.lastTouch?.utmMedium?.toLowerCase() ?? '';\n\n  // Source value\n  const sourceScore =\n    SOURCE_SCORES[lastTouchSource] ?? SOURCE_SCORES[lastTouchMedium] ?? SOURCE_SCORES.default;\n  score += sourceScore;\n\n  // Campaign-level boost (branded campaign = higher intent)\n  const campaign = input.attribution.lastTouch?.utmCampaign?.toLowerCase() ?? '';\n  if (campaign.includes('brand') || campaign.includes('emergency') || campaign.includes('urgent')) {\n    score += 5;\n  }\n\n  // â”€â”€ Form quality signals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // Phone number provided = willing to be called\n  if (input.hasPhone) score += 10;\n\n  // Message length proxy for intent (50+ chars = serious inquiry)\n  if (input.messageLength >= 50) score += 5;\n  if (input.messageLength >= 150) score += 5;\n  if (input.messageLength >= 300) score += 5;\n\n  // â”€â”€ Time-of-day signal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // Business hours submission = more likely to be a genuine business inquiry\n  const hour = input.submittedAt.getHours();\n  const isBusinessHours = hour >= 8 && hour < 18;\n  if (isBusinessHours) score += 3;\n\n  // Cap at 100\n  return Math.min(Math.round(score), 100);\n}\n\n// Async version: fetches behavioral data from Redis session store\nexport async function scoreLead(params: {\n  tenantId: string;\n  sessionId: string;\n  attribution: ScoringInput['attribution'];\n  hasPhone: boolean;\n  messageLength: number;\n}): Promise<number> {\n  const sessionKey = `session:${params.sessionId}`;\n\n  // Read behavioral data accumulated by client-side tracking\n  const sessionData = await redis.hgetall<{\n    pageViews: string;\n    durationSeconds: string;\n    hasPhoneClick: string;\n    hasBookingClick: string;\n    hasLiveChat: string;\n    isRepeatVisitor: string;\n  }>(sessionKey);\n\n  return scoreLeadSync({\n    tenantId: params.tenantId,\n    sessionPageViews: Number(sessionData?.pageViews ?? 1),\n    sessionDurationSeconds: Number(sessionData?.durationSeconds ?? 0),\n    hasPhoneClick: sessionData?.hasPhoneClick === 'true',\n    hasBookingClick: sessionData?.hasBookingClick === 'true',\n    hasLiveChat: sessionData?.hasLiveChat === 'true',\n    isRepeatVisitor: sessionData?.isRepeatVisitor === 'true',\n    attribution: params.attribution,\n    hasPhone: params.hasPhone,\n    messageLength: params.messageLength,\n    submittedAt: new Date(),\n  });\n}\n\n// ============================================================================\n// ROUTING LOGIC\n// ============================================================================\n\nexport type LeadTier = 'qualified' | 'warm' | 'cold';\n\nexport function classifyLead(score: number): LeadTier {\n  if (score >= 70) return 'qualified';\n  if (score >= 40) return 'warm';\n  return 'cold';\n}\n```\n\n---\n",
            "domainNumber": 9
          }
        },
        {
          "domainNumber": 9,
          "fileName": "DOMAIN-9-phone-section-phone.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-9\\DOMAIN-9-phone-section-phone.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "9.4-phone-click-tracker-server-action.md",
            "title": "Section phone",
            "description": "Implementation for domain 9 section phone",
            "topics": ["Domain 9 implementation"],
            "sectionNumber": "phone",
            "content": "### 9.4 Phone Click Tracker (Server Action)\n\n```typescript\n// packages/analytics/src/track-phone-click.ts\n'use server';\n\nimport { z } from 'zod';\nimport { createServerAction } from '@repo/auth/server-action-wrapper';\nimport { db } from '@repo/db';\nimport { Redis } from '@upstash/redis';\n\nconst redis = Redis.fromEnv();\n\nconst PhoneClickSchema = z.object({\n  sessionId: z.string().min(1).max(100),\n  phoneNumber: z.string().max(20),\n  pagePath: z.string().max(200),\n});\n\nexport const trackPhoneClick = createServerAction(PhoneClickSchema, async (input, ctx) => {\n  // 1. Store in DB for reporting\n  await db.from('phone_click_events').insert({\n    tenant_id: ctx.tenantId,\n    session_id: input.sessionId,\n    phone_number: input.phoneNumber,\n    page_path: input.pagePath,\n  });\n\n  // 2. Update session behavioral data in Redis (feeds lead scoring)\n  await redis.hset(`session:${input.sessionId}`, {\n    hasPhoneClick: 'true',\n  });\n\n  // 3. Tinybird event (real-time analytics)\n  const tbToken = process.env.TINYBIRD_TOKEN;\n  if (tbToken) {\n    await fetch(`https://api.tinybird.co/v0/events?name=phone_clicks&token=${tbToken}`, {\n      method: 'POST',\n      body: JSON.stringify({\n        tenant_id: ctx.tenantId,\n        session_id: input.sessionId,\n        page_path: input.pagePath,\n        timestamp: new Date().toISOString(),\n      }),\n    });\n  }\n\n  return { tracked: true };\n});\n```\n\n**Phone number component with click tracking:**\n\n```typescript\n// packages/ui/src/marketing/TrackedPhoneLink.tsx\n'use client';\n\nimport { trackPhoneClick } from '@repo/analytics/track-phone-click';\nimport { useSessionId } from '@repo/analytics/session';\n\nexport function TrackedPhoneLink({\n  phoneNumber,\n  displayNumber,\n  className,\n}: {\n  phoneNumber: string;\n  displayNumber: string;\n  className?: string;\n}) {\n  const sessionId = useSessionId();\n\n  const handleClick = async () => {\n    await trackPhoneClick({\n      sessionId,\n      phoneNumber,\n      pagePath: window.location.pathname,\n    });\n  };\n\n  return (\n    <a\n      href={`tel:${phoneNumber}`}\n      className={className}\n      onClick={handleClick}\n      aria-label={`Call us at ${displayNumber}`}\n      data-track=\"phone_click\"\n    >\n      {displayNumber}\n    </a>\n  );\n}\n```\n\n---\n",
            "domainNumber": 9
          }
        },
        {
          "domainNumber": 9,
          "fileName": "DOMAIN-9-lead-section-lead.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-9\\DOMAIN-9-lead-section-lead.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "9.5-lead-notification-system.md",
            "title": "Section lead",
            "description": "Implementation for domain 9 section lead",
            "topics": ["Domain 9 implementation"],
            "sectionNumber": "lead",
            "content": "### 9.5 Lead Notification System\n\n**File:** `packages/email/src/lead-notification.ts`\n\n```typescript\nimport { Resend } from 'resend';\nimport { classifyLead } from '@repo/lead-capture/scoring';\nimport { db } from '@repo/db';\nimport { Redis } from '@upstash/redis';\n\nconst resend = new Resend(process.env.RESEND_API_KEY!);\nconst redis = Redis.fromEnv();\n\nexport type LeadNotificationPayload = {\n  tenantId: string;\n  leadId: string;\n  name: string;\n  email: string;\n  phone?: string;\n  message: string;\n  score: number;\n  attribution: {\n    firstTouch: { utmSource?: string; utmCampaign?: string; landingPage: string } | null;\n    lastTouch: { utmSource?: string; utmCampaign?: string; landingPage: string } | null;\n  };\n};\n\nexport async function sendLeadNotification(tenantId: string, leadId: string): Promise<void> {\n  // Fetch full lead data\n  const { data: lead } = await db\n    .from('leads')\n    .select('*')\n    .eq('id', leadId)\n    .eq('tenant_id', tenantId)\n    .single();\n\n  if (!lead) return;\n\n  // Fetch tenant notification config\n  const { data: tenant } = await db.from('tenants').select('config').eq('id', tenantId).single();\n\n  const config = tenant?.config as any;\n  const notificationEmail = config?.notifications?.leadEmail ?? config?.identity?.contact?.email;\n\n  if (!notificationEmail) return;\n\n  const tier = classifyLead(lead.score);\n\n  // Qualified leads: immediate notification\n  // Warm leads: batched in daily digest (see Â§9.6)\n  // Cold leads: weekly report only\n  if (tier !== 'qualified') return;\n\n  const scoreEmoji = lead.score >= 80 ? 'ðŸ”¥' : lead.score >= 60 ? 'âš¡' : 'ðŸ“‹';\n  const tierLabel = tier === 'qualified' ? 'ðŸŽ¯ Qualified Lead' : 'ðŸ”µ New Lead';\n\n  await resend.emails.send({\n    from: `Lead Alerts <leads@mail.youragency.com>`,\n    to: [notificationEmail],\n    replyTo: lead.email,\n    subject: `${scoreEmoji} ${tierLabel}: ${lead.name} â€” Score ${lead.score}/100`,\n    html: buildLeadEmailHTML({ lead, config }),\n    text: buildLeadEmailText({ lead }),\n    tags: [\n      { name: 'tenant_id', value: tenantId },\n      { name: 'lead_tier', value: tier },\n      { name: 'lead_score', value: String(lead.score) },\n    ],\n  });\n\n  // Record notification sent\n  await db.from('audit_logs').insert({\n    tenant_id: tenantId,\n    action: 'lead.notification_sent',\n    table_name: 'leads',\n    record_id: leadId,\n    new_data: { notificationEmail, tier, score: lead.score },\n  });\n}\n\nfunction buildLeadEmailHTML({ lead, config }: { lead: any; config: any }): string {\n  const tier = classifyLead(lead.score);\n  const tierColor = tier === 'qualified' ? '#059669' : tier === 'warm' ? '#d97706' : '#6b7280';\n\n  return `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n</head>\n<body style=\"margin: 0; padding: 0; background: #f9fafb; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\">\n  <div style=\"max-width: 600px; margin: 0 auto; padding: 32px 16px;\">\n\n    <!-- Header -->\n    <div style=\"background: ${tierColor}; border-radius: 12px 12px 0 0; padding: 24px; text-align: center;\">\n      <p style=\"margin: 0; color: white; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;\">\n        ${tier === 'qualified' ? 'ðŸŽ¯ Qualified Lead Alert' : 'ðŸ“‹ New Lead'}\n      </p>\n      <h1 style=\"margin: 8px 0 0; color: white; font-size: 28px; font-weight: 700;\">${lead.name}</h1>\n    </div>\n\n    <!-- Score Card -->\n    <div style=\"background: white; border: 1px solid #e5e7eb; padding: 24px; display: flex; align-items: center; gap: 24px;\">\n      <div style=\"text-align: center;\">\n        <div style=\"font-size: 48px; font-weight: 800; color: ${tierColor}; line-height: 1;\">${lead.score}</div>\n        <div style=\"font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;\">Lead Score</div>\n      </div>\n      <div style=\"flex: 1;\">\n        <p style=\"margin: 0 0 4px; font-size: 13px; color: #6b7280;\">Contact</p>\n        <p style=\"margin: 0; font-weight: 600;\"><a href=\"mailto:${lead.email}\" style=\"color: #2563eb;\">${lead.email}</a></p>\n        ${lead.phone ? `<p style=\"margin: 4px 0 0;\"><a href=\"tel:${lead.phone}\" style=\"color: #2563eb; font-weight: 600;\">${lead.phone}</a></p>` : ''}\n      </div>\n    </div>\n\n    <!-- Message -->\n    <div style=\"background: white; border: 1px solid #e5e7eb; border-top: none; padding: 24px;\">\n      <p style=\"margin: 0 0 8px; font-size: 13px; color: #6b7280; font-weight: 600; text-transform: uppercase;\">Message</p>\n      <p style=\"margin: 0; color: #111827; line-height: 1.6; white-space: pre-wrap;\">${lead.message}</p>\n    </div>\n\n    <!-- Attribution -->\n    <div style=\"background: #f9fafb; border: 1px solid #e5e7eb; border-top: none; padding: 20px; border-radius: 0 0 12px 12px;\">\n      <p style=\"margin: 0 0 12px; font-size: 12px; color: #9ca3af; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;\">Attribution</p>\n      <table style=\"width: 100%; font-size: 13px; border-collapse: collapse;\">\n        <tr>\n          <td style=\"padding: 4px 12px 4px 0; color: #6b7280; white-space: nowrap;\">First Touch</td>\n          <td style=\"padding: 4px 0; color: #111827;\">${lead.utm_source_first ?? 'Direct'} ${lead.utm_campaign_first ? `/ ${lead.utm_campaign_first}` : ''}</td>\n        </tr>\n        <tr>\n          <td style=\"padding: 4px 12px 4px 0; color: #6b7280; white-space: nowrap;\">Last Touch</td>\n          <td style=\"padding: 4px 0; color: #111827;\">${lead.utm_source ?? 'Direct'} ${lead.utm_campaign ? `/ ${lead.utm_campaign}` : ''}</td>\n        </tr>\n        <tr>\n          <td style=\"padding: 4px 12px 4px 0; color: #6b7280; white-space: nowrap;\">Landing Page</td>\n          <td style=\"padding: 4px 0; color: #111827;\">${lead.landing_page ?? '/'}</td>\n        </tr>\n        <tr>\n          <td style=\"padding: 4px 12px 4px 0; color: #6b7280; white-space: nowrap;\">Source</td>\n          <td style=\"padding: 4px 0; color: #111827;\">${lead.source ?? 'contact_form'}</td>\n        </tr>\n      </table>\n    </div>\n\n    <!-- CTA -->\n    <div style=\"text-align: center; margin-top: 24px;\">\n      <a\n        href=\"${process.env.NEXT_PUBLIC_PORTAL_URL}/leads/${lead.id}\"\n        style=\"display: inline-block; background: ${tierColor}; color: white; padding: 14px 32px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 15px;\"\n      >\n        View Lead in Portal â†’\n      </a>\n    </div>\n\n    <p style=\"text-align: center; margin-top: 24px; font-size: 12px; color: #9ca3af;\">\n      ${config?.identity?.siteName} Â· Powered by YourAgency\n    </p>\n  </div>\n</body>\n</html>\n  `.trim();\n}\n\nfunction buildLeadEmailText({ lead }: { lead: any }): string {\n  return `\nNew Lead: ${lead.name}\nScore: ${lead.score}/100\n\nEmail: ${lead.email}\n${lead.phone ? `Phone: ${lead.phone}` : ''}\n\nMessage:\n${lead.message}\n\nAttribution:\n- First Touch: ${lead.utm_source_first ?? 'Direct'} / ${lead.utm_campaign_first ?? 'n/a'}\n- Last Touch: ${lead.utm_source ?? 'Direct'} / ${lead.utm_campaign ?? 'n/a'}\n- Landing Page: ${lead.landing_page ?? '/'}\n  `.trim();\n}\n```\n\n---\n",
            "domainNumber": 9
          }
        }
      ]
    },
    {
      "domainNumber": 10,
      "success": true,
      "tasksCreated": 1,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 10,
          "fileName": "DOMAIN-10-supabase-section-supabase.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-10\\DOMAIN-10-supabase-section-supabase.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "10.1-supabase-realtime-for-portal-lead-feed.md",
            "title": "Section supabase",
            "description": "Implementation for domain 10 section supabase",
            "topics": ["Domain 10 implementation"],
            "sectionNumber": "supabase",
            "content": "### 10.1 Supabase Realtime for Portal Lead Feed\n\n**File:** `apps/portal/src/features/leads/ui/LeadFeed.tsx`\n\n```typescript\n'use client';\n\nimport { createClient } from '@supabase/supabase-js';\nimport { useEffect, useState, useCallback } from 'react';\nimport type { Database } from '@repo/db';\nimport { classifyLead } from '@repo/lead-capture/scoring';\n\ntype Lead = Database['public']['Tables']['leads']['Row'];\n\n// ============================================================================\n// REALTIME LEAD FEED\n// Subscribes to INSERT events on the leads table for the current tenant.\n// New leads appear instantly without page refresh.\n// ============================================================================\n\nconst supabase = createClient<Database>(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\n);\n\nexport function LeadFeed({ tenantId }: { tenantId: string }) {\n  const [leads, setLeads] = useState<Lead[]>([]);\n  const [connectionStatus, setConnectionStatus] = useState<'connecting' | 'connected' | 'error'>('connecting');\n  const [newLeadIds, setNewLeadIds] = useState<Set<string>>(new Set());\n\n  // Initial load\n  useEffect(() => {\n    const loadLeads = async () => {\n      const { data } = await supabase\n        .from('leads')\n        .select('*')\n        .eq('tenant_id', tenantId)\n        .order('created_at', { ascending: false })\n        .limit(50);\n\n      if (data) setLeads(data);\n    };\n\n    loadLeads();\n  }, [tenantId]);\n\n  // Real-time subscription\n  useEffect(() => {\n    const channel = supabase\n      .channel(`leads:${tenantId}`)\n      .on(\n        'postgres_changes',\n        {\n          event: 'INSERT',\n          schema: 'public',\n          table: 'leads',\n          filter: `tenant_id=eq.${tenantId}`, // RLS + filter = double protection\n        },\n        (payload) => {\n          const newLead = payload.new as Lead;\n\n          // Prepend new lead to list\n          setLeads((prev) => [newLead, ...prev.slice(0, 49)]);\n\n          // Highlight new lead for 5 seconds\n          setNewLeadIds((prev) => new Set([...prev, newLead.id]));\n          setTimeout(() => {\n            setNewLeadIds((prev) => {\n              const next = new Set(prev);\n              next.delete(newLead.id);\n              return next;\n            });\n          }, 5000);\n\n          // Browser notification (if permission granted)\n          if (Notification.permission === 'granted') {\n            new Notification(`New Lead: ${newLead.name}`, {\n              body: `Score: ${newLead.score}/100 Â· ${newLead.email}`,\n              icon: '/favicon.ico',\n              tag: newLead.id, // Replace previous notification for same lead\n            });\n          }\n        }\n      )\n      .on(\n        'postgres_changes',\n        {\n          event: 'UPDATE',\n          schema: 'public',\n          table: 'leads',\n          filter: `tenant_id=eq.${tenantId}`,\n        },\n        (payload) => {\n          const updated = payload.new as Lead;\n          setLeads((prev) =>\n            prev.map((l) => (l.id === updated.id ? updated : l))\n          );\n        }\n      )\n      .subscribe((status) => {\n        if (status === 'SUBSCRIBED') setConnectionStatus('connected');\n        if (status === 'CLOSED') setConnectionStatus('error');\n        if (status === 'CHANNEL_ERROR') setConnectionStatus('error');\n      });\n\n    return () => {\n      supabase.removeChannel(channel);\n    };\n  }, [tenantId]);\n\n  return (\n    <div aria-label=\"Live lead feed\" aria-live=\"polite\" aria-atomic=\"false\">\n      {/* Connection status indicator */}\n      <div className=\"flex items-center gap-2 mb-4\" role=\"status\">\n        <div\n          className={`h-2 w-2 rounded-full ${\n            connectionStatus === 'connected'\n              ? 'bg-green-500 animate-pulse'\n              : connectionStatus === 'error'\n              ? 'bg-red-500'\n              : 'bg-yellow-500'\n          }`}\n          aria-hidden=\"true\"\n        />\n        <span className=\"text-sm text-gray-500 capitalize\">{connectionStatus}</span>\n      </div>\n\n      {/* Lead list */}\n      <ul className=\"space-y-3\" role=\"list\">\n        {leads.map((lead) => (\n          <LeadCard\n            key={lead.id}\n            lead={lead}\n            isNew={newLeadIds.has(lead.id)}\n          />\n        ))}\n      </ul>\n\n      {leads.length === 0 && (\n        <p className=\"text-gray-500 text-center py-12\">\n          No leads yet. Your first lead will appear here in real time.\n        </p>\n      )}\n    </div>\n  );\n}\n\nfunction LeadCard({ lead, isNew }: { lead: Lead; isNew: boolean }) {\n  const tier = classifyLead(lead.score);\n  const tierStyles = {\n    qualified: 'border-green-500 bg-green-50',\n    warm: 'border-amber-400 bg-amber-50',\n    cold: 'border-gray-200 bg-white',\n  };\n\n  return (\n    <li\n      className={`\n        border rounded-lg p-4 transition-all duration-500\n        ${tierStyles[tier]}\n        ${isNew ? 'ring-2 ring-blue-400 scale-[1.01]' : ''}\n      `}\n      aria-label={`Lead from ${lead.name}, score ${lead.score}`}\n    >\n      <div className=\"flex justify-between items-start\">\n        <div>\n          <p className=\"font-semibold text-gray-900\">{lead.name}</p>\n          <p className=\"text-sm text-gray-500\">{lead.email}</p>\n          {lead.phone && (\n            <a\n              href={`tel:${lead.phone}`}\n              className=\"text-sm text-blue-600 hover:underline\"\n            >\n              {lead.phone}\n            </a>\n          )}\n        </div>\n        <div className=\"text-right\">\n          <span\n            className={`\n              inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold\n              ${tier === 'qualified' ? 'bg-green-100 text-green-800' : ''}\n              ${tier === 'warm' ? 'bg-amber-100 text-amber-800' : ''}\n              ${tier === 'cold' ? 'bg-gray-100 text-gray-700' : ''}\n            `}\n          >\n            {lead.score}/100\n          </span>\n          <p className=\"text-xs text-gray-400 mt-1\">\n            {new Date(lead.created_at).toLocaleTimeString()}\n          </p>\n        </div>\n      </div>\n\n      {lead.message && (\n        <p className=\"mt-2 text-sm text-gray-600 line-clamp-2\">{lead.message}</p>\n      )}\n\n      {(lead.utm_source || lead.utm_source_first) && (\n        <div className=\"mt-2 flex gap-2 flex-wrap\">\n          {lead.utm_source_first && (\n            <span className=\"text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded\">\n              First: {lead.utm_source_first}\n            </span>\n          )}\n          {lead.utm_source && (\n            <span className=\"text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded\">\n              Last: {lead.utm_source}\n            </span>\n          )}\n        </div>\n      )}\n    </li>\n  );\n}\n```\n\n---\n\n## Priority Table for Domains 8â€“10\n\n| Task                                                 | Domain | Priority | Timeline | Success Metric                                     |\n| ---------------------------------------------------- | ------ | -------- | -------- | -------------------------------------------------- |\n| `generateTenantMetadata()` factory on all pages      | 8      | **P0**   | Day 5    | Google Rich Results Test passes                    |\n| LocalBusiness + FAQ JSON-LD on all homepages         | 8      | **P0**   | Day 5    | Schema validated, no errors                        |\n| `sitemap.ts` + `robots.ts` per tenant                | 8      | **P0**   | Day 5    | Sitemap indexed in GSC within 7 days               |\n| Dynamic OG image route (`/og`)                       | 8      | **P1**   | Week 2   | Twitter card validator passes                      |\n| Session attribution capture (`captureAttribution()`) | 9      | **P0**   | Day 4    | UTM data visible in lead records                   |\n| Lead scoring engine                                  | 9      | **P0**   | Day 5    | Score present on all new leads                     |\n| Lead notification email (qualified â‰¥70)              | 9      | **P0**   | Week 1   | Client receives email within 60s of submission     |\n| Phone click tracking                                 | 9      | **P1**   | Week 2   | Clicks appear in portal analytics                  |\n| Realtime lead feed in portal                         | 10     | **P1**   | Week 2   | New lead appears in <1s                            |\n| Sanity Draft Mode enable/disable routes              | 8      | **P1**   | Week 2   | Client editor can preview drafts                   |\n| `llms.txt` + `llms-full.txt` per tenant              | 8      | **P1**   | Week 2   | `/llms.txt` returns 200 with valid content         |\n| Edge A/B testing in middleware                       | 8      | **P2**   | Week 3   | CLS = 0 with variant assignment                    |\n| CMS structured data on blog posts (Article schema)   | 8      | **P1**   | Week 2   | Article schema in Google Rich Results Test         |\n| Breadcrumb schema on all inner pages                 | 8      | **P2**   | Week 3   | Breadcrumbs in Google SERP snippets                |\n| Daily digest email for warm leads                    | 9      | **P2**   | Week 3   | Warm leads batched and sent at 8am tenant TZ       |\n| Multi-touch attribution model in portal analytics    | 9      | **P2**   | Week 3   | First/last/linear attribution visible in dashboard |\n| `ai-context.json` per tenant                         | 8      | **P3**   | Month 2  | AI engines parsing structured context              |\n| Browser push notifications for portal                | 10     | **P3**   | Month 2  | Notification fires on new qualified lead           |\n\n---\n\n**Key architecture invariants across Domains 8â€“10:**\n\n- Every marketing page has exactly one `<script type=\"application/ld+json\">` per schema type â€” never duplicate the same `@type`. [shipped](https://shipped.club/blog/schema-org-nextjs-app-router)\n- Canonical URLs always use `config.deployment.canonicalUrl` as the base â€” never `window.location.href` (which varies by subdomain/custom domain). [jsdevspace.substack](https://jsdevspace.substack.com/p/how-to-configure-seo-in-nextjs-16)\n- `robots.ts` blocks all crawlers on non-production environments via `VERCEL_ENV` check â€” prevents staging content from being indexed. [nextjs](https://nextjs.org/docs/app/api-reference/file-conventions/metadata/robots)\n- Attribution data flows client â†’ sessionStorage/localStorage â†’ form submission payload â†’ DB `leads` table â€” no third-party cookie dependency. [tdstats](https://www.tdstats.com/posts/practical-multi-touch-attribution-for-smbs/)\n- Real-time subscriptions include the `tenant_id` filter at the Postgres layer in addition to RLS â€” defense-in-depth for data isolation.\n- GEO optimization (llms.txt, JSON-LD, citation-dense prose) is built from day one, not retrofitted â€” the marginal cost is low and the upside is compounding as AI-mediated search grows. [llms-txt](https://llms-txt.io/blog/what-is-generative-engine-optimization-geo)\n\n---\n\nNow I have full research coverage. Here are Domains 11â€“14 at complete production depth.\n\n---\n",
            "domainNumber": 10
          }
        }
      ]
    },
    {
      "domainNumber": 11,
      "success": true,
      "tasksCreated": 5,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 11,
          "fileName": "DOMAIN-11-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-11\\DOMAIN-11-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "11.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 11 section philosophy.md",
            "topics": ["Domain 11 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 11.1 Philosophy\n\n**What it is:** Stripe Billing manages recurring subscriptions for the platform itself (agency charging clients) and, optionally, pass-through billing where clients charge their own customers. The critical engineering challenge is webhook idempotency â€” Stripe retries failed webhooks for up to 3 days with exponential backoff, so every handler must be safe to execute multiple times with the same event. [docs.stripe](https://docs.stripe.com/billing/subscriptions/webhooks)\n\n**Why it matters:** A non-idempotent webhook handler can suspend an active tenant when a `customer.subscription.deleted` event fires twice, or charge a client twice when `invoice.payment_succeeded` processes a retry. A single production incident of either type destroys client trust.\n\n**Architecture:** Every Stripe event is written to `processed_webhooks` before processing (Domain 4 Â§4.4). Handler reads the record first â€” if it exists, returns `200` immediately without re-executing. This is the only reliable solution. [dev](https://dev.to/aniefon_umanah_ac5f21311c/building-reliable-stripe-subscriptions-in-nestjs-webhook-idempotency-and-optimistic-locking-3o91)\n\n---\n",
            "domainNumber": 11
          }
        },
        {
          "domainNumber": 11,
          "fileName": "DOMAIN-11-complete-section-complete.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-11\\DOMAIN-11-complete-section-complete.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "11.2-complete-stripe-webhook-handler.md",
            "title": "Section complete",
            "description": "Implementation for domain 11 section complete",
            "topics": ["Domain 11 implementation"],
            "sectionNumber": "complete",
            "content": "### 11.2 Complete Stripe Webhook Handler\n\n**File:** `apps/*/src/app/api/webhooks/stripe/route.ts`\n\n```typescript\nimport { NextRequest, NextResponse } from 'next/server';\nimport Stripe from 'stripe';\nimport { db } from '@repo/db';\nimport { updateBillingStatus } from '@repo/multi-tenant/check-billing';\nimport { invalidateTenantCache } from '@repo/multi-tenant/resolve-tenant';\nimport { sendBillingEmail } from '@repo/email';\nimport { Client as QStashClient } from '@upstash/qstash';\n\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {\n  apiVersion: '2025-11-27.acacia',\n});\n\nconst qstash = new QStashClient({ token: process.env.QSTASH_TOKEN! });\n\n// ============================================================================\n// WEBHOOK ROUTE\n// Edge Runtime: lowest cold-start latency for time-sensitive billing events\n// Must verify Stripe signature BEFORE reading body\n// ============================================================================\n\nexport const runtime = 'nodejs'; // Stripe SDK requires Node.js (crypto.createHmac)\nexport const dynamic = 'force-dynamic';\n\nexport async function POST(req: NextRequest) {\n  let event: Stripe.Event;\n\n  // â”€â”€ Step 1: Signature verification (MUST be first â€” before any parsing) â”€â”€\n  const body = await req.text(); // Raw body required for signature validation\n  const signature = req.headers.get('stripe-signature');\n\n  if (!signature) {\n    return NextResponse.json({ error: 'Missing signature' }, { status: 400 });\n  }\n\n  try {\n    event = stripe.webhooks.constructEvent(body, signature, process.env.STRIPE_WEBHOOK_SECRET!);\n  } catch (err) {\n    console.error('[Stripe Webhook] Signature verification failed:', err);\n    return NextResponse.json({ error: 'Invalid signature' }, { status: 400 });\n  }\n\n  // â”€â”€ Step 2: Idempotency check (prevents double-processing) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // Store event in DB first â€” if already exists, return 200 immediately\n  const { data: existing, error: checkError } = await db\n    .from('processed_webhooks')\n    .select('id')\n    .eq('provider', 'stripe')\n    .eq('event_id', event.id)\n    .maybeSingle();\n\n  if (existing) {\n    // Already processed â€” return 200 so Stripe stops retrying\n    console.log(`[Stripe Webhook] Duplicate event skipped: ${event.id}`);\n    return NextResponse.json({ received: true, duplicate: true });\n  }\n\n  // Insert idempotency record (will fail with unique constraint if race condition)\n  const { error: insertError } = await db.from('processed_webhooks').insert({\n    provider: 'stripe',\n    event_id: event.id,\n    event_type: event.type,\n  });\n\n  if (insertError) {\n    // Another instance beat us to it â€” safe to ignore\n    if (insertError.code === '23505') {\n      return NextResponse.json({ received: true, duplicate: true });\n    }\n    console.error('[Stripe Webhook] Failed to record event:', insertError);\n    return NextResponse.json({ error: 'DB error' }, { status: 500 });\n  }\n\n  // â”€â”€ Step 3: Route to handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  try {\n    await handleStripeEvent(event);\n    return NextResponse.json({ received: true });\n  } catch (err) {\n    // On handler failure: mark webhook as failed for retry\n    console.error(`[Stripe Webhook] Handler failed for ${event.type}:`, err);\n    // Return 500 â€” Stripe will retry\n    return NextResponse.json({ error: 'Handler failed' }, { status: 500 });\n  }\n}\n\n// ============================================================================\n// EVENT HANDLERS\n// ============================================================================\n\nasync function handleStripeEvent(event: Stripe.Event): Promise<void> {\n  switch (event.type) {\n    // â”€â”€ Subscription lifecycle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n    case 'customer.subscription.created':\n      await handleSubscriptionCreated(event.data.object as Stripe.Subscription);\n      break;\n\n    case 'customer.subscription.updated':\n      await handleSubscriptionUpdated(event.data.object as Stripe.Subscription);\n      break;\n\n    case 'customer.subscription.deleted':\n      await handleSubscriptionCancelled(event.data.object as Stripe.Subscription);\n      break;\n\n    // â”€â”€ Payment lifecycle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n    case 'invoice.payment_succeeded':\n      await handlePaymentSucceeded(event.data.object as Stripe.Invoice);\n      break;\n\n    case 'invoice.payment_failed':\n      await handlePaymentFailed(event.data.object as Stripe.Invoice);\n      break;\n\n    case 'invoice.upcoming':\n      // Pre-billing notice â€” send reminder email\n      await handleUpcomingInvoice(event.data.object as Stripe.Invoice);\n      break;\n\n    // â”€â”€ Customer portal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n    case 'billing_portal.session.created':\n      // No-op (audit log only)\n      console.log('[Stripe] Customer portal session created');\n      break;\n\n    // â”€â”€ Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n    case 'checkout.session.completed':\n      await handleCheckoutCompleted(event.data.object as Stripe.Checkout.Session);\n      break;\n\n    default:\n      // Log unhandled events (useful for discovering new events to handle)\n      console.log(`[Stripe Webhook] Unhandled event type: ${event.type}`);\n  }\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nasync function getTenantByStripeCustomer(customerId: string): Promise<string | null> {\n  const { data: tenant } = await db\n    .from('tenants')\n    .select('id')\n    .eq('stripe_customer_id', customerId)\n    .single();\n  return tenant?.id ?? null;\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nasync function handleSubscriptionCreated(sub: Stripe.Subscription): Promise<void> {\n  const tenantId = await getTenantByStripeCustomer(sub.customer as string);\n  if (!tenantId) return;\n\n  const tier = mapPriceToTier(sub.items.data[0]?.price.id ?? '');\n\n  await db\n    .from('tenants')\n    .update({\n      stripe_subscription_id: sub.id,\n      status: 'active',\n      billing_tier: tier,\n      updated_at: new Date().toISOString(),\n    })\n    .eq('id', tenantId);\n\n  await updateBillingStatus(tenantId, 'active');\n  await invalidateTenantCache(tenantId);\n\n  console.log(`[Stripe] Subscription created: tenant=${tenantId}, tier=${tier}`);\n}\n\nasync function handleSubscriptionUpdated(sub: Stripe.Subscription): Promise<void> {\n  const tenantId = await getTenantByStripeCustomer(sub.customer as string);\n  if (!tenantId) return;\n\n  const tier = mapPriceToTier(sub.items.data[0]?.price.id ?? '');\n\n  // Stripe subscription status: active, past_due, canceled, unpaid, trialing\n  const platformStatus = mapStripeStatusToPlatform(sub.status);\n\n  await db\n    .from('tenants')\n    .update({\n      status: platformStatus,\n      billing_tier: tier,\n      updated_at: new Date().toISOString(),\n    })\n    .eq('id', tenantId);\n\n  await updateBillingStatus(tenantId, platformStatus);\n  await invalidateTenantCache(tenantId);\n\n  // Notify client of plan change\n  if (platformStatus === 'active') {\n    await sendBillingEmail('plan_changed', tenantId, { newTier: tier });\n  }\n}\n\nasync function handleSubscriptionCancelled(sub: Stripe.Subscription): Promise<void> {\n  const tenantId = await getTenantByStripeCustomer(sub.customer as string);\n  if (!tenantId) return;\n\n  await updateBillingStatus(tenantId, 'cancelled');\n  await invalidateTenantCache(tenantId);\n\n  // Queue 30-day grace period deletion (GDPR data retention)\n  await qstash.publishJSON({\n    url: `${process.env.NEXT_PUBLIC_APP_URL}/api/internal/offboarding/queue`,\n    body: {\n      tenantId,\n      reason: 'billing_lapse',\n    },\n    delay: 60 * 60 * 24 * 30, // 30 days\n    retries: 3,\n  });\n\n  await sendBillingEmail('subscription_cancelled', tenantId, {\n    cancelledAt: new Date(sub.canceled_at! * 1000).toISOString(),\n  });\n\n  console.log(`[Stripe] Subscription cancelled: tenant=${tenantId}`);\n}\n\nasync function handlePaymentSucceeded(invoice: Stripe.Invoice): Promise<void> {\n  if (!invoice.subscription) return; // Skip one-time payments\n\n  const tenantId = await getTenantByStripeCustomer(invoice.customer as string);\n  if (!tenantId) return;\n\n  // Ensure status is active (payment failure might have suspended them)\n  await updateBillingStatus(tenantId, 'active');\n  await invalidateTenantCache(tenantId);\n\n  // Send receipt email via QStash (async â€” don't block webhook response)\n  await qstash.publishJSON({\n    url: `${process.env.NEXT_PUBLIC_APP_URL}/api/internal/email/billing-receipt`,\n    body: {\n      tenantId,\n      invoiceId: invoice.id,\n      amountPaid: invoice.amount_paid,\n      currency: invoice.currency,\n      hostedInvoiceUrl: invoice.hosted_invoice_url,\n    },\n  });\n}\n\nasync function handlePaymentFailed(invoice: Stripe.Invoice): Promise<void> {\n  if (!invoice.subscription) return;\n\n  const tenantId = await getTenantByStripeCustomer(invoice.customer as string);\n  if (!tenantId) return;\n\n  const attemptCount = invoice.attempt_count ?? 1;\n\n  // Graduated response to payment failure:\n  // Attempt 1: warning email, stay active\n  // Attempt 2: warning + payment method prompt, stay active\n  // Attempt 3+: suspend access\n  if (attemptCount >= 3) {\n    await updateBillingStatus(tenantId, 'suspended');\n    await invalidateTenantCache(tenantId);\n    await sendBillingEmail('account_suspended', tenantId, { attemptCount });\n  } else {\n    await sendBillingEmail('payment_failed', tenantId, {\n      attemptCount,\n      nextAttempt: invoice.next_payment_attempt\n        ? new Date(invoice.next_payment_attempt * 1000).toISOString()\n        : null,\n    });\n  }\n}\n\nasync function handleUpcomingInvoice(invoice: Stripe.Invoice): Promise<void> {\n  const tenantId = await getTenantByStripeCustomer(invoice.customer as string);\n  if (!tenantId) return;\n\n  await sendBillingEmail('upcoming_invoice', tenantId, {\n    amount: invoice.amount_due,\n    currency: invoice.currency,\n    dueDate: new Date((invoice.due_date ?? invoice.created) * 1000).toISOString(),\n  });\n}\n\nasync function handleCheckoutCompleted(session: Stripe.Checkout.Session): Promise<void> {\n  if (!session.customer || !session.subscription) return;\n\n  const tenantId = session.metadata?.tenantId;\n  if (!tenantId) return;\n\n  // Link Stripe customer to tenant (first subscription)\n  await db\n    .from('tenants')\n    .update({\n      stripe_customer_id: session.customer as string,\n      stripe_subscription_id: session.subscription as string,\n      status: 'active',\n      updated_at: new Date().toISOString(),\n    })\n    .eq('id', tenantId);\n\n  await updateBillingStatus(tenantId, 'active');\n  await invalidateTenantCache(tenantId);\n\n  await sendBillingEmail('subscription_started', tenantId, {});\n}\n\n// ============================================================================\n// HELPERS\n// ============================================================================\n\nconst PRICE_TIER_MAP: Record<string, 'starter' | 'professional' | 'enterprise'> = {\n  [process.env.STRIPE_STARTER_PRICE_ID!]: 'starter',\n  [process.env.STRIPE_PROFESSIONAL_PRICE_ID!]: 'professional',\n  [process.env.STRIPE_ENTERPRISE_PRICE_ID!]: 'enterprise',\n};\n\nfunction mapPriceToTier(priceId: string): 'starter' | 'professional' | 'enterprise' {\n  return PRICE_TIER_MAP[priceId] ?? 'starter';\n}\n\nfunction mapStripeStatusToPlatform(\n  stripeStatus: Stripe.Subscription.Status\n): 'active' | 'trial' | 'suspended' | 'cancelled' {\n  const map: Record<string, 'active' | 'trial' | 'suspended' | 'cancelled'> = {\n    active: 'active',\n    trialing: 'trial',\n    past_due: 'suspended', // After first missed payment\n    unpaid: 'suspended',\n    canceled: 'cancelled',\n    incomplete: 'suspended',\n    incomplete_expired: 'cancelled',\n    paused: 'suspended',\n  };\n  return map[stripeStatus] ?? 'suspended';\n}\n```\n\n---\n",
            "domainNumber": 11
          }
        },
        {
          "domainNumber": 11,
          "fileName": "DOMAIN-11-stripe-section-stripe.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-11\\DOMAIN-11-stripe-section-stripe.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "11.3-stripe-checkout-session-creator-server-action.md",
            "title": "Section stripe",
            "description": "Implementation for domain 11 section stripe",
            "topics": ["Domain 11 implementation"],
            "sectionNumber": "stripe",
            "content": "### 11.3 Stripe Checkout Session Creator (Server Action)\n\n```typescript\n// apps/portal/src/features/billing/model/create-checkout.ts\n'use server';\n\nimport Stripe from 'stripe';\nimport { z } from 'zod';\nimport { createServerAction } from '@repo/auth/server-action-wrapper';\nimport { db } from '@repo/db';\n\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {\n  apiVersion: '2025-11-27.acacia',\n});\n\nconst CheckoutSchema = z.object({\n  priceId: z.string().startsWith('price_'),\n  successUrl: z.string().url().optional(),\n  cancelUrl: z.string().url().optional(),\n});\n\nexport const createCheckoutSession = createServerAction(CheckoutSchema, async (input, ctx) => {\n  // Fetch or create Stripe customer for this tenant\n  const { data: tenant } = await db\n    .from('tenants')\n    .select('stripe_customer_id, config')\n    .eq('id', ctx.tenantId)\n    .single();\n\n  const config = tenant?.config as any;\n  let customerId = tenant?.stripe_customer_id;\n\n  if (!customerId) {\n    // Create Stripe customer (first time)\n    const customer = await stripe.customers.create({\n      email: config?.identity?.contact?.email,\n      name: config?.identity?.siteName,\n      metadata: {\n        tenantId: ctx.tenantId,\n        userId: ctx.userId,\n      },\n    });\n\n    customerId = customer.id;\n\n    await db.from('tenants').update({ stripe_customer_id: customerId }).eq('id', ctx.tenantId);\n  }\n\n  // Create Checkout Session\n  const session = await stripe.checkout.sessions.create({\n    customer: customerId,\n    mode: 'subscription',\n    payment_method_types: ['card'],\n    line_items: [{ price: input.priceId, quantity: 1 }],\n    // 14-day trial for new subscriptions\n    subscription_data: {\n      trial_period_days: 14,\n      metadata: { tenantId: ctx.tenantId },\n    },\n    success_url: input.successUrl ?? `${process.env.NEXT_PUBLIC_PORTAL_URL}/billing?success=1`,\n    cancel_url: input.cancelUrl ?? `${process.env.NEXT_PUBLIC_PORTAL_URL}/billing?cancelled=1`,\n    metadata: {\n      tenantId: ctx.tenantId,\n      userId: ctx.userId,\n    },\n    // Allow promo codes\n    allow_promotion_codes: true,\n    // Collect tax automatically\n    automatic_tax: { enabled: true },\n    customer_update: { address: 'auto' },\n  });\n\n  return { checkoutUrl: session.url! };\n});\n```\n\n---\n",
            "domainNumber": 11
          }
        },
        {
          "domainNumber": 11,
          "fileName": "DOMAIN-11-stripe-section-stripe.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-11\\DOMAIN-11-stripe-section-stripe.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "11.4-stripe-customer-portal-self-service-billing.md",
            "title": "Section stripe",
            "description": "Implementation for domain 11 section stripe",
            "topics": ["Domain 11 implementation"],
            "sectionNumber": "stripe",
            "content": "### 11.4 Stripe Customer Portal (Self-Service Billing)\n\n```typescript\n// apps/portal/src/features/billing/model/open-portal.ts\n'use server';\n\nimport Stripe from 'stripe';\nimport { z } from 'zod';\nimport { createServerAction } from '@repo/auth/server-action-wrapper';\nimport { db } from '@repo/db';\n\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {\n  apiVersion: '2025-11-27.acacia',\n});\n\nconst OpenPortalSchema = z.object({\n  returnUrl: z.string().url().optional(),\n});\n\nexport const openBillingPortal = createServerAction(OpenPortalSchema, async (input, ctx) => {\n  const { data: tenant } = await db\n    .from('tenants')\n    .select('stripe_customer_id')\n    .eq('id', ctx.tenantId)\n    .single();\n\n  if (!tenant?.stripe_customer_id) {\n    return { error: 'No billing account found. Please subscribe first.' };\n  }\n\n  // Create a short-lived portal session (link expires in 5 minutes)\n  const portalSession = await stripe.billingPortal.sessions.create({\n    customer: tenant.stripe_customer_id,\n    return_url: input.returnUrl ?? `${process.env.NEXT_PUBLIC_PORTAL_URL}/billing`,\n    // Configure which actions are available in the portal\n    // Set via Stripe Dashboard: portal config ID\n    // configuration: process.env.STRIPE_PORTAL_CONFIG_ID,\n  });\n\n  return { portalUrl: portalSession.url };\n});\n```\n\n---\n",
            "domainNumber": 11
          }
        },
        {
          "domainNumber": 11,
          "fileName": "DOMAIN-11-billing-section-billing.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-11\\DOMAIN-11-billing-section-billing.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "11.5-billing-page-component.md",
            "title": "Section billing",
            "description": "Implementation for domain 11 section billing",
            "topics": ["Domain 11 implementation"],
            "sectionNumber": "billing",
            "content": "### 11.5 Billing Page Component\n\n```typescript\n// apps/portal/src/features/billing/ui/BillingPage.tsx\nimport { createCheckoutSession } from '../model/create-checkout';\nimport { openBillingPortal } from '../model/open-portal';\nimport { db } from '@repo/db';\nimport { headers } from 'next/headers';\n\nconst PLANS = [\n  {\n    id: 'starter',\n    name: 'Starter',\n    priceId: process.env.STRIPE_STARTER_PRICE_ID!,\n    price: 297,\n    interval: 'month',\n    features: [\n      '1 marketing website',\n      'Up to 500 leads/month',\n      'Email notifications',\n      'Basic analytics',\n      'SSL + hosting included',\n    ],\n  },\n  {\n    id: 'professional',\n    name: 'Professional',\n    priceId: process.env.STRIPE_PROFESSIONAL_PRICE_ID!,\n    price: 597,\n    interval: 'month',\n    featured: true,\n    features: [\n      'Up to 5 websites',\n      'Unlimited leads',\n      'Real-time lead feed',\n      'Custom domain',\n      'CRM integration',\n      'A/B testing',\n      'Priority support',\n    ],\n  },\n  {\n    id: 'enterprise',\n    name: 'Enterprise',\n    priceId: process.env.STRIPE_ENTERPRISE_PRICE_ID!,\n    price: 1497,\n    interval: 'month',\n    features: [\n      'Unlimited websites',\n      'White-label portal',\n      'SSO / SAML',\n      'SLA guarantee',\n      'Dedicated support',\n      'Custom integrations',\n      'Audit logs (7 years)',\n    ],\n  },\n] as const;\n\nasync function getCurrentPlan(tenantId: string) {\n  const { data } = await db\n    .from('tenants')\n    .select('billing_tier, status, stripe_customer_id, stripe_subscription_id')\n    .eq('id', tenantId)\n    .single();\n  return data;\n}\n\nexport async function BillingPage() {\n  const tenantId = (await headers()).get('X-Tenant-Id')!;\n  const current = await getCurrentPlan(tenantId);\n  const hasSubscription = !!current?.stripe_subscription_id;\n\n  return (\n    <main aria-labelledby=\"billing-heading\" className=\"max-w-5xl mx-auto px-4 py-12\">\n      <h1 id=\"billing-heading\" className=\"text-3xl font-bold text-gray-900 mb-2\">\n        Billing & Plans\n      </h1>\n\n      {/* Current status banner */}\n      {current?.status === 'trial' && (\n        <div role=\"alert\" className=\"mb-8 p-4 bg-blue-50 border border-blue-200 rounded-lg text-blue-800\">\n          <strong>Free trial active.</strong> Subscribe before your trial ends to keep your website live.\n        </div>\n      )}\n\n      {current?.status === 'suspended' && (\n        <div role=\"alert\" className=\"mb-8 p-4 bg-red-50 border border-red-200 rounded-lg text-red-800\">\n          <strong>Account suspended.</strong> Update your payment method to restore access.\n        </div>\n      )}\n\n      {/* Plan cards */}\n      <div className=\"grid md:grid-cols-3 gap-6 mb-12\">\n        {PLANS.map((plan) => {\n          const isCurrent = current?.billing_tier === plan.id;\n\n          return (\n            <div\n              key={plan.id}\n              className={`\n                border rounded-xl p-6 flex flex-col\n                ${plan.featured ? 'border-primary ring-2 ring-primary' : 'border-gray-200'}\n                ${isCurrent ? 'bg-green-50 border-green-500' : 'bg-white'}\n              `}\n              aria-label={`${plan.name} plan${isCurrent ? ' â€” current plan' : ''}`}\n            >\n              {plan.featured && (\n                <span className=\"inline-flex self-start bg-primary text-white text-xs font-semibold px-2.5 py-1 rounded-full mb-4\">\n                  Most Popular\n                </span>\n              )}\n              {isCurrent && (\n                <span className=\"inline-flex self-start bg-green-500 text-white text-xs font-semibold px-2.5 py-1 rounded-full mb-4\">\n                  Current Plan\n                </span>\n              )}\n\n              <h2 className=\"text-xl font-bold\">{plan.name}</h2>\n              <p className=\"mt-1 mb-4\">\n                <span className=\"text-4xl font-extrabold\">${plan.price}</span>\n                <span className=\"text-gray-500\">/{plan.interval}</span>\n              </p>\n\n              <ul className=\"space-y-2 flex-1 mb-6\">\n                {plan.features.map((feat) => (\n                  <li key={feat} className=\"flex items-start gap-2 text-sm text-gray-700\">\n                    <span aria-hidden=\"true\" className=\"text-green-500 mt-0.5\">âœ“</span>\n                    {feat}\n                  </li>\n                ))}\n              </ul>\n\n              {isCurrent ? (\n                <form action={async () => {\n                  'use server';\n                  const result = await openBillingPortal({});\n                  if (result.success && result.data.portalUrl) {\n                    // Note: redirect must happen in a client-side handler or Route Handler\n                  }\n                }}>\n                  <button\n                    type=\"submit\"\n                    className=\"w-full border border-gray-300 rounded-lg py-3 font-medium hover:bg-gray-50\"\n                  >\n                    Manage Subscription\n                  </button>\n                </form>\n              ) : (\n                <form action={async () => {\n                  'use server';\n                  await createCheckoutSession({ priceId: plan.priceId });\n                }}>\n                  <button\n                    type=\"submit\"\n                    className={`w-full rounded-lg py-3 font-semibold ${\n                      plan.featured\n                        ? 'bg-primary text-white hover:bg-primary/90'\n                        : 'border border-gray-300 hover:bg-gray-50'\n                    }`}\n                  >\n                    {hasSubscription ? 'Switch Plan' : 'Start Free Trial'}\n                  </button>\n                </form>\n              )}\n            </div>\n          );\n        })}\n      </div>\n    </main>\n  );\n}\n```\n\n---\n",
            "domainNumber": 11
          }
        }
      ]
    },
    {
      "domainNumber": 12,
      "success": true,
      "tasksCreated": 7,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 12,
          "fileName": "DOMAIN-12-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-12\\DOMAIN-12-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "12.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 12 section philosophy.md",
            "topics": ["Domain 12 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 12.1 Philosophy\n\n**What it is:** Serverless functions on Vercel have a 60-second execution limit (Pro plan). Any task that might exceed that limit â€” bulk email sends, lead export generation, GDPR deletion, image processing, CRM sync â€” must be offloaded to a background job queue. [webrunner](https://www.webrunner.io/blog/best-practices-for-setting-up-next-js-background-jobs)\n\n**Why QStash:** Upstash QStash is an HTTP-based message queue built for serverless. It delivers messages to your API endpoints with retries, scheduling, and exactly-once delivery guarantees. Unlike Redis queues, QStash works without a persistent worker process â€” the queue is durable in Upstash's infrastructure and your Vercel function wakes up when called. [supastarter](https://supastarter.dev/docs/nextjs/tasks/qstash)\n\n**When to use background jobs:**\n\n- Tasks that could take >10 seconds\n- Tasks that must retry on failure (email sends, CRM sync)\n- Tasks with schedule requirements (daily digests, weekly reports)\n- GDPR deletion (timed to run 30 days after cancellation)\n\n---\n",
            "domainNumber": 12
          }
        },
        {
          "domainNumber": 12,
          "fileName": "DOMAIN-12-qstash-section-qstash.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-12\\DOMAIN-12-qstash-section-qstash.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "12.2-qstash-client-setup.md",
            "title": "Section qstash",
            "description": "Implementation for domain 12 section qstash",
            "topics": ["Domain 12 implementation"],
            "sectionNumber": "qstash",
            "content": "### 12.2 QStash Client Setup\n\n**File:** `packages/jobs/src/client.ts`\n\n```typescript\nimport { Client as QStashClient, Receiver } from '@upstash/qstash';\n\nexport const qstash = new QStashClient({\n  token: process.env.QSTASH_TOKEN!,\n});\n\n// Used to verify QStash requests to our endpoints (prevents unauthorized calls)\nexport const qstashReceiver = new Receiver({\n  currentSigningKey: process.env.QSTASH_CURRENT_SIGNING_KEY!,\n  nextSigningKey: process.env.QSTASH_NEXT_SIGNING_KEY!,\n});\n\n// ============================================================================\n// JOB DEFINITIONS (type-safe payloads)\n// ============================================================================\n\nexport type JobType =\n  | 'email.lead_digest'\n  | 'email.billing_receipt'\n  | 'crm.sync_lead'\n  | 'gdpr.delete_tenant'\n  | 'report.weekly'\n  | 'sitemap.rebuild'\n  | 'booking.reminder'\n  | 'booking.followup';\n\nexport type JobPayloadMap = {\n  'email.lead_digest': { tenantId: string; date: string };\n  'email.billing_receipt': {\n    tenantId: string;\n    invoiceId: string;\n    amountPaid: number;\n    currency: string;\n    hostedInvoiceUrl: string | null;\n  };\n  'crm.sync_lead': {\n    tenantId: string;\n    leadId: string;\n    crmType: 'hubspot' | 'zapier' | 'gohighlevel';\n  };\n  'gdpr.delete_tenant': { tenantId: string; reason: string };\n  'report.weekly': { tenantId: string };\n  'sitemap.rebuild': { tenantId: string };\n  'booking.reminder': { tenantId: string; bookingId: string; reminderType: '24h' | '1h' };\n  'booking.followup': { tenantId: string; bookingId: string };\n};\n\nconst JOB_ENDPOINTS: Record<JobType, string> = {\n  'email.lead_digest': '/api/jobs/email/lead-digest',\n  'email.billing_receipt': '/api/jobs/email/billing-receipt',\n  'crm.sync_lead': '/api/jobs/crm/sync-lead',\n  'gdpr.delete_tenant': '/api/jobs/gdpr/delete-tenant',\n  'report.weekly': '/api/jobs/reports/weekly',\n  'sitemap.rebuild': '/api/jobs/sitemap/rebuild',\n  'booking.reminder': '/api/jobs/booking/reminder',\n  'booking.followup': '/api/jobs/booking/followup',\n};\n\n// ============================================================================\n// ENQUEUE HELPER (type-safe, URL auto-resolved)\n// ============================================================================\n\nexport async function enqueue<T extends JobType>(\n  jobType: T,\n  payload: JobPayloadMap[T],\n  options?: {\n    delaySeconds?: number;\n    notBefore?: Date; // Schedule for specific time\n    retries?: number;\n    deduplicationId?: string;\n  }\n): Promise<void> {\n  const endpoint = JOB_ENDPOINTS[jobType];\n  const baseUrl = process.env.NEXT_PUBLIC_APP_URL!;\n\n  await qstash.publishJSON({\n    url: `${baseUrl}${endpoint}`,\n    body: payload,\n    retries: options?.retries ?? 3,\n    ...(options?.delaySeconds ? { delay: options.delaySeconds } : {}),\n    ...(options?.notBefore ? { notBefore: Math.floor(options.notBefore.getTime() / 1000) } : {}),\n    ...(options?.deduplicationId ? { deduplicationId: options.deduplicationId } : {}),\n  });\n}\n\n// ============================================================================\n// SCHEDULE HELPER (cron-based recurring jobs)\n// Schedules are created once at startup (or via admin UI)\n// ============================================================================\n\nexport async function createSchedule(\n  jobType: JobType,\n  cron: string,\n  payload: Record<string, unknown>\n): Promise<string> {\n  const baseUrl = process.env.NEXT_PUBLIC_APP_URL!;\n  const endpoint = JOB_ENDPOINTS[jobType];\n\n  const schedule = await qstash.schedules.create({\n    destination: `${baseUrl}${endpoint}`,\n    cron,\n    body: JSON.stringify(payload),\n    headers: { 'Content-Type': 'application/json' },\n    retries: 2,\n  });\n\n  return schedule.scheduleId;\n}\n```\n\n---\n",
            "domainNumber": 12
          }
        },
        {
          "domainNumber": 12,
          "fileName": "DOMAIN-12-qstash-section-qstash.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-12\\DOMAIN-12-qstash-section-qstash.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "12.3-qstash-request-verification-middleware.md",
            "title": "Section qstash",
            "description": "Implementation for domain 12 section qstash",
            "topics": ["Domain 12 implementation"],
            "sectionNumber": "qstash",
            "content": "### 12.3 QStash Request Verification Middleware\n\n**Every job endpoint MUST verify the QStash signature to prevent unauthorized calls.**\n\n**File:** `packages/jobs/src/verify-qstash.ts`\n\n```typescript\nimport { NextRequest, NextResponse } from 'next/server';\nimport { qstashReceiver } from './client';\n\n// ============================================================================\n// WRAPPER: Verifies QStash signature and parses typed payload\n// Usage:\n//   export const POST = createJobHandler<'crm.sync_lead'>(async (payload) => {\n//     // payload is typed as JobPayloadMap['crm.sync_lead']\n//   });\n// ============================================================================\n\nexport function createJobHandler<T extends keyof import('./client').JobPayloadMap>(\n  handler: (payload: import('./client').JobPayloadMap[T], req: NextRequest) => Promise<void>\n) {\n  return async function POST(req: NextRequest): Promise<NextResponse> {\n    // Verify signature\n    const signature = req.headers.get('upstash-signature');\n    if (!signature) {\n      return NextResponse.json({ error: 'Missing signature' }, { status: 401 });\n    }\n\n    const body = await req.text();\n\n    let isValid = false;\n    try {\n      isValid = await qstashReceiver.verify({\n        signature,\n        body,\n        url: req.url,\n      });\n    } catch {\n      isValid = false;\n    }\n\n    if (!isValid) {\n      console.error('[QStash] Signature verification failed');\n      return NextResponse.json({ error: 'Invalid signature' }, { status: 401 });\n    }\n\n    // Parse payload\n    let payload: import('./client').JobPayloadMap[T];\n    try {\n      payload = JSON.parse(body);\n    } catch {\n      return NextResponse.json({ error: 'Invalid JSON body' }, { status: 400 });\n    }\n\n    // Execute handler\n    try {\n      await handler(payload, req);\n      return NextResponse.json({ ok: true });\n    } catch (err) {\n      console.error('[Job Handler] Error:', err);\n      // Return 500 â€” QStash will retry up to configured retry count\n      return NextResponse.json(\n        { error: err instanceof Error ? err.message : 'Unknown error' },\n        { status: 500 }\n      );\n    }\n  };\n}\n```\n\n---\n",
            "domainNumber": 12
          }
        },
        {
          "domainNumber": 12,
          "fileName": "DOMAIN-12-email-section-email.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-12\\DOMAIN-12-email-section-email.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "12.4-email-digest-job.md",
            "title": "Section email",
            "description": "Implementation for domain 12 section email",
            "topics": ["Domain 12 implementation"],
            "sectionNumber": "email",
            "content": "### 12.4 Email Digest Job\n\n**File:** `apps/*/src/app/api/jobs/email/lead-digest/route.ts`\n\n```typescript\nimport { createJobHandler } from '@repo/jobs/verify-qstash';\nimport { db } from '@repo/db';\nimport { sendLeadDigestEmail } from '@repo/email';\nimport { classifyLead } from '@repo/lead-capture/scoring';\n\nexport const maxDuration = 60; // 60s max on Vercel Pro\n\nexport const POST = createJobHandler<'email.lead_digest'>(async (payload) => {\n  const { tenantId, date } = payload;\n\n  const startOfDay = new Date(date);\n  startOfDay.setHours(0, 0, 0, 0);\n\n  const endOfDay = new Date(date);\n  endOfDay.setHours(23, 59, 59, 999);\n\n  // Fetch warm leads from the day\n  const { data: leads } = await db\n    .from('leads')\n    .select('*')\n    .eq('tenant_id', tenantId)\n    .gte('created_at', startOfDay.toISOString())\n    .lte('created_at', endOfDay.toISOString())\n    .gte('score', 40) // Warm + qualified\n    .lt('score', 70) // Warm only (qualified get immediate email)\n    .order('score', { ascending: false });\n\n  if (!leads || leads.length === 0) return; // Nothing to digest\n\n  await sendLeadDigestEmail(tenantId, leads, date);\n});\n```\n\n---\n",
            "domainNumber": 12
          }
        },
        {
          "domainNumber": 12,
          "fileName": "DOMAIN-12-crm-section-crm.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-12\\DOMAIN-12-crm-section-crm.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "12.5-crm-sync-job-hubspot-zapier.md",
            "title": "Section crm",
            "description": "Implementation for domain 12 section crm",
            "topics": ["Domain 12 implementation"],
            "sectionNumber": "crm",
            "content": "### 12.5 CRM Sync Job (HubSpot + Zapier)\n\n**File:** `apps/*/src/app/api/jobs/crm/sync-lead/route.ts`\n\n```typescript\nimport { createJobHandler } from '@repo/jobs/verify-qstash';\nimport { db } from '@repo/db';\nimport { getTenantSecret } from '@repo/auth/secrets-manager';\n\nexport const maxDuration = 30;\n\nexport const POST = createJobHandler<'crm.sync_lead'>(async (payload) => {\n  const { tenantId, leadId, crmType } = payload;\n\n  // Fetch lead\n  const { data: lead } = await db\n    .from('leads')\n    .select('*')\n    .eq('id', leadId)\n    .eq('tenant_id', tenantId)\n    .single();\n\n  if (!lead) {\n    console.warn(`[CRM Sync] Lead ${leadId} not found`);\n    return;\n  }\n\n  switch (crmType) {\n    case 'hubspot':\n      await syncToHubSpot(tenantId, lead);\n      break;\n    case 'zapier':\n      await syncToZapier(tenantId, lead);\n      break;\n    case 'gohighlevel':\n      await syncToGoHighLevel(tenantId, lead);\n      break;\n  }\n\n  // Mark lead as synced\n  await db\n    .from('leads')\n    .update({\n      metadata: { ...lead.metadata, crm_synced: true, crm_synced_at: new Date().toISOString() },\n    })\n    .eq('id', leadId);\n});\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nasync function syncToHubSpot(tenantId: string, lead: any): Promise<void> {\n  const apiKey = await getTenantSecret(tenantId, 'HUBSPOT_PRIVATE_APP_TOKEN');\n  if (!apiKey) {\n    console.warn(`[CRM] HubSpot token not configured for tenant ${tenantId}`);\n    return;\n  }\n\n  // Upsert contact in HubSpot (idempotent by email)\n  const response = await fetch('https://api.hubapi.com/crm/v3/objects/contacts/batch/upsert', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      Authorization: `Bearer ${apiKey}`,\n    },\n    body: JSON.stringify({\n      inputs: [\n        {\n          idProperty: 'email',\n          id: lead.email,\n          properties: {\n            email: lead.email,\n            firstname: lead.name.split(' ')[0] ?? lead.name,\n            lastname: lead.name.split(' ').slice(1).join(' ') ?? '',\n            phone: lead.phone ?? '',\n            message: lead.message,\n            hs_lead_status: lead.score >= 70 ? 'QUALIFIED' : 'NEW',\n            // Custom properties (must be created in HubSpot first)\n            lead_score: String(lead.score),\n            utm_source: lead.utm_source ?? '',\n            utm_campaign: lead.utm_campaign ?? '',\n            lead_source: lead.source ?? 'contact_form',\n          },\n        },\n      ],\n    }),\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    throw new Error(`HubSpot sync failed: ${response.status} â€” ${error}`);\n  }\n}\n\nasync function syncToZapier(tenantId: string, lead: any): Promise<void> {\n  // Zapier webhook URL stored per-tenant\n  const webhookUrl = await getTenantSecret(tenantId, 'ZAPIER_WEBHOOK_URL');\n  if (!webhookUrl) return;\n\n  const response = await fetch(webhookUrl, {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({\n      name: lead.name,\n      email: lead.email,\n      phone: lead.phone ?? '',\n      message: lead.message,\n      score: lead.score,\n      source: lead.source,\n      utm_source: lead.utm_source ?? '',\n      utm_medium: lead.utm_medium ?? '',\n      utm_campaign: lead.utm_campaign ?? '',\n      first_touch_source: lead.utm_source_first ?? '',\n      first_touch_campaign: lead.utm_campaign_first ?? '',\n      landing_page: lead.landing_page ?? '/',\n      created_at: lead.created_at,\n    }),\n  });\n\n  if (!response.ok) {\n    throw new Error(`Zapier webhook failed: ${response.status}`);\n  }\n}\n\nasync function syncToGoHighLevel(tenantId: string, lead: any): Promise<void> {\n  const apiKey = await getTenantSecret(tenantId, 'GHL_API_KEY');\n  const locationId = await getTenantSecret(tenantId, 'GHL_LOCATION_ID');\n  if (!apiKey || !locationId) return;\n\n  const nameParts = lead.name.split(' ');\n\n  const response = await fetch('https://services.leadconnectorhq.com/contacts/', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      Authorization: `Bearer ${apiKey}`,\n      Version: '2021-07-28',\n    },\n    body: JSON.stringify({\n      locationId,\n      email: lead.email,\n      phone: lead.phone ?? '',\n      firstName: nameParts[0] ?? '',\n      lastName: nameParts.slice(1).join(' ') ?? '',\n      customField: {\n        message: lead.message,\n        lead_score: lead.score,\n        utm_source: lead.utm_source ?? '',\n        utm_campaign: lead.utm_campaign ?? '',\n      },\n      source: `website-${lead.source ?? 'contact_form'}`,\n      tags: [\n        lead.score >= 70 ? 'qualified-lead' : 'new-lead',\n        `score-${Math.floor(lead.score / 10) * 10}`,\n        lead.utm_source ? `source-${lead.utm_source}` : 'source-direct',\n      ].filter(Boolean),\n    }),\n  });\n\n  if (!response.ok) {\n    throw new Error(`GoHighLevel sync failed: ${response.status}`);\n  }\n}\n```\n\n---\n",
            "domainNumber": 12
          }
        },
        {
          "domainNumber": 12,
          "fileName": "DOMAIN-12-booking-section-booking.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-12\\DOMAIN-12-booking-section-booking.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "12.6-booking-reminder-job.md",
            "title": "Section booking",
            "description": "Implementation for domain 12 section booking",
            "topics": ["Domain 12 implementation"],
            "sectionNumber": "booking",
            "content": "### 12.6 Booking Reminder Job\n\n**File:** `apps/*/src/app/api/jobs/booking/reminder/route.ts`\n\n```typescript\nimport { createJobHandler } from '@repo/jobs/verify-qstash';\nimport { db } from '@repo/db';\nimport { sendBookingReminderEmail } from '@repo/email';\n\nexport const maxDuration = 30;\n\nexport const POST = createJobHandler<'booking.reminder'>(async (payload) => {\n  const { tenantId, bookingId, reminderType } = payload;\n\n  const { data: booking } = await db\n    .from('bookings')\n    .select('*, lead:leads(name, email, phone)')\n    .eq('id', bookingId)\n    .eq('tenant_id', tenantId)\n    .single();\n\n  if (!booking) return;\n  if (booking.status !== 'confirmed') return; // Don't remind for cancelled\n\n  await sendBookingReminderEmail({\n    tenantId,\n    booking,\n    reminderType,\n  });\n});\n```\n\n---\n",
            "domainNumber": 12
          }
        },
        {
          "domainNumber": 12,
          "fileName": "DOMAIN-12-gdpr-section-gdpr.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-12\\DOMAIN-12-gdpr-section-gdpr.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "12.7-gdpr-tenant-deletion-job.md",
            "title": "Section gdpr",
            "description": "Implementation for domain 12 section gdpr",
            "topics": ["Domain 12 implementation"],
            "sectionNumber": "gdpr",
            "content": "### 12.7 GDPR Tenant Deletion Job\n\n```typescript\n// apps/*/src/app/api/jobs/gdpr/delete-tenant/route.ts\nimport { createJobHandler } from '@repo/jobs/verify-qstash';\nimport { db } from '@repo/db';\nimport { removeTenantDomain } from '@repo/multi-tenant/vercel-domains';\nimport { invalidateTenantCache } from '@repo/multi-tenant/resolve-tenant';\n\nexport const maxDuration = 60;\n\nexport const POST = createJobHandler<'gdpr.delete_tenant'>(async (payload) => {\n  const { tenantId, reason } = payload;\n\n  console.log(`[GDPR] Starting deletion for tenant: ${tenantId}, reason: ${reason}`);\n\n  // 1. Mark deletion as in-progress (CANNOT be reversed after this point)\n  const { error: queueError } = await db\n    .from('deletion_queue')\n    .update({ status: 'deleted', deleted_at: new Date().toISOString() })\n    .eq('tenant_id', tenantId)\n    .eq('status', 'pending');\n\n  if (queueError) throw queueError;\n\n  // 2. Delete PII data (leads, bookings â€” personal information)\n  //    Audit logs are retained (legal requirement under most jurisdictions)\n  await db.from('leads').delete().eq('tenant_id', tenantId);\n  await db.from('bookings').delete().eq('tenant_id', tenantId);\n  await db.from('phone_click_events').delete().eq('tenant_id', tenantId);\n  await db.from('tenant_members').delete().eq('tenant_id', tenantId);\n  await db.from('tenant_secrets').delete().eq('tenant_id', tenantId);\n  await db.from('tenant_sso_providers').delete().eq('tenant_id', tenantId);\n\n  // 3. Fetch custom domain before deleting tenant record\n  const { data: tenant } = await db\n    .from('tenants')\n    .select('custom_domain, subdomain')\n    .eq('id', tenantId)\n    .single();\n\n  // 4. Remove Vercel domain assignment\n  if (tenant?.custom_domain) {\n    try {\n      await removeTenantDomain(tenant.custom_domain);\n    } catch (err) {\n      // Non-fatal â€” domain might already be removed\n      console.warn(`[GDPR] Failed to remove domain: ${tenant.custom_domain}`, err);\n    }\n  }\n\n  // 5. Delete tenant record\n  await db.from('tenants').delete().eq('id', tenantId);\n\n  // 6. Bust all caches\n  await invalidateTenantCache(tenantId);\n\n  // 7. Audit log (retained even after tenant deletion â€” use service role client)\n  await db.from('audit_logs').insert({\n    tenant_id: tenantId,\n    action: 'tenant.gdpr_deleted',\n    table_name: 'tenants',\n    record_id: tenantId,\n    new_data: { reason, deleted_at: new Date().toISOString() },\n  });\n\n  console.log(`[GDPR] Deletion complete: tenant=${tenantId}`);\n});\n```\n\n---\n",
            "domainNumber": 12
          }
        }
      ]
    },
    {
      "domainNumber": 13,
      "success": true,
      "tasksCreated": 4,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 13,
          "fileName": "DOMAIN-13-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-13\\DOMAIN-13-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "13.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 13 section philosophy.md",
            "topics": ["Domain 13 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 13.1 Philosophy\n\n**What it is:** Observability means knowing what happened in production without reproducing it locally. The stack is: **Sentry** (errors + performance tracing) + **Tinybird** (business analytics) + **Vercel Analytics** (core web vitals) + **OpenTelemetry** (distributed traces). [tinybird](https://www.tinybird.co/docs/classic/publish-data/charts/guides/real-time-dashboard)\n\n**Why all four:** Each covers a different layer.\n\n| Layer              | Tool             | What It Monitors                                        | When to Use |\n| ------------------ | ---------------- | ------------------------------------------------------- | ----------- |\n| Runtime errors     | Sentry           | Exceptions, server-side crashes, React error boundaries | Always      |\n| Performance traces | Sentry + OTEL    | Slow queries, middleware latency, Server Action timing  | Always      |\n| Business metrics   | Tinybird         | Leads/day, CWV p75, A/B test results, funnel            | Always      |\n| Web vitals         | Vercel Analytics | LCP, INP, CLS per route                                 | Always      |\n| Infrastructure     | Vercel Dashboard | Deployment status, function invocations, edge errors    | Always      |\n\n---\n",
            "domainNumber": 13
          }
        },
        {
          "domainNumber": 13,
          "fileName": "DOMAIN-13-opentelemetry-section-opentelemetry.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-13\\DOMAIN-13-opentelemetry-section-opentelemetry.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "13.2-opentelemetry-instrumentation.md",
            "title": "Section opentelemetry",
            "description": "Implementation for domain 13 section opentelemetry",
            "topics": ["Domain 13 implementation"],
            "sectionNumber": "opentelemetry",
            "content": "### 13.2 OpenTelemetry Instrumentation\n\n**File:** `apps/*/src/instrumentation.ts` (Next.js 16 native, loaded before app startup)\n\n```typescript\n// This file is loaded by Next.js before any request is handled\n// Instrument OpenTelemetry ONCE here â€” all Server Components and Server Actions\n// automatically traced via @vercel/otel\n// Reference: next.config.ts -> experimental.instrumentationHook: true\n\nexport async function register() {\n  if (process.env.NEXT_RUNTIME === 'nodejs') {\n    const { registerOTel } = await import('@vercel/otel');\n    const { SentryPropagator, SentrySampler, SentrySpanProcessor } =\n      await import('@sentry/opentelemetry');\n\n    registerOTel({\n      serviceName: `marketing-platform-${process.env.NEXT_PUBLIC_SITE_ID ?? 'unknown'}`,\n      // Sentry as OpenTelemetry backend\n      spanProcessors: [new SentrySpanProcessor()],\n      // Respect Sentry's sampling decisions\n      sampler: new SentrySampler(),\n      // Propagate Sentry trace headers\n      propagators: [new SentryPropagator()],\n    });\n  }\n\n  if (process.env.NEXT_RUNTIME === 'edge') {\n    // Edge runtime: minimal instrumentation (no full OTel SDK)\n    const Sentry = await import('@sentry/nextjs');\n    Sentry.init({\n      dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,\n      tracesSampleRate: 0.1,\n    });\n  }\n}\n```\n\n**File:** `apps/*/src/sentry.server.config.ts`\n\n```typescript\nimport * as Sentry from '@sentry/nextjs';\n\nSentry.init({\n  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,\n\n  // Tracing\n  tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,\n  tracePropagationTargets: [\n    'localhost',\n    /^https:\\/\\/.*\\.supabase\\.co/,\n    /^https:\\/\\/.*\\.youragency\\.com/,\n  ],\n\n  // Profiling (CPU-level performance traces)\n  profilesSampleRate: 0.05, // 5% of traced transactions\n\n  // Integrations\n  integrations: [\n    // Automatically capture unhandled Postgres errors\n    Sentry.postgresIntegration(),\n    // Capture fetch timing for all outbound requests\n    Sentry.httpIntegration({ tracing: true }),\n  ],\n\n  // PII scrubbing (GDPR)\n  beforeSend: (event) => {\n    // Scrub email addresses from error payloads\n    const eventStr = JSON.stringify(event);\n    const scrubbed = eventStr.replace(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/g, '[email]');\n    return JSON.parse(scrubbed);\n  },\n\n  // Environment tagging (filter by tenant in Sentry dashboard)\n  initialScope: {\n    tags: {\n      'platform.version': process.env.NEXT_PUBLIC_PLATFORM_VERSION ?? 'unknown',\n    },\n  },\n});\n```\n\n---\n",
            "domainNumber": 13
          }
        },
        {
          "domainNumber": 13,
          "fileName": "DOMAIN-13-tinybird-section-tinybird.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-13\\DOMAIN-13-tinybird-section-tinybird.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "13.3-tinybird-analytics-dashboard-schema.md",
            "title": "Section tinybird",
            "description": "Implementation for domain 13 section tinybird",
            "topics": ["Domain 13 implementation"],
            "sectionNumber": "tinybird",
            "content": "### 13.3 Tinybird Analytics Dashboard Schema\n\n**Tinybird Data Sources:**\n\n```sql\n-- 1. page_views.datasource\nSCHEMA >\n  `tenant_id`    String `json:$.tenant_id`,\n  `session_id`   String `json:$.session_id`,\n  `pathname`     String `json:$.pathname`,\n  `referrer`     Nullable(String) `json:$.referrer`,\n  `user_agent`   String `json:$.user_agent`,\n  `utm_source`   Nullable(String) `json:$.utm_source`,\n  `utm_medium`   Nullable(String) `json:$.utm_medium`,\n  `utm_campaign` Nullable(String) `json:$.utm_campaign`,\n  `timestamp`    DateTime64(3) `json:$.timestamp`\n\nENGINE \"MergeTree\"\nENGINE_SORTING_KEY \"tenant_id, timestamp\"\nENGINE_TTL \"timestamp + interval 90 day\"\n\n-- 2. events.datasource\nSCHEMA >\n  `tenant_id`    String `json:$.tenant_id`,\n  `session_id`   String `json:$.session_id`,\n  `event_type`   String `json:$.event_type`,\n  `pathname`     String `json:$.pathname`,\n  `payload`      String `json:$.payload`,\n  `timestamp`    DateTime64(3) `json:$.timestamp`\n\nENGINE \"MergeTree\"\nENGINE_SORTING_KEY \"tenant_id, event_type, timestamp\"\nENGINE_TTL \"timestamp + interval 90 day\"\n```\n\n**Tinybird API Endpoints (Pipes):**\n\n```sql\n-- leads_over_time.pipe â€” Leads grouped by day, last 30 days\nSELECT\n  tenant_id,\n  toDate(created_at) as date,\n  count() as total_leads,\n  countIf(score >= 70) as qualified_leads,\n  countIf(score >= 40 AND score < 70) as warm_leads,\n  countIf(score < 40) as cold_leads,\n  avg(score) as avg_score\nFROM leads_events\nWHERE\n  timestamp >= now() - INTERVAL 30 DAY\n  {% if defined(tenant_id) %}\n    AND tenant_id = {{ String(tenant_id, '') }}\n  {% end %}\nGROUP BY tenant_id, date\nORDER BY date ASC\n\n-- top_sources.pipe â€” Lead sources ranked by conversion\nSELECT\n  tenant_id,\n  utm_source,\n  count() as lead_count,\n  countIf(score >= 70) as qualified,\n  avg(score) as avg_score,\n  qualified / lead_count * 100 as conversion_rate\nFROM leads_events\nWHERE\n  timestamp >= now() - INTERVAL 30 DAY\n  AND utm_source IS NOT NULL\n  {% if defined(tenant_id) %}\n    AND tenant_id = {{ String(tenant_id, '') }}\n  {% end %}\nGROUP BY tenant_id, utm_source\nHAVING lead_count >= 5\nORDER BY qualified DESC\nLIMIT 10\n\n-- funnel.pipe â€” Visitor â†’ Lead conversion funnel\nWITH\n  sessions AS (\n    SELECT tenant_id, session_id, count() as page_views\n    FROM page_views\n    WHERE timestamp >= now() - INTERVAL 30 DAY\n    {% if defined(tenant_id) %}\n      AND tenant_id = {{ String(tenant_id, '') }}\n    {% end %}\n    GROUP BY tenant_id, session_id\n  ),\n  phone_clicks AS (\n    SELECT DISTINCT tenant_id, session_id\n    FROM events\n    WHERE event_type = 'phone_click'\n    AND timestamp >= now() - INTERVAL 30 DAY\n  ),\n  form_starts AS (\n    SELECT DISTINCT tenant_id, session_id\n    FROM events\n    WHERE event_type = 'form_start'\n    AND timestamp >= now() - INTERVAL 30 DAY\n  )\nSELECT\n  s.tenant_id,\n  count(DISTINCT s.session_id) as total_visitors,\n  count(DISTINCT pc.session_id) as phone_clickers,\n  count(DISTINCT fs.session_id) as form_starters,\n  phone_clickers / total_visitors * 100 as phone_click_rate,\n  form_starters / total_visitors * 100 as form_start_rate\nFROM sessions s\nLEFT JOIN phone_clicks pc USING (tenant_id, session_id)\nLEFT JOIN form_starts fs USING (tenant_id, session_id)\nGROUP BY s.tenant_id\n```\n\n---\n",
            "domainNumber": 13
          }
        },
        {
          "domainNumber": 13,
          "fileName": "DOMAIN-13-portal-section-portal.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-13\\DOMAIN-13-portal-section-portal.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "13.4-portal-analytics-dashboard-component.md",
            "title": "Section portal",
            "description": "Implementation for domain 13 section portal",
            "topics": ["Domain 13 implementation"],
            "sectionNumber": "portal",
            "content": "### 13.4 Portal Analytics Dashboard Component\n\n**File:** `apps/portal/src/features/analytics/ui/AnalyticsDashboard.tsx`\n\n```typescript\nimport { Suspense } from 'react';\nimport { cacheTag, cacheLife } from 'next/cache';\n\n// ============================================================================\n// TINYBIRD JWT â€” Per-tenant token (restricts data access to own tenant)\n// Reference: https://clerk.com/blog/tinybird-and-clerk\n// ============================================================================\n\nasync function getTinybirdToken(tenantId: string): Promise<string> {\n  'use cache';\n  cacheTag(`tenant:${tenantId}:tinybird-token`);\n  cacheLife('hours'); // Re-generate JWT hourly\n\n  const response = await fetch('https://api.tinybird.co/v0/pipes/generate_token', {\n    method: 'POST',\n    headers: {\n      'Authorization': `Bearer ${process.env.TINYBIRD_ADMIN_TOKEN}`,\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify({\n      scopes: [\n        { type: 'PIPES:READ', resource: 'leads_over_time' },\n        { type: 'PIPES:READ', resource: 'top_sources' },\n        { type: 'PIPES:READ', resource: 'funnel' },\n        { type: 'PIPES:READ', resource: 'cwv_p75_per_tenant' },\n      ],\n      // Row-level restriction via token fixed parameter\n      fixed_params: { tenant_id: tenantId },\n    }),\n  });\n\n  const { token } = await response.json();\n  return token;\n}\n\n// ============================================================================\n// METRIC FETCHERS (server-side, token-protected)\n// ============================================================================\n\nasync function fetchLeadsOverTime(tenantId: string, token: string) {\n  const res = await fetch(\n    `https://api.tinybird.co/v0/pipes/leads_over_time.json?tenant_id=${tenantId}&token=${token}`,\n    { next: { revalidate: 300, tags: [`tenant:${tenantId}:analytics`] } }\n  );\n  const { data } = await res.json();\n  return data as Array<{\n    date: string;\n    total_leads: number;\n    qualified_leads: number;\n    warm_leads: number;\n    cold_leads: number;\n    avg_score: number;\n  }>;\n}\n\nasync function fetchTopSources(tenantId: string, token: string) {\n  const res = await fetch(\n    `https://api.tinybird.co/v0/pipes/top_sources.json?tenant_id=${tenantId}&token=${token}`,\n    { next: { revalidate: 300 } }\n  );\n  const { data } = await res.json();\n  return data as Array<{\n    utm_source: string;\n    lead_count: number;\n    qualified: number;\n    avg_score: number;\n    conversion_rate: number;\n  }>;\n}\n\nasync function fetchFunnel(tenantId: string, token: string) {\n  const res = await fetch(\n    `https://api.tinybird.co/v0/pipes/funnel.json?tenant_id=${tenantId}&token=${token}`,\n    { next: { revalidate: 300 } }\n  );\n  const { data } = await res.json();\n  return (data?.[0] ?? null) as {\n    total_visitors: number;\n    phone_clickers: number;\n    form_starters: number;\n    phone_click_rate: number;\n    form_start_rate: number;\n  } | null;\n}\n\n// ============================================================================\n// DASHBOARD\n// ============================================================================\n\nasync function MetricsSection({ tenantId }: { tenantId: string }) {\n  const token = await getTinybirdToken(tenantId);\n  const [leadsData, sources, funnel] = await Promise.all([\n    fetchLeadsOverTime(tenantId, token),\n    fetchTopSources(tenantId, token),\n    fetchFunnel(tenantId, token),\n  ]);\n\n  const totalLeads = leadsData.reduce((sum, d) => sum + d.total_leads, 0);\n  const qualifiedLeads = leadsData.reduce((sum, d) => sum + d.qualified_leads, 0);\n  const avgScore = leadsData.length\n    ? Math.round(leadsData.reduce((sum, d) => sum + d.avg_score, 0) / leadsData.length)\n    : 0;\n\n  return (\n    <div className=\"space-y-8\">\n      {/* KPI Cards */}\n      <div\n        className=\"grid grid-cols-2 md:grid-cols-4 gap-4\"\n        role=\"region\"\n        aria-label=\"Key metrics\"\n      >\n        <MetricCard\n          label=\"Total Leads (30d)\"\n          value={totalLeads}\n          aria-label={`Total leads last 30 days: ${totalLeads}`}\n        />\n        <MetricCard\n          label=\"Qualified Leads\"\n          value={qualifiedLeads}\n          sublabel={totalLeads > 0 ? `${Math.round(qualifiedLeads / totalLeads * 100)}% of total` : 'â€”'}\n          highlight\n        />\n        <MetricCard\n          label=\"Avg Lead Score\"\n          value={`${avgScore}/100`}\n        />\n        <MetricCard\n          label=\"Phone Click Rate\"\n          value={`${funnel?.phone_click_rate?.toFixed(1) ?? '0'}%`}\n        />\n      </div>\n\n      {/* Leads over time (last 30 days) */}\n      <section aria-labelledby=\"leads-chart-heading\">\n        <h2 id=\"leads-chart-heading\" className=\"text-lg font-semibold mb-3\">\n          Leads Over Time\n        </h2>\n        <LeadsChart data={leadsData} />\n      </section>\n\n      {/* Top traffic sources */}\n      <section aria-labelledby=\"sources-heading\">\n        <h2 id=\"sources-heading\" className=\"text-lg font-semibold mb-3\">\n          Top Lead Sources\n        </h2>\n        <SourcesTable sources={sources} />\n      </section>\n\n      {/* Conversion funnel */}\n      {funnel && (\n        <section aria-labelledby=\"funnel-heading\">\n          <h2 id=\"funnel-heading\" className=\"text-lg font-semibold mb-3\">\n            Visitor Funnel (30 days)\n          </h2>\n          <FunnelVis funnel={funnel} />\n        </section>\n      )}\n    </div>\n  );\n}\n\nfunction MetricCard({\n  label,\n  value,\n  sublabel,\n  highlight = false,\n}: {\n  label: string;\n  value: string | number;\n  sublabel?: string;\n  highlight?: boolean;\n  'aria-label'?: string;\n}) {\n  return (\n    <div\n      className={`p-4 rounded-xl border ${highlight ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-white'}`}\n    >\n      <p className=\"text-sm text-gray-500 font-medium\">{label}</p>\n      <p className={`text-3xl font-extrabold mt-1 ${highlight ? 'text-green-700' : 'text-gray-900'}`}>\n        {value}\n      </p>\n      {sublabel && <p className=\"text-xs text-gray-400 mt-1\">{sublabel}</p>}\n    </div>\n  );\n}\n\nexport default async function AnalyticsDashboard({ tenantId }: { tenantId: string }) {\n  return (\n    <div>\n      <Suspense fallback={<AnalyticsSkeleton />}>\n        <MetricsSection tenantId={tenantId} />\n      </Suspense>\n    </div>\n  );\n}\n\nfunction AnalyticsSkeleton() {\n  return (\n    <div className=\"space-y-8 animate-pulse\" aria-busy=\"true\" aria-label=\"Loading analytics\">\n      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n        {[...Array(4)].map((_, i) => (\n          <div key={i} className=\"h-24 bg-gray-100 rounded-xl\" />\n        ))}\n      </div>\n      <div className=\"h-64 bg-gray-100 rounded-xl\" />\n      <div className=\"h-48 bg-gray-100 rounded-xl\" />\n    </div>\n  );\n}\n```\n\n---\n",
            "domainNumber": 13
          }
        }
      ]
    },
    {
      "domainNumber": 14,
      "success": true,
      "tasksCreated": 5,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 14,
          "fileName": "DOMAIN-14-why-section-why.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-14\\DOMAIN-14-why-section-why.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "14.1-why-this-is-p0-in-2026.md",
            "title": "Section why",
            "description": "Implementation for domain 14 section why",
            "topics": ["Domain 14 implementation"],
            "sectionNumber": "why",
            "content": "### 14.1 Why This Is P0 in 2026\n\n**Legal context:** ADA Title II compliance deadline for entities serving 50,000+ population: **April 24, 2026** â€” now **past**. Small entities: April 26, 2027. Private businesses face Title III litigation risk regardless of deadline. The platform's marketing clients (law firms, medical practices, home services) frequently serve government contracts, making WCAG 2.1 AA a contractual requirement. [blog.usablenet](https://blog.usablenet.com/title-ii-compliance-deadline-2026)\n\n**The standard:** WCAG 2.2 AA (target) / WCAG 2.1 AA (legal minimum). Key additions in WCAG 2.2: focus appearance (2.4.11), accessible authentication (3.3.8), dragging alternatives (2.5.7), target size minimum (2.5.8).\n\n---\n",
            "domainNumber": 14
          }
        },
        {
          "domainNumber": 14,
          "fileName": "DOMAIN-14-accessibility-section-accessibility.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-14\\DOMAIN-14-accessibility-section-accessibility.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "14.2-accessibility-component-library.md",
            "title": "Section accessibility",
            "description": "Implementation for domain 14 section accessibility",
            "topics": ["Domain 14 implementation"],
            "sectionNumber": "accessibility",
            "content": "### 14.2 Accessibility Component Library\n\n**File:** `packages/ui/src/a11y/index.ts` â€” exports all accessible primitives.\n\n**SkipToContent (WCAG 2.4.1 â€” Bypass Blocks):**\n\n```typescript\n// packages/ui/src/a11y/SkipToContent.tsx\nexport function SkipToContent({ mainId = 'main-content' }: { mainId?: string }) {\n  return (\n    <a\n      href={`#${mainId}`}\n      className=\"\n        sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4\n        focus:z-[9999] focus:bg-white focus:text-primary focus:border-2\n        focus:border-primary focus:px-4 focus:py-2 focus:rounded-lg\n        focus:font-semibold focus:shadow-lg\n        focus:outline-none focus-visible:ring-4 focus-visible:ring-primary/50\n      \"\n    >\n      Skip to main content\n    </a>\n  );\n}\n```\n\n**FocusTrap (modal/drawer dialogs â€” WCAG 2.1.2):**\n\n```typescript\n// packages/ui/src/a11y/FocusTrap.tsx\n'use client';\n\nimport { useEffect, useRef } from 'react';\n\nconst FOCUSABLE_SELECTORS = [\n  'a[href]',\n  'button:not([disabled])',\n  'input:not([disabled])',\n  'select:not([disabled])',\n  'textarea:not([disabled])',\n  '[tabindex]:not([tabindex=\"-1\"])',\n  'details > summary',\n].join(', ');\n\nexport function FocusTrap({\n  children,\n  active,\n}: {\n  children: React.ReactNode;\n  active: boolean;\n}) {\n  const containerRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    if (!active) return;\n    const container = containerRef.current;\n    if (!container) return;\n\n    // Focus first focusable element on open\n    const firstFocusable = container.querySelector<HTMLElement>(FOCUSABLE_SELECTORS);\n    firstFocusable?.focus();\n\n    const handleKeyDown = (e: KeyboardEvent) => {\n      if (e.key !== 'Tab') return;\n\n      const focusable = Array.from(\n        container.querySelectorAll<HTMLElement>(FOCUSABLE_SELECTORS)\n      ).filter((el) => !el.closest('[hidden]'));\n\n      const first = focusable[0];\n      const last = focusable[focusable.length - 1];\n\n      if (e.shiftKey) {\n        if (document.activeElement === first) {\n          e.preventDefault();\n          last?.focus();\n        }\n      } else {\n        if (document.activeElement === last) {\n          e.preventDefault();\n          first?.focus();\n        }\n      }\n    };\n\n    document.addEventListener('keydown', handleKeyDown);\n    return () => document.removeEventListener('keydown', handleKeyDown);\n  }, [active]);\n\n  return (\n    <div ref={containerRef}>\n      {children}\n    </div>\n  );\n}\n```\n\n**Accessible Modal (WCAG 4.1.3, 1.4.13, 2.1.2):**\n\n```typescript\n// packages/ui/src/a11y/Modal.tsx\n'use client';\n\nimport { useEffect, useRef } from 'react';\nimport { FocusTrap } from './FocusTrap';\nimport { createPortal } from 'react-dom';\n\ninterface ModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  title: string;\n  description?: string;\n  children: React.ReactNode;\n  size?: 'sm' | 'md' | 'lg';\n}\n\nexport function Modal({\n  isOpen,\n  onClose,\n  title,\n  description,\n  children,\n  size = 'md',\n}: ModalProps) {\n  const overlayRef = useRef<HTMLDivElement>(null);\n  const titleId = `modal-title-${Math.random().toString(36).slice(2)}`;\n  const descId = `modal-desc-${Math.random().toString(36).slice(2)}`;\n\n  // Restore focus to trigger element on close\n  const triggerRef = useRef<Element | null>(null);\n  useEffect(() => {\n    if (isOpen) {\n      triggerRef.current = document.activeElement;\n    } else {\n      (triggerRef.current as HTMLElement | null)?.focus();\n    }\n  }, [isOpen]);\n\n  // Escape key closes modal\n  useEffect(() => {\n    if (!isOpen) return;\n    const handler = (e: KeyboardEvent) => {\n      if (e.key === 'Escape') onClose();\n    };\n    document.addEventListener('keydown', handler);\n    // Prevent scroll on body\n    document.body.style.overflow = 'hidden';\n    return () => {\n      document.removeEventListener('keydown', handler);\n      document.body.style.overflow = '';\n    };\n  }, [isOpen, onClose]);\n\n  if (!isOpen) return null;\n\n  const sizeClasses = {\n    sm: 'max-w-md',\n    md: 'max-w-lg',\n    lg: 'max-w-2xl',\n  };\n\n  return createPortal(\n    <FocusTrap active={isOpen}>\n      {/* Overlay */}\n      <div\n        ref={overlayRef}\n        className=\"fixed inset-0 z-50 flex items-center justify-center p-4\"\n        aria-hidden=\"false\"\n      >\n        {/* Backdrop */}\n        <div\n          className=\"absolute inset-0 bg-black/50\"\n          onClick={onClose}\n          aria-hidden=\"true\"\n        />\n\n        {/* Dialog */}\n        <div\n          role=\"dialog\"\n          aria-modal=\"true\"\n          aria-labelledby={titleId}\n          aria-describedby={description ? descId : undefined}\n          className={`\n            relative z-10 bg-white rounded-xl shadow-2xl w-full ${sizeClasses[size]}\n            max-h-[90vh] overflow-y-auto\n          `}\n        >\n          <div className=\"flex items-start justify-between p-6 border-b\">\n            <div>\n              <h2 id={titleId} className=\"text-xl font-semibold text-gray-900\">\n                {title}\n              </h2>\n              {description && (\n                <p id={descId} className=\"mt-1 text-sm text-gray-500\">\n                  {description}\n                </p>\n              )}\n            </div>\n\n            <button\n              type=\"button\"\n              onClick={onClose}\n              className=\"ml-4 rounded-lg p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-100 focus-visible:ring-2 focus-visible:ring-primary focus-visible:outline-none\"\n              aria-label=\"Close dialog\"\n            >\n              {/* X icon */}\n              <svg\n                aria-hidden=\"true\"\n                className=\"h-5 w-5\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                stroke=\"currentColor\"\n              >\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n              </svg>\n            </button>\n          </div>\n\n          <div className=\"p-6\">{children}</div>\n        </div>\n      </div>\n    </FocusTrap>,\n    document.body\n  );\n}\n```\n\n---\n",
            "domainNumber": 14
          }
        },
        {
          "domainNumber": 14,
          "fileName": "DOMAIN-14-accessible-section-accessible.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-14\\DOMAIN-14-accessible-section-accessible.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "14.3-accessible-form-components.md",
            "title": "Section accessible",
            "description": "Implementation for domain 14 section accessible",
            "topics": ["Domain 14 implementation"],
            "sectionNumber": "accessible",
            "content": "### 14.3 Accessible Form Components\n\n**File:** `packages/ui/src/a11y/FormField.tsx`\n\n```typescript\n// WCAG 1.3.1 (Info and Relationships), 1.4.3 (Contrast), 3.3.1 (Error Identification)\n// 3.3.2 (Labels or Instructions), 3.3.3 (Error Suggestion), 3.3.4 (Error Prevention)\n\nimport { useId } from 'react';\n\ninterface FormFieldProps {\n  label: string;\n  error?: string;\n  hint?: string;\n  required?: boolean;\n  children: (props: {\n    id: string;\n    'aria-describedby'?: string;\n    'aria-invalid'?: boolean;\n    'aria-required'?: boolean;\n  }) => React.ReactNode;\n}\n\nexport function FormField({\n  label,\n  error,\n  hint,\n  required = false,\n  children,\n}: FormFieldProps) {\n  const id = useId();\n  const errorId = `${id}-error`;\n  const hintId = `${id}-hint`;\n\n  const ariaDescribedBy = [\n    hint ? hintId : null,\n    error ? errorId : null,\n  ]\n    .filter(Boolean)\n    .join(' ') || undefined;\n\n  return (\n    <div className=\"space-y-1.5\">\n      {/* Label â€” always visible, never placeholder-as-label */}\n      <label\n        htmlFor={id}\n        className=\"block text-sm font-medium text-gray-700\"\n      >\n        {label}\n        {required && (\n          <span\n            aria-label=\"required\"\n            className=\"ml-1 text-red-500\"\n            aria-hidden=\"true\"\n          >\n            *\n          </span>\n        )}\n      </label>\n\n      {/* Hint text (shown before the field, not after) */}\n      {hint && (\n        <p id={hintId} className=\"text-xs text-gray-500\">\n          {hint}\n        </p>\n      )}\n\n      {/* Field slot */}\n      {children({\n        id,\n        'aria-describedby': ariaDescribedBy,\n        'aria-invalid': error ? true : undefined,\n        'aria-required': required ? true : undefined,\n      })}\n\n      {/* Error message â€” always below the field, announced by screen reader */}\n      {error && (\n        <p\n          id={errorId}\n          role=\"alert\"\n          aria-live=\"polite\"\n          className=\"text-sm text-red-600 flex items-start gap-1.5\"\n        >\n          {/* Error icon (decorative) */}\n          <svg\n            aria-hidden=\"true\"\n            className=\"h-4 w-4 flex-shrink-0 mt-0.5\"\n            viewBox=\"0 0 20 20\"\n            fill=\"currentColor\"\n          >\n            <path\n              fillRule=\"evenodd\"\n              d=\"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z\"\n              clipRule=\"evenodd\"\n            />\n          </svg>\n          {error}\n        </p>\n      )}\n    </div>\n  );\n}\n```\n\n**Usage in contact form:**\n\n```typescript\n<FormField label=\"Email address\" required error={errors.email} hint=\"We'll never share your email\">\n  {(fieldProps) => (\n    <input\n      {...fieldProps}\n      type=\"email\"\n      name=\"email\"\n      autoComplete=\"email\"\n      className={`\n        block w-full rounded-md border px-3 py-2 text-sm\n        focus:outline-none focus-visible:ring-2 focus-visible:ring-primary\n        ${fieldProps['aria-invalid'] ? 'border-red-500 bg-red-50' : 'border-gray-300'}\n      `}\n    />\n  )}\n</FormField>\n```\n\n---\n",
            "domainNumber": 14
          }
        },
        {
          "domainNumber": 14,
          "fileName": "DOMAIN-14-wcag-section-wcag.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-14\\DOMAIN-14-wcag-section-wcag.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "14.4-wcag-22-compliance-checklist-per-site.md",
            "title": "Section wcag",
            "description": "Implementation for domain 14 section wcag",
            "topics": ["Domain 14 implementation"],
            "sectionNumber": "wcag",
            "content": "### 14.4 WCAG 2.2 Compliance Checklist per Site\n\n**File:** `packages/seo/src/a11y-checklist.ts`\n\n```typescript\n// Programmatic checks run in CI via axe-core\n// Manual checks documented here for QA review\n\nexport const WCAG_22_AA_CHECKLIST = [\n  // â”€â”€ Perceivable â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  {\n    id: '1.1.1',\n    criterion: 'Non-text Content',\n    implementation: 'All <Image> must have descriptive alt text. Decorative images: alt=\"\".',\n    automated: true,\n    test: 'axe: image-alt',\n  },\n  {\n    id: '1.3.1',\n    criterion: 'Info and Relationships',\n    implementation:\n      'Use semantic HTML: <nav>, <main>, <section aria-labelledby>, <header>, <footer>. Never div-soup for structure.',\n    automated: true,\n    test: 'axe: landmark-*',\n  },\n  {\n    id: '1.3.5',\n    criterion: 'Identify Input Purpose',\n    implementation:\n      'All form inputs have autocomplete attributes: name=\"email\" + autoComplete=\"email\".',\n    automated: true,\n    test: 'axe: autocomplete-valid',\n  },\n  {\n    id: '1.4.3',\n    criterion: 'Contrast (Minimum)',\n    implementation: 'Text/background contrast â‰¥ 4.5:1 (normal text), â‰¥ 3:1 (large text, 18pt+).',\n    automated: true,\n    test: 'axe: color-contrast',\n  },\n  {\n    id: '1.4.4',\n    criterion: 'Resize Text',\n    implementation: 'Use rem/em units, not px. Test at 200% zoom â€” no content loss.',\n    automated: false,\n    test: 'Manual: browser zoom to 200%',\n  },\n  {\n    id: '1.4.10',\n    criterion: 'Reflow',\n    implementation:\n      'Single-column layout at 320px width. No horizontal scroll. Use CSS Grid/Flexbox with wrap.',\n    automated: false,\n    test: 'Manual: iPhone SE viewport (375px)',\n  },\n  {\n    id: '1.4.13',\n    criterion: 'Content on Hover or Focus',\n    implementation: 'Tooltips must be: persistent, hoverable, dismissible. Use Radix Tooltip.',\n    automated: false,\n    test: 'Manual: hover tooltip â†’ move to tooltip content',\n  },\n\n  // â”€â”€ Operable â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  {\n    id: '2.1.1',\n    criterion: 'Keyboard',\n    implementation:\n      'All interactive elements reachable by Tab. No keyboard traps except intentional modals (2.1.2).',\n    automated: true,\n    test: 'axe: keyboard + Manual: tab through entire page',\n  },\n  {\n    id: '2.4.1',\n    criterion: 'Bypass Blocks',\n    implementation: '<SkipToContent /> as first element in layout.tsx.',\n    automated: false,\n    test: 'Manual: Tab â†’ first element is \"Skip to main content\"',\n  },\n  {\n    id: '2.4.3',\n    criterion: 'Focus Order',\n    implementation: 'DOM order matches visual order. No tabIndex > 0 (breaks natural order).',\n    automated: true,\n    test: 'axe: tabindex',\n  },\n  {\n    id: '2.4.7',\n    criterion: 'Focus Visible',\n    implementation:\n      'All focusable elements have visible :focus-visible ring. Use focus-visible: ring-2 ring-primary.',\n    automated: true,\n    test: 'axe: focus-visible + Manual: keyboard tab',\n  },\n  {\n    id: '2.4.11',\n    criterion: 'Focus Appearance (WCAG 2.2 NEW)',\n    implementation: 'Focus indicator: min 2px perimeter, min 3:1 contrast change. ring-2 = 2px âœ“.',\n    automated: false,\n    test: 'Manual: verify focus ring visibility on all interactive elements',\n  },\n  {\n    id: '2.5.3',\n    criterion: 'Label in Name',\n    implementation:\n      'Visible button text must match aria-label. Never aria-label=\"Submit\" on button that says \"Send\".',\n    automated: true,\n    test: 'axe: label-content-name-mismatch',\n  },\n  {\n    id: '2.5.7',\n    criterion: 'Dragging Movements (WCAG 2.2 NEW)',\n    implementation: 'All drag-to-reorder UI has a single-pointer alternative (up/down buttons).',\n    automated: false,\n    test: 'Manual: verify keyboard alternative for all drag interactions',\n  },\n  {\n    id: '2.5.8',\n    criterion: 'Target Size Minimum (WCAG 2.2 NEW)',\n    implementation: 'Interactive targets min 24Ã—24px. Buttons: min h-10 (40px) on mobile.',\n    automated: false,\n    test: 'Manual: inspect min-height on all clickable elements on mobile',\n  },\n\n  // â”€â”€ Understandable â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  {\n    id: '3.1.1',\n    criterion: 'Language of Page',\n    implementation: '<html lang=\"en\"> on all pages.',\n    automated: true,\n    test: 'axe: html-has-lang',\n  },\n  {\n    id: '3.3.1',\n    criterion: 'Error Identification',\n    implementation: 'All form errors: specific, programmatically associated via aria-describedby.',\n    automated: false,\n    test: 'Manual: submit empty form â†’ verify screen reader reads error',\n  },\n  {\n    id: '3.3.8',\n    criterion: 'Accessible Authentication (WCAG 2.2 NEW)',\n    implementation:\n      'No cognitive tests (CAPTCHA) without alternatives. Use hCaptcha + audio alternative, or email OTP.',\n    automated: false,\n    test: 'Manual: verify login flow works without visual CAPTCHA',\n  },\n\n  // â”€â”€ Robust â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  {\n    id: '4.1.2',\n    criterion: 'Name, Role, Value',\n    implementation:\n      'All custom components have aria-label, role, aria-expanded, aria-selected as appropriate.',\n    automated: true,\n    test: 'axe: aria-*',\n  },\n  {\n    id: '4.1.3',\n    criterion: 'Status Messages',\n    implementation: 'Toast/alert messages use role=\"status\" (polite) or role=\"alert\" (assertive).',\n    automated: false,\n    test: 'Manual: submit form â†’ verify screen reader announces success/error',\n  },\n] as const;\n```\n\n---\n",
            "domainNumber": 14
          }
        },
        {
          "domainNumber": 14,
          "fileName": "DOMAIN-14-automated-section-automated.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-14\\DOMAIN-14-automated-section-automated.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "14.5-automated-accessibility-testing-in-ci.md",
            "title": "Section automated",
            "description": "Implementation for domain 14 section automated",
            "topics": ["Domain 14 implementation"],
            "sectionNumber": "automated",
            "content": "### 14.5 Automated Accessibility Testing in CI\n\n**File:** `e2e/a11y/homepage.spec.ts`\n\n```typescript\nimport { test, expect } from '@playwright/test';\nimport AxeBuilder from '@axe-core/playwright';\n\nconst TEST_URLS = [\n  { name: 'Homepage', url: 'http://localhost:3001' },\n  { name: 'Contact Page', url: 'http://localhost:3001/contact' },\n  { name: 'Services Page', url: 'http://localhost:3001/services' },\n  { name: 'Blog Index', url: 'http://localhost:3001/blog' },\n  { name: 'Portal Login', url: 'http://localhost:3000/auth/login' },\n  { name: 'Portal Dashboard', url: 'http://localhost:3000/dashboard' },\n];\n\nfor (const { name, url } of TEST_URLS) {\n  test(`${name}: no WCAG 2.2 AA violations`, async ({ page }) => {\n    await page.goto(url);\n    await page.waitForLoadState('networkidle');\n\n    const results = await new AxeBuilder({ page })\n      .withTags([\n        'wcag2a',\n        'wcag2aa',\n        'wcag22aa', // WCAG 2.2 AA rules\n        'best-practice',\n      ])\n      .exclude('#cookie-banner') // Exclude third-party elements\n      .analyze();\n\n    // Group violations by impact for clear reporting\n    const critical = results.violations.filter((v) => v.impact === 'critical');\n    const serious = results.violations.filter((v) => v.impact === 'serious');\n\n    // Zero tolerance for critical and serious violations\n    if (critical.length || serious.length) {\n      console.error('[A11y Violations]', JSON.stringify([...critical, ...serious], null, 2));\n    }\n\n    expect(critical).toHaveLength(0);\n    expect(serious).toHaveLength(0);\n\n    // Log moderate/minor for awareness (don't fail CI)\n    const moderate = results.violations.filter((v) => v.impact === 'moderate');\n    if (moderate.length) {\n      console.warn(`[A11y Warning] ${moderate.length} moderate violations on ${name}`);\n    }\n  });\n\n  test(`${name}: keyboard navigation completes without trap`, async ({ page }) => {\n    await page.goto(url);\n    await page.waitForLoadState('networkidle');\n\n    // Tab through 20 elements â€” if focus is trapped, this will hang\n    for (let i = 0; i < 20; i++) {\n      await page.keyboard.press('Tab');\n      const focusedEl = await page.evaluate(() => document.activeElement?.tagName);\n      expect(focusedEl).not.toBeNull();\n    }\n  });\n\n  test(`${name}: skip to content link works`, async ({ page }) => {\n    await page.goto(url);\n\n    // First Tab should focus the skip link\n    await page.keyboard.press('Tab');\n    const skipLink = await page.evaluate(() => {\n      const el = document.activeElement;\n      return { tagName: el?.tagName, text: el?.textContent?.trim() };\n    });\n\n    expect(skipLink.tagName).toBe('A');\n    expect(skipLink.text?.toLowerCase()).toContain('skip');\n\n    // Activate the skip link\n    await page.keyboard.press('Enter');\n\n    // Focus should now be on main content\n    const focused = await page.evaluate(() => {\n      const el = document.activeElement;\n      return el?.id ?? el?.tagName;\n    });\n    expect(focused).toBe('main-content');\n  });\n\n  test(`${name}: all images have alt text`, async ({ page }) => {\n    await page.goto(url);\n\n    const imagesWithoutAlt = await page.evaluate(() => {\n      const imgs = Array.from(document.querySelectorAll('img'));\n      return imgs.filter((img) => img.getAttribute('alt') === null).map((img) => img.src);\n    });\n\n    expect(imagesWithoutAlt).toHaveLength(0);\n  });\n\n  test(`${name}: color contrast ratio â‰¥ 4.5:1 on body text`, async ({ page }) => {\n    await page.goto(url);\n\n    // Axe handles this programmatically\n    const results = await new AxeBuilder({ page }).withRules(['color-contrast']).analyze();\n\n    expect(results.violations).toHaveLength(0);\n  });\n}\n```\n\n---\n\n## Priority Table for Domains 11â€“14\n\n| Task                                              | Domain | Priority | Timeline | Success Metric                                    |\n| ------------------------------------------------- | ------ | -------- | -------- | ------------------------------------------------- |\n| Stripe webhook handler (idempotent)               | 11     | **P0**   | Day 5    | Duplicate events return 200, no double-processing |\n| Checkout session + billing page                   | 11     | **P0**   | Week 1   | Client can subscribe and see plan                 |\n| Customer portal (Manage Subscription)             | 11     | **P0**   | Week 1   | Client can update card, cancel, upgrade           |\n| Payment failure graduated response                | 11     | **P1**   | Week 1   | Suspension fires on 3rd failed attempt only       |\n| QStash job client + signature verification        | 12     | **P0**   | Week 1   | No job endpoint accepts unsigned requests         |\n| Lead digest daily email job                       | 12     | **P1**   | Week 2   | Warm leads batched, sent at 8 AM tenant TZ        |\n| CRM sync job (Zapier + HubSpot + GHL)             | 12     | **P1**   | Week 2   | Lead appears in CRM within 60s                    |\n| Booking reminder jobs (24h + 1h)                  | 12     | **P1**   | Week 2   | Client receives reminder before appointment       |\n| GDPR deletion job (30-day queued)                 | 12     | **P1**   | Week 2   | Tenant data deleted on cancellation + 30 days     |\n| Sentry + OpenTelemetry instrumentation            | 13     | **P0**   | Day 3    | Errors appear in Sentry within 60s                |\n| Tinybird analytics pipeline                       | 13     | **P1**   | Week 2   | Leads/day chart in portal                         |\n| Per-tenant Tinybird JWT (row-locked)              | 13     | **P1**   | Week 2   | Tenant A cannot query Tenant B data               |\n| Funnel analytics (visitor â†’ lead)                 | 13     | **P2**   | Week 3   | Funnel visible in portal analytics                |\n| SkipToContent + FocusTrap                         | 14     | **P0**   | Day 3    | Tab â†’ \"Skip to main content\" on all sites         |\n| FormField accessible wrapper                      | 14     | **P0**   | Day 3    | All forms pass axe: critical/serious = 0          |\n| Playwright axe-core CI suite                      | 14     | **P0**   | Week 1   | CI fails on any new critical a11y violation       |\n| WCAG 2.2 target size audit                        | 14     | **P1**   | Week 2   | All interactive elements â‰¥ 40px on mobile         |\n| Accessible Modal + Keyboard navigation            | 14     | **P1**   | Week 2   | Modal passes FocusTrap + Escape key tests         |\n| Full WCAG 2.2 AA checklist review                 | 14     | **P1**   | Week 2   | QA sign-off on all 20 checklist items             |\n| Accessible authentication (OTP, no CAPTCHA block) | 14     | **P2**   | Week 3   | Login completes without visual CAPTCHA dependency |\n\n---\n\n**Cross-domain invariants for Domains 11â€“14:**\n\n- Stripe webhooks always: (1) verify signature first, (2) check idempotency table, (3) insert idempotency record, (4) handle. Never skip any step. [digitalapplied](https://www.digitalapplied.com/blog/stripe-payment-integration-developer-guide-2026)\n- Every QStash job endpoint verifies the `upstash-signature` header â€” unsigned requests return `401`, never execute. [upstash](https://upstash.com/docs/qstash/features/background-jobs)\n- GDPR deletion is always delayed 30 days via QStash's `notBefore` parameter after cancellation â€” the grace period allows tenant to reactivate. [edpb.europa](https://www.edpb.europa.eu/news/news/2025/cef-2025-launch-coordinated-enforcement-right-erasure_en)\n- Sentry's `beforeSend` hook scrubs email addresses and phone numbers before sending to Sentry's servers â€” GDPR compliance for error reporting. [compliancepoint](https://www.compliancepoint.com/privacy/gdpr-right-to-erasure-an-enforcement-priority-in-2025/)\n- Tinybird tokens are scoped to a single tenant via `fixed_params` â€” a compromised portal session cannot access another tenant's analytics. [clerk](https://clerk.com/blog/tinybird-and-clerk)\n- Accessibility is a day-one concern, not a post-launch audit â€” every component in `@repo/ui` is built accessible from the first commit. The ADA Title II April 2026 deadline makes this legally enforceable for government-serving clients. [briskventures](https://briskventures.us/blog/ada-compliance-in-2026-accessibility-that-drives-growth/)\n\n---\n\nHere are Domains 15â€“18 at complete production depth.\n\n---\n",
            "domainNumber": 14
          }
        }
      ]
    },
    {
      "domainNumber": 15,
      "success": true,
      "tasksCreated": 5,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 15,
          "fileName": "DOMAIN-15-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-15\\DOMAIN-15-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "15.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 15 section philosophy.md",
            "topics": ["Domain 15 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 15.1 Philosophy\n\n**What it is:** Security is a system property â€” not a single file. The platform hardens at four layers: HTTP headers (what the browser enforces), rate limiting (what the edge enforces), input sanitization (what the application enforces), and secrets management (what the infrastructure enforces). [github](https://github.com/vercel/next.js/discussions/80997)\n\n**CVE-2025-29927 lesson:** The March 2025 Next.js middleware bypass vulnerability allowed attackers to skip all middleware by sending a crafted `x-middleware-subrequest` header â€” bypassing auth, CSP, and rate limiting simultaneously. The lesson: **never rely solely on middleware for access control**. Route Handlers and Server Actions must independently verify session/permissions. Defense in depth is not optional. [projectdiscovery](https://projectdiscovery.io/blog/nextjs-middleware-authorization-bypass)\n\n---\n",
            "domainNumber": 15
          }
        },
        {
          "domainNumber": 15,
          "fileName": "DOMAIN-15-complete-section-complete.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-15\\DOMAIN-15-complete-section-complete.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "15.2-complete-security-headers-system.md",
            "title": "Section complete",
            "description": "Implementation for domain 15 section complete",
            "topics": ["Domain 15 implementation"],
            "sectionNumber": "complete",
            "content": "### 15.2 Complete Security Headers System\n\n**File:** `packages/security/src/headers.ts`\n\n```typescript\nimport { NextRequest, NextResponse } from 'next/server';\nimport { v4 as uuidv4 } from 'uuid';\n\n// ============================================================================\n// SECURITY HEADERS\n// Applied in middleware on EVERY response â€” both marketing sites and portal.\n// Nonce-based CSP: prevents XSS by requiring all inline scripts to carry\n// a per-request random token. Script tags in RSC must read nonce from headers.\n// Reference: https://nextjs.org/docs/app/guides/content-security-policy\n// ============================================================================\n\nexport type SecurityHeadersConfig = {\n  environment: 'production' | 'staging' | 'development';\n  isDashboard: boolean; // Portal routes get stricter CSP than marketing sites\n  customDomain?: string; // For frame-ancestors if embedded in CMS\n};\n\nexport function buildSecurityHeaders(\n  request: NextRequest,\n  config: SecurityHeadersConfig\n): { nonce: string; headers: Record<string, string> } {\n  const nonce = Buffer.from(uuidv4()).toString('base64');\n  const isDev = config.environment === 'development';\n\n  // â”€â”€ Content Security Policy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // Per-request nonce enables strict-dynamic without unsafe-inline.\n  // Every <Script nonce={nonce}> tag is allowed. All others blocked.\n\n  const scriptSrc = [\n    \"'self'\",\n    `'nonce-${nonce}'`,\n    \"'strict-dynamic'\", // Trusts scripts loaded by nonced scripts\n    ...(isDev ? [\"'unsafe-eval'\"] : []), // Next.js dev mode requires eval\n    'https://js.stripe.com', // Stripe.js\n    'https://*.googleapis.com', // Google Tag Manager (if enabled by client)\n    'https://*.googletagmanager.com',\n  ].join(' ');\n\n  const connectSrc = [\n    \"'self'\",\n    'https://*.supabase.co', // Supabase Realtime + REST\n    'https://*.supabase.in',\n    'wss://*.supabase.co', // WebSocket for Realtime\n    'https://api.stripe.com',\n    'https://api.tinybird.co',\n    'https://*.sentry.io',\n    'https://o0.ingest.sentry.io',\n    ...(isDev ? ['ws://localhost:*', 'http://localhost:*'] : []),\n  ].join(' ');\n\n  const frameSrc = [\n    \"'self'\",\n    'https://js.stripe.com', // Stripe payment iframe\n    'https://hooks.stripe.com',\n    ...(config.customDomain ? [`https://${config.customDomain}`] : []),\n  ].join(' ');\n\n  const imgSrc = [\n    \"'self'\",\n    'blob:',\n    'data:',\n    'https://*.supabase.co', // Supabase storage images\n    'https://*.supabase.in',\n    'https://lh3.googleusercontent.com', // Google avatar\n    'https://avatars.githubusercontent.com',\n    'https://placehold.co', // Placeholder images (dev only)\n    'https://*.sanity.io', // Sanity CMS images\n    'https://cdn.sanity.io',\n  ].join(' ');\n\n  const csp = [\n    `default-src 'self'`,\n    `script-src ${scriptSrc}`,\n    `style-src 'self' 'unsafe-inline' https://fonts.googleapis.com`, // unsafe-inline needed for Tailwind\n    `img-src ${imgSrc}`,\n    `font-src 'self' https://fonts.gstatic.com`,\n    `object-src 'none'`,\n    `base-uri 'self'`,\n    `form-action 'self'`,\n    `frame-ancestors ${config.isDashboard ? \"'self'\" : \"'none'\"}`, // Clickjacking prevention\n    `frame-src ${frameSrc}`,\n    `connect-src ${connectSrc}`,\n    `media-src 'self'`,\n    `worker-src 'self' blob:`,\n    `manifest-src 'self'`,\n    `upgrade-insecure-requests`,\n    ...(config.environment === 'production' ? [`block-all-mixed-content`] : []),\n  ]\n    .join('; ')\n    .replace(/\\n/g, '');\n\n  const headers: Record<string, string> = {\n    // CSP (nonce-based, per-request)\n    'Content-Security-Policy': csp,\n\n    // Strict Transport Security (HSTS)\n    // max-age=31536000 = 1 year. includeSubDomains covers *.youragency.com.\n    // preload: eligible for HSTS preload list (https://hstspreload.org)\n    'Strict-Transport-Security': 'max-age=31536000; includeSubDomains; preload',\n\n    // X-Frame-Options (legacy clickjacking prevention, supplement to CSP frame-ancestors)\n    'X-Frame-Options': config.isDashboard ? 'SAMEORIGIN' : 'DENY',\n\n    // X-Content-Type-Options: prevents MIME-type sniffing\n    'X-Content-Type-Options': 'nosniff',\n\n    // Referrer-Policy: limits referrer info sent to third parties\n    // strict-origin-when-cross-origin: sends full URL within same origin, origin only to HTTPS, nothing to HTTP\n    'Referrer-Policy': 'strict-origin-when-cross-origin',\n\n    // Permissions-Policy: disable browser features we never use\n    'Permissions-Policy': [\n      'camera=()', // No webcam access\n      'microphone=()', // No mic access\n      'geolocation=(self)', // Geolocation only from self (service locator feature)\n      'payment=()', // No Payment Request API (using Stripe iframe)\n      'usb=()',\n      'bluetooth=()',\n      'midi=()',\n      'magnetometer=()',\n      'gyroscope=()',\n      'accelerometer=()',\n      'interest-cohort=()', // Disable FLoC\n    ].join(', '),\n\n    // Cross-Origin-Embedder-Policy + Cross-Origin-Opener-Policy\n    // Needed for SharedArrayBuffer (not used, but good practice)\n    'Cross-Origin-Embedder-Policy': 'unsafe-none', // 'require-corp' breaks Stripe\n    'Cross-Origin-Opener-Policy': 'same-origin-allow-popups', // Allows Stripe popup\n    'Cross-Origin-Resource-Policy': 'cross-origin', // Allows CDN assets\n\n    // Pass nonce to Server Components via request header\n    'X-Nonce': nonce,\n\n    // Remove fingerprinting headers\n    'X-Powered-By': '', // Remove \"X-Powered-By: Next.js\"\n    Server: '', // Remove \"Server: Vercel\"\n  };\n\n  return { nonce, headers };\n}\n\n// ============================================================================\n// APPLY TO RESPONSE\n// ============================================================================\n\nexport function applySecurityHeaders(\n  request: NextRequest,\n  response: NextResponse,\n  config: SecurityHeadersConfig\n): { response: NextResponse; nonce: string } {\n  const { nonce, headers } = buildSecurityHeaders(request, config);\n\n  for (const [key, value] of Object.entries(headers)) {\n    if (value === '') {\n      // Delete header (remove fingerprinting)\n      response.headers.delete(key);\n    } else {\n      response.headers.set(key, value);\n    }\n  }\n\n  return { response, nonce };\n}\n```\n\n---\n",
            "domainNumber": 15
          }
        },
        {
          "domainNumber": 15,
          "fileName": "DOMAIN-15-multi-section-multi.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-15\\DOMAIN-15-multi-section-multi.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "15.3-multi-layer-rate-limiting.md",
            "title": "Section multi",
            "description": "Implementation for domain 15 section multi",
            "topics": ["Domain 15 implementation"],
            "sectionNumber": "multi",
            "content": "### 15.3 Multi-Layer Rate Limiting\n\n**File:** `packages/security/src/rate-limit.ts`\n\n```typescript\nimport { Ratelimit } from '@upstash/ratelimit';\nimport { Redis } from '@upstash/redis';\nimport { NextRequest, NextResponse } from 'next/server';\n\n// ============================================================================\n// RATE LIMITER INSTANCES\n// Each enforces a different sliding window â€” stacked for defense in depth.\n// Reference: https://upstash.com/blog/edge-rate-limiting\n// ============================================================================\n\nconst redis = Redis.fromEnv();\n\n// Global per-IP (prevents volumetric attacks)\nconst globalLimiter = new Ratelimit({\n  redis,\n  limiter: Ratelimit.slidingWindow(200, '1 m'), // 200 req/min per IP\n  analytics: true,\n  prefix: 'rl:global',\n});\n\n// Form submission limiter (anti-spam for lead forms)\nconst formLimiter = new Ratelimit({\n  redis,\n  limiter: Ratelimit.slidingWindow(5, '10 m'), // 5 submissions per 10 min\n  analytics: true,\n  prefix: 'rl:form',\n});\n\n// Authentication limiter (brute force protection)\nconst authLimiter = new Ratelimit({\n  redis,\n  limiter: Ratelimit.slidingWindow(10, '15 m'), // 10 auth attempts per 15 min\n  analytics: true,\n  prefix: 'rl:auth',\n});\n\n// API limiter (per API key or IP for programmatic access)\nconst apiLimiter = new Ratelimit({\n  redis,\n  limiter: Ratelimit.slidingWindow(60, '1 m'), // 60 req/min\n  analytics: true,\n  prefix: 'rl:api',\n});\n\n// Webhook ingestion (Stripe, Zapier, etc.)\nconst webhookLimiter = new Ratelimit({\n  redis,\n  limiter: Ratelimit.slidingWindow(100, '1 m'), // 100/min (Stripe can burst)\n  analytics: true,\n  prefix: 'rl:webhook',\n});\n\n// ============================================================================\n// RATE LIMIT MIDDLEWARE\n// Returns a 429 response if limit exceeded; null if allowed.\n// ============================================================================\n\nexport type RateLimitTier = 'global' | 'form' | 'auth' | 'api' | 'webhook';\n\nconst LIMITERS: Record<RateLimitTier, Ratelimit> = {\n  global: globalLimiter,\n  form: formLimiter,\n  auth: authLimiter,\n  api: apiLimiter,\n  webhook: webhookLimiter,\n};\n\n// Canonical IP extraction (Vercel sets x-forwarded-for; trust leftmost)\nfunction getClientIP(request: NextRequest): string {\n  const xForwardedFor = request.headers.get('x-forwarded-for');\n  if (xForwardedFor) {\n    // Leftmost IP = true client (rightmost = Vercel's edge)\n    return xForwardedFor.split(',')[0].trim();\n  }\n  return request.headers.get('x-real-ip') ?? '127.0.0.1';\n}\n\nexport async function checkRateLimit(\n  request: NextRequest,\n  tier: RateLimitTier,\n  identifier?: string // Override IP with user ID or API key for auth'd routes\n): Promise<NextResponse | null> {\n  const limiter = LIMITERS[tier];\n  const ip = getClientIP(request);\n  const key = identifier ?? ip;\n\n  const { success, limit, remaining, reset } = await limiter.limit(key);\n\n  if (!success) {\n    const resetDate = new Date(reset);\n    const retryAfterSeconds = Math.ceil((reset - Date.now()) / 1000);\n\n    return NextResponse.json(\n      {\n        error: 'Too many requests',\n        message: `Rate limit exceeded. Try again after ${resetDate.toISOString()}.`,\n        retryAfter: retryAfterSeconds,\n      },\n      {\n        status: 429,\n        headers: {\n          'X-RateLimit-Limit': String(limit),\n          'X-RateLimit-Remaining': '0',\n          'X-RateLimit-Reset': String(reset),\n          'Retry-After': String(retryAfterSeconds),\n        },\n      }\n    );\n  }\n\n  // Return null (allowed) â€” caller attaches informational headers\n  return null;\n}\n\n// ============================================================================\n// CONVENIENCE: Wrap a Route Handler with rate limiting\n// Usage:\n//   export const POST = withRateLimit('form', async (req) => { ... });\n// ============================================================================\n\nexport function withRateLimit(\n  tier: RateLimitTier,\n  handler: (req: NextRequest) => Promise<NextResponse>\n): (req: NextRequest) => Promise<NextResponse> {\n  return async (req: NextRequest) => {\n    const limitResponse = await checkRateLimit(req, tier);\n    if (limitResponse) return limitResponse;\n    return handler(req);\n  };\n}\n```\n\n---\n",
            "domainNumber": 15
          }
        },
        {
          "domainNumber": 15,
          "fileName": "DOMAIN-15-complete-section-complete.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-15\\DOMAIN-15-complete-section-complete.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "15.4-complete-middleware.md",
            "title": "Section complete",
            "description": "Implementation for domain 15 section complete",
            "topics": ["Domain 15 implementation"],
            "sectionNumber": "complete",
            "content": "### 15.4 Complete Middleware\n\n**File:** `apps/*/src/middleware.ts` â€” the unified middleware integrating all security layers.\n\n```typescript\nimport { NextRequest, NextResponse } from 'next/server';\nimport { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server';\nimport { resolveTenant } from '@repo/multi-tenant/resolve-tenant';\nimport { applySecurityHeaders } from '@repo/security/headers';\nimport { checkRateLimit } from '@repo/security/rate-limit';\nimport { applyABTests } from '@repo/analytics/ab-testing';\n\n// ============================================================================\n// ROUTE MATCHERS\n// ============================================================================\n\nconst isPublicRoute = createRouteMatcher([\n  '/',\n  '/about(.*)',\n  '/services(.*)',\n  '/blog(.*)',\n  '/contact(.*)',\n  '/api/contact',\n  '/api/webhooks/(.*)',\n  '/api/draft-mode/(.*)',\n  '/api/jobs/(.*)', // Protected by QStash signature, not Clerk\n  '/sitemap.xml',\n  '/robots.txt',\n  '/llms.txt',\n  '/llms-full.txt',\n  '/ai-context.json',\n  '/og(.*)',\n  '/auth/(.*)',\n  '/sign-in(.*)',\n  '/sign-up(.*)',\n]);\n\nconst isAuthRoute = createRouteMatcher(['/auth/(.*)', '/sign-in(.*)', '/sign-up(.*)']);\n\nconst isAdminRoute = createRouteMatcher(['/admin(.*)']);\n\nconst isAPIRoute = createRouteMatcher(['/api/(.*)']);\n\nconst isWebhookRoute = createRouteMatcher(['/api/webhooks/(.*)']);\n\n// ============================================================================\n// MAIN MIDDLEWARE\n// Order matters: security headers â†’ rate limiting â†’ tenant resolution â†’ auth\n// ============================================================================\n\nexport default clerkMiddleware(async (auth, request: NextRequest) => {\n  const { pathname, hostname } = request.nextUrl;\n  const isDashboard = hostname.includes('portal.') || hostname.includes('app.');\n\n  // â”€â”€ Step 1: Block CVE-2025-29927 header injection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // Defense against middleware bypass via crafted subrequest header [web:24]\n  if (request.headers.has('x-middleware-subrequest')) {\n    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\n  }\n\n  // â”€â”€ Step 2: Apply security headers (nonce generated per request) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  let response = NextResponse.next();\n  const { response: securedResponse, nonce } = applySecurityHeaders(request, response, {\n    environment: (process.env.VERCEL_ENV ?? 'development') as any,\n    isDashboard,\n  });\n  response = securedResponse;\n\n  // Forward nonce to Server Components (reads from headers in layout)\n  response.headers.set('X-Nonce', nonce);\n\n  // â”€â”€ Step 3: Rate limiting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n  // Webhook endpoints: separate limit (Stripe bursts)\n  if (isWebhookRoute(request)) {\n    const limited = await checkRateLimit(request, 'webhook');\n    if (limited) return limited;\n  }\n  // API routes: standard API limit\n  else if (isAPIRoute(request)) {\n    const limited = await checkRateLimit(request, 'api');\n    if (limited) return limited;\n  }\n  // All other routes: global IP limit\n  else {\n    const limited = await checkRateLimit(request, 'global');\n    if (limited) return limited;\n  }\n\n  // â”€â”€ Step 4: Tenant resolution (custom domain / subdomain routing) â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const tenantContext = await resolveTenant(request);\n\n  if (!tenantContext) {\n    // Unknown domain â€” 404 or redirect to marketing site\n    return NextResponse.rewrite(new URL('/404', request.url));\n  }\n\n  // Inject tenant context into request headers (reads in Server Components)\n  response.headers.set('X-Tenant-Id', tenantContext.tenantId);\n  response.headers.set('X-Tenant-Slug', tenantContext.slug);\n  response.headers.set('X-Billing-Tier', tenantContext.billingTier);\n\n  // â”€â”€ Step 5: Suspended tenant gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  if (\n    tenantContext.status === 'suspended' &&\n    !isPublicRoute(request) &&\n    !pathname.startsWith('/billing')\n  ) {\n    return NextResponse.redirect(new URL('/suspended', request.url));\n  }\n\n  // â”€â”€ Step 6: Clerk auth (protected routes only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  if (!isPublicRoute(request)) {\n    const { userId } = await auth();\n\n    if (!userId) {\n      return NextResponse.redirect(new URL('/sign-in', request.url));\n    }\n\n    // Admin-only routes require admin role\n    if (isAdminRoute(request)) {\n      const { sessionClaims } = await auth();\n      const userRole = (sessionClaims?.metadata as any)?.role;\n\n      if (userRole !== 'super_admin') {\n        return NextResponse.redirect(new URL('/dashboard', request.url));\n      }\n    }\n\n    response.headers.set('X-User-Id', userId);\n  }\n\n  // â”€â”€ Step 7: A/B testing (cookie assignment â€” zero CLS) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  response = await applyABTests(request, response, tenantContext.tenantId);\n\n  return response;\n});\n\nexport const config = {\n  matcher: [\n    // Match all paths except Next.js internals and static files\n    '/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp|ico|css|js|woff|woff2)).*)',\n  ],\n};\n```\n\n---\n",
            "domainNumber": 15
          }
        },
        {
          "domainNumber": 15,
          "fileName": "DOMAIN-15-secrets-section-secrets.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-15\\DOMAIN-15-secrets-section-secrets.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "15.5-secrets-manager.md",
            "title": "Section secrets",
            "description": "Implementation for domain 15 section secrets",
            "topics": ["Domain 15 implementation"],
            "sectionNumber": "secrets",
            "content": "### 15.5 Secrets Manager\n\n**File:** `packages/security/src/secrets-manager.ts`\n\n```typescript\nimport { Redis } from '@upstash/redis';\nimport { createClient } from '@supabase/supabase-js';\nimport { createCipheriv, createDecipheriv, randomBytes } from 'crypto';\n\n// ============================================================================\n// PER-TENANT SECRETS (CRM API keys, Zapier webhooks, etc.)\n// Encrypted at rest using AES-256-GCM. Key stored in environment variable.\n// Cached in Redis with 1-hour TTL.\n// NEVER store plaintext secrets in the tenant config column.\n// ============================================================================\n\nconst redis = Redis.fromEnv();\nconst supabaseAdmin = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\nconst ENCRYPTION_KEY = Buffer.from(process.env.SECRETS_ENCRYPTION_KEY!, 'hex'); // 32 bytes (256 bits)\nconst CACHE_TTL = 3600; // 1 hour\n\n// â”€â”€ AES-256-GCM Encryption â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nfunction encrypt(plaintext: string): string {\n  const iv = randomBytes(12); // 96-bit IV for GCM\n  const cipher = createCipheriv('aes-256-gcm', ENCRYPTION_KEY, iv);\n\n  const encrypted = Buffer.concat([cipher.update(plaintext, 'utf8'), cipher.final()]);\n\n  const authTag = cipher.getAuthTag(); // 128-bit authentication tag\n\n  // Format: iv:authTag:ciphertext (all hex-encoded)\n  return [iv.toString('hex'), authTag.toString('hex'), encrypted.toString('hex')].join(':');\n}\n\nfunction decrypt(ciphertext: string): string {\n  const [ivHex, authTagHex, encryptedHex] = ciphertext.split(':');\n\n  const iv = Buffer.from(ivHex, 'hex');\n  const authTag = Buffer.from(authTagHex, 'hex');\n  const encrypted = Buffer.from(encryptedHex, 'hex');\n\n  const decipher = createDecipheriv('aes-256-gcm', ENCRYPTION_KEY, iv);\n  decipher.setAuthTag(authTag);\n\n  const decrypted = Buffer.concat([decipher.update(encrypted), decipher.final()]);\n\n  return decrypted.toString('utf8');\n}\n\n// â”€â”€ Public API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function getTenantSecret(tenantId: string, secretKey: string): Promise<string | null> {\n  const cacheKey = `secret:${tenantId}:${secretKey}`;\n\n  // Check Redis cache first\n  const cached = await redis.get<string>(cacheKey);\n  if (cached) return cached;\n\n  // Fetch from DB\n  const { data } = await supabaseAdmin\n    .from('tenant_secrets')\n    .select('value_encrypted')\n    .eq('tenant_id', tenantId)\n    .eq('key', secretKey)\n    .single();\n\n  if (!data?.value_encrypted) return null;\n\n  // Decrypt\n  let decrypted: string;\n  try {\n    decrypted = decrypt(data.value_encrypted);\n  } catch (err) {\n    console.error(`[Secrets] Decryption failed for ${tenantId}:${secretKey}`, err);\n    return null;\n  }\n\n  // Cache decrypted value (safe in Redis â€” Redis traffic is encrypted in transit via TLS)\n  await redis.setex(cacheKey, CACHE_TTL, decrypted);\n\n  return decrypted;\n}\n\nexport async function setTenantSecret(\n  tenantId: string,\n  secretKey: string,\n  value: string\n): Promise<void> {\n  const encrypted = encrypt(value);\n\n  await supabaseAdmin.from('tenant_secrets').upsert(\n    {\n      tenant_id: tenantId,\n      key: secretKey,\n      value_encrypted: encrypted,\n      updated_at: new Date().toISOString(),\n    },\n    { onConflict: 'tenant_id,key' }\n  );\n\n  // Bust cache\n  const cacheKey = `secret:${tenantId}:${secretKey}`;\n  await redis.del(cacheKey);\n}\n\nexport async function deleteTenantSecret(tenantId: string, secretKey: string): Promise<void> {\n  await supabaseAdmin\n    .from('tenant_secrets')\n    .delete()\n    .eq('tenant_id', tenantId)\n    .eq('key', secretKey);\n\n  const cacheKey = `secret:${tenantId}:${secretKey}`;\n  await redis.del(cacheKey);\n}\n\nexport async function listTenantSecretKeys(tenantId: string): Promise<string[]> {\n  const { data } = await supabaseAdmin\n    .from('tenant_secrets')\n    .select('key')\n    .eq('tenant_id', tenantId)\n    .order('key');\n\n  return (data ?? []).map((row) => row.key);\n}\n```\n\n---\n",
            "domainNumber": 15
          }
        }
      ]
    },
    {
      "domainNumber": 16,
      "success": true,
      "tasksCreated": 3,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 16,
          "fileName": "DOMAIN-16-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-16\\DOMAIN-16-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "16.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 16 section philosophy.md",
            "topics": ["Domain 16 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 16.1 Philosophy\n\n**What it is:** The CI/CD pipeline is the gatekeeper between code and production. For a monorepo, the critical technique is **affected-package detection** â€” only building, testing, and deploying the packages changed by a given commit. Without this, a one-line fix in a shared utility triggers full rebuilds of 10+ applications. [dev](https://dev.to/pockit_tools/github-actions-in-2026-the-complete-guide-to-monorepo-cicd-and-self-hosted-runners-1jop)\n\n**Why Turborepo remote caching is essential:** Without it, every CI run starts cold. With Vercel Remote Cache, if a teammate built `packages/ui` with identical inputs 10 minutes ago, your CI run gets a cache hit â€” 0ms to rebuild. At 50 PRs/day, this saves 20+ hours of CI time daily. [vercel](https://vercel.com/docs/monorepos/turborepo)\n\n---\n",
            "domainNumber": 16
          }
        },
        {
          "domainNumber": 16,
          "fileName": "DOMAIN-16-complete-cancel-inprogress-runs-for-the-same-branchpr.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-16\\DOMAIN-16-complete-cancel-inprogress-runs-for-the-same-branchpr.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "16.2-complete-github-actions-workflow.md",
            "title": "Cancel in-progress runs for the same branch/PR",
            "description": "concurrency:",
            "topics": ["Domain 16 implementation"],
            "sectionNumber": "complete",
            "content": "### 16.2 Complete GitHub Actions Workflow\n\n**File:** `.github/workflows/ci.yml`\n\n```yaml\nname: CI\n\non:\n  push:\n    branches: [main, develop]\n  pull_request:\n    branches: [main, develop]\n  workflow_dispatch:\n\n# Cancel in-progress runs for the same branch/PR\nconcurrency:\n  group: ${{ github.workflow }}-${{ github.ref }}\n  cancel-in-progress: true\n\nenv:\n  # Turborepo remote cache\n  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}\n  TURBO_TEAM: ${{ vars.TURBO_TEAM }}\n  # Node/pnpm versions\n  NODE_VERSION: '22'\n  PNPM_VERSION: '9'\n\njobs:\n  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  # JOB 1: Detect affected packages\n  # Outputs a JSON matrix of changed apps for downstream jobs\n  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  detect-changes:\n    name: Detect Changed Packages\n    runs-on: ubuntu-latest\n    outputs:\n      affected-apps: ${{ steps.turbo-affected.outputs.apps }}\n      has-shared-changes: ${{ steps.turbo-affected.outputs.has-shared }}\n    steps:\n      - uses: actions/checkout@v4\n        with:\n          fetch-depth: 0 # Full history needed for turbo --since\n\n      - uses: pnpm/action-setup@v4\n        with:\n          version: ${{ env.PNPM_VERSION }}\n\n      - uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'pnpm'\n\n      - name: Install dependencies\n        run: pnpm install --frozen-lockfile\n\n      - name: Detect affected apps\n        id: turbo-affected\n        run: |\n          # Get list of affected packages vs main branch\n          AFFECTED=$(pnpm turbo run build --dry=json --filter=\"...[origin/main]\" 2>/dev/null | jq -r '.packages[]' | grep '^apps/' | jq -R -s -c 'split(\"\\n\") | map(select(length > 0))')\n          echo \"apps=$AFFECTED\" >> $GITHUB_OUTPUT\n\n          # Check if any shared package changed (triggers all app rebuilds)\n          SHARED=$(pnpm turbo run build --dry=json --filter=\"...[origin/main]\" 2>/dev/null | jq -r '.packages[]' | grep '^packages/')\n          if [ -n \"$SHARED\" ]; then\n            echo \"has-shared=true\" >> $GITHUB_OUTPUT\n          else\n            echo \"has-shared=false\" >> $GITHUB_OUTPUT\n          fi\n\n  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  # JOB 2: Type checking + linting (all packages)\n  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  typecheck-lint:\n    name: Typecheck & Lint\n    runs-on: ubuntu-latest\n    needs: detect-changes\n    steps:\n      - uses: actions/checkout@v4\n\n      - uses: pnpm/action-setup@v4\n        with:\n          version: ${{ env.PNPM_VERSION }}\n\n      - uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'pnpm'\n\n      - name: Install dependencies\n        run: pnpm install --frozen-lockfile\n\n      - name: TypeScript check (affected)\n        run: pnpm turbo run typecheck --filter=\"...[origin/main]\" --output-logs=new-only\n\n      - name: ESLint (affected)\n        run: pnpm turbo run lint --filter=\"...[origin/main]\" --output-logs=new-only\n\n      - name: Prettier check\n        run: pnpm prettier --check \"**/*.{ts,tsx,json,md}\" --ignore-path .gitignore\n\n  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  # JOB 3: Unit + integration tests\n  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  test:\n    name: Unit Tests\n    runs-on: ubuntu-latest\n    needs: typecheck-lint\n\n    services:\n      # Local Postgres for integration tests (avoids hitting Supabase)\n      postgres:\n        image: supabase/postgres:15.1.1.89\n        env:\n          POSTGRES_PASSWORD: postgres\n          POSTGRES_DB: test\n        ports:\n          - 5432:5432\n        options: >-\n          --health-cmd pg_isready\n          --health-interval 10s\n          --health-timeout 5s\n          --health-retries 5\n\n    env:\n      # Test environment DB (isolated from production)\n      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test\n      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.TEST_SUPABASE_SERVICE_ROLE_KEY }}\n      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.TEST_SUPABASE_URL }}\n      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.TEST_SUPABASE_ANON_KEY }}\n\n    steps:\n      - uses: actions/checkout@v4\n\n      - uses: pnpm/action-setup@v4\n        with:\n          version: ${{ env.PNPM_VERSION }}\n\n      - uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'pnpm'\n\n      - name: Install dependencies\n        run: pnpm install --frozen-lockfile\n\n      - name: Run DB migrations (test DB)\n        run: pnpm --filter @repo/db run migrate\n\n      - name: Run unit tests (affected, with coverage)\n        run: |\n          pnpm turbo run test \\\n            --filter=\"...[origin/main]\" \\\n            --output-logs=new-only \\\n            -- --coverage\n\n      - name: Upload coverage to Codecov\n        uses: codecov/codecov-action@v4\n        with:\n          token: ${{ secrets.CODECOV_TOKEN }}\n          fail_ci_if_error: false\n\n  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  # JOB 4: Build (affected apps only)\n  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  build:\n    name: Build ${{ matrix.app }}\n    runs-on: ubuntu-latest\n    needs: test\n    if: ${{ needs.detect-changes.outputs.affected-apps != '[]' || needs.detect-changes.outputs.has-shared-changes == 'true' }}\n\n    strategy:\n      fail-fast: false # Let other apps continue building even if one fails\n      matrix:\n        app: ${{ fromJSON(needs.detect-changes.outputs.affected-apps || '[\"apps/portal\", \"apps/admin\"]') }}\n\n    env:\n      # Build-time env vars per app\n      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}\n      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}\n      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}\n      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}\n\n    steps:\n      - uses: actions/checkout@v4\n\n      - uses: pnpm/action-setup@v4\n        with:\n          version: ${{ env.PNPM_VERSION }}\n\n      - uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'pnpm'\n\n      - name: Install dependencies\n        run: pnpm install --frozen-lockfile\n\n      - name: Build ${{ matrix.app }}\n        run: |\n          APP_NAME=$(echo \"${{ matrix.app }}\" | cut -d'/' -f2)\n          pnpm turbo run build --filter=\"$APP_NAME\" --output-logs=new-only\n\n      - name: Check build output size\n        run: |\n          if [ -f \"${{ matrix.app }}/.next/build-manifest.json\" ]; then\n            echo \"=== Bundle Size Report ===\"\n            du -sh ${{ matrix.app }}/.next/\n            # Fail if total bundle > 50MB (red flag for accidental imports)\n            SIZE=$(du -sb ${{ matrix.app }}/.next/ | cut -f1)\n            if [ \"$SIZE\" -gt 52428800 ]; then\n              echo \"âŒ Bundle size exceeds 50MB limit: $SIZE bytes\"\n              exit 1\n            fi\n          fi\n\n  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  # JOB 5: E2E tests (Playwright) â€” runs on build artifacts\n  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  e2e:\n    name: E2E Tests\n    runs-on: ubuntu-latest\n    needs: build\n    timeout-minutes: 30\n\n    env:\n      PLAYWRIGHT_BASE_URL: http://localhost:3000\n      # Test tenant credentials\n      TEST_TENANT_ID: ${{ secrets.TEST_TENANT_ID }}\n      TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}\n      TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}\n\n    steps:\n      - uses: actions/checkout@v4\n\n      - uses: pnpm/action-setup@v4\n        with:\n          version: ${{ env.PNPM_VERSION }}\n\n      - uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'pnpm'\n\n      - name: Install dependencies\n        run: pnpm install --frozen-lockfile\n\n      - name: Install Playwright browsers\n        run: pnpm --filter @repo/e2e exec playwright install --with-deps chromium\n\n      - name: Start app in background\n        run: |\n          pnpm --filter portal run start &\n          # Wait for server to be ready\n          npx wait-on http://localhost:3000 --timeout 60000\n\n      - name: Run E2E tests (including a11y)\n        run: pnpm --filter @repo/e2e run test\n\n      - name: Upload Playwright report on failure\n        if: failure()\n        uses: actions/upload-artifact@v4\n        with:\n          name: playwright-report\n          path: e2e/playwright-report/\n          retention-days: 7\n\n  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  # JOB 6: Security audit\n  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  security:\n    name: Security Audit\n    runs-on: ubuntu-latest\n    needs: detect-changes\n\n    steps:\n      - uses: actions/checkout@v4\n\n      - uses: pnpm/action-setup@v4\n        with:\n          version: ${{ env.PNPM_VERSION }}\n\n      - name: pnpm audit (high + critical only)\n        run: pnpm audit --audit-level=high\n\n      - name: Check for hardcoded secrets (Gitleaks)\n        uses: gitleaks/gitleaks-action@v2\n        env:\n          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}\n\n  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  # JOB 7: Deploy preview (PRs) or production (main)\n  # Handled by Vercel's native GitHub integration â€” this job triggers it\n  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  deploy:\n    name: Deploy\n    runs-on: ubuntu-latest\n    needs: [e2e, security]\n    if: github.event_name == 'push'\n\n    steps:\n      - uses: actions/checkout@v4\n\n      - name: Deploy to Vercel (via CLI for monorepo control)\n        uses: amondnet/vercel-action@v25\n        with:\n          vercel-token: ${{ secrets.VERCEL_TOKEN }}\n          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}\n          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}\n          working-directory: apps/portal\n          vercel-args: ${{ github.ref == 'refs/heads/main' && '--prod' || '' }}\n\n      - name: Notify Sentry of new release\n        run: |\n          curl -sL https://sentry.io/api/0/organizations/${{ vars.SENTRY_ORG }}/releases/ \\\n            -H \"Authorization: Bearer ${{ secrets.SENTRY_AUTH_TOKEN }}\" \\\n            -H \"Content-Type: application/json\" \\\n            -d '{\n              \"version\": \"${{ github.sha }}\",\n              \"refs\": [{\"repository\": \"${{ github.repository }}\", \"commit\": \"${{ github.sha }}\"}],\n              \"projects\": [\"marketing-platform\"]\n            }'\n```\n\n---\n",
            "domainNumber": 16
          }
        },
        {
          "domainNumber": 16,
          "fileName": "DOMAIN-16-feature-section-feature.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-16\\DOMAIN-16-feature-section-feature.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "16.3-feature-flags-system.md",
            "title": "Section feature",
            "description": "Implementation for domain 16 section feature",
            "topics": ["Domain 16 implementation"],
            "sectionNumber": "feature",
            "content": "### 16.3 Feature Flags System\n\n**File:** `packages/feature-flags/src/index.ts`\n\n```typescript\nimport { get } from '@vercel/edge-config';\nimport { Redis } from '@upstash/redis';\n\nconst redis = Redis.fromEnv();\n\n// ============================================================================\n// FEATURE FLAG SYSTEM\n// Reads from Vercel Edge Config (instant, globally distributed, ~0ms).\n// Falls back to Redis for tenant-specific overrides.\n// Falls back to hardcoded defaults if both unavailable.\n// Reference: https://docs.getunleash.io/guides/implement-feature-flags-in-nextjs\n// ============================================================================\n\nexport type FeatureFlag =\n  | 'offline_lead_forms'          // ElectricSQL local-first forms\n  | 'realtime_lead_feed'          // Supabase Realtime in portal\n  | 'ab_testing'                  // Edge A/B testing\n  | 'ai_chat_widget'              // AI chat bubble\n  | 'booking_calendar'            // Cal.com/Calendly integration\n  | 'stripe_billing'              // Enable billing for this tenant\n  | 'white_label_portal'          // Hide agency branding\n  | 'gdpr_tools'                  // GDPR data export/deletion in portal\n  | 'api_access'                  // REST API access for enterprise\n  | 'sso_enabled'                 // SAML/OIDC SSO\n  | 'advanced_analytics'          // Tinybird dashboard\n  | 'multi_site'                  // Multiple sites per tenant account\n  | 'custom_domain'               // Custom domain routing\n  | 'ghl_crm_sync'                // GoHighLevel CRM\n  | 'hubspot_crm_sync';           // HubSpot CRM\n\n// Tier-based defaults (what each plan includes out of the box)\nconst TIER_DEFAULTS: Record<string, Record<FeatureFlag, boolean>> = {\n  starter: {\n    offline_lead_forms: false,\n    realtime_lead_feed: false,\n    ab_testing: false,\n    ai_chat_widget: false,\n    booking_calendar: true,\n    stripe_billing: true,\n    white_label_portal: false,\n    gdpr_tools: false,\n    api_access: false,\n    sso_enabled: false,\n    advanced_analytics: false,\n    multi_site: false,\n    custom_domain: true,\n    ghl_crm_sync: false,\n    hubspot_crm_sync: false,\n  },\n  professional: {\n    offline_lead_forms: true,\n    realtime_lead_feed: true,\n    ab_testing: true,\n    ai_chat_widget: true,\n    booking_calendar: true,\n    stripe_billing: true,\n    white_label_portal: false,\n    gdpr_tools: true,\n    api_access: false,\n    sso_enabled: false,\n    advanced_analytics: true,\n    multi_site: true,\n    custom_domain: true,\n    ghl_crm_sync: true,\n    hubspot_crm_sync: true,\n  },\n  enterprise: {\n    offline_lead_forms: true,\n    realtime_lead_feed: true,\n    ab_testing: true,\n    ai_chat_widget: true,\n    booking_calendar: true,\n    stripe_billing: true,\n    white_label_portal: true,\n    gdpr_tools: true,\n    api_access: true,\n    sso_enabled: true,\n    advanced_analytics: true,\n    multi_site: true,\n    custom_domain: true,\n    ghl_crm_sync: true,\n    hubspot_crm_sync: true,\n  },\n};\n\n// Global feature flag overrides (kill switches, beta features, gradual rollout)\n// Stored in Vercel Edge Config â€” instant propagation without redeployment\ntype EdgeConfigFlags = {\n  [K in FeatureFlag]?: boolean | { enabledTenants: string[]; enabledPercentage?: number };\n};\n\nexport async function isFeatureEnabled(\n  flag: FeatureFlag,\n  context: {\n    tenantId: string;\n    billingTier: 'starter' | 'professional' | 'enterprise';\n  }\n): Promise<boolean> {\n  // â”€â”€ 1. Global kill switch (Edge Config â€” ~0ms read) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  try {\n    const globalFlags = await get<EdgeConfigFlags>('featureFlags');\n    if (globalFlags?.[flag] !== undefined) {\n      const flagConfig = globalFlags[flag];\n\n      if (typeof flagConfig === 'boolean') {\n        if (!flagConfig) return false; // Global kill switch\n      } else if (typeof flagConfig === 'object') {\n        // Tenant allowlist\n        if (flagConfig.enabledTenants?.includes(context.tenantId)) return true;\n\n        // Percentage rollout (deterministic by tenantId hash)\n        if (flagConfig.enabledPercentage !== undefined) {\n          const hash = hashTenantId(context.tenantId);\n          return hash < flagConfig.enabledPercentage;\n        }\n      }\n    }\n  } catch {\n    // Edge Config unavailable â€” fall through\n  }\n\n  // â”€â”€ 2. Tenant-specific override (Redis) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const tenantOverrideKey = `feature:${context.tenantId}:${flag}`;\n  const tenantOverride = await redis.get<boolean>(tenantOverrideKey);\n  if (tenantOverride !== null) return tenantOverride;\n\n  // â”€â”€ 3. Billing tier default â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  return TIER_DEFAULTS[context.billingTier]?.[flag] ?? false;\n}\n\n// â”€â”€ Server Component gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function FeatureGate({\n  flag,\n  tenantId,\n  billingTier,\n  children,\n  fallback = null,\n}: {\n  flag: FeatureFlag;\n  tenantId: string;\n  billingTier: 'starter' | 'professional' | 'enterprise';\n  children: React.ReactNode;\n  fallback?: React.ReactNode;\n}) {\n  const enabled = await isFeatureEnabled(flag, { tenantId, billingTier });\n  return enabled ? <>{children}</> : <>{fallback}</>;\n}\n\n// â”€â”€ Client hook (reads from cookie set during SSR) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// Feature flags are injected into a cookie in middleware to avoid client waterfalls\n\nexport function useFeatureFlag(flag: FeatureFlag): boolean {\n  if (typeof document === 'undefined') return false;\n\n  const cookieKey = `ff_${flag}`;\n  const cookies = Object.fromEntries(\n    document.cookie.split('; ').map((c) => c.split('='))\n  );\n\n  return cookies[cookieKey] === 'true';\n}\n\n// Deterministic hash for percentage rollouts (djb2)\nfunction hashTenantId(tenantId: string): number {\n  let hash = 5381;\n  for (const char of tenantId) {\n    hash = (hash * 33) ^ char.charCodeAt(0);\n  }\n  return Math.abs(hash) % 100;\n}\n\n// â”€â”€ Admin API: override feature for specific tenant â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function setTenantFeatureOverride(\n  tenantId: string,\n  flag: FeatureFlag,\n  enabled: boolean\n): Promise<void> {\n  const key = `feature:${tenantId}:${flag}`;\n  // Persist indefinitely â€” admin explicitly chose this\n  await redis.set(key, enabled);\n}\n\nexport async function clearTenantFeatureOverride(\n  tenantId: string,\n  flag: FeatureFlag\n): Promise<void> {\n  await redis.del(`feature:${tenantId}:${flag}`);\n}\n```\n\n---\n",
            "domainNumber": 16
          }
        }
      ]
    },
    {
      "domainNumber": 17,
      "success": true,
      "tasksCreated": 4,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 17,
          "fileName": "DOMAIN-17-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-17\\DOMAIN-17-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "17.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 17 section philosophy.md",
            "topics": ["Domain 17 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 17.1 Philosophy\n\n**What it is:** When a new client signs up, they must configure their site before it goes live. The onboarding wizard collects identity, branding, contact info, domain, and integrations in a linear multi-step flow. All data is persisted progressively â€” closing the browser at step 3 and returning resumes from step 3. [linkedin](https://www.linkedin.com/posts/ankit-mohanta_implementing-multi-step-form-wizards-in-nextjs-activity-7273937377746653184-eiBe)\n\n**Data persistence strategy:** Each step auto-saves to `onboarding_progress` in Supabase via Server Action on `Next` click. This is safer than holding everything in React state until the final submit â€” network failure at the last step loses nothing.\n\n---\n",
            "domainNumber": 17
          }
        },
        {
          "domainNumber": 17,
          "fileName": "DOMAIN-17-onboarding-section-onboarding.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-17\\DOMAIN-17-onboarding-section-onboarding.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "17.2-onboarding-state-machine.md",
            "title": "Section onboarding",
            "description": "Implementation for domain 17 section onboarding",
            "topics": ["Domain 17 implementation"],
            "sectionNumber": "onboarding",
            "content": "### 17.2 Onboarding State Machine\n\n**File:** `apps/portal/src/features/onboarding/model/onboarding-machine.ts`\n\n```typescript\nimport { z } from 'zod';\n\n// ============================================================================\n// STEP DEFINITIONS\n// ============================================================================\n\nexport const ONBOARDING_STEPS = [\n  'business-info',\n  'branding',\n  'contact-hours',\n  'services',\n  'domain',\n  'integrations',\n  'review',\n  'complete',\n] as const;\n\nexport type OnboardingStep = (typeof ONBOARDING_STEPS)[number];\n\n// â”€â”€ Step Schemas (validated on both client and server) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport const BusinessInfoSchema = z.object({\n  businessName: z.string().min(2).max(100),\n  tagline: z.string().min(5).max(160),\n  industry: z.enum([\n    'law',\n    'hvac',\n    'plumbing',\n    'electrical',\n    'dental',\n    'medical',\n    'realEstate',\n    'accounting',\n    'restaurant',\n    'salon',\n    'general',\n  ]),\n  description: z.string().min(20).max(500),\n});\n\nexport const BrandingSchema = z.object({\n  primaryColor: z.string().regex(/^#[0-9a-fA-F]{6}$/, 'Must be a valid hex color'),\n  accentColor: z.string().regex(/^#[0-9a-fA-F]{6}$/),\n  fontFamily: z.enum(['inter', 'merriweather', 'playfair', 'roboto', 'poppins', 'montserrat']),\n  logoUrl: z.string().url().optional().or(z.literal('')),\n  faviconUrl: z.string().url().optional().or(z.literal('')),\n});\n\nexport const ContactHoursSchema = z.object({\n  phone: z.string().min(7).max(20),\n  email: z.string().email(),\n  address: z.object({\n    street: z.string().optional(),\n    city: z.string().min(2),\n    state: z.string().length(2),\n    zip: z\n      .string()\n      .regex(/^\\d{5}(-\\d{4})?$/)\n      .optional(),\n  }),\n  hours: z\n    .array(\n      z.object({\n        days: z.array(z.string()),\n        opens: z.string().regex(/^\\d{2}:\\d{2}$/),\n        closes: z.string().regex(/^\\d{2}:\\d{2}$/),\n      })\n    )\n    .optional(),\n  serviceAreas: z.array(z.string()).max(10).optional(),\n});\n\nexport const ServicesSchema = z.object({\n  services: z\n    .array(\n      z.object({\n        name: z.string().min(2).max(80),\n        description: z.string().min(10).max(300),\n        slug: z.string().regex(/^[a-z0-9-]+$/),\n        priceDisplay: z.string().optional(),\n      })\n    )\n    .min(1)\n    .max(20),\n});\n\nexport const DomainSchema = z\n  .object({\n    subdomain: z\n      .string()\n      .min(3)\n      .max(63)\n      .regex(/^[a-z0-9]([a-z0-9-]*[a-z0-9])?$/, 'Lowercase letters, numbers, hyphens only')\n      .optional(),\n    customDomain: z\n      .string()\n      .regex(/^([a-z0-9]+(-[a-z0-9]+)*\\.)+[a-z]{2,}$/, 'Enter a valid domain name')\n      .optional(),\n  })\n  .refine((data) => data.subdomain || data.customDomain, {\n    message: 'Either subdomain or custom domain is required',\n  });\n\nexport const IntegrationsSchema = z.object({\n  googleAnalyticsId: z\n    .string()\n    .regex(/^G-[A-Z0-9]+$/)\n    .optional()\n    .or(z.literal('')),\n  googleTagManagerId: z\n    .string()\n    .regex(/^GTM-[A-Z0-9]+$/)\n    .optional()\n    .or(z.literal('')),\n  facebookPixelId: z.string().regex(/^\\d+$/).optional().or(z.literal('')),\n  crmType: z.enum(['none', 'hubspot', 'zapier', 'gohighlevel']).default('none'),\n  zapierWebhookUrl: z.string().url().optional().or(z.literal('')),\n  hubspotToken: z.string().optional().or(z.literal('')),\n  recaptchaSiteKey: z.string().optional().or(z.literal('')),\n  calComUsername: z.string().optional().or(z.literal('')),\n});\n\nexport type OnboardingData = {\n  'business-info'?: z.infer<typeof BusinessInfoSchema>;\n  branding?: z.infer<typeof BrandingSchema>;\n  'contact-hours'?: z.infer<typeof ContactHoursSchema>;\n  services?: z.infer<typeof ServicesSchema>;\n  domain?: z.infer<typeof DomainSchema>;\n  integrations?: z.infer<typeof IntegrationsSchema>;\n};\n\n// â”€â”€ Step metadata â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport const STEP_META: Record<\n  OnboardingStep,\n  {\n    title: string;\n    description: string;\n    schema?: z.ZodTypeAny;\n    dataKey?: keyof OnboardingData;\n    optional?: boolean;\n  }\n> = {\n  'business-info': {\n    title: 'Tell us about your business',\n    description: 'This information powers your SEO, structured data, and AI citations.',\n    schema: BusinessInfoSchema,\n    dataKey: 'business-info',\n  },\n  branding: {\n    title: 'Your brand identity',\n    description:\n      \"Upload your logo and set your colors. We'll generate your full design system from these.\",\n    schema: BrandingSchema,\n    dataKey: 'branding',\n  },\n  'contact-hours': {\n    title: 'How customers reach you',\n    description:\n      'Phone, email, address, and hours appear in Google My Business, schema markup, and your site.',\n    schema: ContactHoursSchema,\n    dataKey: 'contact-hours',\n  },\n  services: {\n    title: 'What you offer',\n    description: 'Add your main services. Each gets its own SEO-optimized page.',\n    schema: ServicesSchema,\n    dataKey: 'services',\n  },\n  domain: {\n    title: 'Choose your domain',\n    description:\n      'Your site goes live on your chosen subdomain immediately. Add a custom domain anytime.',\n    schema: DomainSchema,\n    dataKey: 'domain',\n  },\n  integrations: {\n    title: 'Connect your tools',\n    description: 'All optional â€” connect analytics, CRM, and booking tools. Skippable.',\n    schema: IntegrationsSchema,\n    dataKey: 'integrations',\n    optional: true,\n  },\n  review: {\n    title: 'Review your site',\n    description: 'Everything looks good? Hit launch and your site goes live in under 60 seconds.',\n  },\n  complete: {\n    title: \"You're live! ðŸŽ‰\",\n    description: 'Your site is live. Here are your next steps.',\n  },\n};\n```\n\n---\n",
            "domainNumber": 17
          }
        },
        {
          "domainNumber": 17,
          "fileName": "DOMAIN-17-onboarding-section-onboarding.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-17\\DOMAIN-17-onboarding-section-onboarding.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "17.3-onboarding-server-actions.md",
            "title": "Section onboarding",
            "description": "Implementation for domain 17 section onboarding",
            "topics": ["Domain 17 implementation"],
            "sectionNumber": "onboarding",
            "content": "### 17.3 Onboarding Server Actions\n\n**File:** `apps/portal/src/features/onboarding/model/save-step.ts`\n\n```typescript\n'use server';\n\nimport { z } from 'zod';\nimport { createServerAction } from '@repo/auth/server-action-wrapper';\nimport { db } from '@repo/db';\nimport { enqueue } from '@repo/jobs/client';\nimport { setTenantSecret } from '@repo/security/secrets-manager';\nimport {\n  BusinessInfoSchema,\n  BrandingSchema,\n  ContactHoursSchema,\n  ServicesSchema,\n  DomainSchema,\n  IntegrationsSchema,\n  type OnboardingStep,\n} from './onboarding-machine';\nimport { addVercelDomain } from '@repo/multi-tenant/vercel-domains';\n\n// Unified step-save action (dispatches to per-step handlers)\nconst SaveStepInputSchema = z.object({\n  step: z.enum([\n    'business-info',\n    'branding',\n    'contact-hours',\n    'services',\n    'domain',\n    'integrations',\n  ]),\n  data: z.record(z.unknown()),\n});\n\nexport const saveOnboardingStep = createServerAction(SaveStepInputSchema, async (input, ctx) => {\n  const { tenantId } = ctx;\n  const { step, data } = input;\n\n  // Per-step validation and save\n  switch (step) {\n    case 'business-info': {\n      const parsed = BusinessInfoSchema.parse(data);\n      await db\n        .from('onboarding_progress')\n        .upsert(\n          { tenant_id: tenantId, step, data: parsed, updated_at: new Date().toISOString() },\n          { onConflict: 'tenant_id,step' }\n        );\n      // Update tenant config immediately (used for live preview)\n      await db\n        .from('tenants')\n        .update({\n          config: db.raw(`config || ?::jsonb`, [\n            JSON.stringify({\n              identity: {\n                siteName: parsed.businessName,\n                tagline: parsed.tagline,\n                industry: parsed.industry,\n              },\n            }),\n          ]),\n        })\n        .eq('id', tenantId);\n      break;\n    }\n\n    case 'branding': {\n      const parsed = BrandingSchema.parse(data);\n      await db\n        .from('onboarding_progress')\n        .upsert(\n          { tenant_id: tenantId, step, data: parsed, updated_at: new Date().toISOString() },\n          { onConflict: 'tenant_id,step' }\n        );\n      break;\n    }\n\n    case 'contact-hours': {\n      const parsed = ContactHoursSchema.parse(data);\n      await db\n        .from('onboarding_progress')\n        .upsert(\n          { tenant_id: tenantId, step, data: parsed, updated_at: new Date().toISOString() },\n          { onConflict: 'tenant_id,step' }\n        );\n      break;\n    }\n\n    case 'services': {\n      const parsed = ServicesSchema.parse(data);\n      await db\n        .from('onboarding_progress')\n        .upsert(\n          { tenant_id: tenantId, step, data: parsed, updated_at: new Date().toISOString() },\n          { onConflict: 'tenant_id,step' }\n        );\n      break;\n    }\n\n    case 'domain': {\n      const parsed = DomainSchema.parse(data);\n\n      // Check subdomain availability\n      if (parsed.subdomain) {\n        const { data: existing } = await db\n          .from('tenants')\n          .select('id')\n          .eq('subdomain', parsed.subdomain)\n          .neq('id', tenantId)\n          .maybeSingle();\n\n        if (existing) {\n          return { error: `The subdomain \"${parsed.subdomain}\" is already taken.` };\n        }\n\n        await db\n          .from('tenants')\n          .update({\n            subdomain: parsed.subdomain,\n          })\n          .eq('id', tenantId);\n      }\n\n      if (parsed.customDomain) {\n        // Register domain with Vercel (immediate provisioning)\n        try {\n          await addVercelDomain(parsed.customDomain, tenantId);\n        } catch (err: any) {\n          return { error: `Domain registration failed: ${err.message}` };\n        }\n\n        await db\n          .from('tenants')\n          .update({\n            custom_domain: parsed.customDomain,\n            domain_verified: false, // Will be verified by Vercel webhook\n          })\n          .eq('id', tenantId);\n      }\n\n      await db\n        .from('onboarding_progress')\n        .upsert(\n          { tenant_id: tenantId, step, data: parsed, updated_at: new Date().toISOString() },\n          { onConflict: 'tenant_id,step' }\n        );\n      break;\n    }\n\n    case 'integrations': {\n      const parsed = IntegrationsSchema.parse(data);\n\n      // Store sensitive API keys in encrypted secrets, not in config\n      if (parsed.hubspotToken) {\n        await setTenantSecret(tenantId, 'HUBSPOT_PRIVATE_APP_TOKEN', parsed.hubspotToken);\n      }\n      if (parsed.zapierWebhookUrl) {\n        await setTenantSecret(tenantId, 'ZAPIER_WEBHOOK_URL', parsed.zapierWebhookUrl);\n      }\n\n      // Store non-sensitive integration config in tenant config\n      const safeConfig = {\n        googleAnalyticsId: parsed.googleAnalyticsId,\n        googleTagManagerId: parsed.googleTagManagerId,\n        facebookPixelId: parsed.facebookPixelId,\n        crmType: parsed.crmType,\n        calComUsername: parsed.calComUsername,\n      };\n\n      await db\n        .from('onboarding_progress')\n        .upsert(\n          { tenant_id: tenantId, step, data: safeConfig, updated_at: new Date().toISOString() },\n          { onConflict: 'tenant_id,step' }\n        );\n      break;\n    }\n  }\n\n  return { success: true };\n});\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst CompleteOnboardingSchema = z.object({});\n\nexport const completeOnboarding = createServerAction(\n  CompleteOnboardingSchema,\n  async (_input, ctx) => {\n    const { tenantId } = ctx;\n\n    // Fetch all onboarding progress\n    const { data: steps } = await db\n      .from('onboarding_progress')\n      .select('step, data')\n      .eq('tenant_id', tenantId);\n\n    if (!steps || steps.length < 4) {\n      return { error: 'Please complete all required steps before launching.' };\n    }\n\n    // Merge all step data into a unified site.config\n    const stepMap = Object.fromEntries(steps.map((s) => [s.step, s.data]));\n    const businessInfo = stepMap['business-info'];\n    const branding = stepMap['branding'];\n    const contactHours = stepMap['contact-hours'];\n    const services = stepMap['services'];\n    const integrations = stepMap['integrations'] ?? {};\n\n    const config = {\n      identity: {\n        siteName: businessInfo.businessName,\n        tagline: businessInfo.tagline,\n        industry: businessInfo.industry,\n        description: businessInfo.description,\n        contact: { phone: contactHours.phone, email: contactHours.email },\n        address: contactHours.address,\n        hours: contactHours.hours,\n        serviceAreas: contactHours.serviceAreas,\n        services: services.services,\n      },\n      theme: {\n        colors: {\n          primary: branding.primaryColor,\n          accent: branding.accentColor,\n        },\n        fontFamily: branding.fontFamily,\n      },\n      assets: {\n        logo: branding.logoUrl,\n        favicon: branding.faviconUrl,\n      },\n      analytics: {\n        googleAnalyticsId: integrations.googleAnalyticsId,\n        googleTagManagerId: integrations.googleTagManagerId,\n        facebookPixelId: integrations.facebookPixelId,\n      },\n      integrations: {\n        crmType: integrations.crmType,\n        calComUsername: integrations.calComUsername,\n      },\n    };\n\n    // Write merged config + activate tenant\n    await db\n      .from('tenants')\n      .update({\n        config,\n        status: 'active',\n        onboarding_completed_at: new Date().toISOString(),\n      })\n      .eq('id', tenantId);\n\n    // Queue sitemap rebuild\n    await enqueue('sitemap.rebuild', { tenantId });\n\n    // Send welcome email\n    await enqueue('email.lead_digest', {\n      tenantId,\n      date: new Date().toISOString().split('T')[0],\n    });\n\n    return { success: true, redirectTo: '/dashboard?onboarded=1' };\n  }\n);\n```\n\n---\n",
            "domainNumber": 17
          }
        },
        {
          "domainNumber": 17,
          "fileName": "DOMAIN-17-onboarding-section-onboarding.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-17\\DOMAIN-17-onboarding-section-onboarding.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "17.4-onboarding-wizard-ui.md",
            "title": "Section onboarding",
            "description": "Implementation for domain 17 section onboarding",
            "topics": ["Domain 17 implementation"],
            "sectionNumber": "onboarding",
            "content": "### 17.4 Onboarding Wizard UI\n\n**File:** `apps/portal/src/features/onboarding/ui/OnboardingWizard.tsx`\n\n```typescript\n'use client';\n\nimport { useState, useCallback, useTransition } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { saveOnboardingStep, completeOnboarding } from '../model/save-step';\nimport {\n  ONBOARDING_STEPS,\n  STEP_META,\n  type OnboardingStep,\n  type OnboardingData,\n} from '../model/onboarding-machine';\n\ninterface OnboardingWizardProps {\n  initialStep: OnboardingStep;\n  initialData: Partial<OnboardingData>;\n}\n\nexport function OnboardingWizard({ initialStep, initialData }: OnboardingWizardProps) {\n  const router = useRouter();\n  const [isPending, startTransition] = useTransition();\n  const [currentStep, setCurrentStep] = useState<OnboardingStep>(initialStep);\n  const [savedData, setSavedData] = useState<Partial<OnboardingData>>(initialData);\n  const [error, setError] = useState<string | null>(null);\n\n  const stepIndex = ONBOARDING_STEPS.indexOf(currentStep);\n  const stepMeta = STEP_META[currentStep];\n  const isLastDataStep = currentStep === 'integrations';\n  const isReviewStep = currentStep === 'review';\n  const totalDataSteps = 6;\n\n  const handleStepSubmit = useCallback(\n    async (data: Record<string, unknown>) => {\n      setError(null);\n\n      startTransition(async () => {\n        if (isReviewStep) {\n          const result = await completeOnboarding({});\n          if ('error' in result && result.error) {\n            setError(result.error);\n            return;\n          }\n          router.push('/dashboard?onboarded=1');\n          return;\n        }\n\n        // Save step data\n        const result = await saveOnboardingStep({\n          step: currentStep as any,\n          data,\n        });\n\n        if ('error' in result && result.error) {\n          setError(result.error);\n          return;\n        }\n\n        // Update local state\n        setSavedData((prev) => ({ ...prev, [currentStep]: data }));\n\n        // Advance to next step\n        const nextIndex = stepIndex + 1;\n        if (nextIndex < ONBOARDING_STEPS.length) {\n          setCurrentStep(ONBOARDING_STEPS[nextIndex]);\n        }\n      });\n    },\n    [currentStep, isReviewStep, router, stepIndex]\n  );\n\n  const handleBack = useCallback(() => {\n    if (stepIndex > 0) {\n      setCurrentStep(ONBOARDING_STEPS[stepIndex - 1]);\n    }\n  }, [stepIndex]);\n\n  const handleSkip = useCallback(() => {\n    if (stepMeta.optional) {\n      setCurrentStep(ONBOARDING_STEPS[stepIndex + 1]);\n    }\n  }, [stepIndex, stepMeta.optional]);\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 flex flex-col\">\n      {/* Progress header */}\n      <header className=\"bg-white border-b border-gray-200 px-6 py-4\">\n        <div className=\"max-w-2xl mx-auto\">\n          <div className=\"flex items-center justify-between mb-3\">\n            <span className=\"text-sm font-medium text-gray-500\">\n              Step {Math.min(stepIndex + 1, totalDataSteps)} of {totalDataSteps}\n            </span>\n            <span className=\"text-sm text-gray-400\">\n              {Math.round((stepIndex / totalDataSteps) * 100)}% complete\n            </span>\n          </div>\n\n          {/* Progress bar */}\n          <div\n            role=\"progressbar\"\n            aria-valuenow={stepIndex}\n            aria-valuemin={0}\n            aria-valuemax={totalDataSteps}\n            aria-label=\"Onboarding progress\"\n            className=\"h-2 bg-gray-200 rounded-full overflow-hidden\"\n          >\n            <div\n              className=\"h-full bg-primary rounded-full transition-all duration-500\"\n              style={{ width: `${(stepIndex / totalDataSteps) * 100}%` }}\n            />\n          </div>\n\n          {/* Step pills */}\n          <nav aria-label=\"Onboarding steps\" className=\"mt-3\">\n            <ol className=\"flex gap-1 overflow-x-auto pb-1\">\n              {ONBOARDING_STEPS.filter((s) => s !== 'complete').map((step, i) => {\n                const isCompleted = i < stepIndex;\n                const isCurrent = step === currentStep;\n\n                return (\n                  <li key={step}>\n                    <button\n                      type=\"button\"\n                      onClick={() => isCompleted && setCurrentStep(step)}\n                      disabled={!isCompleted}\n                      className={`\n                        px-2.5 py-1 rounded text-xs font-medium whitespace-nowrap\n                        ${isCurrent ? 'bg-primary text-white' : ''}\n                        ${isCompleted && !isCurrent ? 'bg-green-100 text-green-700 hover:bg-green-200 cursor-pointer' : ''}\n                        ${!isCompleted && !isCurrent ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : ''}\n                      `}\n                      aria-current={isCurrent ? 'step' : undefined}\n                    >\n                      {isCompleted && !isCurrent ? 'âœ“ ' : ''}\n                      {STEP_META[step].title.split(' ').slice(0, 3).join(' ')}\n                    </button>\n                  </li>\n                );\n              })}\n            </ol>\n          </nav>\n        </div>\n      </header>\n\n      {/* Step content */}\n      <main className=\"flex-1 flex items-start justify-center px-4 py-12\">\n        <div className=\"w-full max-w-2xl\">\n          <div className=\"mb-8\">\n            <h1 className=\"text-3xl font-bold text-gray-900\">{stepMeta.title}</h1>\n            <p className=\"mt-2 text-gray-500\">{stepMeta.description}</p>\n          </div>\n\n          {error && (\n            <div\n              role=\"alert\"\n              aria-live=\"assertive\"\n              className=\"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm\"\n            >\n              <strong>Error:</strong> {error}\n            </div>\n          )}\n\n          {/* Dynamic step form â€” renders the right form for the current step */}\n          <StepForm\n            step={currentStep}\n            defaultValues={(savedData as any)[currentStep] ?? {}}\n            onSubmit={handleStepSubmit}\n            isPending={isPending}\n            onBack={stepIndex > 0 ? handleBack : undefined}\n            onSkip={stepMeta.optional ? handleSkip : undefined}\n            isReview={isReviewStep}\n            allData={savedData}\n          />\n        </div>\n      </main>\n    </div>\n  );\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// STEP FORM ROUTER\n// Each step renders its own form component with pre-filled defaults.\n\nfunction StepForm({\n  step,\n  defaultValues,\n  onSubmit,\n  isPending,\n  onBack,\n  onSkip,\n  isReview,\n  allData,\n}: {\n  step: OnboardingStep;\n  defaultValues: Record<string, unknown>;\n  onSubmit: (data: Record<string, unknown>) => Promise<void>;\n  isPending: boolean;\n  onBack?: () => void;\n  onSkip?: () => void;\n  isReview?: boolean;\n  allData: Partial<OnboardingData>;\n}) {\n  const schema = STEP_META[step]?.schema;\n\n  const form = useForm({\n    resolver: schema ? zodResolver(schema) : undefined,\n    defaultValues,\n    mode: 'onChange',\n  });\n\n  if (isReview) {\n    return <ReviewStep allData={allData} onSubmit={() => onSubmit({})} isPending={isPending} onBack={onBack} />;\n  }\n\n  return (\n    <form\n      onSubmit={form.handleSubmit(onSubmit as any)}\n      noValidate\n      aria-label={`${STEP_META[step].title} form`}\n    >\n      {/* Step-specific fields would be rendered here via a component map */}\n      {/* e.g. step === 'business-info' ? <BusinessInfoFields form={form} /> : ... */}\n\n      {/* Navigation */}\n      <div className=\"flex items-center gap-3 mt-8 pt-6 border-t\">\n        {onBack && (\n          <button\n            type=\"button\"\n            onClick={onBack}\n            className=\"px-5 py-2.5 border border-gray-300 rounded-lg font-medium hover:bg-gray-50 focus-visible:ring-2 focus-visible:ring-primary\"\n          >\n            â† Back\n          </button>\n        )}\n\n        <button\n          type=\"submit\"\n          disabled={isPending}\n          className=\"ml-auto flex items-center gap-2 bg-primary text-white px-6 py-2.5 rounded-lg font-semibold hover:bg-primary/90 disabled:opacity-50 focus-visible:ring-2 focus-visible:ring-primary\"\n          aria-disabled={isPending}\n        >\n          {isPending ? (\n            <>\n              <span className=\"h-4 w-4 border-2 border-white/30 border-t-white rounded-full animate-spin\" aria-hidden=\"true\" />\n              Savingâ€¦\n            </>\n          ) : (\n            'Continue â†’'\n          )}\n        </button>\n\n        {onSkip && (\n          <button\n            type=\"button\"\n            onClick={onSkip}\n            className=\"text-sm text-gray-400 hover:text-gray-600 underline\"\n          >\n            Skip for now\n          </button>\n        )}\n      </div>\n\n      {/* Auto-save indicator */}\n      {form.formState.isDirty && (\n        <p className=\"mt-3 text-xs text-gray-400 text-right\" aria-live=\"polite\">\n          Progress is saved automatically when you continue.\n        </p>\n      )}\n    </form>\n  );\n}\n\nfunction ReviewStep({\n  allData,\n  onSubmit,\n  isPending,\n  onBack,\n}: {\n  allData: Partial<OnboardingData>;\n  onSubmit: () => void;\n  isPending: boolean;\n  onBack?: () => void;\n}) {\n  const businessInfo = allData['business-info'];\n  const contactHours = allData['contact-hours'];\n\n  return (\n    <div>\n      <div className=\"space-y-4 mb-8\">\n        <SummaryCard title=\"Business\" value={businessInfo?.businessName ?? 'â€”'} />\n        <SummaryCard title=\"Phone\" value={contactHours?.phone ?? 'â€”'} />\n        <SummaryCard title=\"Email\" value={contactHours?.email ?? 'â€”'} />\n        <SummaryCard title=\"Services\" value={`${allData.services?.services?.length ?? 0} configured`} />\n        <SummaryCard title=\"Domain\" value={allData.domain?.subdomain ? `${allData.domain.subdomain}.youragency.com` : allData.domain?.customDomain ?? 'â€”'} />\n      </div>\n\n      <div className=\"flex items-center gap-3 pt-6 border-t\">\n        {onBack && (\n          <button type=\"button\" onClick={onBack} className=\"px-5 py-2.5 border border-gray-300 rounded-lg font-medium hover:bg-gray-50\">\n            â† Back\n          </button>\n        )}\n        <button\n          type=\"button\"\n          onClick={onSubmit}\n          disabled={isPending}\n          className=\"ml-auto flex items-center gap-2 bg-green-600 text-white px-8 py-3 rounded-lg font-bold text-lg hover:bg-green-700 disabled:opacity-50\"\n        >\n          {isPending ? 'Launchingâ€¦' : 'ðŸš€ Launch My Site'}\n        </button>\n      </div>\n    </div>\n  );\n}\n\nfunction SummaryCard({ title, value }: { title: string; value: string }) {\n  return (\n    <div className=\"flex justify-between items-center p-4 bg-white border border-gray-200 rounded-lg\">\n      <span className=\"text-sm text-gray-500 font-medium\">{title}</span>\n      <span className=\"text-sm font-semibold text-gray-900\">{value}</span>\n    </div>\n  );\n}\n```\n\n---\n",
            "domainNumber": 17
          }
        }
      ]
    },
    {
      "domainNumber": 18,
      "success": true,
      "tasksCreated": 3,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 18,
          "fileName": "DOMAIN-18-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-18\\DOMAIN-18-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "18.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 18 section philosophy.md",
            "topics": ["Domain 18 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 18.1 Philosophy\n\n**What it is:** The super admin panel is your command center for managing all tenants. It is only accessible to users with `role: super_admin` in their Clerk session claims. It provides tenant search, status management, impersonation, billing overrides, feature flag overrides, and a platform-wide metrics overview. [usesaaskit](https://www.usesaaskit.com/docs/nextjs-ai-boilerplate-legacy/guides/super-admin)\n\n---\n",
            "domainNumber": 18
          }
        },
        {
          "domainNumber": 18,
          "fileName": "DOMAIN-18-super-section-super.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-18\\DOMAIN-18-super-section-super.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "18.2-super-admin-dashboard.md",
            "title": "Section super",
            "description": "Implementation for domain 18 section super",
            "topics": ["Domain 18 implementation"],
            "sectionNumber": "super",
            "content": "### 18.2 Super Admin Dashboard\n\n**File:** `apps/admin/src/app/dashboard/page.tsx`\n\n```typescript\nimport { db } from '@repo/db';\nimport { headers } from 'next/headers';\n\nasync function getPlatformMetrics() {\n  const [\n    { count: totalTenants },\n    { count: activeTenants },\n    { count: trialTenants },\n    { count: suspendedTenants },\n    { data: recentLeads },\n  ] = await Promise.all([\n    db.from('tenants').select('*', { count: 'exact', head: true }),\n    db.from('tenants').select('*', { count: 'exact', head: true }).eq('status', 'active'),\n    db.from('tenants').select('*', { count: 'exact', head: true }).eq('status', 'trial'),\n    db.from('tenants').select('*', { count: 'exact', head: true }).eq('status', 'suspended'),\n    db.from('leads').select('id, created_at, tenant_id, score')\n      .order('created_at', { ascending: false })\n      .limit(5),\n  ]);\n\n  return {\n    totalTenants: totalTenants ?? 0,\n    activeTenants: activeTenants ?? 0,\n    trialTenants: trialTenants ?? 0,\n    suspendedTenants: suspendedTenants ?? 0,\n    recentLeads: recentLeads ?? [],\n  };\n}\n\nasync function getTenantList(search?: string, status?: string) {\n  let query = db\n    .from('tenants')\n    .select('id, config->identity->siteName, subdomain, custom_domain, status, billing_tier, created_at, onboarding_completed_at')\n    .order('created_at', { ascending: false })\n    .limit(50);\n\n  if (search) {\n    query = query.or(`subdomain.ilike.%${search}%,custom_domain.ilike.%${search}%`);\n  }\n  if (status) {\n    query = query.eq('status', status as any);\n  }\n\n  const { data } = await query;\n  return data ?? [];\n}\n\nexport default async function AdminDashboard({\n  searchParams,\n}: {\n  searchParams: Promise<{ search?: string; status?: string }>;\n}) {\n  const { search, status } = await searchParams;\n  const [metrics, tenants] = await Promise.all([\n    getPlatformMetrics(),\n    getTenantList(search, status),\n  ]);\n\n  const statusColors: Record<string, string> = {\n    active: 'bg-green-100 text-green-800',\n    trial: 'bg-blue-100 text-blue-800',\n    suspended: 'bg-red-100 text-red-800',\n    cancelled: 'bg-gray-100 text-gray-600',\n    pending: 'bg-yellow-100 text-yellow-800',\n  };\n\n  return (\n    <main className=\"max-w-7xl mx-auto px-4 py-8\">\n      <h1 className=\"text-3xl font-bold text-gray-900 mb-8\">Platform Admin</h1>\n\n      {/* Platform KPIs */}\n      <section aria-labelledby=\"platform-metrics\" className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-10\">\n        <h2 id=\"platform-metrics\" className=\"sr-only\">Platform metrics</h2>\n        <MetricCard label=\"Total Tenants\" value={metrics.totalTenants} />\n        <MetricCard label=\"Active\" value={metrics.activeTenants} color=\"green\" />\n        <MetricCard label=\"Trial\" value={metrics.trialTenants} color=\"blue\" />\n        <MetricCard label=\"Suspended\" value={metrics.suspendedTenants} color=\"red\" />\n      </section>\n\n      {/* Tenant search and filter */}\n      <section aria-labelledby=\"tenant-list-heading\">\n        <div className=\"flex items-center justify-between mb-4\">\n          <h2 id=\"tenant-list-heading\" className=\"text-xl font-semibold\">Tenants</h2>\n          <form className=\"flex gap-3\">\n            <input\n              type=\"search\"\n              name=\"search\"\n              defaultValue={search}\n              placeholder=\"Search domain or nameâ€¦\"\n              className=\"border border-gray-300 rounded-lg px-3 py-2 text-sm focus-visible:ring-2 focus-visible:ring-primary\"\n              aria-label=\"Search tenants\"\n            />\n            <select\n              name=\"status\"\n              defaultValue={status}\n              className=\"border border-gray-300 rounded-lg px-3 py-2 text-sm\"\n              aria-label=\"Filter by status\"\n            >\n              <option value=\"\">All statuses</option>\n              <option value=\"active\">Active</option>\n              <option value=\"trial\">Trial</option>\n              <option value=\"suspended\">Suspended</option>\n              <option value=\"cancelled\">Cancelled</option>\n            </select>\n            <button type=\"submit\" className=\"bg-primary text-white px-4 py-2 rounded-lg text-sm font-medium\">\n              Search\n            </button>\n          </form>\n        </div>\n\n        {/* Tenant table */}\n        <div className=\"bg-white border border-gray-200 rounded-xl overflow-hidden\">\n          <table className=\"w-full text-sm\" role=\"table\">\n            <thead>\n              <tr className=\"border-b border-gray-200 bg-gray-50 text-left\">\n                <th scope=\"col\" className=\"px-4 py-3 font-semibold text-gray-600\">Tenant</th>\n                <th scope=\"col\" className=\"px-4 py-3 font-semibold text-gray-600\">Domain</th>\n                <th scope=\"col\" className=\"px-4 py-3 font-semibold text-gray-600\">Status</th>\n                <th scope=\"col\" className=\"px-4 py-3 font-semibold text-gray-600\">Plan</th>\n                <th scope=\"col\" className=\"px-4 py-3 font-semibold text-gray-600\">Joined</th>\n                <th scope=\"col\" className=\"px-4 py-3 font-semibold text-gray-600\">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              {tenants.map((tenant: any) => (\n                <tr key={tenant.id} className=\"border-b border-gray-100 hover:bg-gray-50\">\n                  <td className=\"px-4 py-3 font-medium text-gray-900\">\n                    {tenant['config->identity->siteName'] ?? tenant.subdomain ?? tenant.id.slice(0, 8)}\n                  </td>\n                  <td className=\"px-4 py-3 text-gray-500 font-mono text-xs\">\n                    {tenant.custom_domain ?? `${tenant.subdomain}.youragency.com`}\n                  </td>\n                  <td className=\"px-4 py-3\">\n                    <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold ${statusColors[tenant.status] ?? 'bg-gray-100 text-gray-600'}`}>\n                      {tenant.status}\n                    </span>\n                  </td>\n                  <td className=\"px-4 py-3 text-gray-600 capitalize\">{tenant.billing_tier}</td>\n                  <td className=\"px-4 py-3 text-gray-400 text-xs\">\n                    {new Date(tenant.created_at).toLocaleDateString()}\n                  </td>\n                  <td className=\"px-4 py-3\">\n                    <div className=\"flex items-center gap-2\">\n                      <a\n                        href={`/admin/tenants/${tenant.id}`}\n                        className=\"text-primary underline text-xs hover:no-underline\"\n                      >\n                        Manage\n                      </a>\n                      <ImpersonateButton tenantId={tenant.id} />\n                    </div>\n                  </td>\n                </tr>\n              ))}\n\n              {tenants.length === 0 && (\n                <tr>\n                  <td colSpan={6} className=\"px-4 py-12 text-center text-gray-400\">\n                    No tenants found.\n                  </td>\n                </tr>\n              )}\n            </tbody>\n          </table>\n        </div>\n      </section>\n    </main>\n  );\n}\n\nfunction MetricCard({ label, value, color = 'gray' }: { label: string; value: number; color?: string }) {\n  const colorMap: Record<string, string> = {\n    gray: 'text-gray-900',\n    green: 'text-green-700',\n    blue: 'text-blue-700',\n    red: 'text-red-700',\n  };\n  return (\n    <div className=\"bg-white border border-gray-200 rounded-xl p-5\">\n      <p className=\"text-sm text-gray-500\">{label}</p>\n      <p className={`text-4xl font-extrabold mt-1 ${colorMap[color]}`}>{value.toLocaleString()}</p>\n    </div>\n  );\n}\n```\n\n---\n",
            "domainNumber": 18
          }
        },
        {
          "domainNumber": 18,
          "fileName": "DOMAIN-18-admin-section-admin.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-18\\DOMAIN-18-admin-section-admin.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "18.3-admin-tenant-detail-impersonation.md",
            "title": "Section admin",
            "description": "Implementation for domain 18 section admin",
            "topics": ["Domain 18 implementation"],
            "sectionNumber": "admin",
            "content": "### 18.3 Admin Tenant Detail + Impersonation\n\n**File:** `apps/admin/src/features/tenants/model/admin-actions.ts`\n\n```typescript\n'use server';\n\nimport { z } from 'zod';\nimport { auth } from '@clerk/nextjs/server';\nimport { db } from '@repo/db';\nimport { updateBillingStatus } from '@repo/multi-tenant/check-billing';\nimport { invalidateTenantCache } from '@repo/multi-tenant/resolve-tenant';\nimport { setTenantFeatureOverride } from '@repo/feature-flags';\nimport { enqueue } from '@repo/jobs/client';\nimport type { FeatureFlag } from '@repo/feature-flags';\n\n// â”€â”€ Guards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nasync function requireSuperAdmin() {\n  const { sessionClaims } = await auth();\n  const role = (sessionClaims?.metadata as any)?.role;\n  if (role !== 'super_admin') {\n    throw new Error('Unauthorized: Super admin role required');\n  }\n}\n\n// â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function adminUpdateTenantStatus(\n  tenantId: string,\n  status: 'active' | 'suspended' | 'cancelled'\n) {\n  await requireSuperAdmin();\n\n  await updateBillingStatus(tenantId, status);\n  await invalidateTenantCache(tenantId);\n\n  await db.from('audit_logs').insert({\n    tenant_id: tenantId,\n    action: `admin.status_changed.${status}`,\n    table_name: 'tenants',\n    record_id: tenantId,\n    new_data: { status, changedBy: 'super_admin' },\n  });\n}\n\nexport async function adminOverrideFeatureFlag(\n  tenantId: string,\n  flag: FeatureFlag,\n  enabled: boolean\n) {\n  await requireSuperAdmin();\n  await setTenantFeatureOverride(tenantId, flag, enabled);\n}\n\nexport async function adminOverrideBillingTier(\n  tenantId: string,\n  tier: 'starter' | 'professional' | 'enterprise'\n) {\n  await requireSuperAdmin();\n\n  await db\n    .from('tenants')\n    .update({\n      billing_tier: tier,\n      updated_at: new Date().toISOString(),\n    })\n    .eq('id', tenantId);\n\n  await invalidateTenantCache(tenantId);\n\n  await db.from('audit_logs').insert({\n    tenant_id: tenantId,\n    action: 'admin.billing_tier_override',\n    table_name: 'tenants',\n    record_id: tenantId,\n    new_data: { billing_tier: tier },\n  });\n}\n\nexport async function adminDeleteTenant(tenantId: string, reason: string) {\n  await requireSuperAdmin();\n\n  // Queue immediate deletion (no 30-day grace for admin-initiated)\n  await enqueue(\n    'gdpr.delete_tenant',\n    { tenantId, reason },\n    {\n      deduplicationId: `gdpr-delete-${tenantId}`,\n    }\n  );\n\n  await db.from('audit_logs').insert({\n    tenant_id: tenantId,\n    action: 'admin.tenant_deletion_queued',\n    table_name: 'tenants',\n    record_id: tenantId,\n    new_data: { reason, queuedBy: 'super_admin' },\n  });\n}\n\nexport async function adminResendWelcomeEmail(tenantId: string) {\n  await requireSuperAdmin();\n\n  // Re-queue welcome email via QStash\n  const { data: tenant } = await db.from('tenants').select('config').eq('id', tenantId).single();\n\n  if (!tenant) throw new Error('Tenant not found');\n\n  await enqueue('email.lead_digest', {\n    tenantId,\n    date: new Date().toISOString().split('T')[0],\n  });\n}\n```\n\n---\n\n## Priority Table for Domains 15â€“18\n\n| Task                                         | Domain | Priority | Timeline | Success Metric                                        |\n| -------------------------------------------- | ------ | -------- | -------- | ----------------------------------------------------- |\n| CSP nonce-based headers in middleware        | 15     | **P0**   | Day 2    | Security headers A+ on securityheaders.com            |\n| CVE-2025-29927 x-middleware-subrequest block | 15     | **P0**   | Day 1    | Middleware rejects crafted header                     |\n| Rate limiting (global + form + auth)         | 15     | **P0**   | Day 3    | Form endpoint returns 429 after 5 submissions/10min   |\n| AES-256-GCM secrets manager                  | 15     | **P0**   | Day 3    | CRM API keys never in DB plaintext                    |\n| Gitleaks secret scan in CI                   | 15     | **P0**   | Day 1    | CI fails on hardcoded credentials                     |\n| GitHub Actions monorepo CI pipeline          | 16     | **P0**   | Day 2    | CI runs only affected packages                        |\n| Turborepo remote cache (Vercel)              | 16     | **P0**   | Day 2    | Cache hit rate >70% within 1 week                     |\n| Build size guard (50MB limit)                | 16     | **P1**   | Week 1   | CI fails on accidental large bundle                   |\n| Playwright E2E in CI                         | 16     | **P0**   | Week 1   | E2E runs on every PR                                  |\n| Deploy to Vercel via CI (prod on main)       | 16     | **P0**   | Day 2    | `main` push auto-deploys to production                |\n| Feature flags (tier defaults + Edge Config)  | 16     | **P0**   | Week 1   | Starter plan cannot access professional features      |\n| Feature flag admin overrides (Redis)         | 16     | **P1**   | Week 2   | Admin can enable beta for single tenant               |\n| Onboarding wizard (6-step, progressive save) | 17     | **P0**   | Week 1   | New tenant completes onboarding in < 10 min           |\n| Domain provisioning in onboarding            | 17     | **P0**   | Week 1   | Subdomain live within 60s of completing step          |\n| Sensitive keys â†’ encrypted secrets at step 6 | 17     | **P0**   | Week 1   | Zapier URL never visible in DB config column          |\n| Review + launch step                         | 17     | **P0**   | Week 1   | `completeOnboarding()` activates tenant + queues jobs |\n| Super admin dashboard (tenant list + KPIs)   | 18     | **P1**   | Week 2   | All tenants visible, searchable, filterable           |\n| Admin status override (suspend/activate)     | 18     | **P1**   | Week 2   | Status change reflects on site within 30s             |\n| Admin billing tier override                  | 18     | **P1**   | Week 2   | Tier change unlocks features immediately              |\n| Admin audit log for all actions              | 18     | **P1**   | Week 2   | All admin actions traceable with timestamp            |\n| GDPR deletion (immediate, admin-initiated)   | 18     | **P2**   | Week 3   | Tenant data gone within 60s when admin triggers       |\n\n---\n\n**Cross-domain invariants for Domains 15â€“18:**\n\n- Security headers applied unconditionally to every response in middleware â€” not in `next.config.ts` (where they can be bypassed). [nextjs](https://nextjs.org/docs/pages/guides/content-security-policy)\n- The `x-middleware-subrequest` block is the first check in middleware, before any other logic â€” it cannot be skipped. [projectdiscovery](https://projectdiscovery.io/blog/nextjs-middleware-authorization-bypass)\n- CI never runs all packages on every commit â€” `turbo run --filter=\"...[origin/main]\"` runs only what changed. A shared package change triggers all apps automatically via Turborepo's dependency graph. [warpbuild](https://warpbuild.com/blog/github-actions-monorepo-guide)\n- Feature flags are the single source of truth for feature access â€” never check `billingTier === 'enterprise'` inline in components. Always call `isFeatureEnabled()`.\n- Onboarding secrets (CRM keys, webhook URLs) go to `setTenantSecret()` â€” never into the `config` JSONB column that is more broadly readable.\n- Super admin actions always: (1) call `requireSuperAdmin()` first, (2) write an audit log after. No exceptions.\n\n---\n\nHere are Domains 19â€“22 at full production depth.\n\n---\n",
            "domainNumber": 18
          }
        }
      ]
    },
    {
      "domainNumber": 19,
      "success": true,
      "tasksCreated": 4,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 19,
          "fileName": "DOMAIN-19-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-19\\DOMAIN-19-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "19.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 19 section philosophy.md",
            "topics": ["Domain 19 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 19.1 Philosophy\n\n**What it is:** Cal.com provides the scheduling infrastructure â€” event types, availability, Google/Outlook calendar sync, video conferencing. Your platform owns the booking _record_ in Supabase (for CRM sync, lead scoring, and GDPR) and Cal.com owns the actual appointment slot. The integration contract is: **your site sends Cal.com the booking, Cal.com sends your webhook the confirmation.** [blog.elest](https://blog.elest.io/cal-com-api-build-custom-booking-flows-and-integrate-with-your-stack/)\n\n**Cal.com API v1 vs v2:** Cal.com deprecated API v1 on **February 15, 2026**. All integrations must use API v2 (`https://api.cal.com/v2`), which requires an OAuth-based access token (`cal_` prefixed) or a managed user token, not a simple API key. [community.make](https://community.make.com/t/cal-com-api-deprecation-any-impact-or-downtime-expected-after-feb-15-2026/103091)\n\n**Architecture â€” two modes:**\n\n| Mode                 | Use Case                                                        | How                                       |\n| -------------------- | --------------------------------------------------------------- | ----------------------------------------- |\n| **Embedded widget**  | Client's website â€” visitor books directly on the marketing site | Cal.com embed JS loads in a drawer/modal  |\n| **Managed bookings** | Agency-managed â€” client's Cal.com account provisioned via API   | Managed User API + per-tenant event types |\n\n---\n",
            "domainNumber": 19
          }
        },
        {
          "domainNumber": 19,
          "fileName": "DOMAIN-19-calcom-section-calcom.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-19\\DOMAIN-19-calcom-section-calcom.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "19.2-calcom-webhook-handler.md",
            "title": "Section calcom",
            "description": "Implementation for domain 19 section calcom",
            "topics": ["Domain 19 implementation"],
            "sectionNumber": "calcom",
            "content": "### 19.2 Cal.com Webhook Handler\n\n**File:** `apps/*/src/app/api/webhooks/cal/route.ts`\n\n```typescript\nimport { NextRequest, NextResponse } from 'next/server';\nimport { createHmac, timingSafeEqual } from 'crypto';\nimport { db } from '@repo/db';\nimport { enqueue } from '@repo/jobs/client';\nimport { classifyLead } from '@repo/lead-capture/scoring';\n\n// ============================================================================\n// CAL.COM WEBHOOK HANDLER (API v2)\n// Events: BOOKING_CREATED, BOOKING_RESCHEDULED, BOOKING_CANCELLED,\n//         BOOKING_CONFIRMED, BOOKING_COMPLETED, BOOKING_NO_SHOW\n// Reference: https://cal.com/docs/api-reference/v2/event-types-webhooks\n// ============================================================================\n\nexport const dynamic = 'force-dynamic';\n\n// Idempotent signature verification (same pattern as Stripe)\nfunction verifyCalWebhook(payload: string, signature: string | null, secret: string): boolean {\n  if (!signature) return false;\n\n  const expected = createHmac('sha256', secret).update(payload).digest('hex');\n\n  try {\n    return timingSafeEqual(Buffer.from(signature, 'hex'), Buffer.from(expected, 'hex'));\n  } catch {\n    return false;\n  }\n}\n\nexport async function POST(req: NextRequest) {\n  const body = await req.text();\n  const signature = req.headers.get('x-cal-signature-256');\n\n  // Tenant ID is passed in the webhook URL: /api/webhooks/cal?tenant=abc123\n  const tenantId = req.nextUrl.searchParams.get('tenant');\n  if (!tenantId) {\n    return NextResponse.json({ error: 'Missing tenant' }, { status: 400 });\n  }\n\n  // Fetch per-tenant Cal.com webhook secret from secrets manager\n  const { getTenantSecret } = await import('@repo/security/secrets-manager');\n  const webhookSecret = await getTenantSecret(tenantId, 'CAL_WEBHOOK_SECRET');\n\n  if (!webhookSecret) {\n    // Cal.com not configured for this tenant â€” silently accept (not an error)\n    return NextResponse.json({ received: true });\n  }\n\n  if (!verifyCalWebhook(body, signature, webhookSecret)) {\n    return NextResponse.json({ error: 'Invalid signature' }, { status: 401 });\n  }\n\n  // Idempotency: parse event ID from payload\n  let event: CalWebhookEvent;\n  try {\n    event = JSON.parse(body);\n  } catch {\n    return NextResponse.json({ error: 'Invalid JSON' }, { status: 400 });\n  }\n\n  // Cal.com doesn't provide a unique event ID on the envelope â€”\n  // construct one from booking UID + trigger type\n  const eventId = `cal:${event.triggerEvent}:${event.payload?.uid}`;\n\n  const { data: existing } = await db\n    .from('processed_webhooks')\n    .select('id')\n    .eq('provider', 'cal')\n    .eq('event_id', eventId)\n    .maybeSingle();\n\n  if (existing) {\n    return NextResponse.json({ received: true, duplicate: true });\n  }\n\n  await db.from('processed_webhooks').insert({\n    provider: 'cal',\n    event_id: eventId,\n    event_type: event.triggerEvent,\n  });\n\n  try {\n    await handleCalEvent(event, tenantId);\n    return NextResponse.json({ received: true });\n  } catch (err) {\n    console.error('[Cal.com Webhook] Handler error:', err);\n    return NextResponse.json({ error: 'Handler failed' }, { status: 500 });\n  }\n}\n\n// ============================================================================\n// EVENT HANDLERS\n// ============================================================================\n\nasync function handleCalEvent(event: CalWebhookEvent, tenantId: string): Promise<void> {\n  switch (event.triggerEvent) {\n    case 'BOOKING_CREATED':\n      await handleBookingCreated(event.payload, tenantId);\n      break;\n    case 'BOOKING_RESCHEDULED':\n      await handleBookingRescheduled(event.payload, tenantId);\n      break;\n    case 'BOOKING_CANCELLED':\n      await handleBookingCancelled(event.payload, tenantId);\n      break;\n    case 'BOOKING_CONFIRMED':\n      await handleBookingConfirmed(event.payload, tenantId);\n      break;\n    case 'BOOKING_COMPLETED':\n      await handleBookingCompleted(event.payload, tenantId);\n      break;\n    case 'BOOKING_NO_SHOW':\n      await handleBookingNoShow(event.payload, tenantId);\n      break;\n    default:\n      console.log(`[Cal.com] Unhandled event: ${event.triggerEvent}`);\n  }\n}\n\nasync function handleBookingCreated(payload: CalBookingPayload, tenantId: string): Promise<void> {\n  const attendee = payload.attendees?.[0];\n  if (!attendee) return;\n\n  // Upsert booking record\n  const { data: booking, error } = await db\n    .from('bookings')\n    .upsert(\n      {\n        tenant_id: tenantId,\n        cal_uid: payload.uid,\n        cal_booking_id: payload.bookingId,\n        status: 'confirmed',\n        attendee_name: attendee.name,\n        attendee_email: attendee.email,\n        attendee_phone: attendee.phoneNumber ?? null,\n        event_type: payload.type,\n        event_title: payload.title,\n        start_time: payload.startTime,\n        end_time: payload.endTime,\n        metadata: {\n          responses: payload.responses,\n          location: payload.location,\n          organizer: payload.organizer,\n          videoCallUrl: payload.videoCallUrl,\n        },\n        created_at: new Date().toISOString(),\n      },\n      { onConflict: 'cal_uid' }\n    )\n    .select()\n    .single();\n\n  if (error || !booking) {\n    throw new Error(`Failed to upsert booking: ${error?.message}`);\n  }\n\n  // Auto-create or update lead from booking attendee (bookings = high-intent)\n  const existingLead = await db\n    .from('leads')\n    .select('id, score')\n    .eq('tenant_id', tenantId)\n    .eq('email', attendee.email.toLowerCase())\n    .maybeSingle();\n\n  if (existingLead.data) {\n    // Boost score: booking = +20 points\n    const newScore = Math.min(100, (existingLead.data.score ?? 50) + 20);\n    await db\n      .from('leads')\n      .update({\n        score: newScore,\n        status: 'booking_confirmed',\n        updated_at: new Date().toISOString(),\n      })\n      .eq('id', existingLead.data.id);\n  } else {\n    // Create new lead from booking (score starts at 70 â€” bookings are qualified)\n    const score = classifyLead({\n      name: attendee.name,\n      email: attendee.email,\n      phone: attendee.phoneNumber ?? undefined,\n      message: `Booking: ${payload.title} on ${new Date(payload.startTime).toLocaleDateString()}`,\n      source: 'booking',\n    });\n\n    await db.from('leads').insert({\n      tenant_id: tenantId,\n      name: attendee.name,\n      email: attendee.email.toLowerCase(),\n      phone: attendee.phoneNumber ?? null,\n      source: 'booking',\n      status: 'booking_confirmed',\n      score: Math.max(score, 70), // Bookings always start qualified\n      booking_id: booking.id,\n    });\n  }\n\n  // Schedule 24h reminder\n  const bookingStart = new Date(payload.startTime);\n  const reminder24h = new Date(bookingStart.getTime() - 24 * 60 * 60 * 1000);\n  const now = new Date();\n\n  if (reminder24h > now) {\n    await enqueue(\n      'booking.reminder',\n      {\n        tenantId,\n        bookingId: booking.id,\n        reminderType: '24h',\n      },\n      {\n        notBefore: reminder24h,\n        deduplicationId: `reminder-24h-${booking.id}`,\n      }\n    );\n  }\n\n  // Schedule 1h reminder\n  const reminder1h = new Date(bookingStart.getTime() - 60 * 60 * 1000);\n  if (reminder1h > now) {\n    await enqueue(\n      'booking.reminder',\n      {\n        tenantId,\n        bookingId: booking.id,\n        reminderType: '1h',\n      },\n      {\n        notBefore: reminder1h,\n        deduplicationId: `reminder-1h-${booking.id}`,\n      }\n    );\n  }\n\n  // Schedule post-appointment follow-up (+30 min after end)\n  const followUpTime = new Date(new Date(payload.endTime).getTime() + 30 * 60 * 1000);\n  await enqueue(\n    'booking.followup',\n    {\n      tenantId,\n      bookingId: booking.id,\n    },\n    {\n      notBefore: followUpTime,\n      deduplicationId: `followup-${booking.id}`,\n    }\n  );\n\n  console.log(`[Cal.com] Booking created: ${booking.id} for tenant ${tenantId}`);\n}\n\nasync function handleBookingRescheduled(\n  payload: CalBookingPayload,\n  tenantId: string\n): Promise<void> {\n  await db\n    .from('bookings')\n    .update({\n      status: 'rescheduled',\n      start_time: payload.startTime,\n      end_time: payload.endTime,\n      updated_at: new Date().toISOString(),\n    })\n    .eq('cal_uid', payload.uid)\n    .eq('tenant_id', tenantId);\n\n  // Re-queue reminders with new time (deduplication IDs are stable â€” QStash replaces)\n  const bookingStart = new Date(payload.startTime);\n  const reminder24h = new Date(bookingStart.getTime() - 24 * 60 * 60 * 1000);\n  if (reminder24h > new Date()) {\n    const { data: booking } = await db\n      .from('bookings')\n      .select('id')\n      .eq('cal_uid', payload.uid)\n      .single();\n\n    if (booking) {\n      await enqueue(\n        'booking.reminder',\n        {\n          tenantId,\n          bookingId: booking.id,\n          reminderType: '24h',\n        },\n        {\n          notBefore: reminder24h,\n          deduplicationId: `reminder-24h-${booking.id}`,\n        }\n      );\n    }\n  }\n}\n\nasync function handleBookingCancelled(payload: CalBookingPayload, tenantId: string): Promise<void> {\n  await db\n    .from('bookings')\n    .update({\n      status: 'cancelled',\n      metadata: db.raw(\n        `metadata || '{\"cancellationReason\": \"${payload.cancellationReason ?? 'unspecified'}\"}'::jsonb`\n      ),\n      updated_at: new Date().toISOString(),\n    })\n    .eq('cal_uid', payload.uid)\n    .eq('tenant_id', tenantId);\n}\n\nasync function handleBookingConfirmed(payload: CalBookingPayload, tenantId: string): Promise<void> {\n  await db\n    .from('bookings')\n    .update({ status: 'confirmed', updated_at: new Date().toISOString() })\n    .eq('cal_uid', payload.uid)\n    .eq('tenant_id', tenantId);\n}\n\nasync function handleBookingCompleted(payload: CalBookingPayload, tenantId: string): Promise<void> {\n  await db\n    .from('bookings')\n    .update({ status: 'completed', updated_at: new Date().toISOString() })\n    .eq('cal_uid', payload.uid)\n    .eq('tenant_id', tenantId);\n\n  // Update lead status to converted\n  const { data: booking } = await db\n    .from('bookings')\n    .select('attendee_email')\n    .eq('cal_uid', payload.uid)\n    .single();\n\n  if (booking) {\n    await db\n      .from('leads')\n      .update({ status: 'converted', updated_at: new Date().toISOString() })\n      .eq('tenant_id', tenantId)\n      .eq('email', booking.attendee_email.toLowerCase());\n  }\n}\n\nasync function handleBookingNoShow(payload: CalBookingPayload, tenantId: string): Promise<void> {\n  await db\n    .from('bookings')\n    .update({ status: 'no_show', updated_at: new Date().toISOString() })\n    .eq('cal_uid', payload.uid)\n    .eq('tenant_id', tenantId);\n}\n\n// ============================================================================\n// CAL.COM API v2 TYPES\n// ============================================================================\n\ninterface CalWebhookEvent {\n  triggerEvent:\n    | 'BOOKING_CREATED'\n    | 'BOOKING_RESCHEDULED'\n    | 'BOOKING_CANCELLED'\n    | 'BOOKING_CONFIRMED'\n    | 'BOOKING_COMPLETED'\n    | 'BOOKING_NO_SHOW'\n    | 'MEETING_STARTED'\n    | 'MEETING_ENDED';\n  createdAt: string;\n  payload: CalBookingPayload;\n}\n\ninterface CalBookingPayload {\n  uid: string;\n  bookingId: number;\n  title: string;\n  type: string;\n  startTime: string;\n  endTime: string;\n  location: string;\n  videoCallUrl?: string;\n  cancellationReason?: string;\n  responses?: Record<string, unknown>;\n  organizer: { name: string; email: string; timeZone: string };\n  attendees: Array<{ name: string; email: string; phoneNumber?: string; timeZone: string }>;\n  metadata?: Record<string, unknown>;\n}\n```\n\n---\n",
            "domainNumber": 19
          }
        },
        {
          "domainNumber": 19,
          "fileName": "DOMAIN-19-calcom-section-calcom.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-19\\DOMAIN-19-calcom-section-calcom.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "19.3-calcom-embed-widget-marketing-site.md",
            "title": "Section calcom",
            "description": "Implementation for domain 19 section calcom",
            "topics": ["Domain 19 implementation"],
            "sectionNumber": "calcom",
            "content": "### 19.3 Cal.com Embed Widget (Marketing Site)\n\n**File:** `packages/ui/src/booking/BookingEmbed.tsx`\n\n```typescript\n'use client';\n\nimport { useEffect, useRef, useState } from 'react';\nimport Cal, { getCalApi } from '@calcom/embed-react';\n\ninterface BookingEmbedProps {\n  calUsername: string;        // e.g. \"john-hvac\" or \"agency/free-consultation\"\n  eventSlug?: string;         // e.g. \"free-consultation\" (uses default if omitted)\n  tenantId: string;           // Passed as Cal metadata for webhook routing\n  prefillName?: string;\n  prefillEmail?: string;\n  mode?: 'inline' | 'popup' | 'floatingButton';\n  buttonText?: string;\n  buttonClassName?: string;\n}\n\n// Inline embed (renders full calendar in page)\nexport function BookingEmbedInline({\n  calUsername,\n  eventSlug = 'free-consultation',\n  tenantId,\n  prefillName,\n  prefillEmail,\n}: BookingEmbedProps) {\n  const calRef = useRef<any>(null);\n\n  useEffect(() => {\n    (async () => {\n      const cal = await getCalApi({ namespace: tenantId });\n\n      // Theme matches tenant's CSS variables\n      cal('ui', {\n        theme: 'auto',\n        hideEventTypeDetails: false,\n        layout: 'month_view',\n        cssVarsPerTheme: {\n          light: {\n            'cal-brand': 'var(--color-primary)',\n            'cal-brand-text': '#ffffff',\n            'cal-border-subtle': '#e5e7eb',\n          },\n          dark: {\n            'cal-brand': 'var(--color-primary)',\n            'cal-brand-text': '#ffffff',\n          },\n        },\n      });\n\n      // Track booking events for analytics\n      cal('on', {\n        action: 'bookingSuccessful',\n        callback: (e: any) => {\n          window.dispatchEvent(\n            new CustomEvent('booking_completed', {\n              detail: {\n                tenantId,\n                eventType: e.detail?.data?.eventType?.slug,\n                attendeeEmail: e.detail?.data?.booking?.attendees?.[0]?.email,\n              },\n            })\n          );\n        },\n      });\n    })();\n  }, [tenantId]);\n\n  return (\n    <div aria-label=\"Schedule an appointment\" role=\"region\">\n      <Cal\n        namespace={tenantId}\n        calLink={`${calUsername}/${eventSlug}`}\n        config={{\n          layout: 'month_view',\n          ...(prefillName ? { name: prefillName } : {}),\n          ...(prefillEmail ? { email: prefillEmail } : {}),\n          metadata: { tenantId }, // Included in webhook payload\n        }}\n        style={{ width: '100%', height: '100%', overflow: 'scroll' }}\n      />\n    </div>\n  );\n}\n\n// Popup trigger (button opens Cal modal)\nexport function BookingEmbedPopup({\n  calUsername,\n  eventSlug = 'free-consultation',\n  tenantId,\n  buttonText = 'Book a Free Consultation',\n  buttonClassName,\n}: BookingEmbedProps) {\n  useEffect(() => {\n    (async () => {\n      const cal = await getCalApi({ namespace: `${tenantId}-popup` });\n      cal('ui', {\n        theme: 'auto',\n        hideEventTypeDetails: false,\n        cssVarsPerTheme: {\n          light: { 'cal-brand': 'var(--color-primary)' },\n        },\n      });\n    })();\n  }, [tenantId]);\n\n  return (\n    <button\n      type=\"button\"\n      data-cal-namespace={`${tenantId}-popup`}\n      data-cal-link={`${calUsername}/${eventSlug}`}\n      data-cal-config={JSON.stringify({ metadata: { tenantId } })}\n      className={buttonClassName ?? 'btn-primary'}\n      aria-label={`${buttonText} â€” opens scheduling calendar`}\n    >\n      {buttonText}\n    </button>\n  );\n}\n\n// Floating button (fixed bottom-right)\nexport function BookingFloatingButton({\n  calUsername,\n  eventSlug = 'free-consultation',\n  tenantId,\n  buttonText = 'Book Now',\n}: BookingEmbedProps) {\n  const [visible, setVisible] = useState(false);\n\n  // Show after 5 seconds or 50% scroll depth\n  useEffect(() => {\n    const timer = setTimeout(() => setVisible(true), 5000);\n    const handleScroll = () => {\n      const scrollPct = window.scrollY / (document.body.scrollHeight - window.innerHeight);\n      if (scrollPct > 0.5) setVisible(true);\n    };\n    window.addEventListener('scroll', handleScroll, { passive: true });\n    return () => {\n      clearTimeout(timer);\n      window.removeEventListener('scroll', handleScroll);\n    };\n  }, []);\n\n  useEffect(() => {\n    if (!visible) return;\n    (async () => {\n      const cal = await getCalApi({ namespace: `${tenantId}-float` });\n      cal('floatingButton', {\n        calLink: `${calUsername}/${eventSlug}`,\n        config: { metadata: { tenantId } },\n        buttonText,\n        buttonColor: 'var(--color-primary)',\n        buttonTextColor: '#ffffff',\n        hideButtonIcon: false,\n      });\n    })();\n  }, [visible, calUsername, eventSlug, tenantId, buttonText]);\n\n  return null; // Cal.com renders the button itself into the DOM\n}\n```\n\n---\n",
            "domainNumber": 19
          }
        },
        {
          "domainNumber": 19,
          "fileName": "DOMAIN-19-calcom-section-calcom.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-19\\DOMAIN-19-calcom-section-calcom.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "19.4-calcom-managed-user-provisioning.md",
            "title": "Section calcom",
            "description": "Implementation for domain 19 section calcom",
            "topics": ["Domain 19 implementation"],
            "sectionNumber": "calcom",
            "content": "### 19.4 Cal.com Managed User Provisioning\n\n**When a new tenant completes onboarding, provision a Cal.com Managed User on their behalf.**\n\n**File:** `packages/bookings/src/provision-cal-user.ts`\n\n```typescript\nimport { getTenantSecret, setTenantSecret } from '@repo/security/secrets-manager';\n\nconst CAL_API_BASE = 'https://api.cal.com/v2';\n\ninterface CalManagedUser {\n  id: number;\n  accessToken: string;\n  refreshToken: string;\n  username: string;\n  email: string;\n}\n\nexport async function provisionCalManagedUser(\n  tenantId: string,\n  email: string,\n  name: string,\n  timeZone: string = 'America/Chicago'\n): Promise<CalManagedUser> {\n  // Agency-level OAuth token (used for managed user provisioning)\n  const agencyToken = process.env.CAL_COM_AGENCY_ACCESS_TOKEN!;\n\n  // Create managed user\n  const response = await fetch(\n    `${CAL_API_BASE}/oauth-clients/${process.env.CAL_COM_CLIENT_ID}/users`,\n    {\n      method: 'POST',\n      headers: {\n        Authorization: `Bearer ${agencyToken}`,\n        'Content-Type': 'application/json',\n        'cal-api-version': '2024-09-04',\n      },\n      body: JSON.stringify({\n        email,\n        name,\n        timeFormat: 12,\n        weekStart: 'Sunday',\n        timeZone,\n      }),\n    }\n  );\n\n  if (!response.ok) {\n    const error = await response.text();\n    throw new Error(`Cal.com user provisioning failed: ${response.status} â€” ${error}`);\n  }\n\n  const { data: user } = (await response.json()) as { data: CalManagedUser };\n\n  // Store access tokens in secrets manager (never in DB plaintext)\n  await setTenantSecret(tenantId, 'CAL_USER_ID', String(user.id));\n  await setTenantSecret(tenantId, 'CAL_ACCESS_TOKEN', user.accessToken);\n  await setTenantSecret(tenantId, 'CAL_REFRESH_TOKEN', user.refreshToken);\n  await setTenantSecret(tenantId, 'CAL_USERNAME', user.username);\n\n  return user;\n}\n\nexport async function createDefaultEventTypes(\n  tenantId: string,\n  businessName: string,\n  services: Array<{ name: string; slug: string; durationMinutes?: number }>\n): Promise<void> {\n  const accessToken = await getTenantSecret(tenantId, 'CAL_ACCESS_TOKEN');\n  if (!accessToken) throw new Error('Cal.com not provisioned for this tenant');\n\n  for (const service of services) {\n    await fetch(`${CAL_API_BASE}/event-types`, {\n      method: 'POST',\n      headers: {\n        Authorization: `Bearer ${accessToken}`,\n        'Content-Type': 'application/json',\n        'cal-api-version': '2024-06-14',\n      },\n      body: JSON.stringify({\n        title: service.name,\n        slug: service.slug,\n        lengthInMinutes: service.durationMinutes ?? 30,\n        description: `Book a ${service.name} with ${businessName}`,\n        locations: [{ type: 'phone' }], // Default to phone; client can change\n        requiresConfirmation: false,\n        disableGuests: true,\n        metadata: { tenantId, serviceSlug: service.slug },\n      }),\n    });\n  }\n}\n\nexport async function registerCalWebhook(\n  tenantId: string,\n  webhookUrl: string,\n  webhookSecret: string\n): Promise<void> {\n  const accessToken = await getTenantSecret(tenantId, 'CAL_ACCESS_TOKEN');\n  if (!accessToken) throw new Error('Cal.com not provisioned for this tenant');\n\n  await setTenantSecret(tenantId, 'CAL_WEBHOOK_SECRET', webhookSecret);\n\n  await fetch(`${CAL_API_BASE}/webhooks`, {\n    method: 'POST',\n    headers: {\n      Authorization: `Bearer ${accessToken}`,\n      'Content-Type': 'application/json',\n      'cal-api-version': '2024-06-14',\n    },\n    body: JSON.stringify({\n      subscriberUrl: webhookUrl,\n      triggers: [\n        'BOOKING_CREATED',\n        'BOOKING_RESCHEDULED',\n        'BOOKING_CANCELLED',\n        'BOOKING_CONFIRMED',\n        'BOOKING_COMPLETED',\n        'BOOKING_NO_SHOW',\n      ],\n      secret: webhookSecret,\n      active: true,\n      payloadTemplate: null, // Use default (full payload)\n    }),\n  });\n}\n```\n\n---\n",
            "domainNumber": 19
          }
        }
      ]
    },
    {
      "domainNumber": 20,
      "success": true,
      "tasksCreated": 5,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 20,
          "fileName": "DOMAIN-20-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-20\\DOMAIN-20-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "20.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 20 section philosophy.md",
            "topics": ["Domain 20 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 20.1 Philosophy\n\n**What it is:** Resend is the email delivery infrastructure. React Email 5 is the template system â€” JSX components compiled to HTML/text that all major email clients can render. Per-tenant domain isolation is critical: each client's emails must come from their own domain (or subdomain) to protect sending reputation. If client A's spam complaints affected all clients, the shared IP pool would be destroyed. [resend](https://resend.com/blog/new-features-in-2025)\n\n**Multi-tenant email architecture:**\n\n- Agency owns `mail.agency.com` â€” used for platform notifications (billing, onboarding)\n- Each client gets their own sending subdomain: `mail.clientdomain.com` â€” used for lead notifications, booking reminders\n- If a client hasn't verified their domain, emails fall back to `mail.agency.com` with reply-to set to the client's address [resend](https://resend.com/docs/dashboard/domains/introduction)\n\n---\n",
            "domainNumber": 20
          }
        },
        {
          "domainNumber": 20,
          "fileName": "DOMAIN-20-email-section-email.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-20\\DOMAIN-20-email-section-email.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "20.2-email-package-structure.md",
            "title": "Section email",
            "description": "Implementation for domain 20 section email",
            "topics": ["Domain 20 implementation"],
            "sectionNumber": "email",
            "content": "### 20.2 Email Package Structure\n\n```\npackages/email/\nâ”œâ”€â”€ src/\nâ”‚   â”œâ”€â”€ client.ts                   # Resend SDK wrapper with multi-tenant routing\nâ”‚   â”œâ”€â”€ send.ts                     # Unified send function with fallback logic\nâ”‚   â”œâ”€â”€ templates/\nâ”‚   â”‚   â”œâ”€â”€ LeadNotification.tsx    # Immediate lead alert\nâ”‚   â”‚   â”œâ”€â”€ LeadDigest.tsx          # Daily lead summary\nâ”‚   â”‚   â”œâ”€â”€ BillingReceipt.tsx      # Payment receipt\nâ”‚   â”‚   â”œâ”€â”€ BillingFailed.tsx       # Payment failure warning\nâ”‚   â”‚   â”œâ”€â”€ BillingCancelled.tsx    # Subscription cancelled\nâ”‚   â”‚   â”œâ”€â”€ UpcomingInvoice.tsx     # Pre-billing reminder\nâ”‚   â”‚   â”œâ”€â”€ BookingConfirmation.tsx # Booking confirmed to attendee\nâ”‚   â”‚   â”œâ”€â”€ BookingReminder.tsx     # 24h / 1h reminder\nâ”‚   â”‚   â”œâ”€â”€ BookingFollowUp.tsx     # Post-appointment follow-up\nâ”‚   â”‚   â”œâ”€â”€ WelcomeAgency.tsx       # Onboarding complete â€” to agency\nâ”‚   â”‚   â”œâ”€â”€ WelcomeClient.tsx       # Account created â€” to client\nâ”‚   â”‚   â””â”€â”€ AccountSuspended.tsx    # Account suspended notice\nâ”‚   â”œâ”€â”€ components/\nâ”‚   â”‚   â”œâ”€â”€ BaseLayout.tsx          # Shared wrapper (logo, footer, unsubscribe)\nâ”‚   â”‚   â”œâ”€â”€ Button.tsx              # CTA button\nâ”‚   â”‚   â”œâ”€â”€ LeadCard.tsx            # Lead summary card component\nâ”‚   â”‚   â””â”€â”€ MetricRow.tsx           # Stat row for digest\nâ”‚   â””â”€â”€ types.ts\n```\n\n---\n",
            "domainNumber": 20
          }
        },
        {
          "domainNumber": 20,
          "fileName": "DOMAIN-20-email-section-email.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-20\\DOMAIN-20-email-section-email.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "20.3-email-client-multi-tenant-routing.md",
            "title": "Section email",
            "description": "Implementation for domain 20 section email",
            "topics": ["Domain 20 implementation"],
            "sectionNumber": "email",
            "content": "### 20.3 Email Client & Multi-Tenant Routing\n\n**File:** `packages/email/src/client.ts`\n\n```typescript\nimport { Resend } from 'resend';\nimport { db } from '@repo/db';\nimport { Redis } from '@upstash/redis';\n\nconst redis = Redis.fromEnv();\n\n// Agency's main Resend account (used for platform emails)\nconst agencyResend = new Resend(process.env.RESEND_API_KEY!);\n\n// Cache: tenant_id â†’ { domainId, fromEmail, verified }\n// TTL: 30 min (domains rarely change)\n\ninterface TenantEmailConfig {\n  fromEmail: string; // e.g. \"leads@johnsplumbing.com\"\n  fromName: string; // e.g. \"John's Plumbing\"\n  replyTo?: string; // Owner's personal email\n  domainVerified: boolean;\n  resendDomainId?: string; // Resend domain ID if verified\n}\n\nexport async function getTenantEmailConfig(tenantId: string): Promise<TenantEmailConfig> {\n  const cacheKey = `email-config:${tenantId}`;\n  const cached = await redis.get<TenantEmailConfig>(cacheKey);\n  if (cached) return cached;\n\n  const { data: tenant } = await db\n    .from('tenants')\n    .select(\n      `\n      config->identity->siteName,\n      config->identity->contact->email,\n      custom_domain,\n      resend_domain_id,\n      resend_domain_verified\n    `\n    )\n    .eq('id', tenantId)\n    .single();\n\n  const siteName = (tenant as any)?.['config->identity->siteName'] ?? 'Our Team';\n  const ownerEmail = (tenant as any)?.['config->identity->contact->email'] ?? null;\n  const customDomain = (tenant as any)?.custom_domain ?? null;\n  const domainVerified = (tenant as any)?.resend_domain_verified ?? false;\n  const resendDomainId = (tenant as any)?.resend_domain_id ?? null;\n\n  let fromEmail: string;\n  if (customDomain && domainVerified) {\n    // Use client's own verified domain\n    fromEmail = `notifications@${customDomain}`;\n  } else {\n    // Fall back to agency subdomain: noreply@agency.com\n    fromEmail = `noreply@${process.env.AGENCY_EMAIL_DOMAIN}`;\n  }\n\n  const config: TenantEmailConfig = {\n    fromEmail,\n    fromName: siteName,\n    replyTo: ownerEmail ?? undefined,\n    domainVerified,\n    resendDomainId: resendDomainId ?? undefined,\n  };\n\n  await redis.setex(cacheKey, 1800, JSON.stringify(config)); // 30 min cache\n  return config;\n}\n\n// Provision a Resend sending domain for a tenant (called during onboarding)\nexport async function provisionTenantEmailDomain(\n  tenantId: string,\n  domain: string\n): Promise<{ dnsRecords: ResendDNSRecord[] }> {\n  const { data, error } = await agencyResend.domains.create({\n    name: domain,\n    region: 'us-east-1',\n    // Custom return path improves DMARC alignment\n    customReturnPath: 'mail',\n  });\n\n  if (error || !data) {\n    throw new Error(`Failed to create Resend domain: ${error?.message}`);\n  }\n\n  // Store Resend domain ID for future API calls\n  await db\n    .from('tenants')\n    .update({\n      resend_domain_id: data.id,\n      resend_domain_verified: false,\n    })\n    .eq('id', tenantId);\n\n  // Bust cache\n  await redis.del(`email-config:${tenantId}`);\n\n  return { dnsRecords: data.records as ResendDNSRecord[] };\n}\n\n// Poll domain verification status (called from a scheduled job)\nexport async function checkTenantEmailDomainVerification(tenantId: string): Promise<boolean> {\n  const { data: tenant } = await db\n    .from('tenants')\n    .select('resend_domain_id')\n    .eq('id', tenantId)\n    .single();\n\n  if (!tenant?.resend_domain_id) return false;\n\n  const { data: domain } = await agencyResend.domains.get(tenant.resend_domain_id);\n\n  const verified = domain?.status === 'verified';\n\n  if (verified) {\n    await db\n      .from('tenants')\n      .update({\n        resend_domain_verified: true,\n      })\n      .eq('id', tenantId);\n\n    await redis.del(`email-config:${tenantId}`);\n  }\n\n  return verified;\n}\n\ntype ResendDNSRecord = {\n  type: string;\n  name: string;\n  value: string;\n  ttl: string;\n  priority?: number;\n};\n```\n\n---\n",
            "domainNumber": 20
          }
        },
        {
          "domainNumber": 20,
          "fileName": "DOMAIN-20-unified-section-unified.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-20\\DOMAIN-20-unified-section-unified.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "20.4-unified-send-function.md",
            "title": "Section unified",
            "description": "Implementation for domain 20 section unified",
            "topics": ["Domain 20 implementation"],
            "sectionNumber": "unified",
            "content": "### 20.4 Unified Send Function\n\n**File:** `packages/email/src/send.ts`\n\n```typescript\nimport { Resend } from 'resend';\nimport { render } from '@react-email/render';\nimport { getTenantEmailConfig } from './client';\nimport type { ReactElement } from 'react';\n\nconst resend = new Resend(process.env.RESEND_API_KEY!);\n\nexport type EmailType =\n  | 'lead_notification'\n  | 'lead_digest'\n  | 'billing_receipt'\n  | 'billing_failed'\n  | 'billing_cancelled'\n  | 'upcoming_invoice'\n  | 'booking_confirmation'\n  | 'booking_reminder_24h'\n  | 'booking_reminder_1h'\n  | 'booking_followup'\n  | 'welcome_agency'\n  | 'welcome_client'\n  | 'account_suspended'\n  | 'plan_changed'\n  | 'subscription_started'\n  | 'subscription_cancelled';\n\ninterface SendEmailOptions {\n  tenantId: string;\n  to: string | string[]; // Recipient(s)\n  toName?: string;\n  template: ReactElement; // React Email component\n  subject: string;\n  emailType: EmailType;\n  idempotencyKey?: string; // Resend idempotency key (prevents duplicates)\n  cc?: string[];\n  bcc?: string[];\n  attachments?: Array<{ filename: string; content: Buffer }>;\n}\n\nexport async function sendEmail(options: SendEmailOptions): Promise<void> {\n  const {\n    tenantId,\n    to,\n    toName,\n    template,\n    subject,\n    emailType,\n    idempotencyKey,\n    cc,\n    bcc,\n    attachments,\n  } = options;\n\n  // Get tenant email configuration (with fallback to agency domain)\n  const config = await getTenantEmailConfig(tenantId);\n\n  // Render React Email template to HTML + plain text\n  const html = await render(template);\n  const text = await render(template, { plainText: true });\n\n  const recipients = Array.isArray(to)\n    ? to.map((email) => email.toLowerCase())\n    : [to.toLowerCase()];\n\n  const { data, error } = await resend.emails.send({\n    from: `${config.fromName} <${config.fromEmail}>`,\n    to: recipients,\n    subject,\n    html,\n    text,\n    ...(config.replyTo ? { replyTo: config.replyTo } : {}),\n    ...(cc?.length ? { cc } : {}),\n    ...(bcc?.length ? { bcc } : {}),\n    ...(attachments?.length\n      ? {\n          attachments: attachments.map((a) => ({\n            filename: a.filename,\n            content: a.content.toString('base64'),\n          })),\n        }\n      : {}),\n    headers: {\n      'X-Tenant-Id': tenantId,\n      'X-Email-Type': emailType,\n      // Unsubscribe header (CAN-SPAM / GDPR compliance)\n      'List-Unsubscribe': `<${process.env.NEXT_PUBLIC_APP_URL}/unsubscribe?tenant=${tenantId}&email=${recipients[0]}>`,\n      'List-Unsubscribe-Post': 'List-Unsubscribe=One-Click',\n    },\n    ...(idempotencyKey ? { idempotencyKey } : {}),\n    tags: [\n      { name: 'tenant_id', value: tenantId },\n      { name: 'email_type', value: emailType },\n    ],\n  });\n\n  if (error) {\n    console.error(`[Email] Send failed (${emailType}, tenant=${tenantId}):`, error);\n    throw new Error(`Email send failed: ${error.message}`);\n  }\n\n  console.log(`[Email] Sent: ${emailType} â†’ ${recipients.join(', ')} (id=${data?.id})`);\n}\n\n// ============================================================================\n// CONVENIENCE WRAPPERS â€” per email type\n// ============================================================================\n\nexport async function sendLeadNotificationEmail(\n  tenantId: string,\n  lead: {\n    name: string;\n    email: string;\n    phone?: string;\n    message: string;\n    score: number;\n    source?: string;\n    utmSource?: string;\n    utmCampaign?: string;\n    landingPage?: string;\n  },\n  ownerEmail: string\n): Promise<void> {\n  const { LeadNotificationEmail } = await import('./templates/LeadNotification');\n\n  await sendEmail({\n    tenantId,\n    to: ownerEmail,\n    subject: `ðŸ”¥ New ${lead.score >= 70 ? 'qualified ' : ''}lead: ${lead.name}`,\n    template: LeadNotificationEmail({ lead }),\n    emailType: 'lead_notification',\n    idempotencyKey: `lead-notification-${tenantId}-${lead.email}-${Date.now()}`,\n  });\n}\n\nexport async function sendLeadDigestEmail(\n  tenantId: string,\n  leads: any[],\n  date: string\n): Promise<void> {\n  const config = await getTenantEmailConfig(tenantId);\n  if (!config.replyTo) return; // No owner email configured\n\n  const { LeadDigestEmail } = await import('./templates/LeadDigest');\n\n  await sendEmail({\n    tenantId,\n    to: config.replyTo,\n    subject: `ðŸ“Š ${leads.length} new lead${leads.length !== 1 ? 's' : ''} on ${date}`,\n    template: LeadDigestEmail({ leads, date, tenantName: config.fromName }),\n    emailType: 'lead_digest',\n    idempotencyKey: `lead-digest-${tenantId}-${date}`,\n  });\n}\n\nexport async function sendBillingEmail(\n  type: Extract<\n    EmailType,\n    | 'billing_receipt'\n    | 'billing_failed'\n    | 'account_suspended'\n    | 'upcoming_invoice'\n    | 'plan_changed'\n    | 'subscription_started'\n    | 'subscription_cancelled'\n  >,\n  tenantId: string,\n  data: Record<string, unknown>\n): Promise<void> {\n  const config = await getTenantEmailConfig(tenantId);\n  if (!config.replyTo) return;\n\n  const templates: Record<string, () => Promise<ReactElement>> = {\n    billing_receipt: async () => {\n      const { BillingReceiptEmail } = await import('./templates/BillingReceipt');\n      return BillingReceiptEmail({ tenantName: config.fromName, ...data });\n    },\n    billing_failed: async () => {\n      const { BillingFailedEmail } = await import('./templates/BillingFailed');\n      return BillingFailedEmail({ tenantName: config.fromName, ...data });\n    },\n    account_suspended: async () => {\n      const { AccountSuspendedEmail } = await import('./templates/AccountSuspended');\n      return AccountSuspendedEmail({ tenantName: config.fromName, ...data });\n    },\n    subscription_started: async () => {\n      const { WelcomeClientEmail } = await import('./templates/WelcomeClient');\n      return WelcomeClientEmail({ tenantName: config.fromName });\n    },\n    subscription_cancelled: async () => {\n      const { BillingCancelledEmail } = await import('./templates/BillingCancelled');\n      return BillingCancelledEmail({ tenantName: config.fromName, ...data });\n    },\n    plan_changed: async () => {\n      const { PlanChangedEmail } = await import('./templates/PlanChanged');\n      return PlanChangedEmail({ tenantName: config.fromName, ...data });\n    },\n    upcoming_invoice: async () => {\n      const { UpcomingInvoiceEmail } = await import('./templates/UpcomingInvoice');\n      return UpcomingInvoiceEmail({ tenantName: config.fromName, ...data });\n    },\n  };\n\n  const templateFn = templates[type];\n  if (!templateFn) return;\n\n  const template = await templateFn();\n  const subjects: Record<string, string> = {\n    billing_receipt: `Your receipt from ${config.fromName}`,\n    billing_failed: `Payment failed â€” action required`,\n    account_suspended: `Your account has been suspended`,\n    subscription_started: `Welcome to the platform, ${config.fromName}!`,\n    subscription_cancelled: `Subscription cancelled`,\n    plan_changed: `Your plan has been updated`,\n    upcoming_invoice: `Upcoming charge for ${config.fromName}`,\n  };\n\n  await sendEmail({\n    tenantId,\n    to: config.replyTo,\n    subject: subjects[type] ?? 'Account notification',\n    template,\n    emailType: type,\n    idempotencyKey: `billing-${type}-${tenantId}-${Date.now()}`,\n  });\n}\n\nexport async function sendBookingReminderEmail(options: {\n  tenantId: string;\n  booking: any;\n  reminderType: '24h' | '1h';\n}): Promise<void> {\n  const { tenantId, booking, reminderType } = options;\n  const { BookingReminderEmail } = await import('./templates/BookingReminder');\n\n  const config = await getTenantEmailConfig(tenantId);\n\n  await sendEmail({\n    tenantId,\n    to: booking.attendee_email,\n    toName: booking.attendee_name,\n    subject:\n      reminderType === '24h'\n        ? `Reminder: Your appointment tomorrow with ${config.fromName}`\n        : `Your appointment is in 1 hour â€” ${config.fromName}`,\n    template: BookingReminderEmail({ booking, reminderType, businessName: config.fromName }),\n    emailType: `booking_reminder_${reminderType}` as EmailType,\n    idempotencyKey: `booking-reminder-${booking.id}-${reminderType}`,\n  });\n}\n```\n\n---\n",
            "domainNumber": 20
          }
        },
        {
          "domainNumber": 20,
          "fileName": "DOMAIN-20-lead-section-lead.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-20\\DOMAIN-20-lead-section-lead.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "20.5-lead-notification-template-react-email-5.md",
            "title": "Section lead",
            "description": "Implementation for domain 20 section lead",
            "topics": ["Domain 20 implementation"],
            "sectionNumber": "lead",
            "content": "### 20.5 Lead Notification Template (React Email 5)\n\n**File:** `packages/email/src/templates/LeadNotification.tsx`\n\n```typescript\nimport {\n  Html, Head, Body, Container, Section, Heading,\n  Text, Button, Hr, Row, Column, Img, Link, Font,\n} from '@react-email/components';\n\ninterface LeadNotificationProps {\n  lead: {\n    name: string;\n    email: string;\n    phone?: string;\n    message: string;\n    score: number;\n    source?: string;\n    utmSource?: string;\n    utmCampaign?: string;\n    landingPage?: string;\n  };\n}\n\nconst scoreColor = (score: number) => {\n  if (score >= 70) return '#16a34a';  // Green: qualified\n  if (score >= 40) return '#ca8a04';  // Yellow: warm\n  return '#6b7280';                    // Gray: cold\n};\n\nconst scoreLabel = (score: number) => {\n  if (score >= 70) return 'â­ Qualified';\n  if (score >= 40) return 'ðŸ”¥ Warm';\n  return 'â„ï¸ Cold';\n};\n\nexport function LeadNotificationEmail({ lead }: LeadNotificationProps) {\n  return (\n    <Html lang=\"en\" dir=\"ltr\">\n      <Head>\n        <Font\n          fontFamily=\"Inter\"\n          fallbackFontFamily=\"Helvetica\"\n          webFont={{ url: 'https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZ9hiA.woff2', format: 'woff2' }}\n          fontWeight={400}\n          fontStyle=\"normal\"\n        />\n      </Head>\n      <Body style={{ backgroundColor: '#f9fafb', fontFamily: 'Inter, Helvetica, Arial, sans-serif' }}>\n        <Container style={{ maxWidth: '560px', margin: '40px auto', backgroundColor: '#ffffff', borderRadius: '12px', overflow: 'hidden', border: '1px solid #e5e7eb' }}>\n\n          {/* Score badge header */}\n          <Section style={{ backgroundColor: scoreColor(lead.score), padding: '16px 24px' }}>\n            <Text style={{ color: '#fff', margin: 0, fontWeight: 700, fontSize: '16px' }}>\n              {scoreLabel(lead.score)} Lead â€” Score: {lead.score}/100\n            </Text>\n          </Section>\n\n          <Section style={{ padding: '28px 32px' }}>\n            <Heading as=\"h1\" style={{ fontSize: '22px', fontWeight: 700, color: '#111827', margin: '0 0 4px' }}>\n              {lead.name}\n            </Heading>\n            <Text style={{ color: '#6b7280', margin: '0 0 24px', fontSize: '15px' }}>\n              Just submitted a contact form on your website\n            </Text>\n\n            {/* Contact details */}\n            <Section style={{ backgroundColor: '#f3f4f6', borderRadius: '8px', padding: '16px 20px', marginBottom: '20px' }}>\n              <Row style={{ marginBottom: '10px' }}>\n                <Column><Text style={{ margin: 0, fontSize: '12px', color: '#9ca3af', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.05em' }}>Email</Text></Column>\n                <Column align=\"right\">\n                  <Link href={`mailto:${lead.email}`} style={{ color: '#2563eb', fontSize: '14px', fontWeight: 500 }}>{lead.email}</Link>\n                </Column>\n              </Row>\n              {lead.phone && (\n                <Row style={{ marginBottom: '10px' }}>\n                  <Column><Text style={{ margin: 0, fontSize: '12px', color: '#9ca3af', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.05em' }}>Phone</Text></Column>\n                  <Column align=\"right\">\n                    <Link href={`tel:${lead.phone}`} style={{ color: '#2563eb', fontSize: '14px', fontWeight: 500 }}>{lead.phone}</Link>\n                  </Column>\n                </Row>\n              )}\n              {lead.utmSource && (\n                <Row>\n                  <Column><Text style={{ margin: 0, fontSize: '12px', color: '#9ca3af', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.05em' }}>Source</Text></Column>\n                  <Column align=\"right\">\n                    <Text style={{ margin: 0, fontSize: '14px', color: '#374151' }}>{lead.utmSource}{lead.utmCampaign ? ` / ${lead.utmCampaign}` : ''}</Text>\n                  </Column>\n                </Row>\n              )}\n            </Section>\n\n            {/* Message */}\n            <Text style={{ fontSize: '13px', color: '#9ca3af', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.05em', margin: '0 0 8px' }}>Their Message</Text>\n            <Section style={{ backgroundColor: '#f0fdf4', borderLeft: '3px solid #16a34a', padding: '12px 16px', borderRadius: '0 6px 6px 0', marginBottom: '28px' }}>\n              <Text style={{ margin: 0, color: '#111827', fontSize: '15px', lineHeight: '1.5' }}>{lead.message}</Text>\n            </Section>\n\n            {/* CTA */}\n            <Button\n              href={`mailto:${lead.email}?subject=Re: Your inquiry`}\n              style={{\n                backgroundColor: '#2563eb',\n                color: '#ffffff',\n                borderRadius: '8px',\n                padding: '12px 24px',\n                fontWeight: 600,\n                fontSize: '15px',\n                display: 'block',\n                textAlign: 'center',\n                textDecoration: 'none',\n              }}\n            >\n              Reply to {lead.name.split(' ')[0]}\n            </Button>\n\n            {lead.landingPage && (\n              <Text style={{ color: '#9ca3af', fontSize: '12px', textAlign: 'center', marginTop: '16px' }}>\n                Submitted from: <Link href={lead.landingPage} style={{ color: '#9ca3af' }}>{lead.landingPage}</Link>\n              </Text>\n            )}\n          </Section>\n\n          <Hr style={{ borderColor: '#e5e7eb', margin: 0 }} />\n\n          {/* Footer */}\n          <Section style={{ padding: '16px 32px', backgroundColor: '#f9fafb' }}>\n            <Text style={{ color: '#9ca3af', fontSize: '12px', margin: 0, textAlign: 'center' }}>\n              You're receiving this because you have lead notifications enabled.{' '}\n              <Link href=\"{{{unsubscribe}}}\" style={{ color: '#9ca3af' }}>Unsubscribe</Link>\n            </Text>\n          </Section>\n        </Container>\n      </Body>\n    </Html>\n  );\n}\n\nexport default LeadNotificationEmail;\n```\n\n---\n",
            "domainNumber": 20
          }
        }
      ]
    },
    {
      "domainNumber": 21,
      "success": true,
      "tasksCreated": 4,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 21,
          "fileName": "DOMAIN-21-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-21\\DOMAIN-21-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "21.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 21 section philosophy.md",
            "topics": ["Domain 21 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 21.1 Philosophy\n\n**What it is:** Every tenant uploads a logo, favicon, and optionally service images. These are stored in Supabase Storage in per-tenant path-prefixed buckets, served through Supabase's built-in image transformation pipeline, and consumed by `next/image` via a custom loader.\n\n**The custom loader is the core architectural decision.** Without it, Next.js would proxy all images through Vercel's image optimization service â€” adding latency and cost. With the Supabase loader, images are transformed at the edge closer to the Supabase CDN, with on-the-fly `width`, `quality`, and automatic WebP conversion.\n\n---\n",
            "domainNumber": 21
          }
        },
        {
          "domainNumber": 21,
          "fileName": "DOMAIN-21-supabase-section-supabase.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-21\\DOMAIN-21-supabase-section-supabase.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "21.2-supabase-storage-configuration.md",
            "title": "Section supabase",
            "description": "Implementation for domain 21 section supabase",
            "topics": ["Domain 21 implementation"],
            "sectionNumber": "supabase",
            "content": "### 21.2 Supabase Storage Configuration\n\n**Buckets (created via migration, not manually):**\n\n```sql\n-- 1. Public assets bucket (logos, favicons, service images)\nINSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)\nVALUES (\n  'tenant-assets',\n  'tenant-assets',\n  TRUE,   -- Public: no auth required to VIEW; upload is restricted by RLS\n  5242880, -- 5MB max per file\n  ARRAY['image/jpeg', 'image/png', 'image/webp', 'image/svg+xml', 'image/gif', 'image/ico']\n);\n\n-- 2. Private documents bucket (PDFs, contracts, GDPR exports)\nINSERT INTO storage.buckets (id, name, public, file_size_limit)\nVALUES (\n  'tenant-documents',\n  'tenant-documents',\n  FALSE,  -- Private: requires signed URL\n  20971520 -- 20MB max\n);\n\n-- RLS: Tenants can only upload/delete their own assets\nCREATE POLICY \"Tenant asset upload\"\nON storage.objects FOR INSERT TO authenticated\nWITH CHECK (\n  bucket_id = 'tenant-assets'\n  AND (storage.foldername(name)) [blog.elest](https://blog.elest.io/cal-com-api-build-custom-booking-flows-and-integrate-with-your-stack/) = (\n    SELECT id::text FROM tenants\n    WHERE id = (auth.jwt() ->> 'tenantId')::uuid\n    LIMIT 1\n  )\n);\n\nCREATE POLICY \"Tenant asset delete\"\nON storage.objects FOR DELETE TO authenticated\nUSING (\n  bucket_id = 'tenant-assets'\n  AND (storage.foldername(name)) [blog.elest](https://blog.elest.io/cal-com-api-build-custom-booking-flows-and-integrate-with-your-stack/) = (\n    SELECT id::text FROM tenants\n    WHERE id = (auth.jwt() ->> 'tenantId')::uuid\n    LIMIT 1\n  )\n);\n```\n\n---\n",
            "domainNumber": 21
          }
        },
        {
          "domainNumber": 21,
          "fileName": "DOMAIN-21-supabase-section-supabase.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-21\\DOMAIN-21-supabase-section-supabase.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "21.3-supabase-image-loader.md",
            "title": "Section supabase",
            "description": "Implementation for domain 21 section supabase",
            "topics": ["Domain 21 implementation"],
            "sectionNumber": "supabase",
            "content": "### 21.3 Supabase Image Loader\n\n**File:** `apps/*/src/lib/supabase-image-loader.ts`\n\n```typescript\n// Custom next/image loader for Supabase Storage\n// Replaces Vercel's image optimization with Supabase's on-the-fly transform\n// Reference: https://supabase.com/docs/guides/storage/serving/image-transformations\n\nconst SUPABASE_PROJECT_ID = process.env.NEXT_PUBLIC_SUPABASE_PROJECT_ID!;\n\ninterface LoaderParams {\n  src: string;\n  width: number;\n  quality?: number;\n}\n\nexport default function supabaseLoader({ src, width, quality }: LoaderParams): string {\n  // src is relative to the bucket: \"tenant-assets/tenant-id/logo.png\"\n  // Full URL for external images (e.g. Google avatar, Sanity CDN)\n  if (src.startsWith('http')) {\n    // External image: use Supabase's image transform proxy\n    return `https://${SUPABASE_PROJECT_ID}.supabase.co/storage/v1/render/image/public/${src}?width=${width}&quality=${quality ?? 80}&format=origin`;\n  }\n\n  return [\n    `https://${SUPABASE_PROJECT_ID}.supabase.co`,\n    `/storage/v1/render/image/public/${src}`,\n    `?width=${width}`,\n    `&quality=${quality ?? 80}`,\n    `&format=webp`, // Always serve WebP (Supabase handles fallback)\n    `&resize=contain`, // Preserve aspect ratio\n  ].join('');\n}\n```\n\n**File:** `next.config.ts` (image loader configuration)\n\n```typescript\nimport type { NextConfig } from 'next';\n\nconst nextConfig: NextConfig = {\n  images: {\n    loader: 'custom',\n    loaderFile: './src/lib/supabase-image-loader.ts',\n    // Fallback domains for external images (Google avatars, Sanity)\n    remotePatterns: [\n      { protocol: 'https', hostname: '*.supabase.co' },\n      { protocol: 'https', hostname: 'lh3.googleusercontent.com' },\n      { protocol: 'https', hostname: 'cdn.sanity.io' },\n      { protocol: 'https', hostname: 'avatars.githubusercontent.com' },\n    ],\n    // Device sizes for responsive images\n    deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048],\n    imageSizes: [16, 32, 48, 64, 96, 128, 256],\n  },\n};\n\nexport default nextConfig;\n```\n\n---\n",
            "domainNumber": 21
          }
        },
        {
          "domainNumber": 21,
          "fileName": "DOMAIN-21-upload-section-upload.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-21\\DOMAIN-21-upload-section-upload.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "21.4-upload-server-action-with-client-side-compression.md",
            "title": "Section upload",
            "description": "Implementation for domain 21 section upload",
            "topics": ["Domain 21 implementation"],
            "sectionNumber": "upload",
            "content": "### 21.4 Upload Server Action (with Client-Side Compression)\n\n**Client-side compression via `browser-image-compression` before upload â€” reduces Supabase egress costs by 6â€“8Ã— for typical user photos.** [youtube](https://www.youtube.com/watch?v=FcisLdkZ_Aw)\n\n**File:** `apps/portal/src/features/assets/model/upload-asset.ts`\n\n```typescript\n'use server';\n\nimport { z } from 'zod';\nimport { createServerAction } from '@repo/auth/server-action-wrapper';\nimport { createClient } from '@supabase/supabase-js';\n\nconst supabaseAdmin = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\nconst UploadAssetSchema = z.object({\n  fileName: z.string().min(1).max(255),\n  fileType: z.enum(['image/jpeg', 'image/png', 'image/webp', 'image/svg+xml', 'image/gif']),\n  fileSize: z.number().max(5 * 1024 * 1024), // 5MB max\n  assetType: z.enum(['logo', 'favicon', 'service-image', 'hero-image', 'gallery']),\n});\n\nexport const getUploadUrl = createServerAction(UploadAssetSchema, async (input, ctx) => {\n  const { tenantId } = ctx;\n  const { fileName, fileType, assetType } = input;\n\n  // Sanitize filename (prevent path traversal)\n  const ext = fileName.split('.').pop()?.toLowerCase() ?? 'jpg';\n  const safeFileName = `${assetType}-${Date.now()}.${ext}`;\n  const storagePath = `${tenantId}/${safeFileName}`;\n\n  // Generate a signed upload URL (5 min expiry)\n  // Client uploads directly to Supabase â€” file never passes through our server\n  const { data, error } = await supabaseAdmin.storage\n    .from('tenant-assets')\n    .createSignedUploadUrl(storagePath, { upsert: true });\n\n  if (error || !data) {\n    throw new Error(`Failed to generate upload URL: ${error?.message}`);\n  }\n\n  return {\n    uploadUrl: data.signedUrl,\n    token: data.token,\n    path: storagePath,\n    publicUrl: `${process.env.NEXT_PUBLIC_SUPABASE_URL}/storage/v1/object/public/tenant-assets/${storagePath}`,\n  };\n});\n\n// Called after successful upload to store URL in tenant config\nconst ConfirmAssetSchema = z.object({\n  assetType: z.enum(['logo', 'favicon', 'service-image', 'hero-image']),\n  publicUrl: z.string().url(),\n  storagePath: z.string(),\n});\n\nexport const confirmAssetUpload = createServerAction(ConfirmAssetSchema, async (input, ctx) => {\n  const { tenantId } = ctx;\n  const { assetType, publicUrl } = input;\n\n  // Map asset type to config path\n  const configKeyMap: Record<string, string> = {\n    logo: 'assets.logo',\n    favicon: 'assets.favicon',\n  };\n\n  const configKey = configKeyMap[input.assetType];\n  if (configKey) {\n    // Deep-merge asset URL into config\n    await import('@repo/db').then(({ db }) =>\n      db\n        .from('tenants')\n        .update({\n          [`config`]: db.raw(\n            `jsonb_set(config, '{${configKey.replace('.', ',')}}', '\"${publicUrl}\"'::jsonb)`\n          ),\n        })\n        .eq('id', tenantId)\n    );\n  }\n\n  return { success: true, url: publicUrl };\n});\n```\n\n**Client-side upload component with compression:**\n\n**File:** `apps/portal/src/features/assets/ui/AssetUploader.tsx`\n\n```typescript\n'use client';\n\nimport { useState, useCallback } from 'react';\nimport imageCompression from 'browser-image-compression';\nimport { getUploadUrl, confirmAssetUpload } from '../model/upload-asset';\n\ninterface AssetUploaderProps {\n  assetType: 'logo' | 'favicon' | 'service-image' | 'hero-image';\n  currentUrl?: string;\n  label: string;\n  aspectHint?: string;             // e.g. \"square (1:1)\" or \"wide (16:9)\"\n  onUploadComplete?: (url: string) => void;\n}\n\nconst COMPRESSION_OPTIONS = {\n  logo: { maxSizeMB: 0.3, maxWidthOrHeight: 800, useWebWorker: true },\n  favicon: { maxSizeMB: 0.05, maxWidthOrHeight: 64, useWebWorker: true },\n  'service-image': { maxSizeMB: 0.5, maxWidthOrHeight: 1200, useWebWorker: true },\n  'hero-image': { maxSizeMB: 0.8, maxWidthOrHeight: 1920, useWebWorker: true },\n};\n\nexport function AssetUploader({\n  assetType,\n  currentUrl,\n  label,\n  aspectHint,\n  onUploadComplete,\n}: AssetUploaderProps) {\n  const [uploading, setUploading] = useState(false);\n  const [progress, setProgress] = useState(0);\n  const [preview, setPreview] = useState<string | null>(currentUrl ?? null);\n  const [error, setError] = useState<string | null>(null);\n\n  const handleFileChange = useCallback(\n    async (e: React.ChangeEvent<HTMLInputElement>) => {\n      const file = e.target.files?.[0];\n      if (!file) return;\n\n      setError(null);\n      setUploading(true);\n      setProgress(0);\n\n      try {\n        // 1. Client-side compression (before upload)\n        setProgress(10);\n        const options = COMPRESSION_OPTIONS[assetType];\n        const compressed = await imageCompression(file, {\n          ...options,\n          onProgress: (p) => setProgress(10 + Math.round(p * 0.4)), // 10-50%\n        });\n\n        // 2. Get signed upload URL from server\n        setProgress(50);\n        const urlResult = await getUploadUrl({\n          fileName: file.name,\n          fileType: file.type as any,\n          fileSize: compressed.size,\n          assetType,\n        });\n\n        if (!urlResult.success || !urlResult.data) {\n          throw new Error('Failed to get upload URL');\n        }\n\n        const { uploadUrl, publicUrl, storagePath } = urlResult.data;\n\n        // 3. Direct upload to Supabase (client â†’ Supabase, bypasses our server)\n        setProgress(60);\n        const uploadResponse = await fetch(uploadUrl, {\n          method: 'PUT',\n          body: compressed,\n          headers: { 'Content-Type': compressed.type },\n        });\n\n        if (!uploadResponse.ok) {\n          throw new Error(`Upload failed: ${uploadResponse.status}`);\n        }\n\n        setProgress(90);\n\n        // 4. Confirm upload in our DB\n        await confirmAssetUpload({ assetType, publicUrl, storagePath });\n\n        setProgress(100);\n        setPreview(URL.createObjectURL(compressed));\n        onUploadComplete?.(publicUrl);\n      } catch (err: any) {\n        setError(err.message ?? 'Upload failed. Please try again.');\n        console.error('[AssetUploader] Error:', err);\n      } finally {\n        setUploading(false);\n      }\n    },\n    [assetType, onUploadComplete]\n  );\n\n  const inputId = `asset-upload-${assetType}`;\n\n  return (\n    <div>\n      <label className=\"block text-sm font-medium text-gray-700 mb-2\" htmlFor={inputId}>\n        {label}\n        {aspectHint && <span className=\"ml-1 text-gray-400 font-normal text-xs\">({aspectHint})</span>}\n      </label>\n\n      <div\n        className={`\n          relative flex flex-col items-center justify-center w-full rounded-xl border-2 border-dashed\n          ${uploading ? 'border-primary/40 bg-primary/5' : 'border-gray-300 hover:border-gray-400'}\n          transition-colors cursor-pointer\n          ${assetType === 'favicon' ? 'h-24' : 'h-40'}\n        `}\n      >\n        {preview ? (\n          <div className=\"absolute inset-0 flex items-center justify-center p-4\">\n            {/* eslint-disable-next-line @next/next/no-img-element */}\n            <img\n              src={preview}\n              alt={`${label} preview`}\n              className=\"max-h-full max-w-full object-contain rounded\"\n            />\n          </div>\n        ) : (\n          <div className=\"text-center p-4\">\n            <svg aria-hidden=\"true\" className=\"mx-auto h-8 w-8 text-gray-400 mb-2\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n            </svg>\n            <p className=\"text-sm text-gray-500\">\n              <span className=\"text-primary font-medium\">Click to upload</span> or drag & drop\n            </p>\n            <p className=\"text-xs text-gray-400 mt-1\">PNG, JPG, WebP, SVG</p>\n          </div>\n        )}\n\n        <input\n          id={inputId}\n          type=\"file\"\n          accept=\"image/*\"\n          onChange={handleFileChange}\n          disabled={uploading}\n          className=\"absolute inset-0 w-full h-full opacity-0 cursor-pointer disabled:cursor-not-allowed\"\n          aria-label={`Upload ${label}`}\n          aria-busy={uploading}\n        />\n      </div>\n\n      {/* Progress bar */}\n      {uploading && (\n        <div\n          role=\"progressbar\"\n          aria-valuenow={progress}\n          aria-valuemin={0}\n          aria-valuemax={100}\n          aria-label={`Uploading ${label}: ${progress}%`}\n          className=\"mt-2 h-1.5 bg-gray-200 rounded-full overflow-hidden\"\n        >\n          <div\n            className=\"h-full bg-primary rounded-full transition-all duration-300\"\n            style={{ width: `${progress}%` }}\n          />\n        </div>\n      )}\n\n      {error && (\n        <p role=\"alert\" className=\"mt-2 text-sm text-red-600\">{error}</p>\n      )}\n\n      {preview && !uploading && (\n        <p className=\"mt-1 text-xs text-green-600\">âœ“ Uploaded successfully</p>\n      )}\n    </div>\n  );\n}\n```\n\n---\n",
            "domainNumber": 21
          }
        }
      ]
    },
    {
      "domainNumber": 22,
      "success": true,
      "tasksCreated": 4,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 22,
          "fileName": "DOMAIN-22-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-22\\DOMAIN-22-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "22.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 22 section philosophy.md",
            "topics": ["Domain 22 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 22.1 Philosophy\n\n**What it is:** An AI chat bubble on the client's marketing site that answers visitor questions using the site's content as context (RAG), captures lead info, and optionally routes to the booking calendar. It is the highest-converting feature on any service business site because it handles the micro-moment between \"I have a question\" and \"I'll just call someone else.\" [zignuts](https://www.zignuts.com/question-and-answer/how-can-we-implement-ai-integration-using-vercel-ai-sdk-in-next-js-16-edge-functions)\n\n**Stack:** Vercel AI SDK 4 (`streamText` + `useChat`) + edge runtime for global latency + Supabase vector store for RAG context injection + tenant-specific system prompt built from `site.config`. [ai-sdk](https://ai-sdk.dev/docs/reference/ai-sdk-ui/use-chat)\n\n---\n",
            "domainNumber": 22
          }
        },
        {
          "domainNumber": 22,
          "fileName": "DOMAIN-22-ai-section-ai.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-22\\DOMAIN-22-ai-section-ai.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "22.2-ai-chat-api-route-streaming-edge.md",
            "title": "Section ai",
            "description": "Implementation for domain 22 section ai",
            "topics": ["Domain 22 implementation"],
            "sectionNumber": "ai",
            "content": "### 22.2 AI Chat API Route (Streaming, Edge)\n\n**File:** `apps/*/src/app/api/chat/route.ts`\n\n```typescript\nimport { streamText, tool } from 'ai';\nimport { openai } from '@ai-sdk/openai';\nimport { NextRequest } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\nimport { z } from 'zod';\nimport { db } from '@repo/db';\nimport { checkRateLimit } from '@repo/security/rate-limit';\n\nexport const runtime = 'edge';\nexport const maxDuration = 30;\n\n// Per-tenant chat rate limit: 20 messages per hour per IP\n// (Prevents API cost abuse from single visitor)\nconst MAX_MESSAGES_PER_SESSION = 15;\n\nconst supabaseAdmin = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\n// ============================================================================\n// SYSTEM PROMPT BUILDER\n// Injects tenant context: services, hours, pricing, location\n// ============================================================================\n\nasync function buildSystemPrompt(tenantId: string): Promise<string> {\n  const { data: tenant } = await db.from('tenants').select('config').eq('id', tenantId).single();\n\n  if (!tenant?.config) {\n    return 'You are a helpful assistant for a local service business.';\n  }\n\n  const config = tenant.config as any;\n  const identity = config.identity ?? {};\n  const services = identity.services ?? [];\n  const hours = identity.hours ?? [];\n\n  const serviceList = services.map((s: any) => `- ${s.name}: ${s.description}`).join('\\n');\n\n  const hoursList = hours\n    .map((h: any) => `${h.days?.join(', ')}: ${h.opens}â€“${h.closes}`)\n    .join('\\n');\n\n  return `\nYou are ${identity.siteName ?? 'a local business'}'s AI assistant on their website.\nYour job: answer visitor questions concisely, capture their contact info, and schedule appointments.\n\nBUSINESS INFORMATION:\nName: ${identity.siteName ?? 'Our Business'}\nIndustry: ${identity.industry ?? 'services'}\nPhone: ${identity.contact?.phone ?? 'See website'}\nEmail: ${identity.contact?.email ?? 'See website'}\nLocation: ${identity.address ? `${identity.address.city}, ${identity.address.state}` : 'See website'}\n\nSERVICES OFFERED:\n${serviceList || 'Contact us for a full list of services.'}\n\nHOURS OF OPERATION:\n${hoursList || 'Please call or check our website for current hours.'}\n\nSERVICE AREAS:\n${identity.serviceAreas?.join(', ') ?? 'Contact us for service area coverage.'}\n\nGUIDELINES:\n- Keep responses under 3 sentences when possible â€” visitors skim, not read\n- Always offer to collect their name/phone/email to have someone call them back\n- If they ask about pricing, give a range if known or say \"We'd need to assess your specific situation for an accurate quote\"\n- If they ask to schedule, use the schedule_appointment tool\n- If they share contact info, use the capture_lead tool\n- Never make up prices, hours, or services not listed above\n- Respond in a warm, professional tone â€” this is a service business, not a tech startup\n- If you cannot answer a question confidently, say \"Great question â€” let me have [business owner name] give you a call to walk through that.\"\n`.trim();\n}\n\n// ============================================================================\n// RAG: Retrieve relevant content chunks for the user's question\n// Uses pgvector similarity search on pre-embedded site content\n// ============================================================================\n\nasync function retrieveContext(query: string, tenantId: string): Promise<string> {\n  // Generate embedding for the user's query\n  const embeddingResponse = await fetch('https://api.openai.com/v1/embeddings', {\n    method: 'POST',\n    headers: {\n      Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify({\n      model: 'text-embedding-3-small',\n      input: query,\n    }),\n  });\n\n  const { data: embedData } = await embeddingResponse.json();\n  const embedding = embedData?.[0]?.embedding;\n\n  if (!embedding) return '';\n\n  // Vector similarity search (cosine distance) in pgvector\n  const { data: chunks } = await supabaseAdmin.rpc('match_site_content', {\n    query_embedding: embedding,\n    match_tenant_id: tenantId,\n    match_threshold: 0.78, // 78% similarity minimum\n    match_count: 4, // Top 4 most relevant chunks\n  });\n\n  if (!chunks?.length) return '';\n\n  return chunks.map((c: any) => c.content).join('\\n\\n---\\n\\n');\n}\n\n// ============================================================================\n// ROUTE HANDLER\n// ============================================================================\n\nexport async function POST(req: NextRequest) {\n  // Rate limiting per IP\n  const limited = await checkRateLimit(req, 'api');\n  if (limited) return limited;\n\n  const tenantId = req.headers.get('X-Tenant-Id');\n  if (!tenantId) {\n    return Response.json({ error: 'Missing tenant context' }, { status: 400 });\n  }\n\n  const { messages, sessionId } = await req.json();\n\n  // Enforce session message limit (prevents infinite context window abuse)\n  if (messages.length > MAX_MESSAGES_PER_SESSION) {\n    return Response.json(\n      { error: 'Message limit reached. Please refresh to start a new conversation.' },\n      { status: 429 }\n    );\n  }\n\n  // Build system prompt with tenant context\n  const systemPrompt = await buildSystemPrompt(tenantId);\n\n  // RAG: get relevant context for the last user message\n  const lastUserMessage = messages.filter((m: any) => m.role === 'user').pop();\n  let ragContext = '';\n  if (lastUserMessage?.content) {\n    ragContext = await retrieveContext(lastUserMessage.content, tenantId);\n  }\n\n  const systemWithContext = ragContext\n    ? `${systemPrompt}\\n\\nRELEVANT SITE CONTENT:\\n${ragContext}`\n    : systemPrompt;\n\n  const result = streamText({\n    model: openai('gpt-4o-mini'), // Cost-optimized for chat widget\n    system: systemWithContext,\n    messages,\n    maxTokens: 512, // Keep responses concise\n    temperature: 0.4, // Lower temp = more consistent service info\n    tools: {\n      // â”€â”€ Tool 1: Capture lead â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n      capture_lead: tool({\n        description:\n          'Capture visitor contact information when they share it. Call this whenever a visitor provides their name, email, or phone number.',\n        parameters: z.object({\n          name: z.string().describe(\"Visitor's name\"),\n          email: z.string().email().optional().describe(\"Visitor's email address\"),\n          phone: z.string().optional().describe(\"Visitor's phone number\"),\n          intent: z\n            .string()\n            .describe('What the visitor is looking for (e.g., \"HVAC repair\", \"free estimate\")'),\n          urgency: z.enum(['low', 'medium', 'high']).default('medium'),\n        }),\n        execute: async ({ name, email, phone, intent, urgency }) => {\n          // Score based on available info\n          const score = [\n            email ? 25 : 0,\n            phone ? 30 : 0,\n            urgency === 'high' ? 20 : urgency === 'medium' ? 10 : 0,\n            15, // Base score for engaging with chat\n          ].reduce((a, b) => a + b, 0);\n\n          const { data: lead } = await db\n            .from('leads')\n            .insert({\n              tenant_id: tenantId,\n              name,\n              email: email?.toLowerCase() ?? null,\n              phone: phone ?? null,\n              message: intent,\n              source: 'ai_chat',\n              score: Math.min(score, 100),\n              metadata: { sessionId, urgency, chatCaptured: true },\n            })\n            .select()\n            .single();\n\n          console.log(`[AI Chat] Lead captured: ${name}, tenant=${tenantId}`);\n\n          return {\n            success: true,\n            message: lead\n              ? `Perfect! I've got your info. Someone from the team will reach out to you ${urgency === 'high' ? 'shortly' : 'soon'}.`\n              : 'Thanks! Your information has been noted.',\n          };\n        },\n      }),\n\n      // â”€â”€ Tool 2: Schedule appointment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n      schedule_appointment: tool({\n        description: 'Show the booking calendar when a visitor wants to schedule an appointment.',\n        parameters: z.object({\n          serviceType: z.string().describe('Type of service to book'),\n          preferredTime: z.string().optional().describe('Preferred time if mentioned'),\n        }),\n        execute: async ({ serviceType, preferredTime }) => {\n          // Fetch Cal.com username for this tenant\n          const { getTenantSecret } = await import('@repo/security/secrets-manager');\n          const calUsername = await getTenantSecret(tenantId, 'CAL_USERNAME');\n\n          if (!calUsername) {\n            return {\n              showBooking: false,\n              message:\n                \"I'd love to schedule that for you! Please call us directly at the number on our website, or I can collect your contact info and have someone call you.\",\n            };\n          }\n\n          return {\n            showBooking: true,\n            calLink: `${calUsername}/${serviceType.toLowerCase().replace(/\\s+/g, '-')}`,\n            message: `Here's our scheduling calendar for ${serviceType}. You can pick a time that works for you:`,\n          };\n        },\n      }),\n\n      // â”€â”€ Tool 3: Get service info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n      get_service_info: tool({\n        description:\n          'Retrieve detailed information about a specific service offered by the business.',\n        parameters: z.object({\n          serviceName: z.string().describe('Name of the service to look up'),\n        }),\n        execute: async ({ serviceName }) => {\n          const { data: tenant } = await db\n            .from('tenants')\n            .select('config->identity->services')\n            .eq('id', tenantId)\n            .single();\n\n          const services: any[] = (tenant as any)?.['config->identity->services'] ?? [];\n          const match = services.find((s: any) =>\n            s.name.toLowerCase().includes(serviceName.toLowerCase())\n          );\n\n          if (!match) {\n            return {\n              found: false,\n              message: `I don't have specific details about \"${serviceName}\" on file, but we'd be happy to discuss it. Can I get your contact info?`,\n            };\n          }\n\n          return {\n            found: true,\n            name: match.name,\n            description: match.description,\n            price: match.priceDisplay ?? 'Contact for pricing',\n          };\n        },\n      }),\n    },\n    toolChoice: 'auto',\n    onFinish: async ({ text, usage }) => {\n      // Log token usage per tenant (for cost attribution)\n      console.log(`[AI Chat] Finished: tenant=${tenantId}, tokens=${usage.totalTokens}`);\n    },\n  });\n\n  return result.toDataStreamResponse();\n}\n```\n\n---\n",
            "domainNumber": 22
          }
        },
        {
          "domainNumber": 22,
          "fileName": "DOMAIN-22-chat-section-chat.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-22\\DOMAIN-22-chat-section-chat.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "22.3-chat-widget-client-component.md",
            "title": "Section chat",
            "description": "Implementation for domain 22 section chat",
            "topics": ["Domain 22 implementation"],
            "sectionNumber": "chat",
            "content": "### 22.3 Chat Widget Client Component\n\n**File:** `packages/ui/src/chat/ChatWidget.tsx`\n\n```typescript\n'use client';\n\nimport { useChat } from '@ai-sdk/react';\nimport { useState, useRef, useEffect } from 'react';\nimport type { Message } from 'ai';\n\ninterface ChatWidgetProps {\n  tenantId: string;\n  businessName: string;\n  primaryColor?: string;\n  greeting?: string;\n  position?: 'bottom-right' | 'bottom-left';\n}\n\nexport function ChatWidget({\n  tenantId,\n  businessName,\n  primaryColor = '#2563eb',\n  greeting = \"Hi! I'm here to answer your questions. How can I help?\",\n  position = 'bottom-right',\n}: ChatWidgetProps) {\n  const [isOpen, setIsOpen] = useState(false);\n  const [hasShownGreeting, setHasShownGreeting] = useState(false);\n  const [showBadge, setShowBadge] = useState(false);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const inputRef = useRef<HTMLInputElement>(null);\n\n  const { messages, input, handleInputChange, handleSubmit, isLoading, error } = useChat({\n    api: '/api/chat',\n    headers: { 'X-Tenant-Id': tenantId },\n    initialMessages: [\n      {\n        id: 'greeting',\n        role: 'assistant',\n        content: greeting,\n        createdAt: new Date(),\n      },\n    ],\n    onError: (err) => console.error('[Chat] Error:', err),\n  });\n\n  // Auto-scroll to latest message\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\n  }, [messages]);\n\n  // Show notification badge after 8 seconds (prompt engagement)\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (!isOpen) setShowBadge(true);\n    }, 8000);\n    return () => clearTimeout(timer);\n  }, [isOpen]);\n\n  // Focus input when chat opens\n  useEffect(() => {\n    if (isOpen) {\n      setTimeout(() => inputRef.current?.focus(), 100);\n    }\n  }, [isOpen]);\n\n  const positionClasses = position === 'bottom-right'\n    ? 'bottom-4 right-4 sm:bottom-6 sm:right-6'\n    : 'bottom-4 left-4 sm:bottom-6 sm:left-6';\n\n  return (\n    <div\n      className={`fixed ${positionClasses} z-50 flex flex-col items-end gap-3`}\n      aria-live=\"polite\"\n    >\n      {/* Chat window */}\n      {isOpen && (\n        <div\n          role=\"dialog\"\n          aria-label={`Chat with ${businessName}`}\n          aria-modal=\"false\"\n          className=\"w-[340px] sm:w-[380px] bg-white rounded-2xl shadow-2xl border border-gray-200 flex flex-col overflow-hidden animate-in slide-in-from-bottom-4 duration-300\"\n          style={{ maxHeight: 'min(520px, calc(100vh - 100px))' }}\n        >\n          {/* Header */}\n          <div\n            className=\"flex items-center justify-between px-4 py-3\"\n            style={{ backgroundColor: primaryColor }}\n          >\n            <div className=\"flex items-center gap-2\">\n              {/* Online indicator */}\n              <div className=\"relative\">\n                <div className=\"h-8 w-8 rounded-full bg-white/20 flex items-center justify-center text-white text-sm font-bold\">\n                  {businessName.charAt(0).toUpperCase()}\n                </div>\n                <span className=\"absolute bottom-0 right-0 h-2.5 w-2.5 bg-green-400 rounded-full border-2 border-white\" aria-label=\"Online\" />\n              </div>\n              <div>\n                <p className=\"text-white font-semibold text-sm\">{businessName}</p>\n                <p className=\"text-white/70 text-xs\">Typically replies instantly</p>\n              </div>\n            </div>\n            <button\n              type=\"button\"\n              onClick={() => setIsOpen(false)}\n              className=\"text-white/80 hover:text-white p-1 rounded focus-visible:ring-2 focus-visible:ring-white\"\n              aria-label=\"Close chat\"\n            >\n              <svg className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" aria-hidden=\"true\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n              </svg>\n            </button>\n          </div>\n\n          {/* Messages */}\n          <div\n            className=\"flex-1 overflow-y-auto p-4 space-y-3\"\n            role=\"log\"\n            aria-label=\"Chat messages\"\n            aria-live=\"polite\"\n          >\n            {messages.map((message) => (\n              <ChatMessage\n                key={message.id}\n                message={message}\n                businessName={businessName}\n                primaryColor={primaryColor}\n              />\n            ))}\n\n            {/* Typing indicator */}\n            {isLoading && (\n              <div className=\"flex items-start gap-2\">\n                <div\n                  className=\"h-7 w-7 rounded-full flex items-center justify-center text-xs font-bold text-white flex-shrink-0\"\n                  style={{ backgroundColor: primaryColor }}\n                  aria-hidden=\"true\"\n                >\n                  {businessName.charAt(0).toUpperCase()}\n                </div>\n                <div className=\"bg-gray-100 rounded-2xl rounded-tl-sm px-4 py-3\">\n                  <div className=\"flex gap-1 items-center\" aria-label=\"AI is typing\">\n                    {[0, 1, 2].map((i) => (\n                      <div\n                        key={i}\n                        className=\"h-2 w-2 bg-gray-400 rounded-full animate-bounce\"\n                        style={{ animationDelay: `${i * 150}ms` }}\n                      />\n                    ))}\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {error && (\n              <p role=\"alert\" className=\"text-xs text-red-500 text-center py-2\">\n                Something went wrong. Please try again.\n              </p>\n            )}\n\n            <div ref={messagesEndRef} />\n          </div>\n\n          {/* Input */}\n          <form\n            onSubmit={handleSubmit}\n            className=\"border-t border-gray-200 p-3 flex gap-2\"\n          >\n            <input\n              ref={inputRef}\n              type=\"text\"\n              value={input}\n              onChange={handleInputChange}\n              placeholder=\"Ask a questionâ€¦\"\n              disabled={isLoading}\n              maxLength={500}\n              className=\"flex-1 text-sm border border-gray-200 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary disabled:opacity-50\"\n              aria-label=\"Type your message\"\n              autoComplete=\"off\"\n            />\n            <button\n              type=\"submit\"\n              disabled={isLoading || !input.trim()}\n              className=\"h-9 w-9 rounded-xl flex items-center justify-center disabled:opacity-40 flex-shrink-0 focus-visible:ring-2 focus-visible:ring-offset-2\"\n              style={{ backgroundColor: primaryColor }}\n              aria-label=\"Send message\"\n            >\n              <svg className=\"h-4 w-4 text-white\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" aria-hidden=\"true\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 19l9 2-9-18-9 18 9-2zm0 0v-8\" />\n              </svg>\n            </button>\n          </form>\n\n          <p className=\"text-center text-[10px] text-gray-300 pb-2\">\n            Powered by AI Â· Responses may vary\n          </p>\n        </div>\n      )}\n\n      {/* Toggle button */}\n      <button\n        type=\"button\"\n        onClick={() => {\n          setIsOpen((v) => !v);\n          setShowBadge(false);\n        }}\n        className=\"relative h-14 w-14 rounded-full shadow-lg flex items-center justify-center focus-visible:ring-4 focus-visible:ring-offset-2 transition-transform active:scale-95\"\n        style={{\n          backgroundColor: primaryColor,\n          focusRingColor: primaryColor,\n        }}\n        aria-label={isOpen ? 'Close chat' : `Chat with ${businessName}`}\n        aria-expanded={isOpen}\n        aria-haspopup=\"dialog\"\n      >\n        {isOpen ? (\n          <svg className=\"h-6 w-6 text-white\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" aria-hidden=\"true\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n          </svg>\n        ) : (\n          <svg className=\"h-6 w-6 text-white\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" aria-hidden=\"true\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z\" />\n          </svg>\n        )}\n\n        {/* Unread badge */}\n        {showBadge && !isOpen && (\n          <span\n            className=\"absolute -top-1 -right-1 h-5 w-5 bg-red-500 rounded-full flex items-center justify-center text-white text-xs font-bold animate-pulse\"\n            aria-label=\"1 new message\"\n          >\n            1\n          </span>\n        )}\n      </button>\n    </div>\n  );\n}\n\n// â”€â”€ Message bubble component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nfunction ChatMessage({\n  message,\n  businessName,\n  primaryColor,\n}: {\n  message: Message;\n  businessName: string;\n  primaryColor: string;\n}) {\n  const isAssistant = message.role === 'assistant';\n\n  // Handle tool result rendering (booking calendar, etc.)\n  const hasBookingTool = message.toolInvocations?.some(\n    (t) => t.toolName === 'schedule_appointment' && (t as any).result?.showBooking\n  );\n\n  return (\n    <div className={`flex items-start gap-2 ${isAssistant ? '' : 'flex-row-reverse'}`}>\n      {isAssistant && (\n        <div\n          className=\"h-7 w-7 rounded-full flex items-center justify-center text-xs font-bold text-white flex-shrink-0 mt-0.5\"\n          style={{ backgroundColor: primaryColor }}\n          aria-hidden=\"true\"\n        >\n          {businessName.charAt(0).toUpperCase()}\n        </div>\n      )}\n\n      <div\n        className={`\n          max-w-[80%] rounded-2xl px-4 py-2.5 text-sm leading-relaxed\n          ${isAssistant\n            ? 'bg-gray-100 text-gray-800 rounded-tl-sm'\n            : 'text-white rounded-tr-sm'}\n        `}\n        style={!isAssistant ? { backgroundColor: primaryColor } : {}}\n      >\n        {message.content}\n\n        {/* Inline booking calendar for tool results */}\n        {hasBookingTool && (\n          <div className=\"mt-3 pt-3 border-t border-gray-200\">\n            {message.toolInvocations\n              ?.filter((t) => t.toolName === 'schedule_appointment' && (t as any).result?.showBooking)\n              .map((t) => (\n                <a\n                  key={t.toolCallId}\n                  href={`https://cal.com/${(t as any).result.calLink}`}\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  className=\"block w-full text-center text-sm font-semibold text-white py-2 px-4 rounded-lg\"\n                  style={{ backgroundColor: primaryColor }}\n                >\n                  ðŸ“… Open Scheduling Calendar\n                </a>\n              ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n```\n\n---\n",
            "domainNumber": 22
          }
        },
        {
          "domainNumber": 22,
          "fileName": "DOMAIN-22-rag-section-rag.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-22\\DOMAIN-22-rag-section-rag.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "22.4-rag-site-content-embedding-job.md",
            "title": "Section rag",
            "description": "Implementation for domain 22 section rag",
            "topics": ["Domain 22 implementation"],
            "sectionNumber": "rag",
            "content": "### 22.4 RAG â€” Site Content Embedding Job\n\n**File:** `apps/*/src/app/api/jobs/sitemap/rebuild/route.ts`\n\n```typescript\nimport { createJobHandler } from '@repo/jobs/verify-qstash';\nimport { db } from '@repo/db';\nimport { createClient } from '@supabase/supabase-js';\n\nexport const maxDuration = 60;\n\nconst supabaseAdmin = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\nexport const POST = createJobHandler<'sitemap.rebuild'>(async (payload) => {\n  const { tenantId } = payload;\n\n  // Fetch site config for this tenant\n  const { data: tenant } = await db.from('tenants').select('config').eq('id', tenantId).single();\n\n  if (!tenant?.config) return;\n  const config = tenant.config as any;\n  const identity = config.identity ?? {};\n\n  // Build chunks from site content (business info + services + FAQs)\n  const chunks: Array<{ content: string; chunkType: string }> = [];\n\n  // Business overview\n  chunks.push({\n    content: `${identity.siteName} is a ${identity.industry} business based in ${identity.address?.city}, ${identity.address?.state}. ${identity.description ?? ''}`,\n    chunkType: 'about',\n  });\n\n  // Contact info\n  chunks.push({\n    content: `Contact ${identity.siteName}: Phone: ${identity.contact?.phone ?? 'N/A'}. Email: ${identity.contact?.email ?? 'N/A'}. Address: ${identity.address?.street ?? ''} ${identity.address?.city}, ${identity.address?.state} ${identity.address?.zip ?? ''}.`,\n    chunkType: 'contact',\n  });\n\n  // Hours\n  if (identity.hours?.length) {\n    const hoursText = identity.hours\n      .map((h: any) => `${h.days?.join(', ')}: ${h.opens} to ${h.closes}`)\n      .join('. ');\n    chunks.push({\n      content: `Hours of operation for ${identity.siteName}: ${hoursText}.`,\n      chunkType: 'hours',\n    });\n  }\n\n  // Service areas\n  if (identity.serviceAreas?.length) {\n    chunks.push({\n      content: `${identity.siteName} serves the following areas: ${identity.serviceAreas.join(', ')}.`,\n      chunkType: 'service_areas',\n    });\n  }\n\n  // Individual services\n  for (const service of identity.services ?? []) {\n    chunks.push({\n      content: `Service: ${service.name}. ${service.description}${service.priceDisplay ? ` Pricing: ${service.priceDisplay}.` : ''}`,\n      chunkType: 'service',\n    });\n  }\n\n  // Generate embeddings in batch (max 20 inputs per OpenAI request)\n  const batchSize = 20;\n  for (let i = 0; i < chunks.length; i += batchSize) {\n    const batch = chunks.slice(i, i + batchSize);\n\n    const embeddingResponse = await fetch('https://api.openai.com/v1/embeddings', {\n      method: 'POST',\n      headers: {\n        Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        model: 'text-embedding-3-small',\n        input: batch.map((c) => c.content),\n        dimensions: 1536,\n      }),\n    });\n\n    const { data: embedData } = await embeddingResponse.json();\n\n    // Upsert into pgvector table\n    const upserts = batch.map((chunk, j) => ({\n      tenant_id: tenantId,\n      content: chunk.content,\n      chunk_type: chunk.chunkType,\n      embedding: embedData[j].embedding,\n      updated_at: new Date().toISOString(),\n    }));\n\n    await supabaseAdmin.from('site_content_embeddings').upsert(upserts, {\n      onConflict: 'tenant_id,chunk_type,content',\n      ignoreDuplicates: false,\n    });\n  }\n\n  console.log(`[RAG] Embedded ${chunks.length} content chunks for tenant ${tenantId}`);\n});\n```\n\n**SQL function for vector similarity search:**\n\n```sql\n-- Supabase migration: match_site_content RPC\nCREATE OR REPLACE FUNCTION match_site_content(\n  query_embedding    vector(1536),\n  match_tenant_id    uuid,\n  match_threshold    float DEFAULT 0.78,\n  match_count        int DEFAULT 4\n)\nRETURNS TABLE (\n  id        uuid,\n  content   text,\n  chunk_type text,\n  similarity float\n)\nLANGUAGE plpgsql\nAS $$\nBEGIN\n  RETURN QUERY\n  SELECT\n    e.id,\n    e.content,\n    e.chunk_type,\n    1 - (e.embedding <=> query_embedding) AS similarity\n  FROM site_content_embeddings e\n  WHERE\n    e.tenant_id = match_tenant_id\n    AND 1 - (e.embedding <=> query_embedding) >= match_threshold\n  ORDER BY e.embedding <=> query_embedding  -- Ascending cosine distance\n  LIMIT match_count;\nEND;\n$$;\n\n-- Index for fast ANN search (HNSW â€” better for high-recall search)\nCREATE INDEX ON site_content_embeddings\nUSING hnsw (embedding vector_cosine_ops)\nWITH (m = 16, ef_construction = 64);\n```\n\n---\n\n## Priority Table for Domains 19â€“22\n\n| Task                                               | Domain | Priority | Timeline | Success Metric                                           |\n| -------------------------------------------------- | ------ | -------- | -------- | -------------------------------------------------------- |\n| Cal.com webhook handler (all 6 events)             | 19     | **P0**   | Week 1   | `BOOKING_CREATED` creates lead + booking record          |\n| Cal.com API v2 (not v1 â€” deprecated Feb 2026)      | 19     | **P0**   | Week 1   | All API calls use `api.cal.com/v2`                       |\n| Booking embed popup on marketing site              | 19     | **P0**   | Week 1   | Visitor can schedule from site without redirect          |\n| 24h + 1h reminder emails queued on booking         | 19     | **P0**   | Week 1   | QStash messages visible in Upstash console               |\n| Post-appointment follow-up email (+30 min)         | 19     | **P1**   | Week 2   | Follow-up sends 30 min after booking end time            |\n| Managed user provisioning (new tenant)             | 19     | **P2**   | Week 3   | New tenant gets Cal.com user + event types on complete   |\n| Resend multi-tenant domain routing                 | 20     | **P0**   | Week 1   | Client emails send from `notifications@clientdomain.com` |\n| Agency fallback domain when client unverified      | 20     | **P0**   | Week 1   | Unverified tenants still receive billing/lead emails     |\n| Lead notification email (immediate)                | 20     | **P0**   | Week 1   | Email arrives < 30s after form submit                    |\n| List-Unsubscribe header on all emails              | 20     | **P0**   | Week 1   | One-click unsubscribe compliant with CAN-SPAM            |\n| Resend idempotency keys (prevent duplicates)       | 20     | **P0**   | Week 1   | No duplicate billing receipt on Stripe retry             |\n| React Email 5 templates (lead + billing + booking) | 20     | **P0**   | Week 2   | All 13 email types have branded templates                |\n| Supabase Storage buckets + RLS policies            | 21     | **P0**   | Week 1   | Tenant A cannot access Tenant B's assets                 |\n| Client-side image compression before upload        | 21     | **P0**   | Week 1   | Logo upload â‰¤ 300KB regardless of source file size       |\n| Supabase custom `next/image` loader                | 21     | **P0**   | Week 1   | All site images served as WebP via Supabase CDN          |\n| Signed upload URL (file never passes server)       | 21     | **P1**   | Week 1   | 4MB Next.js API body limit never hit                     |\n| AI chat widget on marketing site                   | 22     | **P1**   | Week 2   | Widget loads < 50ms above the fold (lazy)                |\n| RAG content embedding job on tenant activate       | 22     | **P1**   | Week 2   | Chat answers questions from site content accurately      |\n| Lead capture tool (AI auto-captures contact info)  | 22     | **P1**   | Week 2   | Lead appears in DB within 5s of chat capture             |\n| Booking tool redirect in chat                      | 22     | **P2**   | Week 3   | Chat \"schedule\" intent surfaces Cal.com calendar         |\n\n| Per-tenant chat rate limiting (20 msg/hr) | 22 | **P2** | Week 3 | Prevent abuse and ensure fair usage |\n",
            "domainNumber": 22
          }
        }
      ]
    },
    {
      "domainNumber": 23,
      "success": true,
      "tasksCreated": 6,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 23,
          "fileName": "DOMAIN-23-philosophy.md-231-philosophy.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-23\\DOMAIN-23-philosophy.md-231-philosophy.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "23.1-philosophy.md",
            "title": "23.1 Philosophy",
            "description": "**What it is:** For a local service business, SEO is the revenue engine â€” not a nice-to-have. The platform must generate correct `generateMetadata()`, `sitemap.ts`, `robots.ts`, JSON-LD structured data, and OpenGraph images automatically from the tenant's `site.config`, requiring zero manual SEO work from the client. [jsdevspace.substack](https://jsdevspace.substack.com/p/how-to-configure-seo-in-nextjs-16)",
            "topics": ["Domain 23 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "# 23.1 Philosophy\n\n**What it is:** For a local service business, SEO is the revenue engine â€” not a nice-to-have. The platform must generate correct `generateMetadata()`, `sitemap.ts`, `robots.ts`, JSON-LD structured data, and OpenGraph images automatically from the tenant's `site.config`, requiring zero manual SEO work from the client. [jsdevspace.substack](https://jsdevspace.substack.com/p/how-to-configure-seo-in-nextjs-16)\n\n**Why automatic matters:** A plumber doesn't know what `LocalBusiness` schema is. The platform reads their config and emits perfect structured data on every page. Google parses the `LocalBusiness` schema to populate the Knowledge Panel, `HoursSpecification` to show business hours in Maps, and `Service` markup to power rich results. Missing any of these costs clients meaningful organic traffic. [dev](https://dev.to/ared/how-to-add-json-ld-structured-data-in-nextjs-for-seo-52i0)\n\n**The three layers:**\n\n| Layer              | File                              | What It Controls                                         |\n| ------------------ | --------------------------------- | -------------------------------------------------------- |\n| Technical metadata | `layout.tsx` `generateMetadata()` | Title, description, canonical, robots, OG, Twitter cards |\n| Crawl directives   | `robots.ts`                       | Which pages Googlebot indexes; block portal routes       |\n| Site structure     | `sitemap.ts`                      | All indexable URLs with `lastModified` and `priority`    |\n",
            "domainNumber": 23
          }
        },
        {
          "domainNumber": 23,
          "fileName": "DOMAIN-23-tenant-232-tenant-metadata-factory.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-23\\DOMAIN-23-tenant-232-tenant-metadata-factory.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "23.2-tenant-metadata-factory.md",
            "title": "23.2 Tenant Metadata Factory",
            "description": "**File:** `packages/seo/src/metadata-factory.ts`",
            "topics": ["Domain 23 implementation"],
            "sectionNumber": "tenant",
            "content": "# 23.2 Tenant Metadata Factory\n\n**File:** `packages/seo/src/metadata-factory.ts`\n\n```typescript\nimport type { Metadata } from 'next';\nimport type { SiteConfig } from '@repo/config/types';\n\n// ============================================================================\n// METADATA FACTORY\n// Generates full Next.js Metadata object from SiteConfig.\n// Called from every page's generateMetadata() â€” never inline in page files.\n// ============================================================================\n\ninterface MetadataOptions {\n  config: SiteConfig;\n  path: string; // Current pathname, e.g. '/services/hvac-repair'\n  pageTitle?: string; // Override: page-specific title prefix\n  pageDescription?: string; // Override: page-specific description\n  ogImage?: string; // Override: page-specific OG image URL\n  noIndex?: boolean; // Force noindex (e.g. thank-you pages, portal pages)\n  canonical?: string; // Explicit canonical (omit for auto-generation)\n}\n\nexport function buildMetadata(options: MetadataOptions): Metadata {\n  const { config, path, pageTitle, pageDescription, ogImage, noIndex = false, canonical } = options;\n\n  const identity = config.identity;\n  const siteUrl = config.siteUrl ?? `https://${config.domain}`;\n\n  // Title template: \"Service Name | Business Name â€” City, ST\"\n  const businessSuffix = identity.address?.city\n    ? `${identity.siteName} â€” ${identity.address.city}, ${identity.address.state}`\n    : identity.siteName;\n\n  const title = pageTitle\n    ? { default: `${pageTitle} | ${businessSuffix}`, template: `%s | ${businessSuffix}` }\n    : { default: businessSuffix, template: `%s | ${businessSuffix}` };\n\n  const description =\n    pageDescription ??\n    identity.tagline ??\n    `${identity.siteName} serving ${identity.address?.city ?? 'your area'}. ${identity.industry ?? 'Professional'} services. Call ${identity.contact?.phone ?? 'us today'}.`;\n\n  const resolvedCanonical = canonical ?? `${siteUrl}${path}`;\n  const resolvedOgImage = ogImage ?? `${siteUrl}/og${path}`;\n\n  return {\n    metadataBase: new URL(siteUrl),\n\n    title,\n    description,\n\n    // Canonical URL â€” critical for multi-tenant (same content, different domains)\n    alternates: {\n      canonical: resolvedCanonical,\n    },\n\n    // Robots\n    robots: noIndex\n      ? { index: false, follow: false }\n      : {\n          index: true,\n          follow: true,\n          googleBot: {\n            index: true,\n            follow: true,\n            'max-video-preview': -1,\n            'max-image-preview': 'large',\n            'max-snippet': -1,\n          },\n        },\n\n    // OpenGraph\n    openGraph: {\n      type: 'website',\n      locale: 'en_US',\n      url: resolvedCanonical,\n      siteName: identity.siteName,\n      title: pageTitle ?? identity.siteName,\n      description,\n      images: [\n        {\n          url: resolvedOgImage,\n          width: 1200,\n          height: 630,\n          alt: `${identity.siteName} â€” ${identity.tagline ?? identity.industry ?? 'Professional Services'}`,\n        },\n      ],\n    },\n\n    // Twitter Card\n    twitter: {\n      card: 'summary_large_image',\n      title: pageTitle ?? identity.siteName,\n      description,\n      images: [resolvedOgImage],\n      creator: identity.socialHandles?.twitter ?? undefined,\n      site: identity.socialHandles?.twitter ?? undefined,\n    },\n\n    // App links / theme\n    other: {\n      'theme-color': config.theme?.colors?.primary ?? '#2563eb',\n    },\n\n    // Verification tags (Google Search Console, Bing)\n    verification: {\n      google: identity.googleSiteVerification ?? undefined,\n      other: identity.bingSiteVerification\n        ? { 'msvalidate.01': [identity.bingSiteVerification] }\n        : undefined,\n    },\n  };\n}\n\n// â”€â”€ Service page metadata â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport function buildServiceMetadata(\n  config: SiteConfig,\n  service: { name: string; description: string; slug: string }\n): Metadata {\n  const city = config.identity.address?.city ?? '';\n  const state = config.identity.address?.state ?? '';\n\n  return buildMetadata({\n    config,\n    path: `/services/${service.slug}`,\n    pageTitle: `${service.name}${city ? ` in ${city}, ${state}` : ''}`,\n    pageDescription: `${service.description} Serving ${city}${config.identity.serviceAreas?.length ? ` and ${config.identity.serviceAreas.slice(0, 3).join(', ')}` : ''}. Call ${config.identity.contact?.phone ?? 'us'} for a free quote.`,\n  });\n}\n\n// â”€â”€ Homepage metadata â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport function buildHomepageMetadata(config: SiteConfig): Metadata {\n  const city = config.identity.address?.city ?? '';\n  const state = config.identity.address?.state ?? '';\n  const industry = config.identity.industry ?? 'services';\n\n  return buildMetadata({\n    config,\n    path: '/',\n    pageTitle: city\n      ? `${config.identity.siteName} â€” ${industry.charAt(0).toUpperCase() + industry.slice(1)} in ${city}, ${state}`\n      : config.identity.siteName,\n    pageDescription:\n      config.identity.tagline ??\n      `${config.identity.siteName} provides professional ${industry} services in ${city}, ${state}. Licensed, insured, and locally trusted. Free estimates available.`,\n  });\n}\n```\n",
            "domainNumber": 23
          }
        },
        {
          "domainNumber": 23,
          "fileName": "DOMAIN-23-json-233-jsonld-structured-data-system.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-23\\DOMAIN-23-json-233-jsonld-structured-data-system.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "23.3-json-ld-structured-data-system.md",
            "title": "23.3 JSON-LD Structured Data System",
            "description": "**File:** `packages/seo/src/structured-data.ts`",
            "topics": ["Domain 23 implementation"],
            "sectionNumber": "json",
            "content": "# 23.3 JSON-LD Structured Data System\n\n**File:** `packages/seo/src/structured-data.ts`\n\n```typescript\nimport type { SiteConfig } from '@repo/config/types';\n\n// ============================================================================\n// JSON-LD STRUCTURED DATA\n// Generates Schema.org markup from SiteConfig.\n// Injected via <script type=\"application/ld+json\"> in layout.tsx.\n// All schemas validated against: https://validator.schema.org\n// ============================================================================\n\n// â”€â”€ LocalBusiness (root schema for all service businesses) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport function buildLocalBusinessSchema(config: SiteConfig): Record<string, unknown> {\n  const identity = config.identity;\n  const siteUrl = config.siteUrl ?? `https://${config.domain}`;\n\n  // Map industry to Schema.org type\n  const schemaTypeMap: Record<string, string> = {\n    hvac: 'HVACBusiness',\n    plumbing: 'Plumber',\n    electrical: 'Electrician',\n    dental: 'Dentist',\n    medical: 'MedicalBusiness',\n    law: 'LegalService',\n    realEstate: 'RealEstateAgent',\n    accounting: 'AccountingService',\n    restaurant: 'Restaurant',\n    salon: 'HairSalon',\n    general: 'LocalBusiness',\n  };\n\n  const schemaType = schemaTypeMap[identity.industry ?? 'general'] ?? 'LocalBusiness';\n\n  const schema: Record<string, unknown> = {\n    '@context': 'https://schema.org',\n    '@type': [schemaType, 'LocalBusiness'],  // Dual type for broader coverage\n    '@id': `${siteUrl}/#organization`,\n\n    name: identity.siteName,\n    description: identity.description ?? identity.tagline,\n    url: siteUrl,\n\n    // Contact\n    ...(identity.contact?.phone ? {\n      telephone: identity.contact.phone,\n    } : {}),\n\n    ...(identity.contact?.email ? {\n      email: identity.contact.email,\n    } : {}),\n\n    // Address\n    ...(identity.address ? {\n      address: {\n        '@type': 'PostalAddress',\n        streetAddress: identity.address.street ?? undefined,\n        addressLocality: identity.address.city,\n        addressRegion: identity.address.state,\n        postalCode: identity.address.zip ?? undefined,\n        addressCountry: 'US',\n      },\n    } : {}),\n\n    // Geo coordinates (if provided)\n    ...(identity.coordinates ? {\n      geo: {\n        '@type': 'GeoCoordinates',\n        latitude: identity.coordinates.lat,\n        longitude: identity.coordinates.lng,\n      },\n    } : {}),\n\n    // Opening hours\n    ...(identity.hours?.length ? {\n      openingHoursSpecification: identity.hours.flatMap((h) =>\n        (h.days ?? []).map((day: string) => ({\n          '@type': 'OpeningHoursSpecification',\n          dayOfWeek: `https://schema.org/${day}`,\n          opens: h.opens,\n          closes: h.closes,\n        }))\n      ),\n    } : {}),\n\n    // Service areas\n    ...(identity.serviceAreas?.length ? {\n      areaServed: identity.serviceAreas.map((area: string) => ({\n        '@type': 'City',\n        name: area,\n      })),\n    } : {}),\n\n    // Logo\n    ...(config.assets?.logo ? {\n      logo: {\n        '@type': 'ImageObject',\n        url: config.assets.logo,\n        width: 400,\n        height: 400,\n      },\n      image: config.assets.logo,\n    } : {}),\n\n    // Social profiles (sameAs)\n    ...(identity.socialHandles ? {\n      sameAs: [\n        identity.socialHandles.facebook ? `https://www.facebook.com/${identity.socialHandles.facebook}` : null,\n        identity.socialHandles.instagram ? `https://www.instagram.com/${identity.socialHandles.instagram}` : null,\n        identity.socialHandles.twitter ? `https://twitter.com/${identity.socialHandles.twitter}` : null,\n        identity.socialHandles.linkedin ? `https://www.linkedin.com/company/${identity.socialHandles.linkedin}` : null,\n        identity.googleBusinessUrl ?? null,\n        identity.yelpUrl ?? null,\n      ].filter(Boolean),\n    } : {}),\n\n    // Payment methods\n    paymentAccepted: 'Cash, Credit Card, Check',\n    currenciesAccepted: 'USD',\n    priceRange: identity.priceRange ?? '$$',\n  };\n\n  return schema;\n}\n\n// â”€â”€ Service schema (one per service page) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport function buildServiceSchema(\n  config: SiteConfig,\n  service: { name: string; description: string; slug: string; priceDisplay?: string }\n): Record<string, unknown> {\n  const siteUrl = config.siteUrl ?? `https://${config.domain}`;\n\n  return {\n    '@context': 'https://schema.org',\n    '@type': 'Service',\n    '@id': `${siteUrl}/services/${service.slug}#service`,\n    name: service.name,\n    description: service.description,\n    provider: {\n      '@type': 'LocalBusiness',\n      '@id': `${siteUrl}/#organization`,\n      name: config.identity.siteName,\n    },\n    areaServed: config.identity.serviceAreas?.map((area: string) => ({\n      '@type': 'City',\n      name: area,\n    })) ?? [],\n    ...(service.priceDisplay ? {\n      offers: {\n        '@type': 'Offer',\n        price: service.priceDisplay,\n        priceCurrency: 'USD',\n      },\n    } : {}),\n  };\n}\n\n// â”€â”€ BreadcrumbList (navigation trail for rich results) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport function buildBreadcrumbSchema(\n  siteUrl: string,\n  siteName: string,\n  crumbs: Array<{ name: string; url: string }>\n): Record<string, unknown> {\n  return {\n    '@context': 'https://schema.org',\n    '@type': 'BreadcrumbList',\n    itemListElement: [\n      {\n        '@type': 'ListItem',\n        position: 1,\n        name: 'Home',\n        item: siteUrl,\n      },\n      ...crumbs.map((crumb, index) => ({\n        '@type': 'ListItem',\n        position: index + 2,\n        name: crumb.name,\n        item: crumb.url,\n      })),\n    ],\n  };\n}\n\n// â”€â”€ FAQPage (drives People Also Ask rich results) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport function buildFAQSchema(\n  faqs: Array<{ question: string; answer: string }>\n): Record<string, unknown> {\n  return {\n    '@context': 'https://schema.org',\n    '@type': 'FAQPage',\n    mainEntity: faqs.map((faq) => ({\n      '@type': 'Question',\n      name: faq.question,\n      acceptedAnswer: {\n        '@type': 'Answer',\n        text: faq.answer,\n      },\n    })),\n  };\n}\n\n// â”€â”€ WebSite schema (enables Google Sitelinks Searchbox) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport function buildWebsiteSchema(config: SiteConfig): Record<string, unknown> {\n  const siteUrl = config.siteUrl ?? `https://${config.domain}`;\n  return {\n    '@context': 'https://schema.org',\n    '@type': 'WebSite',\n    '@id': `${siteUrl}/#website`,\n    url: siteUrl,\n    name: config.identity.siteName,\n    description: config.identity.tagline,\n    publisher: {\n      '@id': `${siteUrl}/#organization`,\n    },\n    potentialAction: {\n      '@type': 'SearchAction',\n      target: {\n        '@type': 'EntryPoint',\n        urlTemplate: `${siteUrl}/?q={search_term_string}`,\n      },\n      'query-input': 'required name=search_term_string',\n    },\n  };\n}\n\n// â”€â”€ JSON-LD script component (Server Component) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport function JsonLd({ schema }: { schema: Record<string, unknown> }) {\n  return (\n    <script\n      type=\"application/ld+json\"\n      // nonce is injected via server component from request headers\n      dangerouslySetInnerHTML={{ __html: JSON.stringify(schema) }}\n    />\n  );\n}\n\n// â”€â”€ Root layout: inject all global schemas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport function RootJsonLd({ config }: { config: SiteConfig }) {\n  const schemas = [\n    buildLocalBusinessSchema(config),\n    buildWebsiteSchema(config),\n  ];\n\n  return (\n    <>\n      {schemas.map((schema, i) => (\n        <JsonLd key={i} schema={schema} />\n      ))}\n    </>\n  );\n}\n```\n",
            "domainNumber": 23
          }
        },
        {
          "domainNumber": 23,
          "fileName": "DOMAIN-23-dynamic-234-dynamic-sitemap.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-23\\DOMAIN-23-dynamic-234-dynamic-sitemap.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "23.4-dynamic-sitemap.md",
            "title": "23.4 Dynamic Sitemap",
            "description": "**File:** `apps/*/src/app/sitemap.ts`",
            "topics": ["Domain 23 implementation"],
            "sectionNumber": "dynamic",
            "content": "# 23.4 Dynamic Sitemap\n\n**File:** `apps/*/src/app/sitemap.ts`\n\n```typescript\nimport type { MetadataRoute } from 'next';\nimport { headers } from 'next/headers';\nimport { resolveTenant } from '@repo/multi-tenant/resolve-tenant';\nimport { db } from '@repo/db';\nimport { cacheTag, cacheLife } from 'next/cache';\n\n// ============================================================================\n// MULTI-TENANT DYNAMIC SITEMAP\n// Reads hostname from request headers to determine tenant.\n// Returns ONLY this tenant's URLs â€” not all tenants' pages.\n// Reference: https://www.buildwithmatija.com/blog/dynamic-sitemap-robots-nextjs-payload-multi-tenant\n// ============================================================================\n\nexport const dynamic = 'force-dynamic'; // Tenant-dependent â€” cannot be static\n\nexport default async function sitemap(): Promise<MetadataRoute.Sitemap> {\n  'use cache';\n  // Cache per tenant, revalidate every 24h or on sitemap:rebuild job\n  const headersList = await headers();\n  const host = headersList.get('host') ?? '';\n\n  const tenantContext = await resolveTenant({ headers: headersList } as any);\n  if (!tenantContext) return [];\n\n  const { tenantId } = tenantContext;\n\n  cacheTag(`tenant:${tenantId}:sitemap`);\n  cacheLife({ revalidate: 86400 }); // 24h\n\n  // Fetch site config\n  const { data: tenant } = await db\n    .from('tenants')\n    .select('config, custom_domain, subdomain')\n    .eq('id', tenantId)\n    .single();\n\n  if (!tenant) return [];\n\n  const config = tenant.config as any;\n  const domain =\n    tenant.custom_domain ?? `${tenant.subdomain}.${process.env.NEXT_PUBLIC_ROOT_DOMAIN}`;\n  const siteUrl = `https://${domain}`;\n  const services = config?.identity?.services ?? [];\n\n  const now = new Date();\n\n  const urls: MetadataRoute.Sitemap = [\n    // Homepage â€” highest priority, monthly change\n    {\n      url: `${siteUrl}/`,\n      lastModified: now,\n      changeFrequency: 'weekly',\n      priority: 1.0,\n    },\n\n    // About page\n    {\n      url: `${siteUrl}/about`,\n      lastModified: now,\n      changeFrequency: 'monthly',\n      priority: 0.7,\n    },\n\n    // Services index\n    {\n      url: `${siteUrl}/services`,\n      lastModified: now,\n      changeFrequency: 'weekly',\n      priority: 0.9,\n    },\n\n    // Individual service pages (most important for local SEO)\n    ...services.map((service: any) => ({\n      url: `${siteUrl}/services/${service.slug}`,\n      lastModified: now,\n      changeFrequency: 'monthly' as const,\n      priority: 0.85,\n    })),\n\n    // Contact page\n    {\n      url: `${siteUrl}/contact`,\n      lastModified: now,\n      changeFrequency: 'monthly',\n      priority: 0.8,\n    },\n\n    // Area pages (SEO: \"HVAC repair in [city]\")\n    ...(config?.identity?.serviceAreas ?? []).map((area: string) => ({\n      url: `${siteUrl}/service-area/${area.toLowerCase().replace(/\\s+/g, '-')}`,\n      lastModified: now,\n      changeFrequency: 'monthly' as const,\n      priority: 0.75,\n    })),\n  ];\n\n  return urls;\n}\n```\n",
            "domainNumber": 23
          }
        },
        {
          "domainNumber": 23,
          "fileName": "DOMAIN-23-per-235-pertenant-robotstxt.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-23\\DOMAIN-23-per-235-pertenant-robotstxt.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "23.5-per-tenant-robots.txt.md",
            "title": "23.5 Per-Tenant Robots.txt",
            "description": "**File:** `apps/*/src/app/robots.ts`",
            "topics": ["Domain 23 implementation"],
            "sectionNumber": "per",
            "content": "# 23.5 Per-Tenant Robots.txt\n\n**File:** `apps/*/src/app/robots.ts`\n\n```typescript\nimport type { MetadataRoute } from 'next';\nimport { headers } from 'next/headers';\nimport { resolveTenant } from '@repo/multi-tenant/resolve-tenant';\n\nexport const dynamic = 'force-dynamic';\n\nexport default async function robots(): Promise<MetadataRoute.Robots> {\n  const headersList = await headers();\n  const tenantContext = await resolveTenant({ headers: headersList } as any);\n\n  if (!tenantContext) {\n    // Unknown domain â€” block indexing\n    return {\n      rules: { userAgent: '*', disallow: '/' },\n    };\n  }\n\n  const { tenantId, status } = tenantContext;\n\n  // Suspended/cancelled tenants: block all indexing\n  if (status === 'suspended' || status === 'cancelled') {\n    return {\n      rules: { userAgent: '*', disallow: '/' },\n    };\n  }\n\n  const domain = headersList.get('host') ?? '';\n  const siteUrl = `https://${domain}`;\n\n  return {\n    rules: [\n      {\n        userAgent: '*',\n        allow: '/',\n        disallow: [\n          '/api/', // Never index API routes\n          '/thank-you', // Conversion pages â€” no SEO value\n          '/booking/confirm', // Post-booking pages\n          '/*?*', // Block query string URLs (UTM params etc)\n        ],\n      },\n      {\n        // Block AI crawlers from scraping client content\n        userAgent: ['GPTBot', 'ClaudeBot', 'PerplexityBot', 'Applebot-Extended'],\n        disallow: '/', // Clients can opt-in via dashboard setting\n      },\n    ],\n    sitemap: `${siteUrl}/sitemap.xml`,\n    host: siteUrl,\n  };\n}\n```\n",
            "domainNumber": 23
          }
        },
        {
          "domainNumber": 23,
          "fileName": "DOMAIN-23-dynamic-236-dynamic-og-image-route.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-23\\DOMAIN-23-dynamic-236-dynamic-og-image-route.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "23.6-dynamic-og-image-route.md",
            "title": "23.6 Dynamic OG Image Route",
            "description": "**File:** `apps/*/src/app/og/[[...path]]/route.tsx`",
            "topics": ["Domain 23 implementation"],
            "sectionNumber": "dynamic",
            "content": "# 23.6 Dynamic OG Image Route\n\n**File:** `apps/*/src/app/og/[[...path]]/route.tsx`\n\n```typescript\nimport { ImageResponse } from 'next/og';\nimport { NextRequest } from 'next/server';\nimport { resolveTenant } from '@repo/multi-tenant/resolve-tenant';\nimport { db } from '@repo/db';\n\nexport const runtime = 'edge';\n\n// ============================================================================\n// DYNAMIC OG IMAGE GENERATOR (Edge Runtime)\n// URL: /og               â†’ Business homepage card\n// URL: /og/services/slug â†’ Service-specific card\n// Reference: https://makerkit.dev/blog/tutorials/dynamic-og-image\n// ============================================================================\n\nexport async function GET(req: NextRequest) {\n  const url = new URL(req.url);\n  const pathSegments = url.pathname.replace('/og', '').split('/').filter(Boolean);\n  const pageType = pathSegments[0] ?? 'home';        // 'services', 'about', etc.\n  const pageSlug = pathSegments[1] ?? null;            // Service slug\n\n  // Resolve tenant from hostname\n  const tenant = await resolveTenant(req);\n  if (!tenant) {\n    return new Response('Not found', { status: 404 });\n  }\n\n  // Fetch tenant config\n  const { data } = await db\n    .from('tenants')\n    .select('config')\n    .eq('id', tenant.tenantId)\n    .single();\n\n  const config = data?.config as any;\n  if (!config) return new Response('Not found', { status: 404 });\n\n  const identity = config.identity ?? {};\n  const primaryColor = config.theme?.colors?.primary ?? '#2563eb';\n\n  // Determine card content based on page type\n  let title = identity.siteName ?? 'Professional Services';\n  let subtitle = identity.tagline ?? identity.description ?? '';\n  let badge = identity.industry ?? 'Local Business';\n\n  if (pageType === 'services' && pageSlug) {\n    const service = (identity.services ?? []).find(\n      (s: any) => s.slug === pageSlug\n    );\n    if (service) {\n      title = service.name;\n      subtitle = service.description;\n      badge = identity.siteName;\n    }\n  } else if (pageType === 'about') {\n    title = `About ${identity.siteName}`;\n    subtitle = identity.description ?? identity.tagline ?? '';\n    badge = 'Our Story';\n  } else if (pageType === 'contact') {\n    title = `Contact ${identity.siteName}`;\n    subtitle = identity.contact?.phone ?? identity.contact?.email ?? '';\n    badge = identity.address?.city ? `${identity.address.city}, ${identity.address.state}` : 'Get in Touch';\n  }\n\n  // Truncate long strings\n  const truncate = (str: string, max: number) =>\n    str.length > max ? str.slice(0, max - 3) + '...' : str;\n\n  return new ImageResponse(\n    (\n      <div\n        style={{\n          width: '100%',\n          height: '100%',\n          display: 'flex',\n          flexDirection: 'column',\n          justifyContent: 'space-between',\n          backgroundColor: '#ffffff',\n          fontFamily: 'Inter, system-ui, sans-serif',\n          padding: '56px 60px',\n          borderTop: `8px solid ${primaryColor}`,\n        }}\n      >\n        {/* Badge */}\n        <div\n          style={{\n            display: 'inline-flex',\n            alignItems: 'center',\n            backgroundColor: `${primaryColor}15`,\n            color: primaryColor,\n            fontSize: '18px',\n            fontWeight: 600,\n            padding: '8px 18px',\n            borderRadius: '999px',\n            alignSelf: 'flex-start',\n            textTransform: 'uppercase',\n            letterSpacing: '0.05em',\n          }}\n        >\n          {truncate(badge, 40)}\n        </div>\n\n        {/* Main content */}\n        <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>\n          <div\n            style={{\n              fontSize: title.length > 40 ? '44px' : '56px',\n              fontWeight: 800,\n              color: '#111827',\n              lineHeight: 1.1,\n            }}\n          >\n            {truncate(title, 60)}\n          </div>\n\n          {subtitle && (\n            <div\n              style={{\n                fontSize: '24px',\n                color: '#6b7280',\n                lineHeight: 1.4,\n              }}\n            >\n              {truncate(subtitle, 120)}\n            </div>\n          )}\n        </div>\n\n        {/* Footer */}\n        <div\n          style={{\n            display: 'flex',\n            alignItems: 'center',\n            justifyContent: 'space-between',\n          }}\n        >\n          <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>\n            {/* Logo placeholder (colored circle with initial) */}\n            <div\n              style={{\n                width: 48,\n                height: 48,\n                borderRadius: '50%',\n                backgroundColor: primaryColor,\n                display: 'flex',\n                alignItems: 'center',\n                justifyContent: 'center',\n                color: '#ffffff',\n                fontSize: '22px',\n                fontWeight: 700,\n              }}\n            >\n              {identity.siteName?.charAt(0)?.toUpperCase() ?? 'B'}\n            </div>\n            <span style={{ fontSize: '22px', fontWeight: 600, color: '#374151' }}>\n              {identity.siteName}\n            </span>\n          </div>\n\n          {identity.contact?.phone && (\n            <div style={{ fontSize: '20px', color: primaryColor, fontWeight: 600 }}>\n              {identity.contact.phone}\n            </div>\n          )}\n        </div>\n      </div>\n    ),\n    {\n      width: 1200,\n      height: 630,\n    }\n  );\n}\n```\n",
            "domainNumber": 23
          }
        }
      ]
    },
    {
      "domainNumber": 24,
      "success": true,
      "tasksCreated": 4,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 24,
          "fileName": "DOMAIN-24-philosophy.md-241-philosophy.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-24\\DOMAIN-24-philosophy.md-241-philosophy.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "24.1-philosophy.md",
            "title": "24.1 Philosophy",
            "description": "**What it is:** When a new lead submits the contact form, the client's portal dashboard updates in real-time â€” new lead card appears at the top of the feed, score badge glows, notification plays. This is built on Supabase Realtime Postgres Changes. [supabase](https://supabase.com/features/realtime-postgres-changes)",
            "topics": ["Domain 24 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "# 24.1 Philosophy\n\n**What it is:** When a new lead submits the contact form, the client's portal dashboard updates in real-time â€” new lead card appears at the top of the feed, score badge glows, notification plays. This is built on Supabase Realtime Postgres Changes. [supabase](https://supabase.com/features/realtime-postgres-changes)\n\n**Security model â€” RLS on Realtime:** Supabase applies Row Level Security policies to Realtime change streams. The client must be authenticated with a token that has `tenant_id` in its JWT claims for the RLS policy to allow them to receive only their own leads. Without this, Tenant A could subscribe and receive Tenant B's leads. [supabase](https://supabase.com/blog/realtime-row-level-security-in-postgresql)\n\n**Supabase Realtime filter syntax:** The filter is a server-side predicate applied before broadcast â€” `tenant_id=eq.{uuid}`. This means only matching rows are sent over the WebSocket â€” not all rows filtered on the client. This is both more secure and dramatically more bandwidth-efficient. [github](https://github.com/orgs/supabase/discussions/27185)\n",
            "domainNumber": 24
          }
        },
        {
          "domainNumber": 24,
          "fileName": "DOMAIN-24-realtime-242-realtime-supabase-setup.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-24\\DOMAIN-24-realtime-242-realtime-supabase-setup.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "24.2-realtime-supabase-setup.md",
            "title": "24.2 Realtime Supabase Setup",
            "description": "**Enabling Realtime on the `leads` table (migration):**",
            "topics": ["Domain 24 implementation"],
            "sectionNumber": "realtime",
            "content": "# 24.2 Realtime Supabase Setup\n\n**Enabling Realtime on the `leads` table (migration):**\n\n```sql\n-- Supabase migration: enable realtime on leads table\n-- Must enable via replication, NOT just the Realtime toggle in dashboard\n\n-- Step 1: Add table to Supabase Realtime publication\nALTER PUBLICATION supabase_realtime ADD TABLE leads;\n\n-- Step 2: RLS policy for Realtime (same policies as REST â€” automatically respected)\n-- This policy ensures the JWT's tenantId claim matches the tenant_id column\n-- (Policy defined in Domain 4 â€” this is a reminder it covers Realtime too)\n\n-- Step 3: Enable realtime for bookings too\nALTER PUBLICATION supabase_realtime ADD TABLE bookings;\n```\n",
            "domainNumber": 24
          }
        },
        {
          "domainNumber": 24,
          "fileName": "DOMAIN-24-realtime-243-realtime-hook.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-24\\DOMAIN-24-realtime-243-realtime-hook.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "24.3-realtime-hook.md",
            "title": "24.3 Realtime Hook",
            "description": "**File:** `packages/realtime/src/use-realtime-leads.ts`",
            "topics": ["Domain 24 implementation"],
            "sectionNumber": "realtime",
            "content": "# 24.3 Realtime Hook\n\n**File:** `packages/realtime/src/use-realtime-leads.ts`\n\n```typescript\n'use client';\n\nimport { useEffect, useRef, useCallback } from 'react';\nimport { createClient } from '@supabase/supabase-js';\nimport type { RealtimeChannel } from '@supabase/supabase-js';\n\n// ============================================================================\n// REALTIME LEADS HOOK\n// Subscribes to INSERT events on the `leads` table filtered by tenant_id.\n// Automatically reconnects on visibility change (handles tab sleep).\n// ============================================================================\n\nexport interface RealtimeLead {\n  id: string;\n  tenant_id: string;\n  name: string;\n  email: string;\n  phone: string | null;\n  message: string;\n  score: number;\n  source: string;\n  status: string;\n  created_at: string;\n  metadata: Record<string, unknown>;\n}\n\ninterface UseRealtimeLeadsOptions {\n  tenantId: string;\n  onNewLead: (lead: RealtimeLead) => void;\n  onLeadUpdated?: (lead: RealtimeLead) => void;\n  enabled?: boolean; // Feature flag: only enabled on Professional+ plans\n}\n\n// Singleton Supabase client for realtime (separate from data client)\n// Using anon key + user's session for RLS enforcement\nconst getRealtimeClient = () =>\n  createClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!);\n\nexport function useRealtimeLeads({\n  tenantId,\n  onNewLead,\n  onLeadUpdated,\n  enabled = true,\n}: UseRealtimeLeadsOptions) {\n  const channelRef = useRef<RealtimeChannel | null>(null);\n  const supabaseRef = useRef(getRealtimeClient());\n  const onNewLeadRef = useRef(onNewLead);\n  const onLeadUpdatedRef = useRef(onLeadUpdated);\n\n  // Keep callbacks current without re-subscribing\n  useEffect(() => {\n    onNewLeadRef.current = onNewLead;\n  }, [onNewLead]);\n  useEffect(() => {\n    onLeadUpdatedRef.current = onLeadUpdated;\n  }, [onLeadUpdated]);\n\n  const subscribe = useCallback(() => {\n    if (!enabled || !tenantId) return;\n\n    // Clean up existing channel before creating new one\n    if (channelRef.current) {\n      supabaseRef.current.removeChannel(channelRef.current);\n    }\n\n    // Channel name must be unique per tab (prevent duplicate subscriptions)\n    const channelName = `leads-feed-${tenantId}-${Math.random().toString(36).slice(2)}`;\n\n    const channel = supabaseRef.current\n      .channel(channelName)\n      .on(\n        'postgres_changes',\n        {\n          event: 'INSERT',\n          schema: 'public',\n          table: 'leads',\n          // Server-side filter: only receive this tenant's leads\n          // RLS enforces this at the DB level; filter reduces bandwidth\n          filter: `tenant_id=eq.${tenantId}`,\n        },\n        (payload) => {\n          const lead = payload.new as RealtimeLead;\n          onNewLeadRef.current(lead);\n        }\n      )\n      .on(\n        'postgres_changes',\n        {\n          event: 'UPDATE',\n          schema: 'public',\n          table: 'leads',\n          filter: `tenant_id=eq.${tenantId}`,\n        },\n        (payload) => {\n          const lead = payload.new as RealtimeLead;\n          onLeadUpdatedRef.current?.(lead);\n        }\n      )\n      .subscribe((status, error) => {\n        if (status === 'SUBSCRIBED') {\n          console.log(`[Realtime] Leads channel connected: ${channelName}`);\n        }\n        if (status === 'CHANNEL_ERROR') {\n          console.error(`[Realtime] Channel error:`, error);\n          // Auto-reconnect after 5 seconds on error\n          setTimeout(subscribe, 5000);\n        }\n        if (status === 'TIMED_OUT') {\n          console.warn('[Realtime] Channel timed out, reconnecting...');\n          setTimeout(subscribe, 2000);\n        }\n      });\n\n    channelRef.current = channel;\n  }, [tenantId, enabled]);\n\n  // Initial subscription\n  useEffect(() => {\n    subscribe();\n\n    // Reconnect on tab focus (WebSocket may have been dropped during tab sleep)\n    const handleVisibilityChange = () => {\n      if (document.visibilityState === 'visible') {\n        subscribe();\n      }\n    };\n\n    document.addEventListener('visibilitychange', handleVisibilityChange);\n\n    return () => {\n      document.removeEventListener('visibilitychange', handleVisibilityChange);\n      if (channelRef.current) {\n        supabaseRef.current.removeChannel(channelRef.current);\n      }\n    };\n  }, [subscribe]);\n}\n```\n",
            "domainNumber": 24
          }
        },
        {
          "domainNumber": 24,
          "fileName": "DOMAIN-24-realtime-244-realtime-lead-feed-ui.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-24\\DOMAIN-24-realtime-244-realtime-lead-feed-ui.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "24.4-realtime-lead-feed-ui.md",
            "title": "24.4 Realtime Lead Feed UI",
            "description": "**File:** `apps/portal/src/features/leads/ui/LeadFeed.tsx`",
            "topics": ["Domain 24 implementation"],
            "sectionNumber": "realtime",
            "content": "# 24.4 Realtime Lead Feed UI\n\n**File:** `apps/portal/src/features/leads/ui/LeadFeed.tsx`\n\n```typescript\n'use client';\n\nimport { useState, useCallback, useOptimistic } from 'react';\nimport { useRealtimeLeads, type RealtimeLead } from '@repo/realtime/use-realtime-leads';\nimport { markLeadContacted } from '../model/lead-actions';\n\ninterface LeadFeedProps {\n  tenantId: string;\n  initialLeads: RealtimeLead[];\n  realtimeEnabled: boolean; // Feature flag: Professional+ only\n}\n\nexport function LeadFeed({ tenantId, initialLeads, realtimeEnabled }: LeadFeedProps) {\n  const [leads, setLeads] = useState<RealtimeLead[]>(initialLeads);\n  const [newLeadIds, setNewLeadIds] = useState<Set<string>>(new Set());\n  const [hasNewLeads, setHasNewLeads] = useState(false);\n\n  const handleNewLead = useCallback((lead: RealtimeLead) => {\n    setLeads((prev) => [lead, ...prev]);\n    setNewLeadIds((prev) => new Set([...prev, lead.id]));\n    setHasNewLeads(true);\n\n    // Browser notification (if permission granted)\n    if (\n      typeof Notification !== 'undefined' &&\n      Notification.permission === 'granted'\n    ) {\n      new Notification(`ðŸ”¥ New lead: ${lead.name}`, {\n        body: `Score: ${lead.score}/100 â€” ${lead.message.slice(0, 80)}`,\n        icon: '/favicon.ico',\n        tag: lead.id, // Deduplicate same lead\n      });\n    }\n\n    // Auto-clear \"new\" badge after 30 seconds\n    setTimeout(() => {\n      setNewLeadIds((prev) => {\n        const next = new Set(prev);\n        next.delete(lead.id);\n        return next;\n      });\n    }, 30_000);\n  }, []);\n\n  const handleLeadUpdated = useCallback((updated: RealtimeLead) => {\n    setLeads((prev) =>\n      prev.map((l) => (l.id === updated.id ? updated : l))\n    );\n  }, []);\n\n  useRealtimeLeads({\n    tenantId,\n    onNewLead: handleNewLead,\n    onLeadUpdated: handleLeadUpdated,\n    enabled: realtimeEnabled,\n  });\n\n  return (\n    <div>\n      {/* Live indicator */}\n      <div className=\"flex items-center justify-between mb-6\">\n        <h2 className=\"text-xl font-bold text-gray-900\">Lead Feed</h2>\n        <div className=\"flex items-center gap-2\">\n          {realtimeEnabled ? (\n            <>\n              <span className=\"relative flex h-2.5 w-2.5\">\n                <span className=\"animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75\" />\n                <span className=\"relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500\" />\n              </span>\n              <span className=\"text-sm text-green-700 font-medium\">Live</span>\n            </>\n          ) : (\n            <span className=\"text-sm text-gray-400 flex items-center gap-1\">\n              <span className=\"h-2.5 w-2.5 rounded-full bg-gray-300 inline-block\" />\n              Upgrade to Professional for live feed\n            </span>\n          )}\n        </div>\n      </div>\n\n      {/* New leads toast */}\n      {hasNewLeads && (\n        <button\n          type=\"button\"\n          onClick={() => {\n            window.scrollTo({ top: 0, behavior: 'smooth' });\n            setHasNewLeads(false);\n          }}\n          className=\"w-full mb-4 py-2.5 bg-green-500 text-white rounded-xl text-sm font-semibold animate-bounce\"\n          aria-live=\"polite\"\n        >\n          â†‘ New leads arrived â€” tap to view\n        </button>\n      )}\n\n      {/* Lead cards */}\n      <div\n        className=\"space-y-3\"\n        role=\"feed\"\n        aria-label=\"Lead feed\"\n        aria-busy={false}\n      >\n        {leads.length === 0 ? (\n          <div className=\"text-center py-16 text-gray-400\">\n            <p className=\"text-5xl mb-4\">ðŸ“­</p>\n            <p className=\"font-medium\">No leads yet</p>\n            <p className=\"text-sm\">Your leads will appear here in real-time</p>\n          </div>\n        ) : (\n          leads.map((lead) => (\n            <LeadCard\n              key={lead.id}\n              lead={lead}\n              isNew={newLeadIds.has(lead.id)}\n            />\n          ))\n        )}\n      </div>\n    </div>\n  );\n}\n\n// â”€â”€ Lead Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nfunction LeadCard({ lead, isNew }: { lead: RealtimeLead; isNew: boolean }) {\n  const [optimisticStatus, setOptimisticStatus] = useState(lead.status);\n  const [isExpanded, setIsExpanded] = useState(false);\n\n  const scoreColor =\n    lead.score >= 70 ? 'text-green-700 bg-green-100' :\n    lead.score >= 40 ? 'text-yellow-700 bg-yellow-100' :\n    'text-gray-600 bg-gray-100';\n\n  const scoreLabel =\n    lead.score >= 70 ? 'Qualified' :\n    lead.score >= 40 ? 'Warm' : 'Cold';\n\n  const timeAgo = formatTimeAgo(new Date(lead.created_at));\n\n  return (\n    <article\n      className={`\n        bg-white border rounded-xl p-4 transition-all duration-500\n        ${isNew ? 'border-green-400 shadow-lg shadow-green-100 ring-1 ring-green-300' : 'border-gray-200 shadow-sm'}\n      `}\n      aria-label={`Lead from ${lead.name}, score ${lead.score}`}\n    >\n      <div className=\"flex items-start justify-between gap-3\">\n        <div className=\"flex items-start gap-3 min-w-0\">\n          {/* Avatar */}\n          <div\n            className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold flex-shrink-0\"\n            aria-hidden=\"true\"\n          >\n            {lead.name.charAt(0).toUpperCase()}\n          </div>\n\n          <div className=\"min-w-0\">\n            <div className=\"flex items-center gap-2 flex-wrap\">\n              <p className=\"font-semibold text-gray-900\">{lead.name}</p>\n              {isNew && (\n                <span className=\"text-xs bg-green-500 text-white px-2 py-0.5 rounded-full font-semibold animate-pulse\">\n                  NEW\n                </span>\n              )}\n            </div>\n\n            <div className=\"flex items-center gap-2 mt-0.5 flex-wrap\">\n              <a\n                href={`mailto:${lead.email}`}\n                className=\"text-sm text-blue-600 hover:underline truncate max-w-[180px]\"\n              >\n                {lead.email}\n              </a>\n              {lead.phone && (\n                <a href={`tel:${lead.phone}`} className=\"text-sm text-gray-500 hover:text-primary\">\n                  {lead.phone}\n                </a>\n              )}\n            </div>\n          </div>\n        </div>\n\n        {/* Score badge */}\n        <div className={`flex-shrink-0 text-center rounded-lg px-3 py-1.5 ${scoreColor}`}>\n          <p className=\"text-lg font-extrabold leading-none\">{lead.score}</p>\n          <p className=\"text-xs font-medium mt-0.5\">{scoreLabel}</p>\n        </div>\n      </div>\n\n      {/* Message preview */}\n      <div className=\"mt-3\">\n        <p\n          className={`text-sm text-gray-600 ${!isExpanded ? 'line-clamp-2' : ''}`}\n          onClick={() => setIsExpanded((v) => !v)}\n          style={{ cursor: 'pointer' }}\n          aria-expanded={isExpanded}\n        >\n          {lead.message}\n        </p>\n      </div>\n\n      {/* Footer */}\n      <div className=\"mt-3 pt-3 border-t border-gray-100 flex items-center justify-between\">\n        <div className=\"flex items-center gap-3 text-xs text-gray-400\">\n          <span>{timeAgo}</span>\n          {lead.metadata?.utmSource && (\n            <span className=\"bg-gray-100 px-2 py-0.5 rounded-full\">\n              {String(lead.metadata.utmSource)}\n            </span>\n          )}\n          {lead.source && lead.source !== 'contact_form' && (\n            <span className=\"bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full capitalize\">\n              {lead.source.replace(/_/g, ' ')}\n            </span>\n          )}\n        </div>\n\n        <div className=\"flex items-center gap-2\">\n          <a\n            href={`mailto:${lead.email}?subject=Re: Your inquiry`}\n            className=\"text-xs font-medium text-primary hover:underline\"\n            aria-label={`Reply to ${lead.name}`}\n          >\n            Reply\n          </a>\n          {lead.phone && (\n            <a\n              href={`tel:${lead.phone}`}\n              className=\"text-xs font-medium text-green-600 hover:underline\"\n              aria-label={`Call ${lead.name}`}\n            >\n              Call\n            </a>\n          )}\n          {optimisticStatus !== 'contacted' && (\n            <button\n              type=\"button\"\n              onClick={async () => {\n                setOptimisticStatus('contacted');\n                await markLeadContacted(lead.id);\n              }}\n              className=\"text-xs text-gray-400 hover:text-gray-600\"\n              aria-label=\"Mark as contacted\"\n            >\n              Mark contacted\n            </button>\n          )}\n          {optimisticStatus === 'contacted' && (\n            <span className=\"text-xs text-green-600\">âœ“ Contacted</span>\n          )}\n        </div>\n      </div>\n    </article>\n  );\n}\n\nfunction formatTimeAgo(date: Date): string {\n  const seconds = Math.floor((Date.now() - date.getTime()) / 1000);\n  if (seconds < 60) return 'just now';\n  if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;\n  if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;\n  return `${Math.floor(seconds / 86400)}d ago`;\n}\n```\n",
            "domainNumber": 24
          }
        }
      ]
    },
    {
      "domainNumber": 25,
      "success": true,
      "tasksCreated": 3,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 25,
          "fileName": "DOMAIN-25-philosophy.md-251-philosophy.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-25\\DOMAIN-25-philosophy.md-251-philosophy.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "25.1-philosophy.md",
            "title": "25.1 Philosophy",
            "description": "**What it is:** Edge-based A/B testing assigns visitors to experiment buckets using a deterministic cookie set in middleware â€” before the request ever hits the origin server. Zero CLS, zero layout shift, zero flash of wrong content. The variant renders server-side in the correct bucket from the first byte. [plasmic](https://www.plasmic.app/blog/nextjs-ab-testing)",
            "topics": ["Domain 25 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "# 25.1 Philosophy\n\n**What it is:** Edge-based A/B testing assigns visitors to experiment buckets using a deterministic cookie set in middleware â€” before the request ever hits the origin server. Zero CLS, zero layout shift, zero flash of wrong content. The variant renders server-side in the correct bucket from the first byte. [plasmic](https://www.plasmic.app/blog/nextjs-ab-testing)\n\n**Why middleware, not client-side:** Client-side A/B testing (Google Optimize style) requires the page to load first, then swap content â€” causing a flash of original content (FOOC). Middleware cookie + server render means the variant is the first thing the browser sees.\n\n**Architecture:** Middleware reads the `ab_bucket` cookie. If absent, assigns deterministically based on tenant + path + visitor fingerprint. Rewrites the request to `/[bucket]/page` path internally (transparent to visitor URL).\n",
            "domainNumber": 25
          }
        },
        {
          "domainNumber": 25,
          "fileName": "DOMAIN-25-ab-252-ab-testing-package.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-25\\DOMAIN-25-ab-252-ab-testing-package.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "25.2-ab-testing-package.md",
            "title": "25.2 A/B Testing Package",
            "description": "**File:** `packages/analytics/src/ab-testing.ts`",
            "topics": ["Domain 25 implementation"],
            "sectionNumber": "ab",
            "content": "# 25.2 A/B Testing Package\n\n**File:** `packages/analytics/src/ab-testing.ts`\n\n```typescript\nimport { NextRequest, NextResponse } from 'next/server';\nimport { get } from '@vercel/edge-config';\nimport { Redis } from '@upstash/redis';\n\nconst redis = Redis.fromEnv();\n\n// ============================================================================\n// A/B TESTING ENGINE (Edge Middleware)\n// ============================================================================\n\nexport interface ABExperiment {\n  id: string;\n  name: string;\n  tenantId: string | 'global'; // 'global' applies to all tenants\n  path: string; // Pathname pattern to test, e.g. '/' or '/services/*'\n  variants: ABVariant[];\n  status: 'active' | 'paused' | 'concluded';\n  startedAt: string;\n  concludedAt?: string;\n  winnerVariantId?: string;\n}\n\nexport interface ABVariant {\n  id: string; // e.g. 'control', 'variant-a', 'variant-b'\n  weight: number; // 0â€“100 (must sum to 100 across all variants)\n  description?: string;\n}\n\nconst COOKIE_NAME = 'ab_assignments'; // Single cookie maps experimentId â†’ variantId\nconst COOKIE_MAX_AGE = 60 * 60 * 24 * 30; // 30 days\n\n// ============================================================================\n// APPLY A/B TESTS IN MIDDLEWARE\n// Called once per request â€” reads Edge Config for experiment definitions\n// ============================================================================\n\nexport async function applyABTests(\n  request: NextRequest,\n  response: NextResponse,\n  tenantId: string\n): Promise<NextResponse> {\n  const { pathname } = request.nextUrl;\n\n  // Fetch active experiments from Edge Config (~0ms)\n  let experiments: ABExperiment[] = [];\n  try {\n    const all = await get<ABExperiment[]>('abExperiments');\n    experiments = (all ?? []).filter(\n      (e) =>\n        e.status === 'active' &&\n        (e.tenantId === 'global' || e.tenantId === tenantId) &&\n        pathMatchesPattern(pathname, e.path)\n    );\n  } catch {\n    // Edge Config unavailable â€” skip A/B testing, don't block request\n    return response;\n  }\n\n  if (experiments.length === 0) return response;\n\n  // Read existing assignments from cookie\n  const cookieValue = request.cookies.get(COOKIE_NAME)?.value;\n  let assignments: Record<string, string> = {};\n  try {\n    assignments = cookieValue ? JSON.parse(Buffer.from(cookieValue, 'base64').toString()) : {};\n  } catch {\n    assignments = {};\n  }\n\n  let assignmentsChanged = false;\n\n  for (const experiment of experiments) {\n    if (assignments[experiment.id]) continue; // Already assigned\n\n    // Assign variant deterministically based on IP + experiment ID\n    // (same IP always gets same variant â€” consistent experience)\n    const ip = request.headers.get('x-forwarded-for')?.split(',')[0] ?? '0.0.0.0';\n    const variantId = assignVariant(ip, experiment.id, experiment.variants);\n\n    assignments[experiment.id] = variantId;\n    assignmentsChanged = true;\n\n    // Track assignment in Redis for analytics (async â€” don't await)\n    redis.hincrby(`ab:${experiment.id}:assignments`, variantId, 1).catch(() => {});\n  }\n\n  if (assignmentsChanged) {\n    const encoded = Buffer.from(JSON.stringify(assignments)).toString('base64');\n    response.cookies.set(COOKIE_NAME, encoded, {\n      httpOnly: true,\n      sameSite: 'lax',\n      secure: process.env.NODE_ENV === 'production',\n      maxAge: COOKIE_MAX_AGE,\n      path: '/',\n    });\n  }\n\n  // Inject assignments as request header for Server Components to read\n  const assignmentsHeader = JSON.stringify(assignments);\n  response.headers.set('X-AB-Assignments', assignmentsHeader);\n\n  return response;\n}\n\n// â”€â”€ Deterministic variant assignment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// djb2 hash of IP + experimentId â†’ maps to variant based on cumulative weights\n\nfunction assignVariant(ip: string, experimentId: string, variants: ABVariant[]): string {\n  const seed = `${ip}:${experimentId}`;\n  let hash = 5381;\n  for (const char of seed) {\n    hash = (hash * 33) ^ char.charCodeAt(0);\n  }\n  const bucket = Math.abs(hash) % 100; // 0â€“99\n\n  let cumulative = 0;\n  for (const variant of variants) {\n    cumulative += variant.weight;\n    if (bucket < cumulative) return variant.id;\n  }\n  return variants[0]?.id ?? 'control';\n}\n\n// â”€â”€ Path pattern matching (supports * wildcard) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nfunction pathMatchesPattern(pathname: string, pattern: string): boolean {\n  if (pattern === '*') return true;\n  if (pattern === pathname) return true;\n  if (pattern.endsWith('*')) {\n    return pathname.startsWith(pattern.slice(0, -1));\n  }\n  return false;\n}\n\n// ============================================================================\n// SERVER COMPONENT HELPER\n// Reads variant assignment from injected header\n// ============================================================================\n\nimport { headers } from 'next/headers';\n\nexport async function getABVariant(experimentId: string): Promise<string | null> {\n  const headersList = await headers();\n  const assignmentsHeader = headersList.get('X-AB-Assignments');\n  if (!assignmentsHeader) return null;\n\n  try {\n    const assignments = JSON.parse(assignmentsHeader);\n    return assignments[experimentId] ?? null;\n  } catch {\n    return null;\n  }\n}\n\n// ============================================================================\n// CONVERSION TRACKING\n// Called from Server Actions or Route Handlers when a conversion event fires\n// ============================================================================\n\nexport async function trackABConversion(\n  experimentId: string,\n  variantId: string,\n  conversionType: 'lead_submitted' | 'phone_clicked' | 'booking_created'\n): Promise<void> {\n  // Increment conversion counter in Redis\n  await redis.hincrby(`ab:${experimentId}:conversions:${conversionType}`, variantId, 1);\n}\n\n// ============================================================================\n// ADMIN: Get experiment results\n// ============================================================================\n\nexport async function getExperimentResults(experimentId: string) {\n  const [assignments, leadConversions, phoneConversions] = await Promise.all([\n    redis.hgetall(`ab:${experimentId}:assignments`),\n    redis.hgetall(`ab:${experimentId}:conversions:lead_submitted`),\n    redis.hgetall(`ab:${experimentId}:conversions:phone_clicked`),\n  ]);\n\n  const variants = Object.keys(assignments ?? {});\n\n  return variants.map((variantId) => {\n    const assigned = Number(assignments?.[variantId] ?? 0);\n    const leads = Number(leadConversions?.[variantId] ?? 0);\n    const phoneClicks = Number(phoneConversions?.[variantId] ?? 0);\n\n    return {\n      variantId,\n      assigned,\n      leads,\n      phoneClicks,\n      leadConversionRate: assigned > 0 ? (leads / assigned) * 100 : 0,\n      phoneConversionRate: assigned > 0 ? (phoneClicks / assigned) * 100 : 0,\n    };\n  });\n}\n```\n",
            "domainNumber": 25
          }
        },
        {
          "domainNumber": 25,
          "fileName": "DOMAIN-25-using-253-using-ab-variants-in-server-components.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-25\\DOMAIN-25-using-253-using-ab-variants-in-server-components.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "25.3-using-ab-variants.md",
            "title": "25.3 Using A/B Variants in Server Components",
            "description": "```typescript",
            "topics": ["Domain 25 implementation"],
            "sectionNumber": "using",
            "content": "# 25.3 Using A/B Variants in Server Components\n\n```typescript\n// Example: A/B test two hero section variants on the homepage\n\nimport { getABVariant } from '@repo/analytics/ab-testing';\n\n// Hero A: Text-focused, headline + subheadline + CTA\nasync function HeroVariantA({ config }: { config: SiteConfig }) {\n  return (\n    <section className=\"py-20 px-6 bg-white text-center\">\n      <h1 className=\"text-5xl font-extrabold text-gray-900 mb-4\">\n        {config.identity.tagline}\n      </h1>\n      <p className=\"text-xl text-gray-500 mb-8 max-w-2xl mx-auto\">\n        {config.identity.description}\n      </p>\n      <CallToActionButtons config={config} />\n    </section>\n  );\n}\n\n// Hero B: Image-focused, full-bleed with overlaid text\nasync function HeroVariantB({ config }: { config: SiteConfig }) {\n  return (\n    <section\n      className=\"relative min-h-[70vh] flex items-center justify-center bg-gray-900\"\n      style={{ backgroundImage: `url(${config.assets?.heroImage})`, backgroundSize: 'cover' }}\n    >\n      <div className=\"absolute inset-0 bg-black/50\" aria-hidden=\"true\" />\n      <div className=\"relative z-10 text-center text-white px-6\">\n        <h1 className=\"text-6xl font-extrabold mb-4\">{config.identity.tagline}</h1>\n        <CallToActionButtons config={config} variant=\"white\" />\n      </div>\n    </section>\n  );\n}\n\n// In homepage Server Component:\nexport default async function HomePage({ config }: { config: SiteConfig }) {\n  const heroVariant = await getABVariant('hero-layout-test-v1');\n\n  return (\n    <>\n      {heroVariant === 'variant-b' ? (\n        <HeroVariantB config={config} />\n      ) : (\n        // 'control' or null â†’ always show control\n        <HeroVariantA config={config} />\n      )}\n      {/* Rest of page */}\n    </>\n  );\n}\n```\n",
            "domainNumber": 25
          }
        }
      ]
    },
    {
      "domainNumber": 26,
      "success": true,
      "tasksCreated": 5,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 26,
          "fileName": "DOMAIN-26-philosophy.md-261-philosophy.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-26\\DOMAIN-26-philosophy.md-261-philosophy.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "26.1-philosophy.md",
            "title": "26.1 Philosophy",
            "description": "**What it is:** Playwright E2E tests cover the critical user journeys that unit tests cannot â€” multi-tenant routing, auth-gated portal pages, form submission to lead creation, billing checkout. [dev](https://dev.to/gustavomeilus/scaling-your-playwright-tests-a-fixture-for-multi-user-multi-context-worlds-53i4)",
            "topics": ["Domain 26 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "# 26.1 Philosophy\n\n**What it is:** Playwright E2E tests cover the critical user journeys that unit tests cannot â€” multi-tenant routing, auth-gated portal pages, form submission to lead creation, billing checkout. [dev](https://dev.to/gustavomeilus/scaling-your-playwright-tests-a-fixture-for-multi-user-multi-context-worlds-53i4)\n\n**Storage state auth pattern:** Playwright supports saving authenticated session state to a JSON file and reusing it across tests. Auth setup runs once per test suite in a global setup file â€” not once per test file. This saves 3â€“10 seconds per test file, which compounds to minutes in CI. [linkedin](https://www.linkedin.com/pulse/playwright-reuse-login-test-multiple-users-easily-testleaf-dnddc)\n\n**Test isolation strategy:** Each test that creates data (leads, tenants) uses a dedicated test tenant seeded before the suite runs, cleaned up after. Tests never share mutable state â€” two parallel test workers cannot corrupt each other's data. [dev](https://dev.to/gustavomeilus/scaling-your-playwright-tests-a-fixture-for-multi-user-multi-context-worlds-53i4)\n",
            "domainNumber": 26
          }
        },
        {
          "domainNumber": 26,
          "fileName": "DOMAIN-26-playwright-262-playwright-config.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-26\\DOMAIN-26-playwright-262-playwright-config.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "26.2-playwright-config.md",
            "title": "26.2 Playwright Config",
            "description": "**File:** `e2e/playwright.config.ts`",
            "topics": ["Domain 26 implementation"],
            "sectionNumber": "playwright",
            "content": "# 26.2 Playwright Config\n\n**File:** `e2e/playwright.config.ts`\n\n```typescript\nimport { defineConfig, devices } from '@playwright/test';\nimport path from 'path';\n\n// Auth state storage paths (one per role/tenant combination)\nexport const AUTH_PATHS = {\n  agencyOwner: path.join(__dirname, '.auth/agency-owner.json'),\n  tenant1Admin: path.join(__dirname, '.auth/tenant1-admin.json'),\n  tenant2Admin: path.join(__dirname, '.auth/tenant2-admin.json'),\n  superAdmin: path.join(__dirname, '.auth/super-admin.json'),\n};\n\nexport default defineConfig({\n  testDir: './tests',\n  fullyParallel: true,\n  forbidOnly: !!process.env.CI,\n  retries: process.env.CI ? 2 : 0, // Retry flaky tests 2x in CI\n  workers: process.env.CI ? 4 : 2,\n  reporter: [\n    ['html', { outputFolder: 'playwright-report', open: 'never' }],\n    ['github'], // Annotates PR with test failures\n    ['list'], // Console output during run\n  ],\n  timeout: 30_000, // 30s per test\n  expect: { timeout: 10_000 },\n\n  use: {\n    baseURL: process.env.PLAYWRIGHT_BASE_URL ?? 'http://localhost:3000',\n    trace: 'retain-on-failure', // Save trace on failure only (saves disk)\n    screenshot: 'only-on-failure',\n    video: 'retain-on-failure',\n    // Emulate mobile viewport for key tests\n    // viewport: { width: 390, height: 844 },\n  },\n\n  projects: [\n    // â”€â”€ Auth setup (runs BEFORE all other projects) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    {\n      name: 'auth-setup',\n      testMatch: '**/*.setup.ts',\n      use: { ...devices['Desktop Chrome'] },\n    },\n\n    // â”€â”€ Authenticated tests (depend on auth-setup) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    {\n      name: 'agency-owner',\n      dependencies: ['auth-setup'],\n      use: {\n        ...devices['Desktop Chrome'],\n        storageState: AUTH_PATHS.agencyOwner,\n      },\n      testMatch: '**/portal/**/*.spec.ts',\n    },\n\n    {\n      name: 'tenant-admin',\n      dependencies: ['auth-setup'],\n      use: {\n        ...devices['Desktop Chrome'],\n        storageState: AUTH_PATHS.tenant1Admin,\n      },\n      testMatch: '**/tenant/**/*.spec.ts',\n    },\n\n    {\n      name: 'super-admin',\n      dependencies: ['auth-setup'],\n      use: {\n        ...devices['Desktop Chrome'],\n        storageState: AUTH_PATHS.superAdmin,\n      },\n      testMatch: '**/admin/**/*.spec.ts',\n    },\n\n    // â”€â”€ Unauthenticated tests (marketing sites, public routes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    {\n      name: 'public',\n      use: { ...devices['Desktop Chrome'] },\n      testMatch: '**/public/**/*.spec.ts',\n    },\n\n    {\n      name: 'public-mobile',\n      use: { ...devices['Pixel 7'] },\n      testMatch: '**/public/**/*.spec.ts',\n    },\n\n    // â”€â”€ Accessibility tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    {\n      name: 'a11y',\n      use: { ...devices['Desktop Chrome'] },\n      testMatch: '**/a11y/**/*.spec.ts',\n    },\n  ],\n\n  // Webserver: start Next.js before tests if not already running\n  webServer: {\n    command: 'pnpm --filter portal run start',\n    url: 'http://localhost:3000',\n    reuseExistingServer: !process.env.CI,\n    timeout: 120_000,\n  },\n});\n```\n",
            "domainNumber": 26
          }
        },
        {
          "domainNumber": 26,
          "fileName": "DOMAIN-26-auth-263-auth-setup-file.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-26\\DOMAIN-26-auth-263-auth-setup-file.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "26.3-auth-setup-file.md",
            "title": "26.3 Auth Setup File",
            "description": "**File:** `e2e/tests/auth.setup.ts`",
            "topics": ["Domain 26 implementation"],
            "sectionNumber": "auth",
            "content": "# 26.3 Auth Setup File\n\n**File:** `e2e/tests/auth.setup.ts`\n\n```typescript\nimport { test as setup, expect } from '@playwright/test';\nimport { AUTH_PATHS } from '../playwright.config';\n\n// ============================================================================\n// AUTH SETUP\n// Runs ONCE before all test projects.\n// Creates authenticated sessions for each role and saves to .auth/*.json.\n// Subsequent tests load these files instead of logging in each time.\n// Reference: https://playwright.dev/docs/auth\n// ============================================================================\n\nconst BASE_URL = process.env.PLAYWRIGHT_BASE_URL ?? 'http://localhost:3000';\n\n// â”€â”€ Agency owner (full platform admin, manages all tenants) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nsetup('authenticate as agency owner', async ({ page }) => {\n  await page.goto(`${BASE_URL}/sign-in`);\n\n  await page.getByLabel('Email address').fill(process.env.TEST_AGENCY_EMAIL!);\n  await page.getByLabel('Password').fill(process.env.TEST_AGENCY_PASSWORD!);\n  await page.getByRole('button', { name: 'Sign in' }).click();\n\n  // Wait for redirect to dashboard (confirms successful auth)\n  await page.waitForURL('**/dashboard**', { timeout: 15_000 });\n  await expect(page.getByRole('heading', { name: 'Dashboard' })).toBeVisible();\n\n  // Save session state\n  await page.context().storageState({ path: AUTH_PATHS.agencyOwner });\n});\n\n// â”€â”€ Tenant 1 admin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nsetup('authenticate as tenant 1 admin', async ({ page }) => {\n  await page.goto(`${BASE_URL}/sign-in`);\n\n  await page.getByLabel('Email address').fill(process.env.TEST_TENANT1_EMAIL!);\n  await page.getByLabel('Password').fill(process.env.TEST_TENANT1_PASSWORD!);\n  await page.getByRole('button', { name: 'Sign in' }).click();\n\n  await page.waitForURL('**/dashboard**', { timeout: 15_000 });\n\n  await page.context().storageState({ path: AUTH_PATHS.tenant1Admin });\n});\n\n// â”€â”€ Super admin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nsetup('authenticate as super admin', async ({ page }) => {\n  await page.goto(`${process.env.PLAYWRIGHT_ADMIN_URL ?? 'http://localhost:3001'}/sign-in`);\n\n  await page.getByLabel('Email address').fill(process.env.TEST_SUPERADMIN_EMAIL!);\n  await page.getByLabel('Password').fill(process.env.TEST_SUPERADMIN_PASSWORD!);\n  await page.getByRole('button', { name: 'Sign in' }).click();\n\n  await page.waitForURL('**/admin/dashboard**', { timeout: 15_000 });\n\n  await page.context().storageState({ path: AUTH_PATHS.superAdmin });\n});\n```\n",
            "domainNumber": 26
          }
        },
        {
          "domainNumber": 26,
          "fileName": "DOMAIN-26-test-264-test-fixtures.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-26\\DOMAIN-26-test-264-test-fixtures.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "26.4-test-fixtures.md",
            "title": "26.4 Test Fixtures",
            "description": "**File:** `e2e/fixtures/index.ts`",
            "topics": ["Domain 26 implementation"],
            "sectionNumber": "test",
            "content": "# 26.4 Test Fixtures\n\n**File:** `e2e/fixtures/index.ts`\n\n```typescript\nimport { test as base, expect, type Page, type APIRequestContext } from '@playwright/test';\nimport { createClient } from '@supabase/supabase-js';\n\n// ============================================================================\n// CUSTOM FIXTURES\n// Extend base Playwright test with typed fixtures for:\n// - tenantId (seeded test tenant)\n// - supabaseAdmin (for direct DB assertions)\n// - leadCountBefore (before test, for delta assertions)\n// ============================================================================\n\nconst supabaseAdmin = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\ninterface CustomFixtures {\n  tenantId: string;\n  tenantDomain: string;\n  supabase: typeof supabaseAdmin;\n  leadCountBefore: number;\n\n  // Helper: submit contact form and wait for lead creation\n  submitContactForm: (options: {\n    name: string;\n    email: string;\n    phone?: string;\n    message: string;\n  }) => Promise<{ leadId: string }>;\n}\n\nexport const test = base.extend<CustomFixtures>({\n  // Seed a fresh test tenant for each test (ensures isolation)\n  tenantId: async ({}, use) => {\n    const tenantId = process.env.TEST_TENANT_ID!;\n    await use(tenantId);\n  },\n\n  tenantDomain: async ({ tenantId }, use) => {\n    const { data } = await supabaseAdmin\n      .from('tenants')\n      .select('subdomain')\n      .eq('id', tenantId)\n      .single();\n\n    const domain = `${data?.subdomain}.localhost:3000`;\n    await use(domain);\n  },\n\n  supabase: async ({}, use) => {\n    await use(supabaseAdmin);\n  },\n\n  leadCountBefore: async ({ tenantId }, use) => {\n    const { count } = await supabaseAdmin\n      .from('leads')\n      .select('*', { count: 'exact', head: true })\n      .eq('tenant_id', tenantId);\n    await use(count ?? 0);\n  },\n\n  submitContactForm: async ({ page, tenantDomain }, use) => {\n    const submit = async (options: {\n      name: string;\n      email: string;\n      phone?: string;\n      message: string;\n    }): Promise<{ leadId: string }> => {\n      // Navigate to the contact form\n      await page.goto(`http://${tenantDomain}/contact`);\n\n      // Fill form fields\n      await page.getByLabel(/name/i).fill(options.name);\n      await page.getByLabel(/email/i).fill(options.email);\n      if (options.phone) {\n        await page.getByLabel(/phone/i).fill(options.phone);\n      }\n      await page.getByLabel(/message/i).fill(options.message);\n\n      // Submit\n      const responsePromise = page.waitForResponse(\n        (resp) => resp.url().includes('/api/contact') && resp.status() === 200\n      );\n\n      await page.getByRole('button', { name: /submit|send|contact/i }).click();\n\n      const response = await responsePromise;\n      const body = await response.json();\n\n      return { leadId: body.leadId };\n    };\n\n    await use(submit);\n  },\n});\n\nexport { expect };\n```\n",
            "domainNumber": 26
          }
        },
        {
          "domainNumber": 26,
          "fileName": "DOMAIN-26-critical-265-critical-test-suites.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-26\\DOMAIN-26-critical-265-critical-test-suites.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "26.5-critical-test-suites.md",
            "title": "26.5 Critical Test Suites",
            "description": "**File:** `e2e/tests/public/contact-form.spec.ts`",
            "topics": ["Domain 26 implementation"],
            "sectionNumber": "critical",
            "content": "# 26.5 Critical Test Suites\n\n**File:** `e2e/tests/public/contact-form.spec.ts`\n\n```typescript\nimport { test, expect } from '../../fixtures';\n\ntest.describe('Contact form â†’ Lead creation', () => {\n  test('submitting form creates a lead in the database', async ({\n    page,\n    tenantDomain,\n    tenantId,\n    supabase,\n    submitContactForm,\n    leadCountBefore,\n  }) => {\n    const leadId = await submitContactForm({\n      name: 'Test Visitor',\n      email: `test+${Date.now()}@example.com`,\n      phone: '555-867-5309',\n      message: 'I need an emergency HVAC repair, my AC is broken',\n    });\n\n    // Success message appears\n    await expect(page.getByRole('alert')).toContainText(/thank|received|follow/i);\n\n    // Lead was created in DB\n    const { data: lead } = await supabase\n      .from('leads')\n      .select('*')\n      .eq('id', leadId.leadId)\n      .single();\n\n    expect(lead).not.toBeNull();\n    expect(lead?.name).toBe('Test Visitor');\n    expect(lead?.score).toBeGreaterThan(0);\n    expect(lead?.tenant_id).toBe(tenantId);\n\n    // Total lead count increased by exactly 1\n    const { count: countAfter } = await supabase\n      .from('leads')\n      .select('*', { count: 'exact', head: true })\n      .eq('tenant_id', tenantId);\n\n    expect(countAfter).toBe(leadCountBefore + 1);\n  });\n\n  test('form blocks submission with invalid email', async ({ page, tenantDomain }) => {\n    await page.goto(`http://${tenantDomain}/contact`);\n\n    await page.getByLabel(/name/i).fill('Test User');\n    await page.getByLabel(/email/i).fill('not-an-email');\n    await page.getByLabel(/message/i).fill('Test message that is long enough');\n    await page.getByRole('button', { name: /submit|send/i }).click();\n\n    // Error message appears, no API call made\n    await expect(page.getByRole('alert')).toBeVisible();\n    await expect(page.getByRole('alert')).toContainText(/email|valid/i);\n  });\n\n  test('phone click is tracked as an event', async ({ page, tenantDomain, tenantId, supabase }) => {\n    await page.goto(`http://${tenantDomain}/`);\n\n    const phoneLink = page.getByRole('link', { name: /^\\+?[\\d\\s\\(\\)\\-]{7,}$/ }).first();\n    await phoneLink.click();\n\n    // Allow event to propagate\n    await page.waitForTimeout(500);\n\n    const { count } = await supabase\n      .from('phone_click_events')\n      .select('*', { count: 'exact', head: true })\n      .eq('tenant_id', tenantId);\n\n    expect(count).toBeGreaterThan(0);\n  });\n});\n```\n\n**File:** `e2e/tests/portal/billing.spec.ts`\n\n```typescript\nimport { test, expect } from '../../fixtures';\n\ntest.describe('Billing portal', () => {\n  test('displays current plan correctly', async ({ page }) => {\n    await page.goto('/billing');\n\n    // Current plan is highlighted\n    const currentPlanBadge = page.getByText('Current Plan');\n    await expect(currentPlanBadge).toBeVisible();\n\n    // All three plans are shown\n    await expect(page.getByRole('heading', { name: 'Starter' })).toBeVisible();\n    await expect(page.getByRole('heading', { name: 'Professional' })).toBeVisible();\n    await expect(page.getByRole('heading', { name: 'Enterprise' })).toBeVisible();\n  });\n\n  test('manage subscription button appears for current plan', async ({ page }) => {\n    await page.goto('/billing');\n\n    const manageButton = page.getByRole('button', { name: 'Manage Subscription' });\n    await expect(manageButton).toBeVisible();\n  });\n});\n```\n\n**File:** `e2e/tests/a11y/homepage.spec.ts`\n\n```typescript\nimport { test, expect } from '../../fixtures';\nimport AxeBuilder from '@axe-core/playwright';\n\ntest.describe('Accessibility â€” Marketing site', () => {\n  test('homepage has no critical accessibility violations', async ({ page, tenantDomain }) => {\n    await page.goto(`http://${tenantDomain}/`);\n\n    const accessibilityScanResults = await new AxeBuilder({ page })\n      .withTags(['wcag2a', 'wcag2aa', 'wcag21a', 'wcag21aa', 'wcag22aa'])\n      .analyze();\n\n    // Critical violations fail the test\n    const critical = accessibilityScanResults.violations.filter(\n      (v) => v.impact === 'critical' || v.impact === 'serious'\n    );\n\n    if (critical.length > 0) {\n      console.error('Accessibility violations:', JSON.stringify(critical, null, 2));\n    }\n\n    expect(critical).toHaveLength(0);\n  });\n\n  test('contact form is keyboard navigable', async ({ page, tenantDomain }) => {\n    await page.goto(`http://${tenantDomain}/contact`);\n\n    // Tab through all form fields\n    await page.keyboard.press('Tab'); // Skip to first field (after skip link)\n    const firstField = page.getByLabel(/name/i);\n    await expect(firstField).toBeFocused();\n\n    await page.keyboard.press('Tab');\n    const emailField = page.getByLabel(/email/i);\n    await expect(emailField).toBeFocused();\n\n    await page.keyboard.press('Tab');\n    const phoneField = page.getByLabel(/phone/i);\n    await expect(phoneField).toBeFocused();\n\n    await page.keyboard.press('Tab');\n    const messageField = page.getByLabel(/message/i);\n    await expect(messageField).toBeFocused();\n\n    await page.keyboard.press('Tab');\n    const submitButton = page.getByRole('button', { name: /submit|send/i });\n    await expect(submitButton).toBeFocused();\n  });\n\n  test('skip to content link is the first focusable element', async ({ page, tenantDomain }) => {\n    await page.goto(`http://${tenantDomain}/`);\n\n    await page.keyboard.press('Tab');\n    const focused = page.locator(':focus');\n\n    await expect(focused).toHaveText(/skip to/i);\n    await expect(focused).toBeVisible();\n  });\n});\n```\n",
            "domainNumber": 26
          }
        }
      ]
    },
    {
      "domainNumber": 27,
      "success": true,
      "tasksCreated": 4,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 27,
          "fileName": "DOMAIN-27-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-27\\DOMAIN-27-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "27.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 27 section philosophy.md",
            "topics": ["Domain 27 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 27.1 Philosophy\n\n**What it is:** Programmatic SEO at scale â€” for every city in a client's service area, the platform auto-generates a dedicated landing page: `/service-area/plano-tx`, `/service-area/frisco-tx`, `/service-area/allen-tx`. Each page is unique (not duplicate content), targeting exact long-tail queries like \"HVAC repair in Plano TX\" or \"licensed electrician Frisco TX.\" [kreativekommit](https://kreativekommit.com/guides/2025/07/ssr-nextjs-local-seo)\n\n**Why this is the single highest-ROI feature for service businesses:** Local service businesses live and die by hyper-local search. A plumber in Plano competes with hundreds of other plumbers on the query \"plumber near me\" â€” but may face zero direct competition on \"emergency water heater replacement Allen TX.\" Each programmatic area page captures a slice of that long-tail demand with virtually no marginal effort. [kreativekommit](https://kreativekommit.com/guides/2025/07/ssr-nextjs-local-seo)\n\n**Rendering strategy:** `generateStaticParams` generates the top 10 cities at build time (seed routes). All remaining cities in the config use `dynamicParams = true` with `cacheLife({ revalidate: 86400 })` â€” they're generated on first request and cached 24h. This means 500 cities never bloat your build time. [mgphq](https://www.mgphq.com/blog/nextjs-programmatic-seo-isr-guide)\n\n---\n",
            "domainNumber": 27
          }
        },
        {
          "domainNumber": 27,
          "fileName": "DOMAIN-27-service-section-service.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-27\\DOMAIN-27-service-section-service.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "27.2-service-area-route.md",
            "title": "Section service",
            "description": "Implementation for domain 27 section service",
            "topics": ["Domain 27 implementation"],
            "sectionNumber": "service",
            "content": "### 27.2 Service Area Route\n\n**File:** `apps/*/src/app/service-area/[slug]/page.tsx`\n\n```typescript\nimport type { Metadata } from 'next';\nimport { notFound } from 'next/navigation';\nimport { headers } from 'next/headers';\nimport { cacheLife, cacheTag } from 'next/cache';\nimport { resolveTenant } from '@repo/multi-tenant/resolve-tenant';\nimport { db } from '@repo/db';\nimport { buildMetadata } from '@repo/seo/metadata-factory';\nimport {\n  buildLocalBusinessSchema,\n  buildServiceSchema,\n  buildBreadcrumbSchema,\n  JsonLd,\n} from '@repo/seo/structured-data';\nimport { ServiceAreaHero } from '@/components/service-area/ServiceAreaHero';\nimport { ServiceAreaServices } from '@/components/service-area/ServiceAreaServices';\nimport { ServiceAreaTestimonials } from '@/components/service-area/ServiceAreaTestimonials';\nimport { ContactFormSection } from '@/components/sections/ContactFormSection';\nimport { BookingEmbedPopup } from '@repo/ui/booking/BookingEmbed';\n\n// ============================================================================\n// SERVICE AREA PAGE â€” Programmatic Local SEO\n// URL: /service-area/[slug]   e.g. /service-area/plano-tx\n// ============================================================================\n\ninterface PageProps {\n  params: Promise<{ slug: string }>;\n}\n\n// Allow pages beyond the seeded static set (on-demand ISR)\nexport const dynamicParams = true;\n\n// Seed top 10 service areas at build time per tenant\nexport async function generateStaticParams() {\n  const allTenants = await db\n    .from('tenants')\n    .select('config')\n    .eq('status', 'active');\n\n  const params: { slug: string }[] = [];\n\n  for (const tenant of allTenants.data ?? []) {\n    const areas: string[] = (tenant.config as any)?.identity?.serviceAreas ?? [];\n    // Seed the first 10 areas only â€” rest are on-demand ISR\n    areas.slice(0, 10).forEach((area) => {\n      params.push({ slug: slugifyArea(area) });\n    });\n  }\n\n  return params;\n}\n\nexport async function generateMetadata({ params }: PageProps): Promise<Metadata> {\n  const { slug } = await params;\n  const headersList = await headers();\n  const tenantContext = await resolveTenant({ headers: headersList } as any);\n  if (!tenantContext) return {};\n\n  const { data: tenant } = await db\n    .from('tenants')\n    .select('config')\n    .eq('id', tenantContext.tenantId)\n    .single();\n\n  if (!tenant?.config) return {};\n\n  const config = tenant.config as any;\n  const areaName = deslugifyArea(slug);\n  const city = areaName.split(',')[0].trim();\n  const state = areaName.split(',') [kreativekommit](https://kreativekommit.com/guides/2025/07/ssr-nextjs-local-seo)?.trim() ?? config.identity?.address?.state ?? '';\n  const industry = config.identity?.industry ?? 'services';\n\n  return buildMetadata({\n    config,\n    path: `/service-area/${slug}`,\n    pageTitle: `${industry.charAt(0).toUpperCase() + industry.slice(1)} Services in ${city}${state ? `, ${state}` : ''}`,\n    pageDescription: `${config.identity?.siteName} provides professional ${industry} services in ${city}, ${state}. ${config.identity?.tagline ?? ''} Licensed, insured, and locally trusted. Free estimates â€” call ${config.identity?.contact?.phone ?? 'today'}.`,\n  });\n}\n\nexport default async function ServiceAreaPage({ params }: PageProps) {\n  'use cache';\n\n  const { slug } = await params;\n  const headersList = await headers();\n\n  const tenantContext = await resolveTenant({ headers: headersList } as any);\n  if (!tenantContext) return notFound();\n\n  const { tenantId } = tenantContext;\n\n  cacheTag(`tenant:${tenantId}:service-area:${slug}`);\n  cacheLife({ revalidate: 86400 }); // 24h â€” static content rarely changes\n\n  const { data: tenant } = await db\n    .from('tenants')\n    .select('config, custom_domain, subdomain')\n    .eq('id', tenantId)\n    .single();\n\n  if (!tenant?.config) return notFound();\n\n  const config = tenant.config as any;\n  const identity = config.identity ?? {};\n  const serviceAreas: string[] = identity.serviceAreas ?? [];\n  const domain = tenant.custom_domain ?? `${tenant.subdomain}.${process.env.NEXT_PUBLIC_ROOT_DOMAIN}`;\n  const siteUrl = `https://${domain}`;\n\n  // Validate: area must be in the configured service areas\n  const areaName = deslugifyArea(slug);\n  const isValidArea = serviceAreas.some(\n    (a: string) => slugifyArea(a) === slug || a.toLowerCase() === areaName.toLowerCase()\n  );\n\n  if (!isValidArea) return notFound();\n\n  const city = areaName.split(',')[0].trim();\n  const state = areaName.split(',') [kreativekommit](https://kreativekommit.com/guides/2025/07/ssr-nextjs-local-seo)?.trim() ?? identity.address?.state ?? '';\n  const services = identity.services ?? [];\n  const industry = identity.industry ?? 'services';\n\n  // Build page-specific LocalBusiness schema (override city with service area city)\n  const localSchema = {\n    ...buildLocalBusinessSchema(config),\n    name: `${identity.siteName} â€” ${city}`,\n    description: `Professional ${industry} services in ${city}, ${state}. ${identity.tagline ?? ''}`,\n    areaServed: [{ '@type': 'City', name: city }],\n  };\n\n  const breadcrumbSchema = buildBreadcrumbSchema(siteUrl, identity.siteName, [\n    { name: 'Service Areas', url: `${siteUrl}/service-areas` },\n    { name: city, url: `${siteUrl}/service-area/${slug}` },\n  ]);\n\n  const calUsername = null; // Fetched from secrets only if needed client-side\n\n  return (\n    <>\n      {/* Structured Data */}\n      <JsonLd schema={localSchema} />\n      <JsonLd schema={breadcrumbSchema} />\n      {services.slice(0, 3).map((service: any) => (\n        <JsonLd\n          key={service.slug}\n          schema={buildServiceSchema(config, service)}\n        />\n      ))}\n\n      {/* Page content */}\n      <main id=\"main-content\">\n        <ServiceAreaHero\n          city={city}\n          state={state}\n          businessName={identity.siteName}\n          industry={industry}\n          tagline={identity.tagline}\n          phone={identity.contact?.phone}\n          primaryColor={config.theme?.colors?.primary}\n        />\n\n        <ServiceAreaServices\n          city={city}\n          services={services}\n          businessName={identity.siteName}\n          industry={industry}\n        />\n\n        {identity.testimonials?.length > 0 && (\n          <ServiceAreaTestimonials\n            testimonials={identity.testimonials}\n            city={city}\n          />\n        )}\n\n        <section className=\"py-16 bg-gray-50\" aria-label=\"Contact us\">\n          <div className=\"container mx-auto px-6\">\n            <h2 className=\"text-3xl font-bold text-gray-900 text-center mb-4\">\n              Get a Free Estimate in {city}\n            </h2>\n            <p className=\"text-gray-500 text-center mb-10 max-w-xl mx-auto\">\n              Serving {city} and the surrounding {state} area. Response within 1 business hour.\n            </p>\n            <ContactFormSection\n              tenantId={tenantId}\n              metadata={{ serviceArea: slug, city, state }}\n            />\n          </div>\n        </section>\n\n        {/* Internal links to other service areas (SEO: link equity distribution) */}\n        <RelatedServiceAreas\n          currentSlug={slug}\n          areas={serviceAreas}\n          siteUrl={siteUrl}\n        />\n      </main>\n    </>\n  );\n}\n\n// â”€â”€ Related areas nav (internal linking) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nfunction RelatedServiceAreas({\n  currentSlug,\n  areas,\n  siteUrl,\n}: {\n  currentSlug: string;\n  areas: string[];\n  siteUrl: string;\n}) {\n  const others = areas\n    .filter((a) => slugifyArea(a) !== currentSlug)\n    .slice(0, 8);\n\n  if (others.length === 0) return null;\n\n  return (\n    <nav\n      aria-label=\"Other service areas\"\n      className=\"py-12 bg-white border-t border-gray-100\"\n    >\n      <div className=\"container mx-auto px-6\">\n        <h2 className=\"text-lg font-semibold text-gray-700 mb-4\">\n          Also Serving:\n        </h2>\n        <ul className=\"flex flex-wrap gap-3\" role=\"list\">\n          {others.map((area) => (\n            <li key={area}>\n              <a\n                href={`${siteUrl}/service-area/${slugifyArea(area)}`}\n                className=\"px-4 py-2 bg-gray-100 hover:bg-primary/10 hover:text-primary text-gray-700 rounded-full text-sm transition-colors\"\n              >\n                {area}\n              </a>\n            </li>\n          ))}\n        </ul>\n      </div>\n    </nav>\n  );\n}\n\n// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nfunction slugifyArea(area: string): string {\n  return area\n    .toLowerCase()\n    .replace(/,\\s*/g, '-')\n    .replace(/\\s+/g, '-')\n    .replace(/[^a-z0-9-]/g, '');\n}\n\nfunction deslugifyArea(slug: string): string {\n  // \"plano-tx\" â†’ \"Plano, TX\"\n  // \"north-richland-hills-tx\" â†’ \"North Richland Hills, TX\"\n  const parts = slug.split('-');\n  const stateAbbr = parts[parts.length - 1]?.toUpperCase();\n  const US_STATES = ['TX', 'CA', 'FL', 'NY', 'IL', 'PA', 'OH', 'GA', 'NC', 'MI',\n    'NJ', 'VA', 'WA', 'AZ', 'MA', 'TN', 'IN', 'MO', 'MD', 'WI', 'CO', 'MN',\n    'SC', 'AL', 'LA', 'KY', 'OR', 'OK', 'CT', 'UT', 'NV', 'AR', 'MS', 'KS',\n    'NM', 'NE', 'WV', 'ID', 'HI', 'NH', 'ME', 'MT', 'RI', 'DE', 'SD', 'ND',\n    'AK', 'VT', 'WY', 'DC'];\n\n  if (US_STATES.includes(stateAbbr ?? '')) {\n    const cityParts = parts.slice(0, -1);\n    const city = cityParts\n      .map((w) => w.charAt(0).toUpperCase() + w.slice(1))\n      .join(' ');\n    return `${city}, ${stateAbbr}`;\n  }\n\n  // No state abbr detected â€” treat whole slug as city name\n  return parts.map((w) => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');\n}\n```\n\n---\n",
            "domainNumber": 27
          }
        },
        {
          "domainNumber": 27,
          "fileName": "DOMAIN-27-service-section-service.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-27\\DOMAIN-27-service-section-service.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "27.3-service-area-hero-component.md",
            "title": "Section service",
            "description": "Implementation for domain 27 section service",
            "topics": ["Domain 27 implementation"],
            "sectionNumber": "service",
            "content": "### 27.3 Service Area Hero Component\n\n**File:** `apps/*/src/components/service-area/ServiceAreaHero.tsx`\n\n```typescript\ninterface ServiceAreaHeroProps {\n  city: string;\n  state: string;\n  businessName: string;\n  industry: string;\n  tagline?: string;\n  phone?: string;\n  primaryColor?: string;\n}\n\nexport function ServiceAreaHero({\n  city,\n  state,\n  businessName,\n  industry,\n  tagline,\n  phone,\n  primaryColor = '#2563eb',\n}: ServiceAreaHeroProps) {\n  const industryLabel = industry.charAt(0).toUpperCase() + industry.slice(1);\n\n  return (\n    <section\n      className=\"relative py-20 px-6 text-center overflow-hidden\"\n      style={{ backgroundColor: `${primaryColor}08` }}\n      aria-labelledby=\"area-hero-heading\"\n    >\n      {/* Geo badge */}\n      <div className=\"inline-flex items-center gap-2 bg-white border border-gray-200 rounded-full px-4 py-1.5 text-sm text-gray-600 mb-6 shadow-sm\">\n        <svg className=\"h-4 w-4 text-red-500\" fill=\"currentColor\" viewBox=\"0 0 20 20\" aria-hidden=\"true\">\n          <path fillRule=\"evenodd\" d=\"M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z\" clipRule=\"evenodd\" />\n        </svg>\n        Serving {city}, {state}\n      </div>\n\n      <h1\n        id=\"area-hero-heading\"\n        className=\"text-4xl sm:text-5xl font-extrabold text-gray-900 mb-4 leading-tight max-w-3xl mx-auto\"\n      >\n        {industryLabel} Services{' '}\n        <span style={{ color: primaryColor }}>in {city}</span>\n      </h1>\n\n      {tagline && (\n        <p className=\"text-xl text-gray-500 mb-8 max-w-2xl mx-auto\">\n          {tagline}\n        </p>\n      )}\n\n      <div className=\"flex flex-col sm:flex-row gap-4 justify-center\">\n        {phone && (\n          <a\n            href={`tel:${phone}`}\n            className=\"inline-flex items-center justify-center gap-2 px-8 py-4 text-white rounded-xl font-bold text-lg shadow-lg hover:opacity-90 transition-opacity\"\n            style={{ backgroundColor: primaryColor }}\n            aria-label={`Call ${businessName} at ${phone}`}\n          >\n            <svg className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" aria-hidden=\"true\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.948V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 7V5z\" />\n            </svg>\n            Call {phone}\n          </a>\n        )}\n\n        <a\n          href=\"#contact\"\n          className=\"inline-flex items-center justify-center gap-2 px-8 py-4 bg-white border-2 rounded-xl font-bold text-lg hover:bg-gray-50 transition-colors\"\n          style={{ borderColor: primaryColor, color: primaryColor }}\n        >\n          Get a Free Estimate\n        </a>\n      </div>\n\n      {/* Trust signals */}\n      <div className=\"mt-10 flex flex-wrap justify-center gap-6 text-sm text-gray-500\">\n        {['Licensed & Insured', 'Free Estimates', 'Same-Day Service', '5-Star Rated'].map((signal) => (\n          <div key={signal} className=\"flex items-center gap-1.5\">\n            <svg className=\"h-4 w-4 text-green-500 flex-shrink-0\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" aria-hidden=\"true\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2.5} d=\"M5 13l4 4L19 7\" />\n            </svg>\n            {signal}\n          </div>\n        ))}\n      </div>\n    </section>\n  );\n}\n```\n\n---\n",
            "domainNumber": 27
          }
        },
        {
          "domainNumber": 27,
          "fileName": "DOMAIN-27-service-section-service.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-27\\DOMAIN-27-service-section-service.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "27.4-service-area-job-cache-invalidation-on-config-change.md",
            "title": "Section service",
            "description": "Implementation for domain 27 section service",
            "topics": ["Domain 27 implementation"],
            "sectionNumber": "service",
            "content": "### 27.4 Service Area Job: Cache Invalidation on Config Change\n\nWhen the client updates their service areas via the portal, the relevant service area page caches must be busted. This is done via a tag-based `revalidateTag` call.\n\n**File:** `packages/cache/src/invalidate-tenant.ts`\n\n```typescript\nimport { revalidateTag } from 'next/cache';\n\nexport async function invalidateTenantServiceAreas(\n  tenantId: string,\n  changedSlugs?: string[]\n): Promise<void> {\n  if (changedSlugs?.length) {\n    // Bust only the changed areas\n    for (const slug of changedSlugs) {\n      revalidateTag(`tenant:${tenantId}:service-area:${slug}`);\n    }\n  } else {\n    // Bust all service area pages for this tenant\n    revalidateTag(`tenant:${tenantId}:service-area`);\n  }\n\n  // Also bust the sitemap (now includes new/removed areas)\n  revalidateTag(`tenant:${tenantId}:sitemap`);\n}\n```\n\n---\n",
            "domainNumber": 27
          }
        }
      ]
    },
    {
      "domainNumber": 28,
      "success": true,
      "tasksCreated": 5,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 28,
          "fileName": "DOMAIN-28-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-28\\DOMAIN-28-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "28.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 28 section philosophy.md",
            "topics": ["Domain 28 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 28.1 Philosophy\n\n**What it is:** Sanity v3 is the headless CMS powering the blog/content section of each client's marketing site. Content editors (the agency, or the client via Sanity Studio) publish posts, and the marketing site fetches them via GROQ queries with on-demand ISR via Sanity webhooks. The result: a Google-indexed blog with fresh content, zero build-time latency, and zero manual deployment steps. [buttercups](https://www.buttercups.tech/blog/react/sanity-integration-guide-for-nextjs-app-router-users)\n\n**Multi-tenant content isolation:** All tenants share one Sanity project (cost savings), with content isolated by a required `tenantId` field on every document. All GROQ queries include `&& tenantId == $tenantId` â€” no tenant sees another tenant's posts. Premium plan clients can get a dedicated Sanity project with their own Studio subdomain. [github](https://github.com/sanity-io/next-sanity)\n\n---\n",
            "domainNumber": 28
          }
        },
        {
          "domainNumber": 28,
          "fileName": "DOMAIN-28-sanity-section-sanity.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-28\\DOMAIN-28-sanity-section-sanity.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "28.2-sanity-schema.md",
            "title": "Section sanity",
            "description": "Implementation for domain 28 section sanity",
            "topics": ["Domain 28 implementation"],
            "sectionNumber": "sanity",
            "content": "### 28.2 Sanity Schema\n\n**File:** `packages/content/schemas/post.ts`\n\n```typescript\nimport { defineField, defineType } from 'sanity';\n\nexport const post = defineType({\n  name: 'post',\n  title: 'Blog Post',\n  type: 'document',\n  fields: [\n    // Required: tenant isolation\n    defineField({\n      name: 'tenantId',\n      title: 'Tenant ID',\n      type: 'string',\n      readOnly: true, // Set programmatically on create, never editable\n      hidden: ({ currentUser }) => {\n        // Hide from editors who aren't super-admins â€” they only see their tenant's posts\n        return !currentUser?.roles?.some((r: any) => r.name === 'administrator');\n      },\n      validation: (Rule) => Rule.required(),\n    }),\n\n    defineField({\n      name: 'title',\n      title: 'Title',\n      type: 'string',\n      validation: (Rule) => Rule.required().max(80),\n    }),\n\n    defineField({\n      name: 'slug',\n      title: 'Slug',\n      type: 'slug',\n      options: { source: 'title', maxLength: 96 },\n      validation: (Rule) => Rule.required(),\n    }),\n\n    defineField({\n      name: 'author',\n      title: 'Author',\n      type: 'object',\n      fields: [\n        { name: 'name', type: 'string', title: 'Name' },\n        { name: 'role', type: 'string', title: 'Role' },\n        { name: 'avatar', type: 'image', title: 'Avatar' },\n      ],\n    }),\n\n    defineField({\n      name: 'mainImage',\n      title: 'Main Image',\n      type: 'image',\n      options: { hotspot: true },\n      fields: [\n        { name: 'alt', type: 'string', title: 'Alt text', validation: (Rule) => Rule.required() },\n        { name: 'caption', type: 'string', title: 'Caption' },\n      ],\n    }),\n\n    defineField({\n      name: 'categories',\n      title: 'Categories',\n      type: 'array',\n      of: [{ type: 'string' }],\n      options: {\n        list: [\n          { title: 'Tips & Guides', value: 'tips-guides' },\n          { title: 'Company News', value: 'company-news' },\n          { title: 'Industry News', value: 'industry-news' },\n          { title: 'Case Studies', value: 'case-studies' },\n          { title: 'FAQs', value: 'faqs' },\n        ],\n      },\n    }),\n\n    defineField({\n      name: 'publishedAt',\n      title: 'Published At',\n      type: 'datetime',\n      validation: (Rule) => Rule.required(),\n    }),\n\n    defineField({\n      name: 'excerpt',\n      title: 'Excerpt',\n      type: 'text',\n      rows: 3,\n      description: 'Used in post cards and meta description (max 160 chars)',\n      validation: (Rule) => Rule.max(160),\n    }),\n\n    // Portable Text body\n    defineField({\n      name: 'body',\n      title: 'Body',\n      type: 'array',\n      of: [\n        { type: 'block' },\n        {\n          type: 'image',\n          options: { hotspot: true },\n          fields: [\n            {\n              name: 'alt',\n              type: 'string',\n              title: 'Alt text',\n              validation: (Rule) => Rule.required(),\n            },\n            { name: 'caption', type: 'string', title: 'Caption' },\n          ],\n        },\n        // Custom block: Call-to-action button\n        {\n          name: 'cta',\n          title: 'Call to Action',\n          type: 'object',\n          fields: [\n            { name: 'text', type: 'string', title: 'Button text' },\n            { name: 'href', type: 'url', title: 'URL' },\n          ],\n        },\n      ],\n    }),\n\n    // SEO overrides (optional â€” auto-generated from title/excerpt if omitted)\n    defineField({\n      name: 'seo',\n      title: 'SEO',\n      type: 'object',\n      fields: [\n        { name: 'title', type: 'string', title: 'Meta title (override)' },\n        { name: 'description', type: 'text', title: 'Meta description (override)', rows: 2 },\n        { name: 'noIndex', type: 'boolean', title: 'Hide from search engines' },\n      ],\n    }),\n\n    defineField({\n      name: 'estimatedReadingTime',\n      title: 'Reading time (minutes)',\n      type: 'number',\n      readOnly: true,\n      // Auto-computed by Sanity input component or computed on save\n    }),\n  ],\n\n  orderings: [\n    {\n      title: 'Published (newest first)',\n      name: 'publishedAtDesc',\n      by: [{ field: 'publishedAt', direction: 'desc' }],\n    },\n  ],\n\n  preview: {\n    select: {\n      title: 'title',\n      subtitle: 'publishedAt',\n      media: 'mainImage',\n    },\n    prepare({ title, subtitle, media }) {\n      return {\n        title,\n        subtitle: subtitle ? new Date(subtitle).toLocaleDateString() : 'Draft',\n        media,\n      };\n    },\n  },\n});\n```\n\n---\n",
            "domainNumber": 28
          }
        },
        {
          "domainNumber": 28,
          "fileName": "DOMAIN-28-sanity-section-sanity.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-28\\DOMAIN-28-sanity-section-sanity.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "28.3-sanity-client-groq-queries.md",
            "title": "Section sanity",
            "description": "Implementation for domain 28 section sanity",
            "topics": ["Domain 28 implementation"],
            "sectionNumber": "sanity",
            "content": "### 28.3 Sanity Client + GROQ Queries\n\n**File:** `packages/content/src/sanity-client.ts`\n\n```typescript\nimport { createClient } from 'next-sanity';\nimport imageUrlBuilder from '@sanity/image-url';\nimport type { SanityImageSource } from '@sanity/image-url/lib/types/types';\n\nexport const sanityClient = createClient({\n  projectId: process.env.NEXT_PUBLIC_SANITY_PROJECT_ID!,\n  dataset: process.env.NEXT_PUBLIC_SANITY_DATASET ?? 'production',\n  apiVersion: '2025-01-01',\n  useCdn: true, // CDN for public reads; disabled for preview mode\n  // Stega encoding disabled in production (for Visual Editing in Studio only)\n  stega: {\n    enabled: process.env.NEXT_PUBLIC_SANITY_STEGA === 'true',\n    studioUrl: process.env.NEXT_PUBLIC_SANITY_STUDIO_URL,\n  },\n});\n\n// Stega-disabled client for non-preview reads (faster)\nexport const sanityClientPublic = sanityClient.withConfig({ stega: false });\n\n// Image URL builder\nconst builder = imageUrlBuilder(sanityClient);\nexport function urlFor(source: SanityImageSource) {\n  return builder.image(source);\n}\n\n// ============================================================================\n// GROQ QUERIES\n// All queries include tenantId filter â€” non-negotiable for multi-tenant\n// ============================================================================\n\n// Projection shared across list and detail views\nconst POST_CARD_PROJECTION = `{\n  _id,\n  title,\n  \"slug\": slug.current,\n  publishedAt,\n  excerpt,\n  estimatedReadingTime,\n  categories,\n  mainImage { asset->, alt },\n  author { name, role, \"avatarUrl\": avatar.asset->url }\n}`;\n\nexport const POSTS_LIST_QUERY = `\n  *[_type == \"post\" && tenantId == $tenantId && !(_id in path(\"drafts.**\")) && !coalesce(seo.noIndex, false)]\n  | order(publishedAt desc)\n  [$from...$to]\n  ${POST_CARD_PROJECTION}\n`;\n\nexport const POSTS_COUNT_QUERY = `\n  count(*[_type == \"post\" && tenantId == $tenantId && !(_id in path(\"drafts.**\"))])\n`;\n\nexport const POST_BY_SLUG_QUERY = `\n  *[_type == \"post\" && tenantId == $tenantId && slug.current == $slug && !(_id in path(\"drafts.**\"))][0] {\n    _id,\n    title,\n    \"slug\": slug.current,\n    publishedAt,\n    excerpt,\n    estimatedReadingTime,\n    categories,\n    mainImage { asset->, alt, caption },\n    author { name, role, \"avatarUrl\": avatar.asset->url },\n    body[] {\n      ...,\n      _type == \"image\" => {\n        asset->,\n        alt,\n        caption\n      }\n    },\n    seo\n  }\n`;\n\nexport const RELATED_POSTS_QUERY = `\n  *[\n    _type == \"post\"\n    && tenantId == $tenantId\n    && slug.current != $currentSlug\n    && !(_id in path(\"drafts.**\"))\n    && count(categories[@ in $categories]) > 0\n  ]\n  | order(publishedAt desc)\n  [0...3]\n  ${POST_CARD_PROJECTION}\n`;\n\nexport const ALL_POST_SLUGS_QUERY = `\n  *[_type == \"post\" && tenantId == $tenantId && !(_id in path(\"drafts.**\"))] {\n    \"slug\": slug.current\n  }\n`;\n```\n\n---\n",
            "domainNumber": 28
          }
        },
        {
          "domainNumber": 28,
          "fileName": "DOMAIN-28-blog-section-blog.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-28\\DOMAIN-28-blog-section-blog.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "28.4-blog-post-page-isr-on-demand-revalidation.md",
            "title": "Section blog",
            "description": "Implementation for domain 28 section blog",
            "topics": ["Domain 28 implementation"],
            "sectionNumber": "blog",
            "content": "### 28.4 Blog Post Page (ISR + On-Demand Revalidation)\n\n**File:** `apps/*/src/app/blog/[slug]/page.tsx`\n\n```typescript\nimport type { Metadata } from 'next';\nimport { notFound } from 'next/navigation';\nimport { headers } from 'next/headers';\nimport { cacheLife, cacheTag } from 'next/cache';\nimport { PortableText } from '@portabletext/react';\nimport { resolveTenant } from '@repo/multi-tenant/resolve-tenant';\nimport { db } from '@repo/db';\nimport {\n  sanityClientPublic,\n  POST_BY_SLUG_QUERY,\n  RELATED_POSTS_QUERY,\n  ALL_POST_SLUGS_QUERY,\n  urlFor,\n} from '@repo/content/sanity-client';\nimport { buildMetadata } from '@repo/seo/metadata-factory';\nimport { buildBreadcrumbSchema, JsonLd } from '@repo/seo/structured-data';\nimport Image from 'next/image';\n\nexport const dynamicParams = true;\n\n// Seed existing post slugs at build time\nexport async function generateStaticParams() {\n  // Minimal: generate for the first 50 posts across all active tenants\n  // Long-tail posts use on-demand ISR\n  const allTenants = await db\n    .from('tenants')\n    .select('id')\n    .eq('status', 'active')\n    .limit(100);\n\n  const params: { slug: string }[] = [];\n\n  for (const tenant of allTenants.data ?? []) {\n    const slugs = await sanityClientPublic.fetch<{ slug: string }[]>(\n      ALL_POST_SLUGS_QUERY,\n      { tenantId: tenant.id }\n    );\n    slugs.slice(0, 10).forEach((s) => params.push({ slug: s.slug }));\n  }\n\n  return params;\n}\n\nexport async function generateMetadata({\n  params,\n}: {\n  params: Promise<{ slug: string }>;\n}): Promise<Metadata> {\n  const { slug } = await params;\n  const headersList = await headers();\n  const tenantContext = await resolveTenant({ headers: headersList } as any);\n  if (!tenantContext) return {};\n\n  const { data: tenant } = await db\n    .from('tenants')\n    .select('config')\n    .eq('id', tenantContext.tenantId)\n    .single();\n\n  const config = tenant?.config as any;\n  if (!config) return {};\n\n  const post = await sanityClientPublic.fetch(\n    POST_BY_SLUG_QUERY,\n    { tenantId: tenantContext.tenantId, slug }\n  );\n\n  if (!post) return {};\n\n  const ogImage = post.mainImage?.asset?.url\n    ? urlFor(post.mainImage).width(1200).height(630).fit('crop').url()\n    : undefined;\n\n  return buildMetadata({\n    config,\n    path: `/blog/${slug}`,\n    pageTitle: post.seo?.title ?? post.title,\n    pageDescription: post.seo?.description ?? post.excerpt,\n    ogImage,\n    noIndex: post.seo?.noIndex ?? false,\n  });\n}\n\nexport default async function BlogPostPage({\n  params,\n}: {\n  params: Promise<{ slug: string }>;\n}) {\n  'use cache';\n\n  const { slug } = await params;\n  const headersList = await headers();\n\n  const tenantContext = await resolveTenant({ headers: headersList } as any);\n  if (!tenantContext) return notFound();\n\n  const { tenantId } = tenantContext;\n\n  cacheTag(`tenant:${tenantId}:blog:${slug}`);\n  cacheLife({ revalidate: 3600 }); // 1h fallback; on-demand webhook busts earlier\n\n  const { data: tenant } = await db\n    .from('tenants')\n    .select('config, custom_domain, subdomain')\n    .eq('id', tenantId)\n    .single();\n\n  const config = tenant?.config as any;\n  const domain = tenant?.custom_domain ?? `${tenant?.subdomain}.${process.env.NEXT_PUBLIC_ROOT_DOMAIN}`;\n  const siteUrl = `https://${domain}`;\n\n  const [post, relatedPosts] = await Promise.all([\n    sanityClientPublic.fetch(POST_BY_SLUG_QUERY, { tenantId, slug }),\n    sanityClientPublic.fetch(RELATED_POSTS_QUERY, {\n      tenantId,\n      currentSlug: slug,\n      categories: [],\n    }),\n  ]);\n\n  if (!post) return notFound();\n\n  const articleSchema = {\n    '@context': 'https://schema.org',\n    '@type': 'BlogPosting',\n    headline: post.title,\n    description: post.excerpt,\n    datePublished: post.publishedAt,\n    dateModified: post.publishedAt,\n    author: {\n      '@type': 'Person',\n      name: post.author?.name ?? config?.identity?.siteName,\n    },\n    publisher: {\n      '@type': 'Organization',\n      name: config?.identity?.siteName,\n      logo: {\n        '@type': 'ImageObject',\n        url: config?.assets?.logo,\n      },\n    },\n    image: post.mainImage?.asset?.url,\n    url: `${siteUrl}/blog/${slug}`,\n    mainEntityOfPage: { '@type': 'WebPage', '@id': `${siteUrl}/blog/${slug}` },\n    ...(post.estimatedReadingTime ? {\n      timeRequired: `PT${post.estimatedReadingTime}M`,\n    } : {}),\n  };\n\n  const breadcrumbSchema = buildBreadcrumbSchema(\n    siteUrl,\n    config?.identity?.siteName ?? '',\n    [\n      { name: 'Blog', url: `${siteUrl}/blog` },\n      { name: post.title, url: `${siteUrl}/blog/${slug}` },\n    ]\n  );\n\n  return (\n    <>\n      <JsonLd schema={articleSchema} />\n      <JsonLd schema={breadcrumbSchema} />\n\n      <main id=\"main-content\" className=\"py-12 px-6\">\n        <article className=\"max-w-3xl mx-auto\" aria-label={post.title}>\n          {/* Breadcrumb */}\n          <nav aria-label=\"Breadcrumb\" className=\"text-sm text-gray-500 mb-8 flex items-center gap-2\">\n            <a href={siteUrl} className=\"hover:text-primary\">Home</a>\n            <span aria-hidden=\"true\">â€º</span>\n            <a href={`${siteUrl}/blog`} className=\"hover:text-primary\">Blog</a>\n            <span aria-hidden=\"true\">â€º</span>\n            <span className=\"text-gray-900 truncate\">{post.title}</span>\n          </nav>\n\n          {/* Categories */}\n          {post.categories?.length > 0 && (\n            <div className=\"flex gap-2 flex-wrap mb-4\">\n              {post.categories.map((cat: string) => (\n                <span\n                  key={cat}\n                  className=\"bg-primary/10 text-primary text-xs font-semibold px-3 py-1 rounded-full capitalize\"\n                >\n                  {cat.replace(/-/g, ' ')}\n                </span>\n              ))}\n            </div>\n          )}\n\n          {/* Title */}\n          <h1 className=\"text-4xl font-extrabold text-gray-900 leading-tight mb-4\">\n            {post.title}\n          </h1>\n\n          {/* Meta row */}\n          <div className=\"flex items-center gap-4 text-sm text-gray-500 mb-8\">\n            {post.author?.name && (\n              <div className=\"flex items-center gap-2\">\n                {post.author.avatarUrl && (\n                  <Image\n                    src={post.author.avatarUrl}\n                    alt={post.author.name}\n                    width={28}\n                    height={28}\n                    className=\"rounded-full\"\n                  />\n                )}\n                <span>{post.author.name}</span>\n              </div>\n            )}\n            {post.publishedAt && (\n              <time dateTime={post.publishedAt}>\n                {new Date(post.publishedAt).toLocaleDateString('en-US', {\n                  year: 'numeric',\n                  month: 'long',\n                  day: 'numeric',\n                })}\n              </time>\n            )}\n            {post.estimatedReadingTime && (\n              <span>{post.estimatedReadingTime} min read</span>\n            )}\n          </div>\n\n          {/* Hero image */}\n          {post.mainImage?.asset && (\n            <div className=\"relative aspect-video mb-10 rounded-2xl overflow-hidden\">\n              <Image\n                src={urlFor(post.mainImage).width(1200).height(630).url()}\n                alt={post.mainImage.alt ?? post.title}\n                fill\n                className=\"object-cover\"\n                priority\n                sizes=\"(max-width: 768px) 100vw, 768px\"\n              />\n              {post.mainImage.caption && (\n                <p className=\"absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs px-4 py-2\">\n                  {post.mainImage.caption}\n                </p>\n              )}\n            </div>\n          )}\n\n          {/* Portable Text body */}\n          <div className=\"prose prose-lg prose-gray max-w-none prose-headings:font-extrabold prose-a:text-primary\">\n            <PortableText\n              value={post.body}\n              components={portableTextComponents}\n            />\n          </div>\n        </article>\n\n        {/* Related posts */}\n        {relatedPosts?.length > 0 && (\n          <aside className=\"max-w-3xl mx-auto mt-16 pt-12 border-t border-gray-200\" aria-label=\"Related posts\">\n            <h2 className=\"text-2xl font-bold text-gray-900 mb-6\">Related Articles</h2>\n            <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-6\">\n              {relatedPosts.map((rp: any) => (\n                <a key={rp._id} href={`${siteUrl}/blog/${rp.slug}`} className=\"group block\">\n                  <p className=\"font-semibold text-gray-900 group-hover:text-primary transition-colors line-clamp-2\">\n                    {rp.title}\n                  </p>\n                  <p className=\"text-sm text-gray-500 mt-1\">\n                    {new Date(rp.publishedAt).toLocaleDateString()}\n                  </p>\n                </a>\n              ))}\n            </div>\n          </aside>\n        )}\n      </main>\n    </>\n  );\n}\n\n// â”€â”€ Portable Text custom components â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst portableTextComponents = {\n  types: {\n    image: ({ value }: any) => (\n      <figure className=\"my-8\">\n        <div className=\"relative rounded-xl overflow-hidden\">\n          <Image\n            src={urlFor(value).width(800).url()}\n            alt={value.alt ?? ''}\n            width={800}\n            height={450}\n            className=\"w-full h-auto\"\n          />\n        </div>\n        {value.caption && (\n          <figcaption className=\"text-sm text-gray-500 text-center mt-2\">\n            {value.caption}\n          </figcaption>\n        )}\n      </figure>\n    ),\n    cta: ({ value }: any) => (\n      <div className=\"my-8 flex justify-center\">\n        <a\n          href={value.href}\n          className=\"inline-flex items-center gap-2 px-6 py-3 bg-primary text-white rounded-xl font-semibold hover:opacity-90 transition-opacity\"\n        >\n          {value.text}\n        </a>\n      </div>\n    ),\n  },\n  marks: {\n    link: ({ children, value }: any) => (\n      <a\n        href={value.href}\n        target={value.href?.startsWith('http') ? '_blank' : undefined}\n        rel={value.href?.startsWith('http') ? 'noopener noreferrer' : undefined}\n      >\n        {children}\n      </a>\n    ),\n  },\n};\n```\n\n---\n",
            "domainNumber": 28
          }
        },
        {
          "domainNumber": 28,
          "fileName": "DOMAIN-28-sanity-section-sanity.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-28\\DOMAIN-28-sanity-section-sanity.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "28.5-sanity-webhook-on-demand-isr.md",
            "title": "Section sanity",
            "description": "Implementation for domain 28 section sanity",
            "topics": ["Domain 28 implementation"],
            "sectionNumber": "sanity",
            "content": "### 28.5 Sanity Webhook â†’ On-Demand ISR\n\n**File:** `apps/*/src/app/api/webhooks/sanity/route.ts`\n\n```typescript\nimport { type NextRequest, NextResponse } from 'next/server';\nimport { parseBody } from 'next-sanity/webhook';\nimport { revalidateTag, revalidatePath } from 'next/cache';\n\n// ============================================================================\n// SANITY WEBHOOK HANDLER\n// Triggered by GROQ-powered webhook in Sanity project settings.\n// Webhook filter: _type == \"post\"\n// Payload: { _type, slug: { current }, tenantId }\n// Reference: https://www.sanity.io/learn/course/controlling-cached-content-in-next-js/tag-based-revalidation\n// ============================================================================\n\nexport const dynamic = 'force-dynamic';\n\nexport async function POST(req: NextRequest) {\n  try {\n    const { body, isValidSignature } = await parseBody<SanityWebhookBody>(\n      req,\n      process.env.SANITY_REVALIDATE_SECRET!\n    );\n\n    if (!isValidSignature) {\n      return NextResponse.json({ message: 'Invalid signature' }, { status: 401 });\n    }\n\n    if (!body?._type) {\n      return NextResponse.json({ message: 'Invalid body' }, { status: 400 });\n    }\n\n    const { _type, slug, tenantId } = body;\n\n    switch (_type) {\n      case 'post': {\n        const slugCurrent = slug?.current;\n        if (slugCurrent && tenantId) {\n          // Bust the specific post\n          revalidateTag(`tenant:${tenantId}:blog:${slugCurrent}`);\n        }\n        // Bust the blog index (post list order/count changed)\n        if (tenantId) {\n          revalidateTag(`tenant:${tenantId}:blog`);\n          // Also bust sitemap (new/removed post affects sitemap.xml)\n          revalidateTag(`tenant:${tenantId}:sitemap`);\n        }\n        break;\n      }\n      default:\n        console.log(`[Sanity Webhook] Unhandled type: ${_type}`);\n    }\n\n    return NextResponse.json({\n      revalidated: true,\n      now: Date.now(),\n      type: _type,\n    });\n  } catch (err: any) {\n    console.error('[Sanity Webhook] Error:', err.message);\n    return NextResponse.json({ message: err.message }, { status: 500 });\n  }\n}\n\ninterface SanityWebhookBody {\n  _type: string;\n  slug?: { current: string };\n  tenantId?: string;\n}\n```\n\n---\n",
            "domainNumber": 28
          }
        }
      ]
    },
    {
      "domainNumber": 29,
      "success": true,
      "tasksCreated": 4,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 29,
          "fileName": "DOMAIN-29-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-29\\DOMAIN-29-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "29.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 29 section philosophy.md",
            "topics": ["Domain 29 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 29.1 Philosophy\n\n**What it is:** The settings section of the portal â€” where clients update their business info, branding, contact details, integrations, and notification preferences. Every field maps to a path in `site.config`, and changes are persisted via Server Actions with Zod validation, optimistic UI, and deep-merge into the JSONB config column. [nextjs](https://nextjs.org/docs/14/app/building-your-application/data-fetching/server-actions-and-mutations)\n\n**Architecture â€” one schema per settings section:**\nRather than one giant settings form (unmaintainable), settings are split into sections (`identity`, `branding`, `contact`, `hours`, `integrations`, `notifications`). Each section is its own form with its own Zod schema and Server Action. This gives clean error boundaries, granular `revalidateTag` calls, and independent loading states.\n\n---\n",
            "domainNumber": 29
          }
        },
        {
          "domainNumber": 29,
          "fileName": "DOMAIN-29-settings-section-settings.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-29\\DOMAIN-29-settings-section-settings.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "29.2-settings-server-actions.md",
            "title": "Section settings",
            "description": "Implementation for domain 29 section settings",
            "topics": ["Domain 29 implementation"],
            "sectionNumber": "settings",
            "content": "### 29.2 Settings Server Actions\n\n**File:** `apps/portal/src/features/settings/model/settings-actions.ts`\n\n```typescript\n'use server';\n\nimport { z } from 'zod';\nimport { revalidateTag } from 'next/cache';\nimport { createServerAction } from '@repo/auth/server-action-wrapper';\nimport { db } from '@repo/db';\nimport { invalidateTenantServiceAreas } from '@repo/cache/invalidate-tenant';\n\n// ============================================================================\n// SETTINGS ACTIONS\n// Each action handles one settings section independently.\n// All use deep-merge: only specified fields are updated, rest preserved.\n// ============================================================================\n\n// â”€â”€ 1. Identity settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst IdentitySchema = z.object({\n  siteName: z.string().min(2).max(80),\n  tagline: z.string().max(160).optional(),\n  description: z.string().max(500).optional(),\n  industry: z.enum(['hvac', 'plumbing', 'electrical', 'dental', 'medical',\n    'law', 'realEstate', 'accounting', 'restaurant', 'salon', 'general']),\n  priceRange: z.enum(['$', '$$', '$$$', '$$$$']).optional(),\n  yearEstablished: z.number().min(1800).max(new Date().getFullYear()).optional(),\n});\n\nexport const updateIdentitySettings = createServerAction(\n  IdentitySchema,\n  async (input, ctx) => {\n    const { tenantId } = ctx;\n\n    await db.rpc('deep_merge_config', {\n      p_tenant_id: tenantId,\n      p_path: '{identity}',\n      p_value: input,\n    });\n\n    revalidateTag(`tenant:${tenantId}`);\n    revalidateTag(`tenant:${tenantId}:sitemap`);\n\n    return { success: true };\n  }\n);\n\n// â”€â”€ 2. Contact settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst ContactSchema = z.object({\n  phone: z.string().regex(/^[\\+]?[\\d\\s\\-\\(\\)]{7,20}$/, 'Invalid phone number').optional(),\n  email: z.string().email().optional(),\n  address: z.object({\n    street: z.string().max(100).optional(),\n    city: z.string().max(80),\n    state: z.string().length(2).toUpperCase(),\n    zip: z.string().regex(/^\\d{5}(-\\d{4})?$/).optional(),\n  }).optional(),\n  coordinates: z.object({\n    lat: z.number().min(-90).max(90),\n    lng: z.number().min(-180).max(180),\n  }).optional(),\n});\n\nexport const updateContactSettings = createServerAction(\n  ContactSchema,\n  async (input, ctx) => {\n    const { tenantId } = ctx;\n\n    await db.rpc('deep_merge_config', {\n      p_tenant_id: tenantId,\n      p_path: '{identity,contact}',\n      p_value: { ...input.address ? { address: input.address } : {},\n                 ...input.coordinates ? { coordinates: input.coordinates } : {},\n                 ...input.phone ? { contact: { phone: input.phone, email: input.email } } : {} },\n    });\n\n    revalidateTag(`tenant:${tenantId}`);\n    return { success: true };\n  }\n);\n\n// â”€â”€ 3. Service areas settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst ServiceAreasSchema = z.object({\n  serviceAreas: z.array(z.string().min(2).max(60)).min(1).max(50),\n});\n\nexport const updateServiceAreasSettings = createServerAction(\n  ServiceAreasSchema,\n  async (input, ctx) => {\n    const { tenantId } = ctx;\n\n    // Fetch current areas before update (for cache invalidation delta)\n    const { data: current } = await db\n      .from('tenants')\n      .select('config->identity->serviceAreas')\n      .eq('id', tenantId)\n      .single();\n\n    const previousAreas: string[] = (current as any)?.['config->identity->serviceAreas'] ?? [];\n\n    await db.rpc('deep_merge_config', {\n      p_tenant_id: tenantId,\n      p_path: '{identity}',\n      p_value: { serviceAreas: input.serviceAreas },\n    });\n\n    // Invalidate only removed areas (added areas have no cache to bust)\n    const removedAreas = previousAreas.filter((a) => !input.serviceAreas.includes(a));\n    await invalidateTenantServiceAreas(tenantId, removedAreas.map(slugifyArea));\n\n    revalidateTag(`tenant:${tenantId}:sitemap`);\n\n    return { success: true };\n  }\n);\n\n// â”€â”€ 4. Business hours settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst HoursSchema = z.object({\n  hours: z.array(z.object({\n    days: z.array(z.enum(['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'])),\n    opens: z.string().regex(/^( [kreativekommit](https://kreativekommit.com/guides/2025/07/ssr-nextjs-local-seo)\\d|2[0-3]):([0-5]\\d)$/, 'Use HH:MM format'),\n    closes: z.string().regex(/^( [kreativekommit](https://kreativekommit.com/guides/2025/07/ssr-nextjs-local-seo)\\d|2[0-3]):([0-5]\\d)$/, 'Use HH:MM format'),\n  })).max(7),\n});\n\nexport const updateHoursSettings = createServerAction(\n  HoursSchema,\n  async (input, ctx) => {\n    await db.rpc('deep_merge_config', {\n      p_tenant_id: ctx.tenantId,\n      p_path: '{identity}',\n      p_value: { hours: input.hours },\n    });\n\n    revalidateTag(`tenant:${ctx.tenantId}`);\n    return { success: true };\n  }\n);\n\n// â”€â”€ 5. Notification preferences â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst NotificationsSchema = z.object({\n  leadEmail: z.object({\n    enabled: z.boolean(),\n    scoreThreshold: z.number().min(0).max(100),\n    digestEnabled: z.boolean(),\n    digestTime: z.string().regex(/^( [kreativekommit](https://kreativekommit.com/guides/2025/07/ssr-nextjs-local-seo)\\d|2[0-3]):([0-5]\\d)$/),\n  }),\n  bookingEmail: z.object({\n    confirmationEnabled: z.boolean(),\n    reminderEnabled: z.boolean(),\n    followUpEnabled: z.boolean(),\n  }),\n  smsEnabled: z.boolean().optional(),\n  smsPhone: z.string().optional(),\n});\n\nexport const updateNotificationsSettings = createServerAction(\n  NotificationsSchema,\n  async (input, ctx) => {\n    await db\n      .from('tenants')\n      .update({\n        notification_config: input,\n        updated_at: new Date().toISOString(),\n      })\n      .eq('id', ctx.tenantId);\n\n    return { success: true };\n  }\n);\n\n// â”€â”€ 6. Integrations settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst IntegrationsSchema = z.object({\n  googleAnalyticsId: z.string().regex(/^G-[A-Z0-9]+$/).optional().or(z.literal('')),\n  googleTagManagerId: z.string().regex(/^GTM-[A-Z0-9]+$/).optional().or(z.literal('')),\n  facebookPixelId: z.string().regex(/^\\d+$/).optional().or(z.literal('')),\n  googleSiteVerification: z.string().optional(),\n  bingSiteVerification: z.string().optional(),\n});\n\nexport const updateIntegrationsSettings = createServerAction(\n  IntegrationsSchema,\n  async (input, ctx) => {\n    // Store non-empty values only\n    const cleaned = Object.fromEntries(\n      Object.entries(input).filter(([, v]) => v !== '' && v !== undefined)\n    );\n\n    await db.rpc('deep_merge_config', {\n      p_tenant_id: ctx.tenantId,\n      p_path: '{identity}',\n      p_value: cleaned,\n    });\n\n    revalidateTag(`tenant:${ctx.tenantId}`);\n    return { success: true };\n  }\n);\n\nfunction slugifyArea(area: string): string {\n  return area.toLowerCase().replace(/,\\s*/g, '-').replace(/\\s+/g, '-').replace(/[^a-z0-9-]/g, '');\n}\n```\n\n---\n",
            "domainNumber": 29
          }
        },
        {
          "domainNumber": 29,
          "fileName": "DOMAIN-29-deep-section-deep.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-29\\DOMAIN-29-deep-section-deep.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "29.3-deep-merge-config-sql-function.md",
            "title": "Section deep",
            "description": "Implementation for domain 29 section deep",
            "topics": ["Domain 29 implementation"],
            "sectionNumber": "deep",
            "content": "### 29.3 Deep Merge Config SQL Function\n\n```sql\n-- Supabase migration: deep_merge_config RPC\n-- Used by all settings actions to surgically update config paths\n-- without overwriting sibling keys\n\nCREATE OR REPLACE FUNCTION deep_merge_config(\n  p_tenant_id  uuid,\n  p_path       text[],         -- e.g. '{identity}' or '{identity,contact}'\n  p_value      jsonb           -- New values to merge at this path\n)\nRETURNS void\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nDECLARE\n  v_current jsonb;\n  v_merged  jsonb;\nBEGIN\n  -- Get current config (locked for update)\n  SELECT config INTO v_current\n  FROM tenants\n  WHERE id = p_tenant_id\n  FOR UPDATE;\n\n  IF v_current IS NULL THEN\n    RAISE EXCEPTION 'Tenant % not found', p_tenant_id;\n  END IF;\n\n  -- Deep merge: existing value at path is merged with new value\n  -- jsonb_set replaces; we use || (concat) for shallow merge at the path\n  v_merged := jsonb_set(\n    v_current,\n    p_path,\n    COALESCE(v_current #> p_path, '{}') || p_value,\n    true  -- create missing path\n  );\n\n  UPDATE tenants\n  SET config     = v_merged,\n      updated_at = now()\n  WHERE id = p_tenant_id;\nEND;\n$$;\n\n-- Grant execute to authenticated users (RLS still enforced by row ownership)\nGRANT EXECUTE ON FUNCTION deep_merge_config TO authenticated;\n```\n\n---\n",
            "domainNumber": 29
          }
        },
        {
          "domainNumber": 29,
          "fileName": "DOMAIN-29-settings-section-settings.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-29\\DOMAIN-29-settings-section-settings.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "29.4-settings-form-hours-example-most-complex.md",
            "title": "Section settings",
            "description": "Implementation for domain 29 section settings",
            "topics": ["Domain 29 implementation"],
            "sectionNumber": "settings",
            "content": "### 29.4 Settings Form (Hours Example â€” Most Complex)\n\n**File:** `apps/portal/src/features/settings/ui/HoursSettings.tsx`\n\n```typescript\n'use client';\n\nimport { useState, useTransition } from 'react';\nimport { updateHoursSettings } from '../model/settings-actions';\n\nconst DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] as const;\ntype Day = typeof DAYS[number];\n\ninterface HourEntry {\n  days: Day[];\n  opens: string;\n  closes: string;\n}\n\ninterface HoursSettingsProps {\n  initialHours: HourEntry[];\n}\n\nexport function HoursSettings({ initialHours }: HoursSettingsProps) {\n  const [hours, setHours] = useState<HourEntry[]>(\n    initialHours.length > 0 ? initialHours : [\n      { days: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'], opens: '08:00', closes: '17:00' },\n    ]\n  );\n  const [isPending, startTransition] = useTransition();\n  const [error, setError] = useState<string | null>(null);\n  const [saved, setSaved] = useState(false);\n\n  const addHourGroup = () => {\n    setHours((prev) => [...prev, { days: [], opens: '09:00', closes: '17:00' }]);\n  };\n\n  const removeHourGroup = (index: number) => {\n    setHours((prev) => prev.filter((_, i) => i !== index));\n  };\n\n  const toggleDay = (entryIndex: number, day: Day) => {\n    setHours((prev) =>\n      prev.map((entry, i) => {\n        if (i !== entryIndex) return entry;\n        const days = entry.days.includes(day)\n          ? entry.days.filter((d) => d !== day)\n          : [...entry.days, day];\n        return { ...entry, days };\n      })\n    );\n  };\n\n  const handleTimeChange = (entryIndex: number, field: 'opens' | 'closes', value: string) => {\n    setHours((prev) =>\n      prev.map((entry, i) =>\n        i === entryIndex ? { ...entry, [field]: value } : entry\n      )\n    );\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    setError(null);\n    setSaved(false);\n\n    startTransition(async () => {\n      const result = await updateHoursSettings({ hours });\n      if (result.success) {\n        setSaved(true);\n        setTimeout(() => setSaved(false), 3000);\n      } else {\n        setError('Failed to save hours. Please check your entries and try again.');\n      }\n    });\n  };\n\n  return (\n    <form onSubmit={handleSubmit} aria-label=\"Business hours settings\">\n      <h2 className=\"text-lg font-bold text-gray-900 mb-1\">Business Hours</h2>\n      <p className=\"text-sm text-gray-500 mb-6\">\n        Set your operating hours. These appear on your website and in Google search results.\n      </p>\n\n      <div className=\"space-y-4\">\n        {hours.map((entry, entryIndex) => (\n          <div\n            key={entryIndex}\n            className=\"border border-gray-200 rounded-xl p-4 space-y-4 bg-white\"\n          >\n            {/* Day selector */}\n            <div>\n              <p className=\"text-sm font-medium text-gray-700 mb-2\">Days</p>\n              <div className=\"flex flex-wrap gap-2\" role=\"group\" aria-label={`Days for schedule ${entryIndex + 1}`}>\n                {DAYS.map((day) => (\n                  <button\n                    key={day}\n                    type=\"button\"\n                    onClick={() => toggleDay(entryIndex, day)}\n                    className={`\n                      px-3 py-1 rounded-lg text-sm font-medium transition-colors\n                      ${entry.days.includes(day)\n                        ? 'bg-primary text-white'\n                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}\n                    `}\n                    aria-pressed={entry.days.includes(day)}\n                    aria-label={day}\n                  >\n                    {day.slice(0, 3)}\n                  </button>\n                ))}\n              </div>\n            </div>\n\n            {/* Time range */}\n            <div className=\"flex items-center gap-4\">\n              <div>\n                <label\n                  htmlFor={`opens-${entryIndex}`}\n                  className=\"block text-xs font-medium text-gray-500 mb-1\"\n                >\n                  Opens\n                </label>\n                <input\n                  id={`opens-${entryIndex}`}\n                  type=\"time\"\n                  value={entry.opens}\n                  onChange={(e) => handleTimeChange(entryIndex, 'opens', e.target.value)}\n                  className=\"border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary\"\n                />\n              </div>\n              <span className=\"text-gray-400 mt-5\">â€“</span>\n              <div>\n                <label\n                  htmlFor={`closes-${entryIndex}`}\n                  className=\"block text-xs font-medium text-gray-500 mb-1\"\n                >\n                  Closes\n                </label>\n                <input\n                  id={`closes-${entryIndex}`}\n                  type=\"time\"\n                  value={entry.closes}\n                  onChange={(e) => handleTimeChange(entryIndex, 'closes', e.target.value)}\n                  className=\"border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary\"\n                />\n              </div>\n\n              <button\n                type=\"button\"\n                onClick={() => removeHourGroup(entryIndex)}\n                className=\"mt-5 text-gray-400 hover:text-red-500 p-1 rounded focus-visible:ring-2 focus-visible:ring-red-500\"\n                aria-label={`Remove schedule ${entryIndex + 1}`}\n                disabled={hours.length === 1}\n              >\n                <svg className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" aria-hidden=\"true\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                </svg>\n              </button>\n            </div>\n          </div>\n        ))}\n      </div>\n\n      <button\n        type=\"button\"\n        onClick={addHourGroup}\n        className=\"mt-3 text-sm text-primary hover:underline flex items-center gap-1\"\n      >\n        <span aria-hidden=\"true\">+</span> Add another schedule\n      </button>\n\n      {error && (\n        <p role=\"alert\" className=\"mt-4 text-sm text-red-600\">{error}</p>\n      )}\n\n      <div className=\"mt-6 flex items-center gap-4\">\n        <button\n          type=\"submit\"\n          disabled={isPending}\n          className=\"px-6 py-2.5 bg-primary text-white rounded-xl font-semibold text-sm disabled:opacity-50 hover:opacity-90 transition-opacity\"\n          aria-busy={isPending}\n        >\n          {isPending ? 'Savingâ€¦' : 'Save Hours'}\n        </button>\n        {saved && (\n          <p role=\"status\" className=\"text-sm text-green-600 font-medium\">\n            âœ“ Hours saved\n          </p>\n        )}\n      </div>\n    </form>\n  );\n}\n```\n\n---\n",
            "domainNumber": 29
          }
        }
      ]
    },
    {
      "domainNumber": 30,
      "success": true,
      "tasksCreated": 3,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 30,
          "fileName": "DOMAIN-30-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-30\\DOMAIN-30-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "30.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 30 section philosophy.md",
            "topics": ["Domain 30 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 30.1 Philosophy\n\n**What it is:** Every client can connect their own domain (`johnsplumbing.com`) to replace the default subdomain (`johns-plumbing.agency.com`). The platform handles the full flow: client enters domain â†’ platform adds it to Vercel via API â†’ DNS instructions shown â†’ platform polls verification â†’ marks as active. [vercel](https://vercel.com/docs/multi-tenant/domain-management)\n\n**Vercel for Platforms API:** Vercel exposes a REST API for programmatically adding, removing, and checking domains. In multi-tenant apps, the wildcard domain `*.agency.com` is set at project level. Custom domains like `johnsplumbing.com` are added per-deployment via this API. Vercel auto-provisions the SSL certificate once DNS propagates. [vercel](https://vercel.com/kb/guide/how-do-i-add-a-custom-domain-to-my-vercel-project)\n\n**DNS requirements for clients:** Two records are needed. For an apex domain (`johnsplumbing.com`): an `A` record pointing to `76.76.21.21` (Vercel's IP). For a `www` subdomain: a `CNAME` pointing to `cname.vercel-dns.com`. [stackoverflow](https://stackoverflow.com/questions/78001208/add-custom-domain-to-dynamic-subdomain-in-nextjs-app-deployed-in-vercel-that-alr)\n\n---\n",
            "domainNumber": 30
          }
        },
        {
          "domainNumber": 30,
          "fileName": "DOMAIN-30-domain-section-domain.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-30\\DOMAIN-30-domain-section-domain.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "30.2-domain-management-service.md",
            "title": "Section domain",
            "description": "Implementation for domain 30 section domain",
            "topics": ["Domain 30 implementation"],
            "sectionNumber": "domain",
            "content": "### 30.2 Domain Management Service\n\n**File:** `packages/domains/src/vercel-domains.ts`\n\n```typescript\nimport { Redis } from '@upstash/redis';\nimport { db } from '@repo/db';\n\nconst redis = Redis.fromEnv();\n\nconst VERCEL_API = 'https://api.vercel.com';\nconst VERCEL_TOKEN = process.env.VERCEL_API_TOKEN!;\nconst VERCEL_TEAM_ID = process.env.VERCEL_TEAM_ID!;\nconst VERCEL_PROJECT_ID = process.env.VERCEL_PROJECT_ID!;\n\n// ============================================================================\n// VERCEL DOMAINS API WRAPPER\n// Reference: https://vercel.com/docs/multi-tenant/domain-management\n// ============================================================================\n\ninterface VercelDomainResponse {\n  name: string;\n  apexName: string;\n  projectId: string;\n  redirect?: string;\n  verified: boolean;\n  verification?: VercelVerificationChallenge[];\n}\n\ninterface VercelVerificationChallenge {\n  type: 'TXT';\n  domain: string;\n  value: string;\n  reason: string;\n}\n\ninterface DomainAddResult {\n  status: 'added' | 'already_exists' | 'conflict' | 'error';\n  domain?: VercelDomainResponse;\n  dnsInstructions?: DNSInstruction[];\n  error?: string;\n}\n\ninterface DNSInstruction {\n  type: 'A' | 'CNAME' | 'TXT';\n  name: string; // '@' or 'www'\n  value: string;\n  ttl?: number;\n  note?: string;\n}\n\nexport async function addDomainToVercel(domain: string): Promise<DomainAddResult> {\n  const response = await fetch(\n    `${VERCEL_API}/v9/projects/${VERCEL_PROJECT_ID}/domains?teamId=${VERCEL_TEAM_ID}`,\n    {\n      method: 'POST',\n      headers: {\n        Authorization: `Bearer ${VERCEL_TOKEN}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({ name: domain }),\n    }\n  );\n\n  if (response.status === 409) {\n    // Domain already exists in this project\n    return { status: 'already_exists' };\n  }\n\n  if (response.status === 403) {\n    // Domain belongs to another Vercel team\n    return {\n      status: 'conflict',\n      error:\n        'This domain is currently associated with another project. Please remove it from its current location first.',\n    };\n  }\n\n  if (!response.ok) {\n    const error = await response.text();\n    return { status: 'error', error };\n  }\n\n  const data: VercelDomainResponse = await response.json();\n\n  // Build DNS instructions based on whether it's apex or subdomain\n  const isApex = !domain.includes('.', domain.indexOf('.') + 1) || domain.split('.').length === 2;\n\n  const dnsInstructions: DNSInstruction[] = isApex\n    ? [\n        {\n          type: 'A',\n          name: '@',\n          value: '76.76.21.21',\n          ttl: 3600,\n          note: 'Add at your DNS provider for the root domain',\n        },\n        {\n          type: 'CNAME',\n          name: 'www',\n          value: 'cname.vercel-dns.com.',\n          ttl: 3600,\n          note: 'Optional: redirects www to root domain',\n        },\n      ]\n    : [\n        {\n          type: 'CNAME',\n          name: domain.split('.')[0],\n          value: 'cname.vercel-dns.com.',\n          ttl: 3600,\n          note: 'Add at your DNS provider',\n        },\n      ];\n\n  // If Vercel requires a verification TXT record (domain in use elsewhere)\n  if (data.verification?.length) {\n    data.verification.forEach((v) => {\n      dnsInstructions.push({\n        type: 'TXT',\n        name: v.domain.replace(`.${domain}`, '') || '@',\n        value: v.value,\n        note: 'Required for domain verification: ' + v.reason,\n      });\n    });\n  }\n\n  return { status: 'added', domain: data, dnsInstructions };\n}\n\nexport async function removeDomainFromVercel(domain: string): Promise<void> {\n  await fetch(\n    `${VERCEL_API}/v9/projects/${VERCEL_PROJECT_ID}/domains/${domain}?teamId=${VERCEL_TEAM_ID}`,\n    {\n      method: 'DELETE',\n      headers: { Authorization: `Bearer ${VERCEL_TOKEN}` },\n    }\n  );\n}\n\nexport async function checkDomainVerification(\n  domain: string\n): Promise<{ verified: boolean; config?: VercelDomainResponse }> {\n  const response = await fetch(\n    `${VERCEL_API}/v9/projects/${VERCEL_PROJECT_ID}/domains/${domain}?teamId=${VERCEL_TEAM_ID}`,\n    {\n      headers: { Authorization: `Bearer ${VERCEL_TOKEN}` },\n    }\n  );\n\n  if (!response.ok) return { verified: false };\n\n  const data: VercelDomainResponse = await response.json();\n\n  return { verified: data.verified, config: data };\n}\n\n// ============================================================================\n// TENANT DOMAIN MANAGEMENT\n// ============================================================================\n\nexport async function addCustomDomainForTenant(\n  tenantId: string,\n  domain: string\n): Promise<DomainAddResult> {\n  // Normalize: lowercase, strip protocol, strip trailing slash\n  const normalized = domain\n    .toLowerCase()\n    .replace(/^https?:\\/\\//, '')\n    .replace(/\\/+$/, '');\n\n  // Check if domain is already claimed by another tenant\n  const { data: existing } = await db\n    .from('tenants')\n    .select('id')\n    .eq('custom_domain', normalized)\n    .neq('id', tenantId)\n    .maybeSingle();\n\n  if (existing) {\n    return {\n      status: 'conflict',\n      error: 'This domain is already registered to another account.',\n    };\n  }\n\n  // Add to Vercel\n  const result = await addDomainToVercel(normalized);\n\n  if (result.status === 'added' || result.status === 'already_exists') {\n    // Save domain (unverified) to tenant record\n    await db\n      .from('tenants')\n      .update({\n        custom_domain: normalized,\n        custom_domain_verified: false,\n        custom_domain_added_at: new Date().toISOString(),\n      })\n      .eq('id', tenantId);\n\n    // Store DNS instructions in Redis (TTL 7 days â€” client needs time to update DNS)\n    if (result.dnsInstructions) {\n      await redis.setex(\n        `domain-dns:${tenantId}`,\n        7 * 24 * 3600,\n        JSON.stringify(result.dnsInstructions)\n      );\n    }\n\n    // Schedule first verification check in 5 minutes\n    const { enqueue } = await import('@repo/jobs/client');\n    await enqueue(\n      'domain.verify',\n      { tenantId, domain: normalized },\n      {\n        notBefore: new Date(Date.now() + 5 * 60 * 1000),\n      }\n    );\n  }\n\n  return result;\n}\n\nexport async function verifyAndActivateDomain(\n  tenantId: string,\n  domain: string\n): Promise<{ activated: boolean; retryIn?: number }> {\n  const { verified } = await checkDomainVerification(domain);\n\n  if (verified) {\n    await db\n      .from('tenants')\n      .update({\n        custom_domain_verified: true,\n        custom_domain_verified_at: new Date().toISOString(),\n      })\n      .eq('id', tenantId);\n\n    // Bust cache so middleware picks up new domain\n    await redis.del(`tenant-domain:${domain}`);\n\n    // Also provision Resend sending domain (now that custom domain is verified)\n    const { checkTenantEmailDomainVerification } = await import('@repo/email/client');\n    await checkTenantEmailDomainVerification(tenantId);\n\n    return { activated: true };\n  }\n\n  // Not yet verified â€” schedule retry with exponential backoff\n  // (5min, 10min, 20min, 1h, 2h, 6h, 12h, 24h)\n  return { activated: false, retryIn: 300 };\n}\n\nexport async function removeCustomDomainForTenant(tenantId: string): Promise<void> {\n  const { data: tenant } = await db\n    .from('tenants')\n    .select('custom_domain')\n    .eq('id', tenantId)\n    .single();\n\n  if (!tenant?.custom_domain) return;\n\n  await removeDomainFromVercel(tenant.custom_domain);\n\n  await db\n    .from('tenants')\n    .update({\n      custom_domain: null,\n      custom_domain_verified: false,\n      custom_domain_added_at: null,\n      custom_domain_verified_at: null,\n    })\n    .eq('id', tenantId);\n\n  await redis.del(`tenant-domain:${tenant.custom_domain}`);\n  await redis.del(`domain-dns:${tenantId}`);\n}\n```\n\n---\n",
            "domainNumber": 30
          }
        },
        {
          "domainNumber": 30,
          "fileName": "DOMAIN-30-domain-section-domain.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-30\\DOMAIN-30-domain-section-domain.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "30.3-domain-management-ui.md",
            "title": "Section domain",
            "description": "Implementation for domain 30 section domain",
            "topics": ["Domain 30 implementation"],
            "sectionNumber": "domain",
            "content": "### 30.3 Domain Management UI\n\n**File:** `apps/portal/src/features/settings/ui/DomainSettings.tsx`\n\n```typescript\n'use client';\n\nimport { useState, useTransition } from 'react';\nimport { addDomainAction, removeDomainAction, verifyDomainAction } from '../model/domain-actions';\n\ninterface DNSInstruction {\n  type: string;\n  name: string;\n  value: string;\n  note?: string;\n}\n\ninterface DomainSettingsProps {\n  tenantId: string;\n  currentDomain: string | null;\n  isVerified: boolean;\n  defaultSubdomain: string;\n  initialDnsInstructions: DNSInstruction[] | null;\n}\n\nexport function DomainSettings({\n  tenantId,\n  currentDomain,\n  isVerified,\n  defaultSubdomain,\n  initialDnsInstructions,\n}: DomainSettingsProps) {\n  const [domain, setDomain] = useState(currentDomain ?? '');\n  const [dnsInstructions, setDnsInstructions] = useState<DNSInstruction[] | null>(initialDnsInstructions);\n  const [error, setError] = useState<string | null>(null);\n  const [isPending, startTransition] = useTransition();\n  const [verifying, setVerifying] = useState(false);\n  const [verificationResult, setVerificationResult] = useState<'verified' | 'pending' | null>(\n    isVerified ? 'verified' : currentDomain ? 'pending' : null\n  );\n\n  const handleAdd = (e: React.FormEvent) => {\n    e.preventDefault();\n    setError(null);\n\n    const normalized = domain.trim().toLowerCase().replace(/^https?:\\/\\//, '');\n    if (!normalized || !normalized.includes('.')) {\n      setError('Please enter a valid domain name (e.g. johnsplumbing.com)');\n      return;\n    }\n\n    startTransition(async () => {\n      const result = await addDomainAction({ domain: normalized });\n      if (result.success && result.data) {\n        const { status, dnsInstructions: instructions, error: addError } = result.data as any;\n        if (status === 'added' || status === 'already_exists') {\n          setDnsInstructions(instructions ?? null);\n          setVerificationResult('pending');\n        } else {\n          setError(addError ?? 'Failed to add domain. Please try again.');\n        }\n      }\n    });\n  };\n\n  const handleVerify = () => {\n    setVerifying(true);\n    startTransition(async () => {\n      const result = await verifyDomainAction({ domain });\n      if (result.success && (result.data as any)?.activated) {\n        setVerificationResult('verified');\n      } else {\n        setVerificationResult('pending');\n      }\n      setVerifying(false);\n    });\n  };\n\n  const handleRemove = () => {\n    if (!confirm('Remove this custom domain? Your site will return to the default subdomain.')) return;\n    startTransition(async () => {\n      await removeDomainAction({});\n      setDomain('');\n      setDnsInstructions(null);\n      setVerificationResult(null);\n    });\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h2 className=\"text-lg font-bold text-gray-900 mb-1\">Custom Domain</h2>\n        <p className=\"text-sm text-gray-500\">\n          Connect your own domain to replace{' '}\n          <code className=\"bg-gray-100 px-1.5 py-0.5 rounded text-xs\">{defaultSubdomain}</code>\n        </p>\n      </div>\n\n      {/* Current domain status */}\n      {currentDomain && (\n        <div className={`flex items-center justify-between p-4 rounded-xl border ${\n          verificationResult === 'verified'\n            ? 'bg-green-50 border-green-200'\n            : 'bg-yellow-50 border-yellow-200'\n        }`}>\n          <div className=\"flex items-center gap-3\">\n            <div className={`h-2.5 w-2.5 rounded-full ${\n              verificationResult === 'verified' ? 'bg-green-500' : 'bg-yellow-500 animate-pulse'\n            }`} aria-hidden=\"true\" />\n            <div>\n              <p className=\"font-semibold text-gray-900\">{currentDomain}</p>\n              <p className=\"text-sm text-gray-500\">\n                {verificationResult === 'verified'\n                  ? 'Active â€” SSL certificate issued'\n                  : 'Pending DNS verification'}\n              </p>\n            </div>\n          </div>\n          <button\n            type=\"button\"\n            onClick={handleRemove}\n            disabled={isPending}\n            className=\"text-sm text-red-500 hover:text-red-700 font-medium\"\n          >\n            Remove\n          </button>\n        </div>\n      )}\n\n      {/* Add domain form */}\n      {!currentDomain && (\n        <form onSubmit={handleAdd} className=\"flex gap-3\">\n          <div className=\"flex-1\">\n            <label htmlFor=\"custom-domain\" className=\"sr-only\">Custom domain</label>\n            <input\n              id=\"custom-domain\"\n              type=\"text\"\n              value={domain}\n              onChange={(e) => setDomain(e.target.value)}\n              placeholder=\"johnsplumbing.com\"\n              disabled={isPending}\n              className=\"w-full border border-gray-300 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary disabled:opacity-50\"\n              aria-describedby={error ? 'domain-error' : undefined}\n            />\n          </div>\n          <button\n            type=\"submit\"\n            disabled={isPending || !domain.trim()}\n            className=\"px-5 py-2.5 bg-primary text-white rounded-xl font-semibold text-sm disabled:opacity-50 hover:opacity-90 transition-opacity whitespace-nowrap\"\n          >\n            {isPending ? 'Addingâ€¦' : 'Add Domain'}\n          </button>\n        </form>\n      )}\n\n      {error && (\n        <p id=\"domain-error\" role=\"alert\" className=\"text-sm text-red-600\">{error}</p>\n      )}\n\n      {/* DNS Instructions */}\n      {dnsInstructions && verificationResult === 'pending' && (\n        <div className=\"border border-gray-200 rounded-xl overflow-hidden\">\n          <div className=\"px-4 py-3 bg-gray-50 border-b border-gray-200\">\n            <h3 className=\"font-semibold text-gray-900 text-sm\">DNS Configuration Required</h3>\n            <p className=\"text-xs text-gray-500 mt-0.5\">\n              Add these records at your DNS provider (GoDaddy, Namecheap, Cloudflare, etc.)\n            </p>\n          </div>\n\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full text-sm\">\n              <thead>\n                <tr className=\"bg-gray-50 border-b border-gray-200\">\n                  {['Type', 'Name', 'Value', ''].map((h) => (\n                    <th key={h} className=\"text-left px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wide\">\n                      {h}\n                    </th>\n                  ))}\n                </tr>\n              </thead>\n              <tbody>\n                {dnsInstructions.map((record, i) => (\n                  <tr key={i} className=\"border-b border-gray-100 last:border-0\">\n                    <td className=\"px-4 py-3\">\n                      <span className=\"bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs font-mono font-bold\">\n                        {record.type}\n                      </span>\n                    </td>\n                    <td className=\"px-4 py-3 font-mono text-xs text-gray-700\">{record.name}</td>\n                    <td className=\"px-4 py-3 font-mono text-xs text-gray-700 max-w-xs truncate\" title={record.value}>\n                      {record.value}\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <button\n                        type=\"button\"\n                        onClick={() => navigator.clipboard.writeText(record.value)}\n                        className=\"text-xs text-gray-400 hover:text-primary\"\n                        aria-label={`Copy ${record.type} record value`}\n                      >\n                        Copy\n                      </button>\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n\n          <div className=\"px-4 py-3 bg-yellow-50 border-t border-yellow-100 flex items-center justify-between\">\n            <p className=\"text-xs text-yellow-700\">\n              DNS propagation can take 5 minutes to 48 hours\n            </p>\n            <button\n              type=\"button\"\n              onClick={handleVerify}\n              disabled={isPending || verifying}\n              className=\"text-sm font-semibold text-primary hover:underline disabled:opacity-50\"\n            >\n              {verifying ? 'Checkingâ€¦' : 'Check Verification'}\n            </button>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n```\n\n---\n\n## Priority Table for Domains 27â€“30\n\n| Task                                           | Domain | Priority | Timeline | Success Metric                                        |\n| ---------------------------------------------- | ------ | -------- | -------- | ----------------------------------------------------- |\n| Service area pages (`/service-area/[slug]`)    | 27     | **P0**   | Week 1   | All configured areas resolve to unique pages          |\n| `generateStaticParams` for top 10 areas        | 27     | **P0**   | Week 1   | Top areas pre-built, don't incur first-request delay  |\n| Area-specific `LocalBusiness` JSON-LD          | 27     | **P0**   | Week 1   | Each area page passes Google Rich Results Test        |\n| Internal linking between area pages            | 27     | **P1**   | Week 1   | Link equity flows to all area pages                   |\n| `cacheTag` bust on service area config change  | 27     | **P1**   | Week 2   | Deleted area returns 404 within 60s                   |\n| Sanity schema (`post` + `tenantId` isolation)  | 28     | **P1**   | Week 2   | No cross-tenant content leakage in GROQ queries       |\n| Blog list + detail pages (ISR, `cacheLife` 1h) | 28     | **P1**   | Week 2   | Posts render SSR, not CSR                             |\n| Sanity webhook â†’ `revalidateTag` on publish    | 28     | **P1**   | Week 2   | New post live on site < 5s after Sanity publish       |\n| `BlogPosting` + `BreadcrumbList` JSON-LD       | 28     | **P1**   | Week 2   | Blog posts eligible for Google article rich results   |\n| Related posts (GROQ category match)            | 28     | **P2**   | Week 3   | 3 related posts shown on each post page               |\n| `deep_merge_config` SQL function               | 29     | **P0**   | Week 1   | Settings updates never clobber sibling config keys    |\n| Identity + contact settings forms              | 29     | **P0**   | Week 1   | Client can update business name, phone, address       |\n| Business hours form (multi-day groups)         | 29     | **P0**   | Week 1   | Hours changes reflect in JSON-LD within 60s           |\n| Notification preferences settings              | 29     | **P1**   | Week 2   | Client can disable/enable lead email alerts           |\n| Integrations settings (GA, GTM, Pixel)         | 29     | **P1**   | Week 2   | Client can add GA4 ID, tags fire on next visit        |\n| Vercel Domains API integration                 | 30     | **P0**   | Week 1   | Custom domain added to project programmatically       |\n| DNS instructions display with copy buttons     | 30     | **P0**   | Week 1   | Client can follow DNS setup without support ticket    |\n| Domain verification polling job (QStash)       | 30     | **P0**   | Week 1   | Domain auto-activates within 5 min of DNS propagation |\n| Domain â†’ Resend sending domain auto-link       | 30     | **P1**   | Week 2   | Verified domain automatically used for outbound email |\n| Remove domain flow (Vercel API delete)         | 30     | **P1**   | Week 2   | Removing domain falls back to subdomain cleanly       |\n\n---\n\n**Cross-domain invariants for Domains 27â€“30:**\n\n- Service area pages must return `notFound()` for any slug not in the tenant's configured `serviceAreas`. Without this, Googlebot could crawl fabricated URLs (`/service-area/mars-tx`) and waste crawl budget on 200s with thin content. [mgphq](https://www.mgphq.com/blog/nextjs-programmatic-seo-isr-guide)\n- All Sanity GROQ queries **must** include `&& tenantId == $tenantId`. A query without this filter returns all tenants' posts. This is a data isolation requirement, not an optimization. [github](https://github.com/sanity-io/next-sanity)\n- The `deep_merge_config` function uses `FOR UPDATE` row lock â€” two simultaneous settings saves from different browser tabs will serialize, not race. Without the lock, the second write silently overwrites the first. [nextjs](https://nextjs.org/docs/14/app/building-your-application/data-fetching/server-actions-and-mutations)\n- The Vercel Domains API call in `addDomainToVercel` must handle the `403` (domain in another team) and `409` (domain already in this project) responses gracefully â€” both are valid non-error states that require different UI feedback. [macchiato.hashnode](https://macchiato.hashnode.dev/how-to-build-a-multi-tenant-app-with-custom-domains-using-nextjs)\n- Domain verification polling uses QStash with exponential backoff scheduling â€” not a cron job polling all unverified domains every minute. At scale (1000+ tenants), a per-domain backoff queue is orders of magnitude more efficient than a batch cron. [youtube](https://www.youtube.com/watch?v=NizAmP_Eobs)\n\n---\n",
            "domainNumber": 30
          }
        }
      ]
    },
    {
      "domainNumber": 31,
      "success": true,
      "tasksCreated": 4,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 31,
          "fileName": "DOMAIN-31-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-31\\DOMAIN-31-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "31.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 31 section philosophy.md",
            "topics": ["Domain 31 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 31.1 Philosophy\n\n**What it is:** Service business field workers (plumbers at a job site, HVAC techs in a basement) often operate in low-connectivity environments. A service worker + Background Sync API queues form submissions offline in IndexedDB and replays them automatically when connectivity returns â€” zero data loss. [nextjs](https://nextjs.org/docs/app/guides/progressive-web-apps)\n\n**Why Background Sync, not just `localStorage`:** `localStorage` persists data across page loads but cannot automatically trigger a network retry without the user reopening the app. Background Sync uses the OS-level network state event â€” the submission fires even if the user has closed the browser tab, as soon as connectivity returns. [digitalapplied](https://www.digitalapplied.com/blog/progressive-web-apps-2026-pwa-performance-guide)\n\n**Service worker strategy â€” two layers:**\n\n1. **App shell caching** (Workbox `StaleWhileRevalidate`) â€” contact form HTML/JS/CSS served instantly from cache, updated in background\n2. **POST queue** (Workbox `BackgroundSyncPlugin`) â€” failed contact form POST requests queued in IndexedDB and retried when online [youtube](https://www.youtube.com/watch?v=unnBfDeQYQM)\n\n---\n",
            "domainNumber": 31
          }
        },
        {
          "domainNumber": 31,
          "fileName": "DOMAIN-31-service-section-service.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-31\\DOMAIN-31-service-section-service.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "31.2-service-worker-setup.md",
            "title": "Section service",
            "description": "Implementation for domain 31 section service",
            "topics": ["Domain 31 implementation"],
            "sectionNumber": "service",
            "content": "### 31.2 Service Worker Setup\n\n**File:** `apps/*/public/sw.js`\n\n```javascript\n// ============================================================================\n// SERVICE WORKER\n// Compiled by Workbox via next.config.ts (serwist or custom).\n// Two strategies:\n//   1. App shell (static assets) â†’ CacheFirst / StaleWhileRevalidate\n//   2. Contact form POSTs â†’ NetworkOnly + BackgroundSyncPlugin fallback\n// ============================================================================\n\nimport { precacheAndRoute, cleanupOutdatedCaches } from 'workbox-precaching';\nimport { registerRoute } from 'workbox-routing';\nimport { NetworkOnly, StaleWhileRevalidate, CacheFirst } from 'workbox-strategies';\nimport { BackgroundSyncPlugin } from 'workbox-background-sync';\nimport { ExpirationPlugin } from 'workbox-expiration';\nimport { CacheableResponsePlugin } from 'workbox-cacheable-response';\n\n// Injected by build tool (Serwist / next-pwa)\nprecacheAndRoute(self.__WB_MANIFEST ?? []);\ncleanupOutdatedCaches();\n\n// â”€â”€ 1. App shell: JS/CSS/fonts â†’ CacheFirst (rarely change) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nregisterRoute(\n  ({ request }) => request.destination === 'script' || request.destination === 'style',\n  new CacheFirst({\n    cacheName: 'app-shell',\n    plugins: [\n      new CacheableResponsePlugin({ statuses: [0, 200] }),\n      new ExpirationPlugin({ maxEntries: 60, maxAgeSeconds: 30 * 24 * 60 * 60 }), // 30d\n    ],\n  })\n);\n\n// â”€â”€ 2. Images â†’ StaleWhileRevalidate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nregisterRoute(\n  ({ request }) => request.destination === 'image',\n  new StaleWhileRevalidate({\n    cacheName: 'images',\n    plugins: [\n      new CacheableResponsePlugin({ statuses: [0, 200] }),\n      new ExpirationPlugin({ maxEntries: 100, maxAgeSeconds: 7 * 24 * 60 * 60 }), // 7d\n    ],\n  })\n);\n\n// â”€â”€ 3. Contact form POSTs â†’ NetworkOnly + BackgroundSync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// If network fails â†’ queues in IndexedDB â†’ retries when online.\n// Note: BackgroundSync only fires when browser regains connectivity.\n// Reference: https://developers.google.com/web/tools/workbox/modules/workbox-background-sync\n\nconst bgSyncPlugin = new BackgroundSyncPlugin('contact-form-queue', {\n  maxRetentionTime: 24 * 60, // Retry for up to 24 hours (in minutes)\n  onSync: async ({ queue }) => {\n    let entry;\n    while ((entry = await queue.shiftRequest())) {\n      try {\n        await fetch(entry.request);\n        // Post-sync: notify the page that a queued submission was sent\n        const clients = await self.clients.matchAll();\n        clients.forEach((client) => {\n          client.postMessage({\n            type: 'BACKGROUND_SYNC_COMPLETE',\n            tag: 'contact-form-queue',\n          });\n        });\n      } catch (error) {\n        console.error('[SW] Background sync failed, re-queuing:', error);\n        await queue.unshiftRequest(entry);\n        throw error; // Rethrow to trigger retry\n      }\n    }\n  },\n});\n\nregisterRoute(\n  ({ url }) => url.pathname.startsWith('/api/contact'),\n  new NetworkOnly({ plugins: [bgSyncPlugin] }),\n  'POST'\n);\n\n// â”€â”€ 4. API routes â†’ NetworkFirst (fresh data preferred) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nregisterRoute(\n  ({ url }) => url.pathname.startsWith('/api/') && !url.pathname.startsWith('/api/contact'),\n  new StaleWhileRevalidate({\n    cacheName: 'api-responses',\n    plugins: [\n      new CacheableResponsePlugin({ statuses: [200] }),\n      new ExpirationPlugin({ maxEntries: 50, maxAgeSeconds: 5 * 60 }), // 5 min\n    ],\n  })\n);\n\n// â”€â”€ Offline fallback: serve cached homepage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nself.addEventListener('fetch', (event) => {\n  if (event.request.mode === 'navigate') {\n    event.respondWith(\n      fetch(event.request).catch(() => caches.match('/offline') ?? caches.match('/'))\n    );\n  }\n});\n\n// â”€â”€ Message handler: skip waiting on update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nself.addEventListener('message', (event) => {\n  if (event.data?.type === 'SKIP_WAITING') {\n    self.skipWaiting();\n  }\n});\n```\n\n---\n",
            "domainNumber": 31
          }
        },
        {
          "domainNumber": 31,
          "fileName": "DOMAIN-31-offline-section-offline.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-31\\DOMAIN-31-offline-section-offline.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "31.3-offline-aware-contact-form-hook.md",
            "title": "Section offline",
            "description": "Implementation for domain 31 section offline",
            "topics": ["Domain 31 implementation"],
            "sectionNumber": "offline",
            "content": "### 31.3 Offline-Aware Contact Form Hook\n\n**File:** `packages/ui/src/hooks/use-offline-form.ts`\n\n```typescript\n'use client';\n\nimport { useState, useEffect, useCallback } from 'react';\nimport { openDB, type IDBPDatabase } from 'idb';\n\n// ============================================================================\n// OFFLINE FORM HOOK\n// Detects online/offline state and queues form submissions in IndexedDB\n// when offline. The service worker's BackgroundSync replays them.\n// Falls back gracefully if service worker / Background Sync not supported.\n// ============================================================================\n\nexport interface PendingSubmission {\n  id: string;\n  url: string;\n  body: Record<string, unknown>;\n  timestamp: number;\n  retryCount: number;\n}\n\nconst DB_NAME = 'offline-form-store';\nconst STORE_NAME = 'pending-submissions';\n\nlet dbInstance: IDBPDatabase | null = null;\n\nasync function getDB(): Promise<IDBPDatabase> {\n  if (dbInstance) return dbInstance;\n\n  dbInstance = await openDB(DB_NAME, 1, {\n    upgrade(db) {\n      if (!db.objectStoreNames.contains(STORE_NAME)) {\n        db.createObjectStore(STORE_NAME, { keyPath: 'id' });\n      }\n    },\n  });\n\n  return dbInstance;\n}\n\nexport function useOfflineForm(apiUrl: string) {\n  const [isOnline, setIsOnline] = useState(\n    typeof navigator !== 'undefined' ? navigator.onLine : true\n  );\n  const [pendingCount, setPendingCount] = useState(0);\n  const [syncedOfflineData, setSyncedOfflineData] = useState(false);\n\n  // Track online state\n  useEffect(() => {\n    const handleOnline = () => setIsOnline(true);\n    const handleOffline = () => setIsOnline(false);\n\n    window.addEventListener('online', handleOnline);\n    window.addEventListener('offline', handleOffline);\n\n    return () => {\n      window.removeEventListener('online', handleOnline);\n      window.removeEventListener('offline', handleOffline);\n    };\n  }, []);\n\n  // Listen for background sync completion message from service worker\n  useEffect(() => {\n    if (!('serviceWorker' in navigator)) return;\n\n    const handleMessage = (event: MessageEvent) => {\n      if (event.data?.type === 'BACKGROUND_SYNC_COMPLETE') {\n        setSyncedOfflineData(true);\n        loadPendingCount();\n        // Auto-clear notification after 5s\n        setTimeout(() => setSyncedOfflineData(false), 5000);\n      }\n    };\n\n    navigator.serviceWorker.addEventListener('message', handleMessage);\n    return () => navigator.serviceWorker.removeEventListener('message', handleMessage);\n  }, []);\n\n  const loadPendingCount = useCallback(async () => {\n    try {\n      const db = await getDB();\n      const all = await db.getAll(STORE_NAME);\n      setPendingCount(all.length);\n    } catch {\n      setPendingCount(0);\n    }\n  }, []);\n\n  useEffect(() => {\n    loadPendingCount();\n  }, [loadPendingCount]);\n\n  // Submit: try network first, fall back to IndexedDB queue\n  const submit = useCallback(\n    async (\n      formData: Record<string, unknown>\n    ): Promise<{ success: boolean; queued: boolean; error?: string }> => {\n      // Attempt network submission\n      if (isOnline) {\n        try {\n          const response = await fetch(apiUrl, {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify(formData),\n          });\n\n          if (response.ok) {\n            return { success: true, queued: false };\n          }\n\n          // Non-2xx but connected â€” don't queue (validation error, etc.)\n          const error = await response.json().catch(() => ({}));\n          return {\n            success: false,\n            queued: false,\n            error: error.message ?? `Server error: ${response.status}`,\n          };\n        } catch {\n          // Network error despite navigator.onLine â€” fall through to queue\n        }\n      }\n\n      // Queue in IndexedDB for background sync\n      try {\n        const db = await getDB();\n        const submission: PendingSubmission = {\n          id: `${Date.now()}-${Math.random().toString(36).slice(2)}`,\n          url: apiUrl,\n          body: formData,\n          timestamp: Date.now(),\n          retryCount: 0,\n        };\n\n        await db.add(STORE_NAME, submission);\n\n        // Register background sync (if supported)\n        if ('serviceWorker' in navigator && 'SyncManager' in window) {\n          const registration = await navigator.serviceWorker.ready;\n          await (registration as any).sync.register('contact-form-queue');\n        }\n\n        setPendingCount((prev) => prev + 1);\n\n        return { success: true, queued: true };\n      } catch (err: any) {\n        return { success: false, queued: false, error: err.message };\n      }\n    },\n    [apiUrl, isOnline]\n  );\n\n  return {\n    isOnline,\n    submit,\n    pendingCount,\n    syncedOfflineData,\n  };\n}\n```\n\n---\n",
            "domainNumber": 31
          }
        },
        {
          "domainNumber": 31,
          "fileName": "DOMAIN-31-pwa-section-pwa.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-31\\DOMAIN-31-pwa-section-pwa.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "31.4-pwa-manifest-nextjs-integration.md",
            "title": "Section pwa",
            "description": "Implementation for domain 31 section pwa",
            "topics": ["Domain 31 implementation"],
            "sectionNumber": "pwa",
            "content": "### 31.4 PWA Manifest + Next.js Integration\n\n**File:** `apps/*/src/app/manifest.ts`\n\n```typescript\nimport type { MetadataRoute } from 'next';\nimport { headers } from 'next/headers';\nimport { resolveTenant } from '@repo/multi-tenant/resolve-tenant';\nimport { db } from '@repo/db';\n\nexport const dynamic = 'force-dynamic';\n\n// Per-tenant PWA manifest â€” name, theme color, and icons from tenant config\nexport default async function manifest(): Promise<MetadataRoute.Manifest> {\n  const headersList = await headers();\n  const tenantContext = await resolveTenant({ headers: headersList } as any);\n\n  // Default manifest if tenant not resolved\n  if (!tenantContext) {\n    return {\n      name: 'Business Site',\n      short_name: 'Business',\n      theme_color: '#2563eb',\n      background_color: '#ffffff',\n      display: 'standalone',\n      start_url: '/',\n      icons: [\n        { src: '/icon-192.png', sizes: '192x192', type: 'image/png' },\n        { src: '/icon-512.png', sizes: '512x512', type: 'image/png' },\n      ],\n    };\n  }\n\n  const { data: tenant } = await db\n    .from('tenants')\n    .select('config')\n    .eq('id', tenantContext.tenantId)\n    .single();\n\n  const config = tenant?.config as any;\n  const identity = config?.identity ?? {};\n  const primaryColor = config?.theme?.colors?.primary ?? '#2563eb';\n  const logo = config?.assets?.logo;\n\n  return {\n    name: identity.siteName ?? 'Business Site',\n    short_name: (identity.siteName ?? 'Business').slice(0, 12),\n    description: identity.tagline,\n    theme_color: primaryColor,\n    background_color: '#ffffff',\n    display: 'standalone',\n    start_url: '/?source=pwa',\n    scope: '/',\n    orientation: 'portrait-primary',\n    categories: ['business', 'productivity'],\n    icons: [\n      ...(logo\n        ? [\n            { src: logo, sizes: '192x192', type: 'image/png', purpose: 'any maskable' as const },\n            { src: logo, sizes: '512x512', type: 'image/png', purpose: 'any' as const },\n          ]\n        : [\n            { src: '/icon-192.png', sizes: '192x192', type: 'image/png' },\n            { src: '/icon-512.png', sizes: '512x512', type: 'image/png' },\n          ]),\n    ],\n    shortcuts: [\n      {\n        name: 'Contact Us',\n        short_name: 'Contact',\n        url: '/contact?source=pwa-shortcut',\n        icons: [{ src: '/icon-contact.png', sizes: '96x96' }],\n      },\n      {\n        name: 'Book Appointment',\n        short_name: 'Book',\n        url: '/book?source=pwa-shortcut',\n        icons: [{ src: '/icon-book.png', sizes: '96x96' }],\n      },\n    ],\n  };\n}\n```\n\n**Offline banner component â€” shown when user is offline:**\n\n```typescript\n'use client';\n\nimport { useEffect, useState } from 'react';\n\nexport function OfflineBanner() {\n  const [isOffline, setIsOffline] = useState(false);\n  const [justReconnected, setJustReconnected] = useState(false);\n\n  useEffect(() => {\n    const handleOffline = () => {\n      setIsOffline(true);\n      setJustReconnected(false);\n    };\n    const handleOnline = () => {\n      setIsOffline(false);\n      setJustReconnected(true);\n      setTimeout(() => setJustReconnected(false), 4000);\n    };\n\n    window.addEventListener('offline', handleOffline);\n    window.addEventListener('online', handleOnline);\n\n    return () => {\n      window.removeEventListener('offline', handleOffline);\n      window.removeEventListener('online', handleOnline);\n    };\n  }, []);\n\n  if (!isOffline && !justReconnected) return null;\n\n  return (\n    <div\n      role=\"status\"\n      aria-live=\"polite\"\n      className={`\n        fixed top-0 left-0 right-0 z-[100] py-2 px-4 text-center text-sm font-medium\n        transition-all duration-300\n        ${isOffline ? 'bg-yellow-500 text-yellow-900' : 'bg-green-500 text-white'}\n      `}\n    >\n      {isOffline\n        ? 'ðŸ“¶ You\\'re offline â€” forms will be sent when you reconnect'\n        : 'âœ“ Back online â€” syncing any pending submissionsâ€¦'}\n    </div>\n  );\n}\n```\n\n---\n",
            "domainNumber": 31
          }
        }
      ]
    },
    {
      "domainNumber": 32,
      "success": true,
      "tasksCreated": 3,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 32,
          "fileName": "DOMAIN-32-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-32\\DOMAIN-32-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "32.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 32 section philosophy.md",
            "topics": ["Domain 32 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 32.1 Philosophy\n\n**What it is:** Weekly/monthly PDF reports emailed to clients summarizing their lead volume, score distribution, booking count, and source breakdown. Clients feel the platform is working even when they aren't actively logged in. [strapi](https://strapi.io/blog/build-a-pdf-generation-engine-with-nextjs-puppeteer-and-strapi)\n\n**PDF generation choice â€” `@react-pdf/renderer` over Puppeteer:** Puppeteer requires a headless Chromium binary (~300MB), is slow to launch (~2â€“5s cold), and fails on Vercel's 250MB function size limit. `@react-pdf/renderer` runs in pure Node.js, generates PDFs in ~100â€“300ms, requires zero binary dependencies, and runs as a QStash job on any serverless platform. [pdfnoodle](https://pdfnoodle.com/blog/how-to-generate-pdf-reports-from-html-with-react-pdf)\n\n**Report delivery:** QStash triggers the `report.generate` job weekly (Sunday 11 PM CST) per tenant. The job generates the PDF, uploads it to Supabase Storage, and emails the download link via Resend. The PDF URL is time-limited (signed URL, 7-day expiry). [pdfnoodle](https://pdfnoodle.com/blog/how-to-generate-pdf-reports-from-html-with-react-pdf)\n\n---\n",
            "domainNumber": 32
          }
        },
        {
          "domainNumber": 32,
          "fileName": "DOMAIN-32-pdf-section-pdf.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-32\\DOMAIN-32-pdf-section-pdf.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "32.2-pdf-report-template.md",
            "title": "Section pdf",
            "description": "Implementation for domain 32 section pdf",
            "topics": ["Domain 32 implementation"],
            "sectionNumber": "pdf",
            "content": "### 32.2 PDF Report Template\n\n**File:** `packages/reports/src/templates/WeeklyReport.tsx`\n\n```typescript\nimport {\n  Document, Page, Text, View, StyleSheet, Font, Svg,\n  Line, Rect, G, Image,\n} from '@react-pdf/renderer';\n\n// ============================================================================\n// WEEKLY LEAD REPORT â€” @react-pdf/renderer\n// Runs server-side in a QStash job (pure Node, no browser required)\n// ============================================================================\n\nFont.register({\n  family: 'Inter',\n  fonts: [\n    { src: 'https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hiJ-Ek-_EeA.woff', fontWeight: 400 },\n    { src: 'https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuI6fAZ9hiJ-Ek-_EeA.woff', fontWeight: 700 },\n    { src: 'https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuGKYAZ9hiJ-Ek-_EeA.woff', fontWeight: 800 },\n  ],\n});\n\ninterface WeeklyReportProps {\n  businessName: string;\n  logoUrl?: string;\n  primaryColor: string;\n  reportPeriod: string;         // e.g. \"Feb 17 â€“ Feb 23, 2026\"\n  stats: {\n    totalLeads: number;\n    qualifiedLeads: number;     // score â‰¥ 70\n    warmLeads: number;          // score 40â€“69\n    coldLeads: number;          // score < 40\n    totalBookings: number;\n    completedBookings: number;\n    newThisWeek: number;        // vs prior week\n    avgScore: number;\n  };\n  topLeads: Array<{\n    name: string;\n    email: string;\n    score: number;\n    source: string;\n    date: string;\n  }>;\n  sourceBreakdown: Array<{\n    source: string;\n    count: number;\n    percentage: number;\n  }>;\n  weeklyTrend: Array<{\n    day: string;    // \"Mon\", \"Tue\", etc.\n    count: number;\n  }>;\n}\n\nconst styles = StyleSheet.create({\n  page: {\n    fontFamily: 'Inter',\n    backgroundColor: '#ffffff',\n    paddingTop: 0,\n    paddingBottom: 48,\n    paddingHorizontal: 0,\n    fontSize: 10,\n    color: '#111827',\n  },\n  header: {\n    paddingVertical: 28,\n    paddingHorizontal: 48,\n    marginBottom: 24,\n  },\n  headerTop: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    justifyContent: 'space-between',\n    marginBottom: 8,\n  },\n  businessName: {\n    fontSize: 18,\n    fontWeight: 800,\n    color: '#ffffff',\n  },\n  reportTitle: {\n    fontSize: 11,\n    color: 'rgba(255,255,255,0.8)',\n    marginTop: 2,\n  },\n  period: {\n    fontSize: 10,\n    color: 'rgba(255,255,255,0.7)',\n    marginTop: 2,\n  },\n  section: {\n    paddingHorizontal: 48,\n    marginBottom: 28,\n  },\n  sectionTitle: {\n    fontSize: 11,\n    fontWeight: 700,\n    color: '#6b7280',\n    textTransform: 'uppercase',\n    letterSpacing: 1,\n    marginBottom: 12,\n  },\n  statsGrid: {\n    flexDirection: 'row',\n    gap: 12,\n  },\n  statCard: {\n    flex: 1,\n    backgroundColor: '#f9fafb',\n    borderRadius: 8,\n    padding: 14,\n    borderWidth: 1,\n    borderColor: '#e5e7eb',\n  },\n  statValue: {\n    fontSize: 28,\n    fontWeight: 800,\n    color: '#111827',\n    lineHeight: 1,\n  },\n  statLabel: {\n    fontSize: 9,\n    color: '#6b7280',\n    marginTop: 4,\n    fontWeight: 400,\n  },\n  statDelta: {\n    fontSize: 9,\n    marginTop: 6,\n    fontWeight: 700,\n  },\n  table: {\n    borderWidth: 1,\n    borderColor: '#e5e7eb',\n    borderRadius: 8,\n    overflow: 'hidden',\n  },\n  tableHeader: {\n    flexDirection: 'row',\n    backgroundColor: '#f3f4f6',\n    paddingVertical: 8,\n    paddingHorizontal: 14,\n  },\n  tableHeaderCell: {\n    fontSize: 9,\n    fontWeight: 700,\n    color: '#6b7280',\n    textTransform: 'uppercase',\n    letterSpacing: 0.5,\n  },\n  tableRow: {\n    flexDirection: 'row',\n    paddingVertical: 9,\n    paddingHorizontal: 14,\n    borderTopWidth: 1,\n    borderColor: '#f3f4f6',\n  },\n  tableCell: {\n    fontSize: 9.5,\n    color: '#374151',\n  },\n  scoreChip: {\n    paddingHorizontal: 6,\n    paddingVertical: 2,\n    borderRadius: 4,\n    fontSize: 9,\n    fontWeight: 700,\n  },\n  footer: {\n    position: 'absolute',\n    bottom: 24,\n    left: 48,\n    right: 48,\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    alignItems: 'center',\n    borderTopWidth: 1,\n    borderColor: '#e5e7eb',\n    paddingTop: 12,\n  },\n  footerText: {\n    fontSize: 8,\n    color: '#9ca3af',\n  },\n});\n\nconst scoreColor = (score: number): string => {\n  if (score >= 70) return '#16a34a';\n  if (score >= 40) return '#ca8a04';\n  return '#6b7280';\n};\n\nconst scoreBackground = (score: number): string => {\n  if (score >= 70) return '#dcfce7';\n  if (score >= 40) return '#fef3c7';\n  return '#f3f4f6';\n};\n\n// Mini bar chart (pure SVG â€” no canvas)\nfunction BarChart({\n  data,\n  primaryColor,\n}: {\n  data: Array<{ day: string; count: number }>;\n  primaryColor: string;\n}) {\n  const maxCount = Math.max(...data.map((d) => d.count), 1);\n  const chartWidth = 400;\n  const chartHeight = 80;\n  const barWidth = 40;\n  const gap = (chartWidth - data.length * barWidth) / (data.length + 1);\n\n  return (\n    <Svg width={chartWidth} height={chartHeight + 20}>\n      {data.map((d, i) => {\n        const barHeight = (d.count / maxCount) * chartHeight;\n        const x = gap + i * (barWidth + gap);\n        const y = chartHeight - barHeight;\n\n        return (\n          <G key={d.day}>\n            <Rect\n              x={x}\n              y={y}\n              width={barWidth}\n              height={barHeight}\n              fill={primaryColor}\n              rx={4}\n              opacity={0.85}\n            />\n            <Text\n              style={{ fontSize: 8, color: '#6b7280', textAnchor: 'middle' } as any}\n              x={x + barWidth / 2}\n              y={chartHeight + 14}\n            >\n              {d.day}\n            </Text>\n            {d.count > 0 && (\n              <Text\n                style={{ fontSize: 7.5, color: '#111827', textAnchor: 'middle' } as any}\n                x={x + barWidth / 2}\n                y={y - 4}\n              >\n                {d.count}\n              </Text>\n            )}\n          </G>\n        );\n      })}\n    </Svg>\n  );\n}\n\nexport function WeeklyReportDocument({\n  businessName,\n  logoUrl,\n  primaryColor,\n  reportPeriod,\n  stats,\n  topLeads,\n  sourceBreakdown,\n  weeklyTrend,\n}: WeeklyReportProps) {\n  const leadDelta = stats.newThisWeek - (stats.totalLeads - stats.newThisWeek);\n  const leadDeltaStr = leadDelta >= 0 ? `+${leadDelta} vs prior week` : `${leadDelta} vs prior week`;\n\n  return (\n    <Document\n      title={`Weekly Report â€” ${businessName} â€” ${reportPeriod}`}\n      author=\"Platform Analytics\"\n      creator=\"Agency Platform\"\n    >\n      <Page size=\"A4\" style={styles.page}>\n        {/* Header */}\n        <View style={[styles.header, { backgroundColor: primaryColor }]}>\n          <View style={styles.headerTop}>\n            <View>\n              <Text style={styles.businessName}>{businessName}</Text>\n              <Text style={styles.reportTitle}>Weekly Performance Report</Text>\n              <Text style={styles.period}>{reportPeriod}</Text>\n            </View>\n            {logoUrl && (\n              <Image\n                src={logoUrl}\n                style={{ width: 48, height: 48, borderRadius: 8 }}\n              />\n            )}\n          </View>\n        </View>\n\n        {/* KPI Cards */}\n        <View style={styles.section}>\n          <Text style={styles.sectionTitle}>Overview</Text>\n          <View style={styles.statsGrid}>\n            {[\n              { label: 'Total Leads', value: stats.totalLeads, delta: leadDeltaStr, positive: leadDelta >= 0 },\n              { label: 'Qualified Leads', value: stats.qualifiedLeads, delta: `${Math.round((stats.qualifiedLeads / Math.max(stats.totalLeads, 1)) * 100)}% of total`, positive: true },\n              { label: 'Bookings', value: stats.totalBookings, delta: `${stats.completedBookings} completed`, positive: true },\n              { label: 'Avg. Lead Score', value: `${stats.avgScore}/100`, delta: stats.avgScore >= 60 ? 'Above target' : 'Below target', positive: stats.avgScore >= 60 },\n            ].map((card) => (\n              <View key={card.label} style={styles.statCard}>\n                <Text style={styles.statValue}>{card.value}</Text>\n                <Text style={styles.statLabel}>{card.label}</Text>\n                <Text style={[styles.statDelta, { color: card.positive ? '#16a34a' : '#dc2626' }]}>\n                  {card.delta}\n                </Text>\n              </View>\n            ))}\n          </View>\n        </View>\n\n        {/* Daily trend chart */}\n        <View style={styles.section}>\n          <Text style={styles.sectionTitle}>Daily Lead Volume</Text>\n          <BarChart data={weeklyTrend} primaryColor={primaryColor} />\n        </View>\n\n        {/* Top leads table */}\n        <View style={styles.section}>\n          <Text style={styles.sectionTitle}>Top Leads This Week</Text>\n          <View style={styles.table}>\n            <View style={styles.tableHeader}>\n              {['Name', 'Email', 'Score', 'Source', 'Date'].map((h, i) => (\n                <Text\n                  key={h}\n                  style={[\n                    styles.tableHeaderCell,\n                    { flex: i === 1 ? 2 : 1 },\n                  ]}\n                >\n                  {h}\n                </Text>\n              ))}\n            </View>\n            {topLeads.map((lead, i) => (\n              <View key={i} style={styles.tableRow}>\n                <Text style={[styles.tableCell, { flex: 1 }]}>{lead.name}</Text>\n                <Text style={[styles.tableCell, { flex: 2, color: '#2563eb' }]}>{lead.email}</Text>\n                <View style={{ flex: 1 }}>\n                  <View style={[styles.scoreChip, {\n                    backgroundColor: scoreBackground(lead.score),\n                    alignSelf: 'flex-start',\n                  }]}>\n                    <Text style={{ fontSize: 9, fontWeight: 700, color: scoreColor(lead.score) }}>\n                      {lead.score}\n                    </Text>\n                  </View>\n                </View>\n                <Text style={[styles.tableCell, { flex: 1, textTransform: 'capitalize' }]}>\n                  {lead.source.replace(/_/g, ' ')}\n                </Text>\n                <Text style={[styles.tableCell, { flex: 1 }]}>{lead.date}</Text>\n              </View>\n            ))}\n          </View>\n        </View>\n\n        {/* Source breakdown */}\n        <View style={styles.section}>\n          <Text style={styles.sectionTitle}>Lead Sources</Text>\n          <View style={{ gap: 6 }}>\n            {sourceBreakdown.map((src) => (\n              <View key={src.source} style={{ flexDirection: 'row', alignItems: 'center', gap: 10 }}>\n                <Text style={{ fontSize: 9.5, color: '#374151', width: 100, textTransform: 'capitalize' }}>\n                  {src.source.replace(/_/g, ' ')}\n                </Text>\n                <View style={{ flex: 1, backgroundColor: '#f3f4f6', borderRadius: 4, height: 8 }}>\n                  <View style={{\n                    width: `${src.percentage}%`,\n                    backgroundColor: primaryColor,\n                    borderRadius: 4,\n                    height: 8,\n                  }} />\n                </View>\n                <Text style={{ fontSize: 9.5, color: '#6b7280', width: 40, textAlign: 'right' }}>\n                  {src.count} ({src.percentage}%)\n                </Text>\n              </View>\n            ))}\n          </View>\n        </View>\n\n        {/* Footer */}\n        <View style={styles.footer} fixed>\n          <Text style={styles.footerText}>\n            Generated {new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}\n          </Text>\n          <Text style={styles.footerText} render={({ pageNumber, totalPages }) =>\n            `Page ${pageNumber} of ${totalPages}`\n          } />\n        </View>\n      </Page>\n    </Document>\n  );\n}\n```\n\n---\n",
            "domainNumber": 32
          }
        },
        {
          "domainNumber": 32,
          "fileName": "DOMAIN-32-report-section-report.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-32\\DOMAIN-32-report-section-report.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "32.3-report-generation-job.md",
            "title": "Section report",
            "description": "Implementation for domain 32 section report",
            "topics": ["Domain 32 implementation"],
            "sectionNumber": "report",
            "content": "### 32.3 Report Generation Job\n\n**File:** `apps/*/src/app/api/jobs/reports/weekly/route.ts`\n\n```typescript\nimport { createJobHandler } from '@repo/jobs/verify-qstash';\nimport { renderToBuffer } from '@react-pdf/renderer';\nimport { createElement } from 'react';\nimport { createClient } from '@supabase/supabase-js';\nimport { db } from '@repo/db';\nimport { sendEmail } from '@repo/email/send';\nimport { ReportEmailTemplate } from '@repo/email/templates/WeeklyReport';\nimport { WeeklyReportDocument } from '@repo/reports/templates/WeeklyReport';\n\nexport const maxDuration = 60; // PDF generation can take up to 60s for large datasets\n\nconst supabaseAdmin = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\nexport const POST = createJobHandler<'report.weekly'>(async (payload) => {\n  const { tenantId } = payload;\n\n  const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();\n  const twoWeeksAgo = new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString();\n\n  // Fetch tenant config\n  const { data: tenant } = await db\n    .from('tenants')\n    .select('config, notification_config')\n    .eq('id', tenantId)\n    .single();\n\n  const config = tenant?.config as any;\n  const notifConfig = tenant?.notification_config as any;\n\n  // Respect notification preference â€” skip if reports disabled\n  if (notifConfig?.weeklyReport === false) return;\n\n  const ownerEmail = config?.identity?.contact?.email;\n  if (!ownerEmail) return;\n\n  // â”€â”€ Fetch this week's leads â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n  const { data: leads, count: totalLeads } = await db\n    .from('leads')\n    .select('*', { count: 'exact' })\n    .eq('tenant_id', tenantId)\n    .gte('created_at', weekAgo)\n    .order('score', { ascending: false });\n\n  const { count: priorWeekLeads } = await db\n    .from('leads')\n    .select('*', { count: 'exact', head: true })\n    .eq('tenant_id', tenantId)\n    .gte('created_at', twoWeeksAgo)\n    .lt('created_at', weekAgo);\n\n  // â”€â”€ Fetch this week's bookings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n  const { data: bookings } = await db\n    .from('bookings')\n    .select('status')\n    .eq('tenant_id', tenantId)\n    .gte('created_at', weekAgo);\n\n  // â”€â”€ Compute stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n  const allLeads = leads ?? [];\n  const qualified = allLeads.filter((l) => l.score >= 70);\n  const warm = allLeads.filter((l) => l.score >= 40 && l.score < 70);\n  const cold = allLeads.filter((l) => l.score < 40);\n  const avgScore =\n    allLeads.length > 0\n      ? Math.round(allLeads.reduce((sum, l) => sum + l.score, 0) / allLeads.length)\n      : 0;\n\n  // Source breakdown\n  const sourceCounts: Record<string, number> = {};\n  allLeads.forEach((l) => {\n    const src = l.source ?? 'unknown';\n    sourceCounts[src] = (sourceCounts[src] ?? 0) + 1;\n  });\n\n  const sourceBreakdown = Object.entries(sourceCounts)\n    .map(([source, count]) => ({\n      source,\n      count,\n      percentage: Math.round((count / Math.max(allLeads.length, 1)) * 100),\n    }))\n    .sort((a, b) => b.count - a.count);\n\n  // Daily trend (last 7 days)\n  const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];\n  const weeklyTrend = Array.from({ length: 7 }, (_, i) => {\n    const d = new Date();\n    d.setDate(d.getDate() - (6 - i));\n    const dayLeads = allLeads.filter((l) => {\n      const lDate = new Date(l.created_at);\n      return lDate.toDateString() === d.toDateString();\n    });\n    return { day: dayLabels[d.getDay()]!, count: dayLeads.length };\n  });\n\n  const reportPeriod = `${new Date(weekAgo).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} â€“ ${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;\n\n  // â”€â”€ Generate PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n  const pdfBuffer = await renderToBuffer(\n    createElement(WeeklyReportDocument, {\n      businessName: config?.identity?.siteName ?? 'Your Business',\n      logoUrl: config?.assets?.logo,\n      primaryColor: config?.theme?.colors?.primary ?? '#2563eb',\n      reportPeriod,\n      stats: {\n        totalLeads: totalLeads ?? 0,\n        qualifiedLeads: qualified.length,\n        warmLeads: warm.length,\n        coldLeads: cold.length,\n        totalBookings: bookings?.length ?? 0,\n        completedBookings: bookings?.filter((b) => b.status === 'completed').length ?? 0,\n        newThisWeek: allLeads.length,\n        avgScore,\n      },\n      topLeads: allLeads.slice(0, 8).map((l) => ({\n        name: l.name,\n        email: l.email,\n        score: l.score,\n        source: l.source ?? 'unknown',\n        date: new Date(l.created_at).toLocaleDateString('en-US', {\n          month: 'short',\n          day: 'numeric',\n        }),\n      })),\n      sourceBreakdown,\n      weeklyTrend,\n    })\n  );\n\n  // â”€â”€ Upload PDF to Supabase Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n  const fileName = `reports/${tenantId}/weekly-${new Date().toISOString().split('T')[0]}.pdf`;\n\n  await supabaseAdmin.storage.from('tenant-documents').upload(fileName, pdfBuffer, {\n    contentType: 'application/pdf',\n    upsert: true,\n  });\n\n  // Create signed URL (7-day expiry)\n  const { data: signedUrl } = await supabaseAdmin.storage\n    .from('tenant-documents')\n    .createSignedUrl(fileName, 7 * 24 * 60 * 60);\n\n  if (!signedUrl?.signedUrl) {\n    console.error(`[Report] Failed to create signed URL for ${fileName}`);\n    return;\n  }\n\n  // â”€â”€ Email report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n  await sendEmail({\n    tenantId,\n    to: ownerEmail,\n    subject: `ðŸ“Š Your weekly report is ready â€” ${reportPeriod}`,\n    template: ReportEmailTemplate({\n      businessName: config?.identity?.siteName ?? 'Your Business',\n      reportPeriod,\n      totalLeads: totalLeads ?? 0,\n      qualifiedLeads: qualified.length,\n      totalBookings: bookings?.length ?? 0,\n      downloadUrl: signedUrl.signedUrl,\n      priorWeekLeads: priorWeekLeads ?? 0,\n    }),\n    emailType: 'lead_digest',\n    idempotencyKey: `weekly-report-${tenantId}-${new Date().toISOString().split('T')[0]}`,\n  });\n\n  console.log(`[Report] Weekly report sent to ${ownerEmail} for tenant ${tenantId}`);\n});\n```\n\n---\n",
            "domainNumber": 32
          }
        }
      ]
    },
    {
      "domainNumber": 33,
      "success": true,
      "tasksCreated": 5,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 33,
          "fileName": "DOMAIN-33-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-33\\DOMAIN-33-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "33.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 33 section philosophy.md",
            "topics": ["Domain 33 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 33.1 Philosophy\n\n**What it is:** Two legally mandatory systems â€” a cookie consent banner (for analytics/marketing cookies) and a data subject rights flow (right of erasure, right of access per GDPR Article 17). The EDPB coordinated enforcement action that launched in 2025 specifically targeted the right to erasure â€” regulators are actively checking that SaaS platforms process deletion requests correctly. [gdpr](https://gdpr.eu/article-17-right-to-be-forgotten/)\n\n**Architecture â€” the platform is dual controller:**\n\n- The **agency** is the data controller for platform-level data (billing info, account data)\n- Each **tenant** is the data controller for their leads/bookings (visitor data they collect)\n  This means deletion requests for lead data must be processed by the tenant's system, not the agency's. The platform provides the tooling; legal responsibility sits with the client.\n\n---\n",
            "domainNumber": 33
          }
        },
        {
          "domainNumber": 33,
          "fileName": "DOMAIN-33-cookie-section-cookie.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-33\\DOMAIN-33-cookie-section-cookie.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "33.2-cookie-consent-system.md",
            "title": "Section cookie",
            "description": "Implementation for domain 33 section cookie",
            "topics": ["Domain 33 implementation"],
            "sectionNumber": "cookie",
            "content": "### 33.2 Cookie Consent System\n\n**File:** `packages/privacy/src/consent.ts`\n\n```typescript\n'use server';\n\nimport { cookies } from 'next/headers';\n\n// ============================================================================\n// GDPR COOKIE CONSENT\n// Server-side consent management â€” consent state read before page render.\n// No flash of analytics loading before consent check.\n// Reference: https://www.buildwithmatija.com/blog/build-cookie-consent-banner-nextjs-15-server-client\n// ============================================================================\n\nconst CONSENT_COOKIE = 'cookie_consent_v2';\nconst CONSENT_VERSION = 2;\nconst CONSENT_MAX_AGE = 365 * 24 * 60 * 60; // 1 year\n\nexport interface CookieConsent {\n  essential: true; // Always true â€” cannot be declined\n  analytics: boolean; // GA4, Tinybird, Mixpanel\n  marketing: boolean; // Facebook Pixel, Google Ads\n  version: number;\n  timestamp: number;\n  consentGiven: boolean;\n}\n\nexport async function getCookieConsent(): Promise<CookieConsent | null> {\n  const cookieStore = await cookies();\n  const raw = cookieStore.get(CONSENT_COOKIE)?.value;\n  if (!raw) return null;\n\n  try {\n    const consent = JSON.parse(raw) as CookieConsent;\n    // Invalidate old versions\n    if (consent.version !== CONSENT_VERSION) return null;\n    // Expire after 1 year\n    if (Date.now() - consent.timestamp > CONSENT_MAX_AGE * 1000) return null;\n    return consent;\n  } catch {\n    return null;\n  }\n}\n\nexport async function hasValidConsent(): Promise<boolean> {\n  const consent = await getCookieConsent();\n  return consent?.consentGiven === true;\n}\n\nexport async function shouldLoadAnalytics(): Promise<boolean> {\n  const consent = await getCookieConsent();\n  return consent?.consentGiven === true && consent.analytics === true;\n}\n\nexport async function shouldLoadMarketing(): Promise<boolean> {\n  const consent = await getCookieConsent();\n  return consent?.consentGiven === true && consent.marketing === true;\n}\n\nexport async function shouldShowBanner(): Promise<boolean> {\n  return !(await hasValidConsent());\n}\n\nexport async function acceptAllCookies(): Promise<void> {\n  const cookieStore = await cookies();\n  const consent: CookieConsent = {\n    essential: true,\n    analytics: true,\n    marketing: true,\n    version: CONSENT_VERSION,\n    timestamp: Date.now(),\n    consentGiven: true,\n  };\n  cookieStore.set(CONSENT_COOKIE, JSON.stringify(consent), {\n    httpOnly: false, // Must be readable by client for GA consent mode\n    sameSite: 'lax',\n    secure: process.env.NODE_ENV === 'production',\n    maxAge: CONSENT_MAX_AGE,\n    path: '/',\n  });\n}\n\nexport async function rejectNonEssentialCookies(): Promise<void> {\n  const cookieStore = await cookies();\n  const consent: CookieConsent = {\n    essential: true,\n    analytics: false,\n    marketing: false,\n    version: CONSENT_VERSION,\n    timestamp: Date.now(),\n    consentGiven: true,\n  };\n  cookieStore.set(CONSENT_COOKIE, JSON.stringify(consent), {\n    httpOnly: false,\n    sameSite: 'lax',\n    secure: process.env.NODE_ENV === 'production',\n    maxAge: CONSENT_MAX_AGE,\n    path: '/',\n  });\n}\n\nexport async function saveCustomConsent(options: {\n  analytics: boolean;\n  marketing: boolean;\n}): Promise<void> {\n  const cookieStore = await cookies();\n  const consent: CookieConsent = {\n    essential: true,\n    analytics: options.analytics,\n    marketing: options.marketing,\n    version: CONSENT_VERSION,\n    timestamp: Date.now(),\n    consentGiven: true,\n  };\n  cookieStore.set(CONSENT_COOKIE, JSON.stringify(consent), {\n    httpOnly: false,\n    sameSite: 'lax',\n    secure: process.env.NODE_ENV === 'production',\n    maxAge: CONSENT_MAX_AGE,\n    path: '/',\n  });\n}\n```\n\n---\n",
            "domainNumber": 33
          }
        },
        {
          "domainNumber": 33,
          "fileName": "DOMAIN-33-cookie-section-cookie.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-33\\DOMAIN-33-cookie-section-cookie.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "33.3-cookie-consent-banner-component.md",
            "title": "Section cookie",
            "description": "Implementation for domain 33 section cookie",
            "topics": ["Domain 33 implementation"],
            "sectionNumber": "cookie",
            "content": "### 33.3 Cookie Consent Banner Component\n\n**File:** `packages/ui/src/privacy/CookieBanner.tsx`\n\n```typescript\n'use client';\n\nimport { useState, useTransition } from 'react';\nimport {\n  acceptAllCookies,\n  rejectNonEssentialCookies,\n  saveCustomConsent,\n} from '@repo/privacy/consent';\n\ninterface CookieBannerProps {\n  show: boolean;\n  businessName: string;\n  privacyPolicyUrl: string;\n}\n\nexport function CookieBanner({ show, businessName, privacyPolicyUrl }: CookieBannerProps) {\n  const [visible, setVisible] = useState(show);\n  const [showCustomize, setShowCustomize] = useState(false);\n  const [analytics, setAnalytics] = useState(true);\n  const [marketing, setMarketing] = useState(false);\n  const [isPending, startTransition] = useTransition();\n\n  if (!visible) return null;\n\n  const handleAcceptAll = () => {\n    startTransition(async () => {\n      await acceptAllCookies();\n      setVisible(false);\n      // Dispatch consent update event for GA Consent Mode\n      window.dispatchEvent(new CustomEvent('consentUpdated', {\n        detail: { analytics: true, marketing: true },\n      }));\n    });\n  };\n\n  const handleRejectAll = () => {\n    startTransition(async () => {\n      await rejectNonEssentialCookies();\n      setVisible(false);\n      window.dispatchEvent(new CustomEvent('consentUpdated', {\n        detail: { analytics: false, marketing: false },\n      }));\n    });\n  };\n\n  const handleSaveCustom = () => {\n    startTransition(async () => {\n      await saveCustomConsent({ analytics, marketing });\n      setVisible(false);\n      window.dispatchEvent(new CustomEvent('consentUpdated', {\n        detail: { analytics, marketing },\n      }));\n    });\n  };\n\n  return (\n    <div\n      role=\"dialog\"\n      aria-label=\"Cookie consent\"\n      aria-modal=\"false\"\n      className=\"fixed bottom-0 left-0 right-0 z-50 p-4 sm:p-6\"\n    >\n      <div className=\"max-w-2xl mx-auto bg-white border border-gray-200 rounded-2xl shadow-xl p-5 sm:p-6\">\n        {!showCustomize ? (\n          <>\n            <h2 className=\"text-base font-bold text-gray-900 mb-2\">\n              {businessName} uses cookies\n            </h2>\n            <p className=\"text-sm text-gray-600 mb-4\">\n              We use essential cookies to make our site work. With your consent, we may also use\n              analytics cookies to understand how visitors use the site.{' '}\n              <a href={privacyPolicyUrl} className=\"text-primary underline\" target=\"_blank\" rel=\"noopener noreferrer\">\n                Privacy Policy\n              </a>\n            </p>\n\n            <div className=\"flex flex-col sm:flex-row gap-3\">\n              <button\n                type=\"button\"\n                onClick={handleAcceptAll}\n                disabled={isPending}\n                className=\"flex-1 py-2.5 bg-primary text-white rounded-xl text-sm font-semibold hover:opacity-90 transition-opacity disabled:opacity-50\"\n              >\n                Accept All\n              </button>\n              <button\n                type=\"button\"\n                onClick={handleRejectAll}\n                disabled={isPending}\n                className=\"flex-1 py-2.5 border border-gray-300 text-gray-700 rounded-xl text-sm font-semibold hover:bg-gray-50 transition-colors disabled:opacity-50\"\n              >\n                Reject Non-Essential\n              </button>\n              <button\n                type=\"button\"\n                onClick={() => setShowCustomize(true)}\n                disabled={isPending}\n                className=\"flex-1 py-2.5 text-gray-500 rounded-xl text-sm hover:text-gray-700 transition-colors disabled:opacity-50\"\n              >\n                Customize\n              </button>\n            </div>\n          </>\n        ) : (\n          <>\n            <h2 className=\"text-base font-bold text-gray-900 mb-4\">Cookie Preferences</h2>\n\n            {[\n              { label: 'Essential', description: 'Required for the site to function. Cannot be disabled.', enabled: true, locked: true, onChange: () => {} },\n              { label: 'Analytics', description: 'Helps us understand how visitors use the site (anonymized).', enabled: analytics, locked: false, onChange: setAnalytics },\n              { label: 'Marketing', description: 'Used to show relevant ads on third-party sites.', enabled: marketing, locked: false, onChange: setMarketing },\n            ].map((category) => (\n              <div key={category.label} className=\"flex items-start justify-between mb-4\">\n                <div className=\"flex-1 mr-4\">\n                  <p className=\"text-sm font-semibold text-gray-900\">{category.label}</p>\n                  <p className=\"text-xs text-gray-500 mt-0.5\">{category.description}</p>\n                </div>\n                <button\n                  type=\"button\"\n                  role=\"switch\"\n                  aria-checked={category.enabled}\n                  aria-label={`${category.label} cookies ${category.enabled ? 'enabled' : 'disabled'}`}\n                  disabled={category.locked}\n                  onClick={() => !category.locked && category.onChange(!category.enabled)}\n                  className={`\n                    relative inline-flex h-6 w-11 items-center rounded-full transition-colors flex-shrink-0\n                    ${category.enabled ? 'bg-primary' : 'bg-gray-300'}\n                    ${category.locked ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}\n                  `}\n                >\n                  <span\n                    className={`\n                      inline-block h-4 w-4 transform rounded-full bg-white transition-transform\n                      ${category.enabled ? 'translate-x-6' : 'translate-x-1'}\n                    `}\n                  />\n                </button>\n              </div>\n            ))}\n\n            <div className=\"flex gap-3 mt-4\">\n              <button\n                type=\"button\"\n                onClick={handleSaveCustom}\n                disabled={isPending}\n                className=\"flex-1 py-2.5 bg-primary text-white rounded-xl text-sm font-semibold hover:opacity-90 disabled:opacity-50\"\n              >\n                Save Preferences\n              </button>\n              <button\n                type=\"button\"\n                onClick={() => setShowCustomize(false)}\n                disabled={isPending}\n                className=\"py-2.5 px-4 text-gray-500 text-sm hover:text-gray-700\"\n              >\n                Back\n              </button>\n            </div>\n          </>\n        )}\n      </div>\n    </div>\n  );\n}\n```\n\n---\n",
            "domainNumber": 33
          }
        },
        {
          "domainNumber": 33,
          "fileName": "DOMAIN-33-right-section-right.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-33\\DOMAIN-33-right-section-right.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "33.4-right-to-erasure-data-deletion-system.md",
            "title": "Section right",
            "description": "Implementation for domain 33 section right",
            "topics": ["Domain 33 implementation"],
            "sectionNumber": "right",
            "content": "### 33.4 Right to Erasure â€” Data Deletion System\n\n**File:** `packages/privacy/src/erasure.ts`\n\n```typescript\nimport { db } from '@repo/db';\nimport { createClient } from '@supabase/supabase-js';\n\n// ============================================================================\n// GDPR ARTICLE 17 â€” RIGHT TO ERASURE IMPLEMENTATION\n// Two erasure types:\n//   1. Hard delete: physically removes records (used for leads/bookings)\n//   2. Anonymization: replaces PII with pseudonymous tokens (used where\n//      records must be retained for billing/legal audit trail)\n//\n// EDPB 2025 enforcement: controllers must respond within 30 days.\n// Reference: https://gdpr-info.eu/art-17-gdpr/\n// ============================================================================\n\nconst supabaseAdmin = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\nconst ANONYMIZED_EMAIL_SUFFIX = '@anonymized.invalid';\nconst ANONYMIZED_NAME = '[Anonymized]';\nconst ANONYMIZED_PHONE = '[Anonymized]';\n\nexport interface ErasureRequest {\n  requestId: string;\n  tenantId: string;\n  subjectEmail: string; // The person requesting erasure\n  requestedAt: string;\n  requestedBy: 'subject' | 'tenant_admin' | 'agency_admin';\n  reason?: string;\n}\n\nexport interface ErasureResult {\n  requestId: string;\n  deletedLeads: number;\n  deletedBookings: number;\n  anonymizedLeads: number; // Leads retained but anonymized (financial records)\n  deletedFiles: number;\n  completedAt: string;\n}\n\nexport async function processErasureRequest(request: ErasureRequest): Promise<ErasureResult> {\n  const { tenantId, subjectEmail, requestId } = request;\n  const normalizedEmail = subjectEmail.toLowerCase().trim();\n\n  // Log the request first (audit trail â€” required by GDPR Article 5(2))\n  await db.from('erasure_requests').upsert({\n    id: requestId,\n    tenant_id: tenantId,\n    subject_email: normalizedEmail,\n    requested_at: request.requestedAt,\n    requested_by: request.requestedBy,\n    reason: request.reason,\n    status: 'processing',\n  });\n\n  let deletedLeads = 0;\n  let deletedBookings = 0;\n  let anonymizedLeads = 0;\n  let deletedFiles = 0;\n\n  try {\n    // â”€â”€ 1. Leads â€” hard delete (no legitimate retention interest) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n    const { data: leadsToDelete, count } = await db\n      .from('leads')\n      .select('id', { count: 'exact' })\n      .eq('tenant_id', tenantId)\n      .eq('email', normalizedEmail);\n\n    if (leadsToDelete?.length) {\n      await db.from('leads').delete().eq('tenant_id', tenantId).eq('email', normalizedEmail);\n\n      deletedLeads = count ?? leadsToDelete.length;\n    }\n\n    // â”€â”€ 2. Bookings â€” anonymize (financial/legal audit trail required) â”€â”€â”€â”€â”€â”€â”€\n    // Booking records may need to be retained for accounting purposes.\n    // PII (name, email, phone) is replaced with pseudonymous tokens.\n    // The booking UID (used for calendar sync) is retained.\n\n    const { data: bookingsToAnonymize } = await db\n      .from('bookings')\n      .select('id')\n      .eq('tenant_id', tenantId)\n      .eq('attendee_email', normalizedEmail);\n\n    if (bookingsToAnonymize?.length) {\n      const anonymizedSuffix = requestId.slice(0, 8); // Stable per request\n\n      await db\n        .from('bookings')\n        .update({\n          attendee_name: ANONYMIZED_NAME,\n          attendee_email: `${anonymizedSuffix}${ANONYMIZED_EMAIL_SUFFIX}`,\n          attendee_phone: ANONYMIZED_PHONE,\n          metadata: db.raw(`metadata - 'responses'`), // Remove form responses (PII)\n          updated_at: new Date().toISOString(),\n        })\n        .eq('tenant_id', tenantId)\n        .eq('attendee_email', normalizedEmail);\n\n      anonymizedLeads = bookingsToAnonymize.length;\n    }\n\n    // â”€â”€ 3. Chat session data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n    await db\n      .from('chat_sessions')\n      .delete()\n      .eq('tenant_id', tenantId)\n      .eq('visitor_email', normalizedEmail);\n\n    // â”€â”€ 4. Storage files (profile images, uploaded documents) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n    const { data: files } = await supabaseAdmin.storage\n      .from('tenant-documents')\n      .list(`${tenantId}/leads/${normalizedEmail}`);\n\n    if (files?.length) {\n      const filePaths = files.map((f) => `${tenantId}/leads/${normalizedEmail}/${f.name}`);\n      await supabaseAdmin.storage.from('tenant-documents').remove(filePaths);\n      deletedFiles = files.length;\n    }\n\n    // â”€â”€ 5. Mark erasure request as complete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n    await db\n      .from('erasure_requests')\n      .update({\n        status: 'completed',\n        completed_at: new Date().toISOString(),\n        result: {\n          deletedLeads,\n          deletedBookings,\n          anonymizedLeads,\n          deletedFiles,\n        },\n      })\n      .eq('id', requestId);\n\n    const result: ErasureResult = {\n      requestId,\n      deletedLeads,\n      deletedBookings,\n      anonymizedLeads,\n      deletedFiles,\n      completedAt: new Date().toISOString(),\n    };\n\n    console.log(`[GDPR] Erasure complete for ${normalizedEmail} (tenant=${tenantId}):`, result);\n\n    return result;\n  } catch (err) {\n    // Mark as failed â€” operator must be notified\n    await db\n      .from('erasure_requests')\n      .update({\n        status: 'failed',\n        error: String(err),\n      })\n      .eq('id', requestId);\n\n    throw err;\n  }\n}\n\n// â”€â”€ Data export (GDPR Article 20 â€” Right to Data Portability) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function exportSubjectData(\n  tenantId: string,\n  subjectEmail: string\n): Promise<Record<string, unknown>> {\n  const normalizedEmail = subjectEmail.toLowerCase().trim();\n\n  const [leads, bookings, chatSessions] = await Promise.all([\n    db.from('leads').select('*').eq('tenant_id', tenantId).eq('email', normalizedEmail),\n    db.from('bookings').select('*').eq('tenant_id', tenantId).eq('attendee_email', normalizedEmail),\n    db\n      .from('chat_sessions')\n      .select('*')\n      .eq('tenant_id', tenantId)\n      .eq('visitor_email', normalizedEmail),\n  ]);\n\n  return {\n    exportDate: new Date().toISOString(),\n    dataController: tenantId,\n    dataSubject: { email: normalizedEmail },\n    data: {\n      leads: leads.data ?? [],\n      bookings: (bookings.data ?? []).map((b) => ({\n        ...b,\n        // Exclude internal IDs that are meaningless to the subject\n        cal_uid: undefined,\n        tenant_id: undefined,\n      })),\n      chatSessions: chatSessions.data ?? [],\n    },\n  };\n}\n```\n\n---\n",
            "domainNumber": 33
          }
        },
        {
          "domainNumber": 33,
          "fileName": "DOMAIN-33-public-section-public.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-33\\DOMAIN-33-public-section-public.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "33.5-public-erasure-request-form.md",
            "title": "Section public",
            "description": "Implementation for domain 33 section public",
            "topics": ["Domain 33 implementation"],
            "sectionNumber": "public",
            "content": "### 33.5 Public Erasure Request Form\n\n**File:** `apps/*/src/app/privacy/erasure/page.tsx`\n\n```typescript\nimport type { Metadata } from 'next';\nimport { ErasureRequestForm } from '@/components/privacy/ErasureRequestForm';\n\nexport const metadata: Metadata = {\n  title: 'Data Deletion Request',\n  description: 'Request deletion of your personal data.',\n  robots: { index: false, follow: false }, // Never index privacy/legal pages\n};\n\nexport default function ErasureRequestPage() {\n  return (\n    <main id=\"main-content\" className=\"max-w-xl mx-auto px-6 py-16\">\n      <h1 className=\"text-3xl font-bold text-gray-900 mb-4\">\n        Request Data Deletion\n      </h1>\n      <p className=\"text-gray-600 mb-8\">\n        Under GDPR Article 17 and CCPA, you have the right to request deletion of\n        your personal data. Submit your request below â€” we'll process it within\n        30 days and send confirmation to your email address.\n      </p>\n      <ErasureRequestForm />\n    </main>\n  );\n}\n```\n\n**File:** `apps/*/src/app/api/privacy/erasure/route.ts`\n\n```typescript\nimport { NextRequest, NextResponse } from 'next/server';\nimport { z } from 'zod';\nimport { v4 as uuidv4 } from 'uuid';\nimport { checkRateLimit } from '@repo/security/rate-limit';\nimport { resolveTenant } from '@repo/multi-tenant/resolve-tenant';\nimport { processErasureRequest } from '@repo/privacy/erasure';\nimport { enqueue } from '@repo/jobs/client';\n\nconst ErasureSchema = z.object({\n  email: z.string().email(),\n  reason: z.string().max(500).optional(),\n});\n\n// Rate limit: 3 requests per email per 24h (prevent abuse)\nexport async function POST(req: NextRequest) {\n  const limited = await checkRateLimit(req, 'erasure');\n  if (limited) return limited;\n\n  const tenantContext = await resolveTenant(req);\n  if (!tenantContext) return NextResponse.json({ error: 'Not found' }, { status: 404 });\n\n  const body = await req.json().catch(() => null);\n  const parsed = ErasureSchema.safeParse(body);\n\n  if (!parsed.success) {\n    return NextResponse.json({ error: 'Invalid request' }, { status: 400 });\n  }\n\n  const requestId = uuidv4();\n\n  // Queue as a job â€” don't block the HTTP response waiting for DB operations\n  await enqueue('erasure.process', {\n    requestId,\n    tenantId: tenantContext.tenantId,\n    subjectEmail: parsed.data.email,\n    requestedAt: new Date().toISOString(),\n    requestedBy: 'subject',\n    reason: parsed.data.reason,\n  });\n\n  // Confirmation email (async)\n  await enqueue('email.erasure.confirmation', {\n    tenantId: tenantContext.tenantId,\n    email: parsed.data.email,\n    requestId,\n  });\n\n  return NextResponse.json({\n    success: true,\n    requestId,\n    message: \"Your request has been received. We'll process it within 30 days.\",\n  });\n}\n```\n\n---\n",
            "domainNumber": 33
          }
        }
      ]
    },
    {
      "domainNumber": 34,
      "success": true,
      "tasksCreated": 5,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 34,
          "fileName": "DOMAIN-34-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-34\\DOMAIN-34-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "34.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 34 section philosophy.md",
            "topics": ["Domain 34 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 34.1 Philosophy\n\n**What it is:** Enterprise-tier clients (typically agencies using the platform under their own brand) want zero visible trace of the underlying platform. The portal itself should show their logo, their brand colors, their custom domain, and no \"Powered by\" attribution. [youtube](https://www.youtube.com/watch?v=GdUqkgBW6cQ)\n\n**What changes per white-label client:**\n\n- Portal domain: `portal.johnsplumbing.com` instead of `portal.agency.com`\n- Portal logo + favicon: their branding\n- Portal primary color: applied via CSS custom properties\n- Email sender: `noreply@johnsplumbing.com`\n- Remove all \"Powered by Agency\" footers and attribution\n- Custom error pages (`404`, `500`) with their branding\n\n**What does NOT change:** The underlying codebase, database, or infrastructure. White-labeling is a presentation layer controlled entirely by `site.config` + CSS variables. No code branching required.\n\n---\n",
            "domainNumber": 34
          }
        },
        {
          "domainNumber": 34,
          "fileName": "DOMAIN-34-white-section-white.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-34\\DOMAIN-34-white-section-white.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "34.2-white-label-config-schema.md",
            "title": "Section white",
            "description": "Implementation for domain 34 section white",
            "topics": ["Domain 34 implementation"],
            "sectionNumber": "white",
            "content": "### 34.2 White-Label Config Schema\n\n**Extension to `SiteConfig` for Enterprise tier:**\n\n```typescript\n// packages/config/src/types.ts (additions)\n\nexport interface WhiteLabelConfig {\n  enabled: boolean;\n  // Portal branding (replaces agency branding)\n  portalName: string; // e.g. \"Johns Plumbing Client Portal\"\n  portalLogoUrl?: string; // URL in Supabase Storage\n  portalFaviconUrl?: string;\n  portalPrimaryColor: string; // Portal primary CSS variable\n  portalDomain?: string; // e.g. \"portal.johnsplumbing.com\"\n  // Remove attribution\n  hideAgencyBranding: boolean; // Removes \"Powered by\" footer\n  hideSupportLink: boolean; // Hides support chat widget\n  // Custom legal\n  privacyPolicyUrl?: string;\n  termsOfServiceUrl?: string;\n  // Custom support\n  supportEmail?: string;\n  supportPhone?: string;\n}\n```\n\n---\n",
            "domainNumber": 34
          }
        },
        {
          "domainNumber": 34,
          "fileName": "DOMAIN-34-white-section-white.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-34\\DOMAIN-34-white-section-white.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "34.3-white-label-theme-provider.md",
            "title": "Section white",
            "description": "Implementation for domain 34 section white",
            "topics": ["Domain 34 implementation"],
            "sectionNumber": "white",
            "content": "### 34.3 White-Label Theme Provider\n\n**File:** `apps/portal/src/components/providers/WhiteLabelProvider.tsx`\n\n```typescript\nimport { headers } from 'next/headers';\nimport { resolveTenant } from '@repo/multi-tenant/resolve-tenant';\nimport { db } from '@repo/db';\n\n// ============================================================================\n// WHITE-LABEL THEME PROVIDER\n// Server Component: reads white-label config from DB, injects CSS variables\n// into <head> so the portal renders with the client's brand colors from byte 1.\n// No flash of wrong brand color â€” values are in the SSR'd HTML.\n// ============================================================================\n\nexport async function WhiteLabelProvider({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  const headersList = await headers();\n  const tenantContext = await resolveTenant({ headers: headersList } as any);\n\n  let whiteLabelConfig = null;\n\n  if (tenantContext) {\n    const { data: tenant } = await db\n      .from('tenants')\n      .select('config, plan')\n      .eq('id', tenantContext.tenantId)\n      .single();\n\n    // White-label only available on Enterprise plan\n    if (tenant?.plan === 'enterprise') {\n      whiteLabelConfig = (tenant.config as any)?.whiteLabel ?? null;\n    }\n  }\n\n  // If no white-label config, use agency defaults\n  const primaryColor = whiteLabelConfig?.portalPrimaryColor ?? '#2563eb';\n  const portalName = whiteLabelConfig?.portalName ?? process.env.NEXT_PUBLIC_AGENCY_NAME ?? 'Client Portal';\n\n  const cssVars = `\n    :root {\n      --color-primary: ${primaryColor};\n      --color-primary-50: ${primaryColor}14;\n      --color-primary-100: ${primaryColor}29;\n      --color-primary-500: ${primaryColor};\n      --color-primary-600: ${primaryColor}e6;\n      --color-primary-700: ${primaryColor}cc;\n      --portal-name: \"${portalName}\";\n    }\n  `.trim();\n\n  return (\n    <>\n      {/* Inline CSS variables â€” no FOUC, no flash */}\n      <style\n        dangerouslySetInnerHTML={{ __html: cssVars }}\n        id=\"white-label-vars\"\n      />\n      {children}\n    </>\n  );\n}\n```\n\n---\n",
            "domainNumber": 34
          }
        },
        {
          "domainNumber": 34,
          "fileName": "DOMAIN-34-white-section-white.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-34\\DOMAIN-34-white-section-white.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "34.4-white-label-portal-layout.md",
            "title": "Section white",
            "description": "Implementation for domain 34 section white",
            "topics": ["Domain 34 implementation"],
            "sectionNumber": "white",
            "content": "### 34.4 White-Label Portal Layout\n\n**File:** `apps/portal/src/app/layout.tsx` (relevant sections)\n\n```typescript\nimport { WhiteLabelProvider } from '@/components/providers/WhiteLabelProvider';\nimport { WhiteLabelHeader } from '@/components/layout/WhiteLabelHeader';\nimport { WhiteLabelFooter } from '@/components/layout/WhiteLabelFooter';\n\nexport default async function PortalLayout({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  const headersList = await headers();\n  const tenantContext = await resolveTenant({ headers: headersList } as any);\n\n  let whiteLabelData = {\n    portalName: process.env.NEXT_PUBLIC_AGENCY_NAME ?? 'Client Portal',\n    logoUrl: null as string | null,\n    faviconUrl: null as string | null,\n    hideAgencyBranding: false,\n    supportEmail: process.env.NEXT_PUBLIC_AGENCY_SUPPORT_EMAIL,\n    hideSupportLink: false,\n  };\n\n  if (tenantContext) {\n    const { data: tenant } = await db\n      .from('tenants')\n      .select('config, plan')\n      .eq('id', tenantContext.tenantId)\n      .single();\n\n    if (tenant?.plan === 'enterprise') {\n      const wl = (tenant.config as any)?.whiteLabel;\n      if (wl?.enabled) {\n        whiteLabelData = {\n          portalName: wl.portalName ?? whiteLabelData.portalName,\n          logoUrl: wl.portalLogoUrl ?? null,\n          faviconUrl: wl.portalFaviconUrl ?? null,\n          hideAgencyBranding: wl.hideAgencyBranding ?? false,\n          supportEmail: wl.supportEmail ?? whiteLabelData.supportEmail,\n          hideSupportLink: wl.hideSupportLink ?? false,\n        };\n      }\n    }\n  }\n\n  return (\n    <html lang=\"en\" suppressHydrationWarning>\n      <head>\n        {whiteLabelData.faviconUrl && (\n          <link rel=\"icon\" href={whiteLabelData.faviconUrl} />\n        )}\n      </head>\n      <body>\n        <WhiteLabelProvider>\n          <WhiteLabelHeader\n            portalName={whiteLabelData.portalName}\n            logoUrl={whiteLabelData.logoUrl}\n          />\n          <main id=\"main-content\">\n            {children}\n          </main>\n          <WhiteLabelFooter\n            hideAgencyBranding={whiteLabelData.hideAgencyBranding}\n            supportEmail={whiteLabelData.supportEmail}\n            hideSupportLink={whiteLabelData.hideSupportLink}\n          />\n        </WhiteLabelProvider>\n      </body>\n    </html>\n  );\n}\n```\n\n**File:** `apps/portal/src/components/layout/WhiteLabelHeader.tsx`\n\n```typescript\nimport Image from 'next/image';\nimport Link from 'next/link';\n\ninterface WhiteLabelHeaderProps {\n  portalName: string;\n  logoUrl: string | null;\n}\n\nexport function WhiteLabelHeader({ portalName, logoUrl }: WhiteLabelHeaderProps) {\n  return (\n    <header className=\"sticky top-0 z-40 bg-white border-b border-gray-200 h-16\">\n      <div className=\"h-full max-w-7xl mx-auto px-4 sm:px-6 flex items-center justify-between\">\n        <Link\n          href=\"/dashboard\"\n          className=\"flex items-center gap-3 focus-visible:ring-2 focus-visible:ring-primary rounded-lg\"\n          aria-label={`${portalName} â€” go to dashboard`}\n        >\n          {logoUrl ? (\n            <Image\n              src={logoUrl}\n              alt={`${portalName} logo`}\n              width={120}\n              height={36}\n              className=\"h-8 w-auto object-contain\"\n              priority\n            />\n          ) : (\n            <span className=\"text-lg font-bold text-gray-900\">{portalName}</span>\n          )}\n        </Link>\n\n        {/* Navigation, notifications, user menu â€” same regardless of white-label */}\n        <PortalHeaderActions />\n      </div>\n    </header>\n  );\n}\n\nfunction PortalHeaderActions() {\n  // Notifications bell, user avatar dropdown â€” implementation shared across all tenants\n  return (\n    <div className=\"flex items-center gap-3\">\n      {/* See Domain 3 (Auth) for user menu implementation */}\n    </div>\n  );\n}\n```\n\n**File:** `apps/portal/src/components/layout/WhiteLabelFooter.tsx`\n\n```typescript\ninterface WhiteLabelFooterProps {\n  hideAgencyBranding: boolean;\n  supportEmail?: string;\n  hideSupportLink: boolean;\n}\n\nexport function WhiteLabelFooter({\n  hideAgencyBranding,\n  supportEmail,\n  hideSupportLink,\n}: WhiteLabelFooterProps) {\n  return (\n    <footer className=\"border-t border-gray-100 py-4 px-6 mt-auto\">\n      <div className=\"max-w-7xl mx-auto flex items-center justify-between text-xs text-gray-400\">\n        <p>Â© {new Date().getFullYear()} All rights reserved.</p>\n\n        <div className=\"flex items-center gap-4\">\n          {supportEmail && !hideSupportLink && (\n            <a href={`mailto:${supportEmail}`} className=\"hover:text-gray-600 transition-colors\">\n              Support\n            </a>\n          )}\n\n          {/* \"Powered by\" â€” hidden on Enterprise white-label */}\n          {!hideAgencyBranding && (\n            <span className=\"text-gray-300\">\n              Powered by {process.env.NEXT_PUBLIC_AGENCY_NAME ?? 'Platform'}\n            </span>\n          )}\n        </div>\n      </div>\n    </footer>\n  );\n}\n```\n\n---\n",
            "domainNumber": 34
          }
        },
        {
          "domainNumber": 34,
          "fileName": "DOMAIN-34-white-section-white.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-34\\DOMAIN-34-white-section-white.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "34.5-white-label-settings-enterprise-admin.md",
            "title": "Section white",
            "description": "Implementation for domain 34 section white",
            "topics": ["Domain 34 implementation"],
            "sectionNumber": "white",
            "content": "### 34.5 White-Label Settings (Enterprise Admin)\n\n**File:** `apps/portal/src/features/settings/ui/WhiteLabelSettings.tsx`\n\n```typescript\n'use client';\n\nimport { useState, useTransition } from 'react';\nimport { AssetUploader } from '@/features/assets/ui/AssetUploader';\nimport { updateWhiteLabelSettings } from '../model/settings-actions';\n\ninterface WhiteLabelSettingsProps {\n  tenantId: string;\n  initialConfig: {\n    portalName?: string;\n    portalLogoUrl?: string;\n    portalPrimaryColor?: string;\n    hideAgencyBranding?: boolean;\n    hideSupportLink?: boolean;\n    privacyPolicyUrl?: string;\n  };\n  isPlanEnterprise: boolean;\n}\n\nexport function WhiteLabelSettings({\n  tenantId,\n  initialConfig,\n  isPlanEnterprise,\n}: WhiteLabelSettingsProps) {\n  const [portalName, setPortalName] = useState(initialConfig.portalName ?? '');\n  const [primaryColor, setPrimaryColor] = useState(initialConfig.portalPrimaryColor ?? '#2563eb');\n  const [hideAgencyBranding, setHideAgencyBranding] = useState(initialConfig.hideAgencyBranding ?? false);\n  const [hideSupportLink, setHideSupportLink] = useState(initialConfig.hideSupportLink ?? false);\n  const [privacyPolicyUrl, setPrivacyPolicyUrl] = useState(initialConfig.privacyPolicyUrl ?? '');\n  const [isPending, startTransition] = useTransition();\n  const [saved, setSaved] = useState(false);\n\n  if (!isPlanEnterprise) {\n    return (\n      <div className=\"rounded-xl border-2 border-dashed border-gray-200 p-8 text-center\">\n        <p className=\"text-2xl mb-3\">ðŸ·ï¸</p>\n        <p className=\"font-semibold text-gray-900 mb-1\">White-Label is an Enterprise feature</p>\n        <p className=\"text-sm text-gray-500 mb-4\">\n          Remove all platform branding and use your own logo, colors, and domain.\n        </p>\n        <a\n          href=\"/billing\"\n          className=\"inline-flex px-5 py-2.5 bg-primary text-white rounded-xl text-sm font-semibold hover:opacity-90\"\n        >\n          Upgrade to Enterprise\n        </a>\n      </div>\n    );\n  }\n\n  const handleSave = (e: React.FormEvent) => {\n    e.preventDefault();\n    startTransition(async () => {\n      await updateWhiteLabelSettings({\n        portalName,\n        portalPrimaryColor: primaryColor,\n        hideAgencyBranding,\n        hideSupportLink,\n        privacyPolicyUrl: privacyPolicyUrl || undefined,\n      });\n      setSaved(true);\n      setTimeout(() => setSaved(false), 3000);\n    });\n  };\n\n  return (\n    <form onSubmit={handleSave} className=\"space-y-6\" aria-label=\"White-label portal settings\">\n      <div>\n        <h2 className=\"text-lg font-bold text-gray-900 mb-1\">White-Label Portal</h2>\n        <p className=\"text-sm text-gray-500\">\n          Customize the portal to match your brand. Changes take effect immediately.\n        </p>\n      </div>\n\n      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-6\">\n        <div>\n          <label htmlFor=\"portal-name\" className=\"block text-sm font-medium text-gray-700 mb-1.5\">\n            Portal Name\n          </label>\n          <input\n            id=\"portal-name\"\n            type=\"text\"\n            value={portalName}\n            onChange={(e) => setPortalName(e.target.value)}\n            placeholder=\"Acme Co. Client Portal\"\n            maxLength={60}\n            className=\"w-full border border-gray-300 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary\"\n          />\n        </div>\n\n        <div>\n          <label htmlFor=\"primary-color\" className=\"block text-sm font-medium text-gray-700 mb-1.5\">\n            Portal Primary Color\n          </label>\n          <div className=\"flex items-center gap-3\">\n            <input\n              id=\"primary-color\"\n              type=\"color\"\n              value={primaryColor}\n              onChange={(e) => setPrimaryColor(e.target.value)}\n              className=\"h-10 w-14 border border-gray-300 rounded-lg cursor-pointer p-0.5\"\n              aria-label=\"Choose primary color\"\n            />\n            <input\n              type=\"text\"\n              value={primaryColor}\n              onChange={(e) => setPrimaryColor(e.target.value)}\n              placeholder=\"#2563eb\"\n              maxLength={7}\n              className=\"flex-1 border border-gray-300 rounded-xl px-4 py-2.5 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-primary\"\n              aria-label=\"Hex color value\"\n            />\n          </div>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-6\">\n        <AssetUploader\n          assetType=\"logo\"\n          currentUrl={initialConfig.portalLogoUrl}\n          label=\"Portal Logo\"\n          aspectHint=\"horizontal (3:1 recommended)\"\n          tenantId={tenantId}\n        />\n      </div>\n\n      {/* Toggle options */}\n      <div className=\"space-y-4 pt-4 border-t border-gray-100\">\n        {[\n          {\n            id: 'hide-agency',\n            label: 'Remove \"Powered by\" branding',\n            description: 'Hides the platform attribution in the footer.',\n            value: hideAgencyBranding,\n            onChange: setHideAgencyBranding,\n          },\n          {\n            id: 'hide-support',\n            label: 'Hide support link',\n            description: 'Removes the platform support link from the footer.',\n            value: hideSupportLink,\n            onChange: setHideSupportLink,\n          },\n        ].map((toggle) => (\n          <div key={toggle.id} className=\"flex items-start justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-900\">{toggle.label}</p>\n              <p className=\"text-xs text-gray-500 mt-0.5\">{toggle.description}</p>\n            </div>\n            <button\n              type=\"button\"\n              role=\"switch\"\n              aria-checked={toggle.value}\n              id={toggle.id}\n              onClick={() => toggle.onChange(!toggle.value)}\n              className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors flex-shrink-0 ml-4 ${\n                toggle.value ? 'bg-primary' : 'bg-gray-300'\n              }`}\n              aria-label={toggle.label}\n            >\n              <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${\n                toggle.value ? 'translate-x-6' : 'translate-x-1'\n              }`} />\n            </button>\n          </div>\n        ))}\n      </div>\n\n      <div className=\"flex items-center gap-4\">\n        <button\n          type=\"submit\"\n          disabled={isPending}\n          className=\"px-6 py-2.5 bg-primary text-white rounded-xl font-semibold text-sm disabled:opacity-50 hover:opacity-90 transition-opacity\"\n        >\n          {isPending ? 'Savingâ€¦' : 'Save White-Label Settings'}\n        </button>\n        {saved && (\n          <p role=\"status\" className=\"text-sm text-green-600 font-medium\">âœ“ Settings saved</p>\n        )}\n      </div>\n    </form>\n  );\n}\n```\n\n---\n\n## Priority Table for Domains 31â€“34\n\n| Task                                                         | Domain | Priority | Timeline | Success Metric                                                    |\n| ------------------------------------------------------------ | ------ | -------- | -------- | ----------------------------------------------------------------- |\n| Service worker registration + app shell caching              | 31     | **P1**   | Week 2   | Marketing site loads offline after first visit                    |\n| BackgroundSync plugin for contact form POSTs                 | 31     | **P1**   | Week 2   | Form submitted offline fires when reconnected                     |\n| `useOfflineForm` hook with IndexedDB fallback                | 31     | **P1**   | Week 2   | Offline submission stored, synced on reconnect                    |\n| Per-tenant `manifest.ts` (name, color, icons)                | 31     | **P1**   | Week 2   | \"Add to Home Screen\" installs with correct branding               |\n| Offline banner (online/offline status indicator)             | 31     | **P2**   | Week 3   | Visitor sees yellow bar when offline                              |\n| `@react-pdf/renderer` weekly report template                 | 32     | **P1**   | Week 2   | PDF renders with logo, bar chart, top leads table                 |\n| QStash weekly report job (Sunday 11PM CST)                   | 32     | **P1**   | Week 2   | Cron triggers per active tenant with reports enabled              |\n| PDF upload to Supabase Storage (private bucket)              | 32     | **P1**   | Week 2   | PDF accessible via 7-day signed URL                               |\n| Report email with download link                              | 32     | **P1**   | Week 2   | Email arrives Sunday evening with correct stats                   |\n| Notification preference to disable reports                   | 32     | **P2**   | Week 3   | Client can opt out of weekly report                               |\n| Cookie consent banner (server-side, no FOUC)                 | 33     | **P0**   | Week 1   | Banner shows on first visit, hidden on return                     |\n| Accept/Reject/Customize consent flows                        | 33     | **P0**   | Week 1   | All three paths set correct cookie and fire GA consent mode       |\n| GDPR Article 17 erasure endpoint + job                       | 33     | **P0**   | Week 1   | Erasure request queued and processed within 30 days               |\n| PII anonymization for bookings (hard delete for leads)       | 33     | **P0**   | Week 1   | Booking records retained, PII replaced with pseudonyms            |\n| Erasure request audit log (`erasure_requests` table)         | 33     | **P0**   | Week 1   | Every request traceable with timestamp and result                 |\n| GDPR Article 20 data export endpoint                         | 33     | **P1**   | Week 2   | Subject can download all their data as JSON                       |\n| White-label CSS variable injection (server-side)             | 34     | **P1**   | Week 2   | No flash of wrong brand color on portal load                      |\n| White-label portal name + logo in header                     | 34     | **P1**   | Week 2   | Agency logo replaced with client logo on Enterprise plan          |\n| Hide \"Powered by\" on Enterprise plan                         | 34     | **P1**   | Week 2   | No platform attribution visible in footer                         |\n| White-label settings UI (Enterprise-gated)                   | 34     | **P2**   | Week 3   | Non-Enterprise sees upgrade prompt; Enterprise sees full settings |\n| White-label portal domain support (custom `portal.*` domain) | 34     | **P2**   | Week 3   | `portal.johnsplumbing.com` routes to correct tenant portal        |\n\n---\n\n**Cross-domain invariants for Domains 31â€“34:**\n\n- The BackgroundSync queue tag (`contact-form-queue`) is hardcoded in both the service worker and the form hook. A mismatch means queued requests are never replayed. They must be identical strings. [youtube](https://www.youtube.com/watch?v=unnBfDeQYQM)\n- `@react-pdf/renderer`'s `renderToBuffer` must be called in a Node.js Route Handler, **not** an Edge Runtime function â€” the library has no Edge-compatible build. The `maxDuration = 60` directive is required because PDF generation with fonts can take 10â€“40 seconds on cold starts. [reddit](https://www.reddit.com/r/nextjs/comments/1pqkmeu/anyone_generating_pdfs_serverside_in_nextjs/)\n- GDPR erasure of booking records uses **anonymization not hard deletion** because financial records (booking history, payment correlation) may have a legitimate retention basis under accounting law. The legal distinction: hard deletion where no retention basis exists (leads), anonymization where a retention basis exists but PII must be removed (bookings). [rgpd](https://rgpd.com/gdpr/chapter-3-rights-of-the-data-subject/article-17-right-to-erasure-right-to-be-forgotten/)\n- The cookie consent cookie is `httpOnly: false` â€” this is intentional. Google's Consent Mode v2 requires the page's JavaScript to read the consent state to conditionally fire gtag commands. An `httpOnly` cookie would prevent this. [buildwithmatija](https://www.buildwithmatija.com/blog/build-cookie-consent-banner-nextjs-15-server-client)\n- White-label CSS variables are injected as an inline `<style>` tag in the server-rendered HTML, **not** via a `useEffect` or client-side CSS-in-JS. This eliminates the flash of wrong brand color on first paint â€” critical for Enterprise clients doing demos to their own customers. [youtube](https://www.youtube.com/watch?v=GdUqkgBW6cQ)\n",
            "domainNumber": 34
          }
        }
      ]
    },
    {
      "domainNumber": 35,
      "success": true,
      "tasksCreated": 7,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 35,
          "fileName": "DOMAIN-35-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-35\\DOMAIN-35-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "35.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 35 section philosophy.md",
            "topics": ["Domain 35 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 35.1 Philosophy\n\n**What it is:** A hardened, automated system that prevents performance regressions from ever reaching production. Every PR runs Lighthouse CI audits, every build enforces bundle size limits, and every production deployment feeds Vercel Speed Insights (RUM) so real-user degradation triggers an alert â€” not a post-mortem. [trevorlasn](https://www.trevorlasn.com/blog/lighthouse-ci)\n\n**Why a budget, not just monitoring:** Monitoring tells you a regression already reached production. A performance budget makes it impossible to merge one. LCP < 2.5s, INP < 200ms, CLS < 0.1 â€” these are Google's Good thresholds. A single unreviewed `import` of a 200KB charting library can flip LCP from 1.8s to 3.4s. The budget gate catches this in CI before it ships. [almcorp](https://almcorp.com/blog/core-web-vitals-2026-technical-seo-guide/)\n\n**The two enforcement layers:**\n\n| Layer                       | Tool                                   | When It Runs                          | What It Blocks                              |\n| --------------------------- | -------------------------------------- | ------------------------------------- | ------------------------------------------- |\n| Bundle size gate            | `@next/bundle-analyzer` + `size-limit` | On every `next build` in CI           | PRs that grow JS payload beyond budget      |\n| Lighthouse performance gate | `@lhci/cli`                            | Post-build against preview deployment | PRs where LCP/INP/CLS drops below threshold |\n\n---\n",
            "domainNumber": 35
          }
        },
        {
          "domainNumber": 35,
          "fileName": "DOMAIN-35-performance-section-performance.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-35\\DOMAIN-35-performance-section-performance.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "35.2-performance-budgets-configuration.md",
            "title": "Section performance",
            "description": "Implementation for domain 35 section performance",
            "topics": ["Domain 35 implementation"],
            "sectionNumber": "performance",
            "content": "### 35.2 Performance Budgets Configuration\n\n**File:** `.lighthouserc.ts` (repo root)\n\n```typescript\n// ============================================================================\n// LIGHTHOUSE CI CONFIG\n// Runs against Vercel preview deployment URL (injected by CI as LHCI_BUILD_CONTEXT__CURRENT_BRANCH_URL)\n// Reference: https://github.com/GoogleChrome/lighthouse-ci\n// ============================================================================\n\nconst config = {\n  ci: {\n    collect: {\n      // Audit 3 critical paths per PR\n      url: [\n        process.env.LHCI_BASE_URL ?? 'http://localhost:3000',\n        `${process.env.LHCI_BASE_URL ?? 'http://localhost:3000'}/services`,\n        `${process.env.LHCI_BASE_URL ?? 'http://localhost:3000'}/contact`,\n      ],\n      numberOfRuns: 3, // Median of 3 runs â€” eliminates noise\n      settings: {\n        // Throttle to simulate a mid-range mobile device (Moto G4 equivalent)\n        throttling: {\n          rttMs: 40,\n          throughputKbps: 10240,\n          cpuSlowdownMultiplier: 1, // Desktop test â€” clients are mostly desktop\n        },\n        formFactor: 'desktop',\n        screenEmulation: {\n          mobile: false,\n          width: 1350,\n          height: 940,\n          deviceScaleFactor: 1,\n          disabled: false,\n        },\n        onlyCategories: ['performance', 'accessibility', 'best-practices', 'seo'],\n      },\n    },\n\n    assert: {\n      // Fail the build if ANY of these assertions fail on ANY audited page\n      assertions: {\n        // â”€â”€ Core Web Vitals (Google \"Good\" thresholds) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        'largest-contentful-paint': [\n          'error',\n          { maxNumericValue: 2500, aggregationMethod: 'median-run' },\n        ],\n        'interaction-to-next-paint': [\n          'error',\n          { maxNumericValue: 200, aggregationMethod: 'median-run' },\n        ],\n        'cumulative-layout-shift': [\n          'error',\n          { maxNumericValue: 0.1, aggregationMethod: 'median-run' },\n        ],\n        'total-blocking-time': ['error', { maxNumericValue: 300, aggregationMethod: 'median-run' }],\n\n        // â”€â”€ Lighthouse scores (composite) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        'categories:performance': ['error', { minScore: 0.85 }],\n        'categories:accessibility': ['error', { minScore: 0.95 }], // WCAG 2.2 AA\n        'categories:best-practices': ['warn', { minScore: 0.9 }],\n        'categories:seo': ['error', { minScore: 0.95 }],\n\n        // â”€â”€ Resource size budgets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        'resource-summary:script:size': ['error', { maxNumericValue: 400_000 }], // 400 KB JS\n        'resource-summary:image:size': ['warn', { maxNumericValue: 1_000_000 }], // 1 MB images\n        'resource-summary:total:size': ['error', { maxNumericValue: 2_000_000 }], // 2 MB total\n\n        // â”€â”€ Specific audits â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        'uses-optimized-images': 'warn',\n        'uses-responsive-images': 'warn',\n        'uses-text-compression': 'error',\n        'uses-long-cache-ttl': 'warn',\n        'render-blocking-resources': ['error', { maxLength: 0 }],\n        'unused-javascript': ['warn', { maxNumericValue: 50_000 }], // Warn if > 50KB unused JS\n        'unused-css-rules': 'warn',\n        'modern-image-formats': 'warn',\n        'no-document-write': 'error',\n\n        // â”€â”€ Accessibility (complements Domain 14) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        'color-contrast': 'error',\n        'image-alt': 'error',\n        label: 'error',\n        'duplicate-id-aria': 'error',\n        'button-name': 'error',\n        'link-name': 'error',\n\n        // â”€â”€ SEO audits â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        'meta-description': 'error',\n        'document-title': 'error',\n        canonical: 'warn',\n        'robots-txt': 'warn',\n      },\n    },\n\n    upload: {\n      target: 'temporary-public-storage', // Free LHCI server storage (90d retention)\n      // For Enterprise: replace with: target: 'lhci', serverBaseUrl: process.env.LHCI_SERVER_URL\n    },\n  },\n};\n\nexport default config;\n```\n\n---\n",
            "domainNumber": 35
          }
        },
        {
          "domainNumber": 35,
          "fileName": "DOMAIN-35-bundle-section-bundle.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-35\\DOMAIN-35-bundle-section-bundle.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "35.3-bundle-size-gate.md",
            "title": "Section bundle",
            "description": "Implementation for domain 35 section bundle",
            "topics": ["Domain 35 implementation"],
            "sectionNumber": "bundle",
            "content": "### 35.3 Bundle Size Gate\n\n**File:** `.size-limit.ts` (repo root)\n\n```typescript\n// ============================================================================\n// SIZE-LIMIT CONFIG\n// Enforces per-route JavaScript payload budgets.\n// Run: pnpm size-limit â†’ fails CI if any budget is exceeded.\n// Reference: https://nextjs.org/docs/app/guides/package-bundling\n// ============================================================================\n\nconst config = [\n  // â”€â”€ Marketing site pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  {\n    name: 'Marketing: Homepage (First Load JS)',\n    path: '.next/static/chunks/pages/index.js',\n    limit: '85 KB',\n    gzip: true,\n  },\n  {\n    name: 'Marketing: Service page',\n    path: '.next/static/chunks/pages/services/[slug].js',\n    limit: '60 KB',\n    gzip: true,\n  },\n  {\n    name: 'Marketing: Contact page',\n    path: '.next/static/chunks/pages/contact.js',\n    limit: '50 KB',\n    gzip: true,\n  },\n\n  // â”€â”€ Shared chunks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  {\n    name: 'Framework chunk (React + Next.js runtime)',\n    path: '.next/static/chunks/framework-*.js',\n    limit: '50 KB',\n    gzip: true,\n  },\n  {\n    name: 'Main chunk (shared code)',\n    path: '.next/static/chunks/main-*.js',\n    limit: '40 KB',\n    gzip: true,\n  },\n\n  // â”€â”€ Portal pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  {\n    name: 'Portal: Dashboard First Load JS',\n    path: '.next/static/chunks/pages/dashboard/index.js',\n    limit: '120 KB', // Portal can be heavier â€” no SEO concern\n    gzip: true,\n  },\n  {\n    name: 'Portal: Leads page',\n    path: '.next/static/chunks/pages/dashboard/leads.js',\n    limit: '90 KB',\n    gzip: true,\n  },\n];\n\nexport default config;\n```\n\n**File:** `packages/config/src/next.config.ts` (bundle analyzer wrapper)\n\n```typescript\nimport type { NextConfig } from 'next';\nimport bundleAnalyzer from '@next/bundle-analyzer';\n\n// ============================================================================\n// BUNDLE ANALYZER CONFIG\n// Enable: ANALYZE=true pnpm build\n// Generates: .next/analyze/client.html + server.html\n// ============================================================================\n\nconst withBundleAnalyzer = bundleAnalyzer({\n  enabled: process.env.ANALYZE === 'true',\n  openAnalyzer: false, // CI-safe: don't auto-open browser\n});\n\nexport function withPerformanceDefaults(config: NextConfig): NextConfig {\n  return withBundleAnalyzer({\n    ...config,\n\n    // Turbopack (stable in Next.js 16): faster builds, same output\n    turbopack: {\n      rules: {},\n    },\n\n    // Tree-shake: only import used icons from lucide-react\n    experimental: {\n      optimizePackageImports: [\n        'lucide-react',\n        '@radix-ui/react-icons',\n        'date-fns',\n        'lodash-es',\n        '@react-pdf/renderer', // Lazy-load only in report job context\n      ],\n    },\n\n    // Compiler options\n    compiler: {\n      removeConsole: process.env.NODE_ENV === 'production' ? { exclude: ['error', 'warn'] } : false,\n    },\n\n    // Images: WebP/AVIF by default\n    images: {\n      formats: ['image/avif', 'image/webp'],\n      deviceSizes: [640, 750, 828, 1080, 1200, 1920],\n      imageSizes: [16, 32, 48, 64, 96, 128, 256],\n      minimumCacheTTL: 31536000, // 1 year â€” immutable images\n    },\n  });\n}\n```\n\n---\n",
            "domainNumber": 35
          }
        },
        {
          "domainNumber": 35,
          "fileName": "DOMAIN-35-lcp-section-lcp.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-35\\DOMAIN-35-lcp-section-lcp.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "35.4-lcp-optimization-checklist-code-level.md",
            "title": "Section lcp",
            "description": "Implementation for domain 35 section lcp",
            "topics": ["Domain 35 implementation"],
            "sectionNumber": "lcp",
            "content": "### 35.4 LCP Optimization Checklist (Code-Level)\n\nThese are non-negotiable implementation patterns applied across all tenant marketing sites. [makersden](https://makersden.io/blog/optimize-web-vitals-in-nextjs-2025)\n\n**Hero image â€” the #1 LCP element:**\n\n```typescript\n// âœ… CORRECT â€” hero image is always the LCP element\n// next/image with priority=true skips lazy loading and emits\n// <link rel=\"preload\" as=\"image\"> in <head> for the LCP candidate.\n\nimport Image from 'next/image';\n\nexport function HeroSection({ imageUrl, alt }: { imageUrl: string; alt: string }) {\n  return (\n    <section className=\"relative h-[560px] overflow-hidden\">\n      <Image\n        src={imageUrl}\n        alt={alt}\n        fill\n        priority                        // Preload + no lazy loading\n        fetchPriority=\"high\"            // Explicitly boost fetch priority\n        sizes=\"100vw\"                   // Full viewport width\n        className=\"object-cover\"\n        quality={85}                    // 85 = sweet spot: quality vs size\n        placeholder=\"blur\"             // Base64 LQIP â€” no layout shift during load\n        blurDataURL=\"data:image/svg+xml;base64,...\"  // From build-time Plaiceholder\n      />\n    </section>\n  );\n}\n\n// âŒ WRONG â€” never do this for above-the-fold images\n// <Image src={url} alt={alt} fill />  â† no priority â†’ treated as lazy â†’ LCP suffers\n// <img src={url} alt={alt} />         â† no optimization â†’ no preload â†’ no AVIF/WebP\n```\n\n**Font optimization â€” zero CLS from font swap:** [shahin](https://shahin.page/article/nextjs-font-optimization-google-local-self-hosting-performance)\n\n```typescript\n// File: apps/*/src/app/layout.tsx\n\nimport { Inter } from 'next/font/google';\n\n// next/font downloads Inter at BUILD TIME, self-hosts it, and generates\n// CSS size-adjust overrides for the system fallback font.\n// Result: ZERO layout shift when the custom font loads â€” CLS = 0.00 from fonts.\n\nconst inter = Inter({\n  subsets: ['latin'],\n  display: 'swap',                           // FOUT (flash of unstyled text) is acceptable\n  preload: true,                             // Generates <link rel=\"preload\"> in <head>\n  variable: '--font-inter',                  // CSS custom property for Tailwind integration\n  fallback: ['system-ui', 'arial'],          // Explicit fallback â€” used for size-adjust\n  adjustFontFallback: true,                  // Generates size-adjust, ascent-override etc.\n});\n\nexport default function RootLayout({ children }: { children: React.ReactNode }) {\n  return (\n    <html lang=\"en\" className={inter.variable}>\n      <body className=\"font-sans\">\n        {children}\n      </body>\n    </html>\n  );\n}\n\n// If loading a LOCAL font (client's custom brand font):\nimport localFont from 'next/font/local';\n\nconst brandFont = localFont({\n  src: [\n    { path: './fonts/BrandFont-Regular.woff2', weight: '400', style: 'normal' },\n    { path: './fonts/BrandFont-Bold.woff2', weight: '700', style: 'normal' },\n  ],\n  variable: '--font-brand',\n  display: 'swap',\n  preload: true,\n  adjustFontFallback: 'Arial',\n});\n```\n\n**Third-party scripts â€” never block LCP:** [eastondev](https://eastondev.com/blog/en/posts/dev/20251219-nextjs-core-web-vitals/)\n\n```typescript\n// File: apps/*/src/components/analytics/ThirdPartyScripts.tsx\n// All third-party scripts use next/script with afterInteractive or lazyOnload\n// NEVER use <script> tags directly â€” they block parsing\n\nimport Script from 'next/script';\n\ninterface ThirdPartyScriptsProps {\n  googleAnalyticsId?: string;\n  googleTagManagerId?: string;\n  facebookPixelId?: string;\n  analyticsConsent: boolean;    // From cookie consent (Domain 33)\n  marketingConsent: boolean;\n}\n\nexport function ThirdPartyScripts({\n  googleAnalyticsId,\n  googleTagManagerId,\n  facebookPixelId,\n  analyticsConsent,\n  marketingConsent,\n}: ThirdPartyScriptsProps) {\n  return (\n    <>\n      {/* GTM: afterInteractive â†’ loads after page becomes interactive */}\n      {googleTagManagerId && analyticsConsent && (\n        <Script\n          id=\"gtm\"\n          strategy=\"afterInteractive\"\n          dangerouslySetInnerHTML={{\n            __html: `\n              (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':\n              new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],\n              j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=\n              'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);\n              })(window,document,'script','dataLayer','${googleTagManagerId}');\n            `,\n          }}\n        />\n      )}\n\n      {/* GA4 direct (when no GTM): lazyOnload â†’ loads during idle time */}\n      {googleAnalyticsId && !googleTagManagerId && analyticsConsent && (\n        <>\n          <Script\n            src={`https://www.googletagmanager.com/gtag/js?id=${googleAnalyticsId}`}\n            strategy=\"lazyOnload\"   // Never afterInteractive for raw gtag â€” too early\n          />\n          <Script\n            id=\"ga4-init\"\n            strategy=\"lazyOnload\"\n            dangerouslySetInnerHTML={{\n              __html: `\n                window.dataLayer = window.dataLayer || [];\n                function gtag(){dataLayer.push(arguments);}\n                gtag('js', new Date());\n                gtag('config', '${googleAnalyticsId}', {\n                  send_page_view: true,\n                  anonymize_ip: true\n                });\n                // GDPR Consent Mode v2\n                gtag('consent', 'default', {\n                  analytics_storage: '${analyticsConsent ? 'granted' : 'denied'}',\n                  ad_storage: '${marketingConsent ? 'granted' : 'denied'}',\n                  ad_user_data: '${marketingConsent ? 'granted' : 'denied'}',\n                  ad_personalization: '${marketingConsent ? 'granted' : 'denied'}',\n                });\n              `,\n            }}\n          />\n        </>\n      )}\n\n      {/* Facebook Pixel: lazyOnload â€” never blocks LCP */}\n      {facebookPixelId && marketingConsent && (\n        <Script\n          id=\"fb-pixel\"\n          strategy=\"lazyOnload\"\n          dangerouslySetInnerHTML={{\n            __html: `\n              !function(f,b,e,v,n,t,s)\n              {if(f.fbq)return;n=f.fbq=function(){n.callMethod?\n              n.callMethod.apply(n,arguments):n.queue.push(arguments)};\n              if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';\n              n.queue=[];t=b.createElement(e);t.async=!0;\n              t.src=v;s=b.getElementsByTagName(e)[0];\n              s.parentNode.insertBefore(t,s)}(window, document,'script',\n              'https://connect.facebook.net/en_US/fbevents.js');\n              fbq('init', '${facebookPixelId}');\n              fbq('track', 'PageView');\n            `,\n          }}\n        />\n      )}\n    </>\n  );\n}\n```\n\n---\n",
            "domainNumber": 35
          }
        },
        {
          "domainNumber": 35,
          "fileName": "DOMAIN-35-vercel-section-vercel.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-35\\DOMAIN-35-vercel-section-vercel.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "35.5-vercel-speed-insights-integration.md",
            "title": "Section vercel",
            "description": "Implementation for domain 35 section vercel",
            "topics": ["Domain 35 implementation"],
            "sectionNumber": "vercel",
            "content": "### 35.5 Vercel Speed Insights Integration\n\n**File:** `apps/*/src/app/layout.tsx` (additions)\n\n```typescript\nimport { SpeedInsights } from '@vercel/speed-insights/next';\nimport { Analytics } from '@vercel/analytics/next';\n\nexport default function RootLayout({ children }: { children: React.ReactNode }) {\n  return (\n    <html lang=\"en\">\n      <body>\n        {children}\n        {/* Real User Monitoring â€” zero config on Vercel, ~1KB inline script */}\n        <SpeedInsights />\n        {/* Vercel Web Analytics (optional, privacy-first, no cookies) */}\n        <Analytics />\n      </body>\n    </html>\n  );\n}\n```\n\n**RUM alerting â€” Vercel Speed Insights webhook to Slack/PagerDuty:**\n\n```typescript\n// File: apps/*/src/app/api/webhooks/speed-insights/route.ts\n// Vercel sends webhook when RES drops below threshold for 15+ minutes\n\nimport { NextRequest, NextResponse } from 'next/server';\n\ninterface SpeedInsightsWebhookPayload {\n  event: 'score_degraded' | 'score_recovered';\n  metric: string;\n  score: number;\n  threshold: number;\n  url: string;\n  projectId: string;\n}\n\nexport async function POST(req: NextRequest) {\n  const secret = req.headers.get('x-vercel-signature');\n  if (secret !== process.env.SPEED_INSIGHTS_WEBHOOK_SECRET) {\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n  }\n\n  const payload: SpeedInsightsWebhookPayload = await req.json();\n\n  if (payload.event === 'score_degraded') {\n    // Alert the dev team via Slack\n    await fetch(process.env.SLACK_WEBHOOK_PERF_ALERTS!, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        text:\n          `ðŸš¨ *Performance Regression Detected*\\n` +\n          `â€¢ Metric: \\`${payload.metric}\\`\\n` +\n          `â€¢ Score: ${payload.score} (threshold: ${payload.threshold})\\n` +\n          `â€¢ URL: ${payload.url}\\n` +\n          `â€¢ Action: Check Vercel Speed Insights dashboard`,\n      }),\n    });\n  }\n\n  return NextResponse.json({ received: true });\n}\n```\n\n---\n",
            "domainNumber": 35
          }
        },
        {
          "domainNumber": 35,
          "fileName": "DOMAIN-35-lighthouse-.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-35\\DOMAIN-35-lighthouse-.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "35.6-lighthouse-ci-github-actions-job.md",
            "title": "============================================================================",
            "description": "name: Performance Gate (Lighthouse CI)",
            "topics": ["Domain 35 implementation"],
            "sectionNumber": "lighthouse",
            "content": "### 35.6 Lighthouse CI GitHub Actions Job\n\n**File:** `.github/workflows/lighthouse.yml`\n\n```yaml\n# ============================================================================\n# LIGHTHOUSE CI â€” Performance Gate\n# Runs on every PR against the Vercel preview deployment.\n# Fails the merge if LCP/INP/CLS/score thresholds are not met.\n# Reference: https://github.com/GoogleChrome/lighthouse-ci\n# ============================================================================\n\nname: Performance Gate (Lighthouse CI)\n\non:\n  pull_request:\n    branches: [main, staging]\n    paths:\n      # Only run when marketing site or shared packages change\n      - 'apps/marketing/**'\n      - 'packages/**'\n      - '!packages/reports/**' # Report package changes don't affect marketing site perf\n      - '!**/*.test.ts'\n      - '!**/*.spec.ts'\n\njobs:\n  lighthouse:\n    name: Lighthouse Audit\n    runs-on: ubuntu-latest\n    timeout-minutes: 20\n\n    steps:\n      - name: Checkout\n        uses: actions/checkout@v4\n\n      - name: Setup pnpm\n        uses: pnpm/action-setup@v3\n        with:\n          version: 9\n\n      - name: Setup Node.js\n        uses: actions/setup-node@v4\n        with:\n          node-version: '22'\n          cache: 'pnpm'\n\n      # Wait for Vercel preview deployment to be ready\n      - name: Wait for Vercel Preview\n        uses: patrickedqvist/wait-for-vercel-preview@v1.3.1\n        id: vercel-preview\n        with:\n          token: ${{ secrets.GITHUB_TOKEN }}\n          max_timeout: 300 # 5 min max wait\n          check_interval: 15\n        env:\n          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}\n\n      - name: Install LHCI\n        run: pnpm add -g @lhci/cli@0.14.x\n\n      # Collect, assert, and upload results\n      - name: Run Lighthouse CI\n        run: lhci autorun\n        env:\n          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}\n          LHCI_BASE_URL: ${{ steps.vercel-preview.outputs.url }}\n          LHCI_BUILD_CONTEXT__CURRENT_BRANCH: ${{ github.head_ref }}\n          LHCI_BUILD_CONTEXT__COMMIT: ${{ github.sha }}\n\n      # Upload HTML report as artifact (accessible from Actions tab)\n      - name: Upload Lighthouse Report\n        uses: actions/upload-artifact@v4\n        if: always()\n        with:\n          name: lighthouse-report-${{ github.sha }}\n          path: .lighthouseci/\n          retention-days: 30\n```\n\n---\n",
            "domainNumber": 35
          }
        },
        {
          "domainNumber": 35,
          "fileName": "DOMAIN-35-bundle-.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-35\\DOMAIN-35-bundle-.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "35.7-bundle-size-check-ci-job.md",
            "title": "============================================================================",
            "description": "name: Bundle Size Check",
            "topics": ["Domain 35 implementation"],
            "sectionNumber": "bundle",
            "content": "### 35.7 Bundle Size Check CI Job\n\n**File:** `.github/workflows/bundle-size.yml`\n\n```yaml\n# ============================================================================\n# BUNDLE SIZE GATE\n# Runs on every PR â€” fails if any bundle exceeds size-limit budget.\n# Posts a comment on the PR with the size report.\n# ============================================================================\n\nname: Bundle Size Check\n\non:\n  pull_request:\n    branches: [main, staging]\n\njobs:\n  bundle-size:\n    name: Bundle Size Analysis\n    runs-on: ubuntu-latest\n    timeout-minutes: 15\n\n    steps:\n      - uses: actions/checkout@v4\n\n      - uses: pnpm/action-setup@v3\n        with:\n          version: 9\n\n      - uses: actions/setup-node@v4\n        with:\n          node-version: '22'\n          cache: 'pnpm'\n\n      - name: Install dependencies\n        run: pnpm install --frozen-lockfile\n\n      - name: Build with bundle analysis\n        run: pnpm --filter marketing build\n        env:\n          ANALYZE: 'true'\n          NODE_ENV: production\n          # Use stub env vars â€” real secrets not needed for build\n          NEXT_PUBLIC_SUPABASE_URL: 'https://stub.supabase.co'\n          NEXT_PUBLIC_SUPABASE_ANON_KEY: 'stub'\n          NEXT_PUBLIC_ROOT_DOMAIN: 'localhost'\n\n      - name: Check bundle size limits\n        run: pnpm size-limit --json > size-report.json\n        continue-on-error: true # Capture output even if limits exceeded\n\n      - name: Parse size report\n        id: size\n        run: |\n          PASSED=$(cat size-report.json | jq '[.[] | select(.exceeded == false)] | length')\n          FAILED=$(cat size-report.json | jq '[.[] | select(.exceeded == true)] | length')\n          echo \"passed=$PASSED\" >> $GITHUB_OUTPUT\n          echo \"failed=$FAILED\" >> $GITHUB_OUTPUT\n          echo \"report=$(cat size-report.json | jq -c .)\" >> $GITHUB_OUTPUT\n\n      - name: Post bundle size comment on PR\n        uses: actions/github-script@v7\n        with:\n          script: |\n            const report = JSON.parse(process.env.REPORT);\n            const rows = report.map(r => {\n              const status = r.exceeded ? 'âŒ' : 'âœ…';\n              const delta = r.passed !== undefined\n                ? (r.sizeRaw - r.limitRaw > 0 ? `+${((r.sizeRaw - r.limitRaw) / 1024).toFixed(1)} KB` : 'OK')\n                : 'new';\n              return `| ${status} | ${r.name} | ${(r.sizeRaw/1024).toFixed(1)} KB | ${(r.limitRaw/1024).toFixed(1)} KB | ${delta} |`;\n            }).join('\\n');\n\n            const body = `## Bundle Size Report\\n\\n| Status | Bundle | Size | Limit | Delta |\\n|--------|--------|------|-------|-------|\\n${rows}\\n\\n${process.env.FAILED > 0 ? '> âš ï¸ **Bundle size limits exceeded. Fix before merging.**' : '> âœ… All bundle sizes within budget.'}`;\n\n            github.rest.issues.createComment({\n              issue_number: context.issue.number,\n              owner: context.repo.owner,\n              repo: context.repo.repo,\n              body,\n            });\n        env:\n          REPORT: ${{ steps.size.outputs.report }}\n          FAILED: ${{ steps.size.outputs.failed }}\n\n      - name: Fail if bundle exceeded\n        if: steps.size.outputs.failed > 0\n        run: |\n          echo \"Bundle size limits exceeded. See PR comment for details.\"\n          exit 1\n```\n\n---\n",
            "domainNumber": 35
          }
        }
      ]
    },
    {
      "domainNumber": 36,
      "success": true,
      "tasksCreated": 6,
      "averageScore": 100,
      "validationResults": [
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        },
        {
          "isValid": true,
          "missingSections": [],
          "score": 100
        }
      ],
      "tasks": [
        {
          "domainNumber": 36,
          "fileName": "DOMAIN-36-philosophy.md-section-philosophymd.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-36\\DOMAIN-36-philosophy.md-section-philosophymd.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "36.1-philosophy.md",
            "title": "Section philosophy.md",
            "description": "Implementation for domain 36 section philosophy.md",
            "topics": ["Domain 36 implementation"],
            "sectionNumber": "philosophy.md",
            "content": "### 36.1 Philosophy\n\n**What it is:** The authoritative operational playbook for promoting code through environments (dev â†’ staging â†’ production), running database migrations safely, rolling back a bad deployment in under 3 minutes, and seeding a fresh environment from scratch. [vercel](https://vercel.com/docs/frameworks/full-stack/nextjs)\n\n**Vercel's zero-downtime deployment model:** Vercel deploys to immutable URLs, then atomically re-points the production domain alias. The old deployment stays live and serves existing connections until they complete. No traffic is dropped during promotion. [vercel](https://vercel.com/changelog/stage-and-manually-promote-deployments-to-production)\n\n**Database migrations â€” the critical constraint:** The Next.js app deployment and the Supabase migration run independently. During the window between \"migration applied\" and \"new code deployed,\" both old and new code versions are running concurrently against the database. All migrations must therefore be **backward-compatible** â€” never drop a column or rename one in the same deployment as the code that depends on the change. [hrekov](https://hrekov.com/blog/vercel-migrations)\n\n---\n",
            "domainNumber": 36
          }
        },
        {
          "domainNumber": 36,
          "fileName": "DOMAIN-36-environment-section-environment.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-36\\DOMAIN-36-environment-section-environment.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "36.2-environment-architecture.md",
            "title": "Section environment",
            "description": "Implementation for domain 36 section environment",
            "topics": ["Domain 36 implementation"],
            "sectionNumber": "environment",
            "content": "### 36.2 Environment Architecture\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                       ENVIRONMENT CHAIN                         â”‚\nâ”‚                                                                 â”‚\nâ”‚  dev (local)          staging (Vercel)        production (Vercel)â”‚\nâ”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚\nâ”‚  localhost:3000       staging.agency.com      agency.com         â”‚\nâ”‚  Supabase local       Supabase staging project Supabase prod     â”‚\nâ”‚  .env.local           .env.staging (Vercel)   .env.production    â”‚\nâ”‚  No real data         Seeded fixture data      Live tenant data   â”‚\nâ”‚  Feature flags: all   Feature flags: selective FF: GA-gated       â”‚\nâ”‚  off by default       testing new features    rollout-ready      â”‚\nâ”‚                                                                 â”‚\nâ”‚  Branch: feature/*    Branch: staging         Branch: main       â”‚\nâ”‚  Deploy: preview PR   Deploy: auto on push    Deploy: promoted   â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n---\n",
            "domainNumber": 36
          }
        },
        {
          "domainNumber": 36,
          "fileName": "DOMAIN-36-full-.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-36\\DOMAIN-36-full-.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "36.3-full-cicd-pipeline-complete.md",
            "title": "============================================================================",
            "description": "name: CI/CD Pipeline",
            "topics": ["Domain 36 implementation"],
            "sectionNumber": "full",
            "content": "### 36.3 Full CI/CD Pipeline (Complete)\n\n**File:** `.github/workflows/deploy.yml`\n\n```yaml\n# ============================================================================\n# FULL CI/CD PIPELINE\n# PR â†’ checks â†’ preview â†’ staging â†’ production promotion\n# ============================================================================\n\nname: CI/CD Pipeline\n\non:\n  push:\n    branches: [main, staging]\n  pull_request:\n    branches: [main, staging]\n\nconcurrency:\n  group: ${{ github.workflow }}-${{ github.ref }}\n  cancel-in-progress: true # Cancel stale PR runs\n\nenv:\n  PNPM_VERSION: '9'\n  NODE_VERSION: '22'\n\njobs:\n  # â”€â”€ 1. Type check (fast gate â€” runs first) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  typecheck:\n    name: TypeScript Check\n    runs-on: ubuntu-latest\n    timeout-minutes: 10\n    steps:\n      - uses: actions/checkout@v4\n      - uses: pnpm/action-setup@v3\n        with: { version: '${{ env.PNPM_VERSION }}' }\n      - uses: actions/setup-node@v4\n        with: { node-version: '${{ env.NODE_VERSION }}', cache: 'pnpm' }\n      - run: pnpm install --frozen-lockfile\n      - run: pnpm typecheck\n      - run: pnpm lint\n\n  # â”€â”€ 2. Unit + integration tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  test:\n    name: Tests\n    runs-on: ubuntu-latest\n    timeout-minutes: 20\n    needs: typecheck\n\n    services:\n      postgres:\n        image: supabase/postgres:15.1.1.78\n        env:\n          POSTGRES_PASSWORD: postgres\n          POSTGRES_DB: postgres\n        options: >-\n          --health-cmd pg_isready\n          --health-interval 10s\n          --health-timeout 5s\n          --health-retries 5\n        ports: ['5432:5432']\n\n    steps:\n      - uses: actions/checkout@v4\n      - uses: pnpm/action-setup@v3\n        with: { version: '${{ env.PNPM_VERSION }}' }\n      - uses: actions/setup-node@v4\n        with: { node-version: '${{ env.NODE_VERSION }}', cache: 'pnpm' }\n      - run: pnpm install --frozen-lockfile\n\n      # Apply migrations to test Postgres\n      - name: Run Supabase migrations (test DB)\n        run: pnpm supabase db push --local\n        env:\n          SUPABASE_DB_URL: postgresql://postgres:postgres@localhost:5432/postgres\n\n      - name: Run unit tests\n        run: pnpm test --coverage\n        env:\n          NODE_ENV: test\n          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres\n\n      - name: Upload coverage\n        uses: codecov/codecov-action@v4\n        with:\n          token: ${{ secrets.CODECOV_TOKEN }}\n          fail_ci_if_error: false\n\n  # â”€â”€ 3. Build check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  build:\n    name: Build Check\n    runs-on: ubuntu-latest\n    timeout-minutes: 20\n    needs: typecheck\n    steps:\n      - uses: actions/checkout@v4\n      - uses: pnpm/action-setup@v3\n        with: { version: '${{ env.PNPM_VERSION }}' }\n      - uses: actions/setup-node@v4\n        with: { node-version: '${{ env.NODE_VERSION }}', cache: 'pnpm' }\n      - run: pnpm install --frozen-lockfile\n      - name: Build all apps\n        run: pnpm build\n        env:\n          NODE_ENV: production\n          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.STAGING_SUPABASE_URL }}\n          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.STAGING_SUPABASE_ANON_KEY }}\n          NEXT_PUBLIC_ROOT_DOMAIN: 'staging.agency.com'\n          NEXT_TELEMETRY_DISABLED: '1'\n\n  # â”€â”€ 4. Migrate staging DB (on staging branch push) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  migrate-staging:\n    name: Migrate Staging DB\n    runs-on: ubuntu-latest\n    timeout-minutes: 10\n    needs: [test, build]\n    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'\n    steps:\n      - uses: actions/checkout@v4\n      - uses: pnpm/action-setup@v3\n        with: { version: '${{ env.PNPM_VERSION }}' }\n      - uses: actions/setup-node@v4\n        with: { node-version: '${{ env.NODE_VERSION }}', cache: 'pnpm' }\n      - run: pnpm install --frozen-lockfile\n\n      - name: Apply migrations to staging Supabase\n        run: pnpm supabase db push\n        env:\n          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}\n          SUPABASE_DB_PASSWORD: ${{ secrets.STAGING_SUPABASE_DB_PASSWORD }}\n          SUPABASE_PROJECT_ID: ${{ secrets.STAGING_SUPABASE_PROJECT_ID }}\n\n  # â”€â”€ 5. Deploy to staging (Vercel) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  deploy-staging:\n    name: Deploy to Staging\n    runs-on: ubuntu-latest\n    timeout-minutes: 15\n    needs: migrate-staging\n    environment:\n      name: staging\n      url: https://staging.agency.com\n    steps:\n      - uses: actions/checkout@v4\n      - name: Deploy to Vercel (staging)\n        run: |\n          npx vercel --token=${{ secrets.VERCEL_TOKEN }} \\\n            --env=staging \\\n            --scope=${{ secrets.VERCEL_ORG_ID }} \\\n            2>&1 | tee deploy.log\n          echo \"DEPLOYMENT_URL=$(grep -o 'https://[^[:space:]]*' deploy.log | head -1)\" >> $GITHUB_ENV\n\n      - name: Run smoke tests against staging\n        run: pnpm test:e2e:smoke\n        env:\n          BASE_URL: ${{ env.DEPLOYMENT_URL }}\n          PLAYWRIGHT_TEST_BASE_URL: ${{ env.DEPLOYMENT_URL }}\n\n  # â”€â”€ 6. Migrate production DB (on main push) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  migrate-production:\n    name: Migrate Production DB\n    runs-on: ubuntu-latest\n    timeout-minutes: 10\n    needs: [test, build]\n    if: github.ref == 'refs/heads/main' && github.event_name == 'push'\n    environment:\n      name: production-db # Requires manual approval in GitHub Environments\n    steps:\n      - uses: actions/checkout@v4\n      - uses: pnpm/action-setup@v3\n        with: { version: '${{ env.PNPM_VERSION }}' }\n      - uses: actions/setup-node@v4\n        with: { node-version: '${{ env.NODE_VERSION }}', cache: 'pnpm' }\n      - run: pnpm install --frozen-lockfile\n\n      - name: Apply migrations to production Supabase\n        run: pnpm supabase db push\n        env:\n          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}\n          SUPABASE_DB_PASSWORD: ${{ secrets.PROD_SUPABASE_DB_PASSWORD }}\n          SUPABASE_PROJECT_ID: ${{ secrets.PROD_SUPABASE_PROJECT_ID }}\n\n  # â”€â”€ 7. Deploy to production (staged â€” NOT auto-promoted) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  deploy-production-staged:\n    name: Stage Production Deployment\n    runs-on: ubuntu-latest\n    timeout-minutes: 15\n    needs: migrate-production\n    steps:\n      - uses: actions/checkout@v4\n      - name: Deploy to Vercel (staged, no domain assignment)\n        run: |\n          DEPLOYMENT_URL=$(npx vercel --prod --skip-domain \\\n            --token=${{ secrets.VERCEL_TOKEN }} \\\n            --scope=${{ secrets.VERCEL_ORG_ID }} \\\n            2>&1 | tail -1)\n          echo \"STAGED_URL=$DEPLOYMENT_URL\" >> $GITHUB_ENV\n          echo \"DEPLOYMENT_ID=$(npx vercel inspect $DEPLOYMENT_URL --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }} | grep 'id:' | awk '{print $2}')\" >> $GITHUB_ENV\n\n      - name: Run smoke tests against staged deployment\n        run: pnpm test:e2e:smoke\n        env:\n          BASE_URL: ${{ env.STAGED_URL }}\n          PLAYWRIGHT_TEST_BASE_URL: ${{ env.STAGED_URL }}\n\n      - name: Post staged deployment info to Slack\n        run: |\n          curl -X POST ${{ secrets.SLACK_WEBHOOK_DEPLOYMENTS }} \\\n            -H 'Content-type: application/json' \\\n            -d '{\n              \"text\": \"ðŸš€ *Production deployment staged and smoke-tested*\\nâ€¢ Staged URL: ${{ env.STAGED_URL }}\\nâ€¢ Deployment ID: ${{ env.DEPLOYMENT_ID }}\\nâ€¢ Commit: ${{ github.sha }}\\nâ€¢ <https://vercel.com/${{ secrets.VERCEL_ORG_ID }}|Promote in Vercel dashboard>\"\n            }'\n```\n\n---\n",
            "domainNumber": 36
          }
        },
        {
          "domainNumber": 36,
          "fileName": "DOMAIN-36-zero-section-zero.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-36\\DOMAIN-36-zero-section-zero.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "36.4-zero-downtime-migration-strategy.md",
            "title": "Section zero",
            "description": "Implementation for domain 36 section zero",
            "topics": ["Domain 36 implementation"],
            "sectionNumber": "zero",
            "content": "### 36.4 Zero-Downtime Migration Strategy\n\nEvery database schema change follows a **three-phase expand/contract pattern**. This guarantees no downtime regardless of how long the Vercel deployment takes to propagate. [hrekov](https://hrekov.com/blog/vercel-migrations)\n\n```\nPHASE 1 â€” EXPAND (backward-compatible add)\nDeploy migration BEFORE new code.\nOld code + new code BOTH work against this schema.\n\n  âœ… ADD column (nullable, with default) â†’ safe\n  âœ… ADD table â†’ safe\n  âœ… ADD index (CONCURRENTLY) â†’ safe, non-blocking\n  âœ… ADD constraint (NOT VALID, then VALIDATE separately) â†’ safe\n\nPHASE 2 â€” MIGRATE DATA (if needed)\nRun a backfill job in a QStash background job.\nNever UPDATE millions of rows in a single migration â€” use batched QStash jobs.\n\nPHASE 3 â€” CONTRACT (remove old schema)\nDeploy AFTER new code has been running 1+ deployment cycles.\nOld code is no longer running â€” safe to remove the old shape.\n\n  âœ… DROP old column â†’ safe (new code no longer references it)\n  âœ… DROP old table â†’ safe\n  âœ… RENAME column â†’ safe (after dual-write period)\n  âœ… ADD NOT NULL constraint â†’ safe (after backfill confirmed)\n```\n\n**Safe migration example â€” adding `score_v2` column:**\n\n```sql\n-- ============================================================\n-- MIGRATION: add score_v2 column (Phase 1 â€” Expand)\n-- Deploy THIS migration BEFORE deploying the new code.\n-- Both old and new app versions work with this schema.\n-- ============================================================\n\n-- Step 1: Add nullable column (old code ignores it, new code uses it)\nALTER TABLE leads\n  ADD COLUMN IF NOT EXISTS score_v2 smallint DEFAULT NULL;\n\n-- Step 2: Add index CONCURRENTLY (non-locking â€” safe on live table)\nCREATE INDEX CONCURRENTLY IF NOT EXISTS idx_leads_score_v2\n  ON leads(score_v2)\n  WHERE score_v2 IS NOT NULL;\n\n-- ============================================================\n-- MIGRATION: backfill + enforce NOT NULL (Phase 3 â€” Contract)\n-- Deploy AFTER new code has shipped and score_v2 is being written.\n-- ============================================================\n\n-- Step 1: Backfill historical rows (run as QStash batch job first,\n--         migration only enforces constraint after backfill confirmed)\n-- (See: packages/jobs/src/backfill-score-v2.ts)\n\n-- Step 2: Enforce NOT NULL + drop old column\nALTER TABLE leads\n  ALTER COLUMN score_v2 SET NOT NULL,\n  ALTER COLUMN score_v2 SET DEFAULT 0;\n\n-- Wait one more deploy cycle before dropping old 'score' column\n-- ALTER TABLE leads DROP COLUMN score;   â† Phase 3, separate migration\n```\n\n---\n",
            "domainNumber": 36
          }
        },
        {
          "domainNumber": 36,
          "fileName": "DOMAIN-36-rollback-.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-36\\DOMAIN-36-rollback-.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "36.5-rollback-procedure.md",
            "title": "============================================================",
            "description": "vercel ls --prod --token=$VERCEL_TOKEN --scope=$VERCEL_ORG_ID",
            "topics": ["Domain 36 implementation"],
            "sectionNumber": "rollback",
            "content": "### 36.5 Rollback Procedure\n\n**Target: â‰¤ 3 minutes from incident detection to rollback.**\n\n```bash\n# ============================================================\n# ROLLBACK RUNBOOK\n# Run when: post-deploy error rate spike, LCP regression, data incident\n# ============================================================\n\n# Step 1: Identify the last good deployment (30 seconds)\nvercel ls --prod --token=$VERCEL_TOKEN --scope=$VERCEL_ORG_ID\n# Copy the deployment ID of the last known-good deployment\n\n# Step 2: Promote the last good deployment (10 seconds)\n# This atomically re-points the production domain â€” zero downtime\nvercel promote <LAST_GOOD_DEPLOYMENT_ID> --token=$VERCEL_TOKEN --scope=$VERCEL_ORG_ID\n\n# Step 3: Verify rollback (30 seconds)\ncurl -I https://agency.com | grep x-vercel-id\n# Confirm x-vercel-id matches the rolled-back deployment\n\n# Step 4: Disable the bad feature flag (if rollback is for a feature, not a bug)\n# Dashboard â†’ Feature Flags â†’ [flag-name] â†’ Set to 0% rollout\n# This is instant â€” no deployment required (see Domain 16)\n\n# â”€â”€ IF DATABASE MIGRATION ALSO NEEDS ROLLBACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n# (Only needed for Phase 3 \"Contract\" migrations â€” Phase 1 Expand is always safe)\n# WARNING: only safe if no data has been written to new columns yet\n\nsupabase db push --db-url=$PROD_DATABASE_URL \\\n  --target-version <PREVIOUS_MIGRATION_VERSION>\n\n# â”€â”€ NUCLEAR OPTION: Point-in-time recovery â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n# Supabase PITR â€” restores entire database to a timestamp\n# Use only for data corruption incidents (data loss is irreversible)\n# Supabase Dashboard â†’ Project Settings â†’ Database â†’ PITR\n# Select timestamp BEFORE the incident\n# âš ï¸ This DOES lose all writes between the incident time and now\n```\n\n---\n",
            "domainNumber": 36
          }
        },
        {
          "domainNumber": 36,
          "fileName": "DOMAIN-36-fresh-.md",
          "path": "C:\\dev\\marketing-websites\\tasks\\domain-36\\DOMAIN-36-fresh-.md",
          "validation": {
            "isValid": true,
            "missingSections": [],
            "score": 100
          },
          "domainFile": {
            "file": "36.6-fresh-environment-setup.md",
            "title": "============================================================",
            "description": "set -euo pipefail",
            "topics": ["Domain 36 implementation"],
            "sectionNumber": "fresh",
            "content": "### 36.6 Fresh Environment Setup\n\n**File:** `scripts/setup-env.sh`\n\n```bash\n#!/usr/bin/env bash\n# ============================================================\n# FRESH ENVIRONMENT SETUP SCRIPT\n# Run once to initialize a new developer's local environment\n# or a new staging environment from scratch.\n# ============================================================\n\nset -euo pipefail\n\necho \"ðŸš€ Setting up fresh environment...\"\n\n# 1. Install dependencies\necho \"ðŸ“¦ Installing dependencies...\"\npnpm install\n\n# 2. Copy environment file\nif [ ! -f .env.local ]; then\n  cp .env.example .env.local\n  echo \"âœ… Created .env.local â€” fill in your Supabase + Clerk credentials\"\nfi\n\n# 3. Start Supabase locally\necho \"ðŸ˜ Starting local Supabase...\"\nnpx supabase start\n\n# 4. Apply all migrations\necho \"ðŸ—ƒï¸  Applying database migrations...\"\nnpx supabase db push --local\n\n# 5. Seed database with fixture data\necho \"ðŸŒ± Seeding fixture data...\"\nnpx tsx scripts/seed.ts\n\n# 6. Install Playwright browsers\necho \"ðŸŽ­ Installing Playwright browsers...\"\nnpx playwright install chromium\n\n# 7. Build packages (required before running apps)\necho \"ðŸ—ï¸  Building shared packages...\"\npnpm --filter './packages/**' build\n\necho \"\"\necho \"âœ… Environment setup complete!\"\necho \"\"\necho \"Next steps:\"\necho \"  pnpm dev          â†’ Start all apps in development mode\"\necho \"  pnpm test         â†’ Run unit tests\"\necho \"  pnpm test:e2e     â†’ Run Playwright E2E tests\"\necho \"  pnpm build        â†’ Production build\"\necho \"  ANALYZE=true pnpm build â†’ Bundle analysis\"\necho \"\"\necho \"Supabase Studio: http://localhost:54323\"\necho \"Marketing site:  http://localhost:3000\"\necho \"Portal:          http://localhost:3001\"\necho \"Super Admin:     http://localhost:3002\"\n```\n\n**File:** `scripts/seed.ts`\n\n```typescript\n#!/usr/bin/env tsx\n// ============================================================\n// DATABASE SEEDER\n// Creates fixture data for local development + staging.\n// NEVER runs against production (guarded by NODE_ENV check).\n// ============================================================\n\nimport { createClient } from '@supabase/supabase-js';\nimport { v4 as uuidv4 } from 'uuid';\n\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\nasync function seed() {\n  if (process.env.NODE_ENV === 'production') {\n    throw new Error('âŒ Seed script must never run against production database');\n  }\n\n  console.log('ðŸŒ± Seeding database...');\n\n  // â”€â”€ Create 3 demo tenants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n  const tenants = [\n    {\n      id: uuidv4(),\n      subdomain: 'demo-hvac',\n      status: 'active',\n      plan: 'pro',\n      config: {\n        siteUrl: 'https://demo-hvac.localhost:3000',\n        identity: {\n          siteName: 'Arctic Air HVAC',\n          tagline: 'Keeping Plano cool since 2005',\n          industry: 'hvac',\n          contact: { phone: '(972) 555-0100', email: 'info@arcticairhvac.com' },\n          address: { street: '123 Main St', city: 'Plano', state: 'TX', zip: '75024' },\n          serviceAreas: ['Plano, TX', 'Frisco, TX', 'Allen, TX', 'McKinney, TX', 'Richardson, TX'],\n          services: [\n            { name: 'AC Repair', slug: 'ac-repair', description: 'Fast same-day AC repair' },\n            {\n              name: 'Furnace Installation',\n              slug: 'furnace-install',\n              description: 'Licensed furnace installation',\n            },\n            {\n              name: 'HVAC Maintenance',\n              slug: 'hvac-maintenance',\n              description: 'Annual tune-up plans',\n            },\n          ],\n          hours: [\n            {\n              days: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'],\n              opens: '07:00',\n              closes: '19:00',\n            },\n            { days: ['Saturday'], opens: '08:00', closes: '15:00' },\n          ],\n          priceRange: '$$',\n        },\n        theme: { colors: { primary: '#0ea5e9' } },\n      },\n    },\n    {\n      id: uuidv4(),\n      subdomain: 'demo-plumbing',\n      status: 'active',\n      plan: 'starter',\n      config: {\n        siteUrl: 'https://demo-plumbing.localhost:3000',\n        identity: {\n          siteName: \"Mike's Plumbing\",\n          tagline: 'No job too big, no leak too small',\n          industry: 'plumbing',\n          contact: { phone: '(214) 555-0200', email: 'mike@mikesplumbing.com' },\n          address: { city: 'Dallas', state: 'TX', zip: '75201' },\n          serviceAreas: ['Dallas, TX', 'Irving, TX', 'Garland, TX'],\n          services: [\n            {\n              name: 'Drain Cleaning',\n              slug: 'drain-cleaning',\n              description: 'Emergency drain service',\n            },\n            { name: 'Water Heater', slug: 'water-heater', description: 'Repair and replacement' },\n          ],\n          priceRange: '$',\n        },\n        theme: { colors: { primary: '#16a34a' } },\n      },\n    },\n    {\n      id: uuidv4(),\n      subdomain: 'demo-dental',\n      status: 'active',\n      plan: 'enterprise',\n      config: {\n        siteUrl: 'https://demo-dental.localhost:3000',\n        identity: {\n          siteName: 'Bright Smile Dental',\n          tagline: 'Family dentistry with a gentle touch',\n          industry: 'dental',\n          contact: { phone: '(469) 555-0300', email: 'hello@brightsmile.com' },\n          address: { street: '456 Oak Ave', city: 'Frisco', state: 'TX', zip: '75034' },\n          serviceAreas: ['Frisco, TX', 'McKinney, TX', 'Prosper, TX'],\n          services: [\n            {\n              name: 'Teeth Cleaning',\n              slug: 'cleaning',\n              description: 'Professional cleaning and exam',\n            },\n            { name: 'Teeth Whitening', slug: 'whitening', description: 'In-office Zoom whitening' },\n            { name: 'Invisalign', slug: 'invisalign', description: 'Clear aligner treatment' },\n          ],\n          priceRange: '$$$',\n        },\n        theme: { colors: { primary: '#7c3aed' } },\n        whiteLabel: {\n          enabled: true,\n          portalName: 'Bright Smile Patient Portal',\n          portalPrimaryColor: '#7c3aed',\n          hideAgencyBranding: true,\n          hideSupportLink: false,\n        },\n      },\n    },\n  ];\n\n  const { error: tenantError } = await supabase\n    .from('tenants')\n    .upsert(tenants, { onConflict: 'subdomain' });\n  if (tenantError) throw tenantError;\n  console.log(`  âœ… Created ${tenants.length} demo tenants`);\n\n  // â”€â”€ Create sample leads â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n  const leads = tenants.flatMap((tenant) =>\n    Array.from({ length: 12 }, (_, i) => ({\n      id: uuidv4(),\n      tenant_id: tenant.id,\n      name: `Demo Lead ${i + 1}`,\n      email: `lead${i + 1}@example.com`,\n      phone: `(555) ${String(i).padStart(3, '0')}-0000`,\n      message: 'Interested in a free estimate for services.',\n      score: Math.floor(Math.random() * 100),\n      source: ['contact_form', 'phone_click', 'booking', 'chat_widget'][\n        Math.floor(Math.random() * 4)\n      ]!,\n      status: ['new', 'contacted', 'qualified', 'converted'][Math.floor(Math.random() * 4)]!,\n      created_at: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),\n    }))\n  );\n\n  const { error: leadError } = await supabase.from('leads').upsert(leads, { onConflict: 'id' });\n  if (leadError) throw leadError;\n  console.log(`  âœ… Created ${leads.length} sample leads`);\n\n  console.log('\\nâœ… Seed complete');\n  console.log('\\nDemo tenant subdomains:');\n  tenants.forEach((t) => console.log(`  â†’ http://${t.subdomain}.localhost:3000`));\n}\n\nseed().catch((err) => {\n  console.error('âŒ Seed failed:', err);\n  process.exit(1);\n});\n```\n\n---\n\n## Priority Table for Domains 35â€“36\n\n| Task                                                                           | Domain | Priority | Timeline | Success Metric                                                |\n| ------------------------------------------------------------------------------ | ------ | -------- | -------- | ------------------------------------------------------------- |\n| `@next/bundle-analyzer` wired to `ANALYZE=true pnpm build`                     | 35     | **P0**   | Week 1   | Any dev can run `ANALYZE=true pnpm build` and see treemap     |\n| `size-limit` config with per-route JS budgets                                  | 35     | **P0**   | Week 1   | CI fails if marketing homepage JS exceeds 85 KB gzip          |\n| `size-limit` PR comment bot                                                    | 35     | **P1**   | Week 2   | Every PR shows delta table â€” no surprise regressions          |\n| `next/font` for all typefaces (Inter + client brand fonts)                     | 35     | **P0**   | Week 1   | CLS = 0.00 from font swap on all tenant sites                 |\n| Hero images: `priority` + `fetchPriority=\"high\"` + `placeholder=\"blur\"`        | 35     | **P0**   | Week 1   | LCP < 2.5s on 90th percentile across all tenant sites         |\n| All third-party scripts via `next/script` (`afterInteractive`/`lazyOnload`)    | 35     | **P0**   | Week 1   | Third-party scripts contribute 0ms to LCP                     |\n| `optimizePackageImports` for `lucide-react`, `date-fns`, `lodash-es`           | 35     | **P1**   | Week 2   | Tree-shaking verified in bundle analyzer treemap              |\n| Lighthouse CI GitHub Actions job                                               | 35     | **P1**   | Week 2   | PRs blocked when LCP > 2.5s or performance score < 0.85       |\n| `.lighthouserc.ts` with Core Web Vitals + accessibility + SEO assertions       | 35     | **P1**   | Week 2   | 30+ Lighthouse assertions enforced on every PR                |\n| Vercel Speed Insights + webhook to Slack                                       | 35     | **P2**   | Week 3   | Team alerted within 15 minutes of production RUM regression   |\n| Expand/contract migration pattern documented and enforced via review checklist | 36     | **P0**   | Week 1   | Zero breaking schema changes ever deployed to production      |\n| `migrate-staging` + `migrate-production` CI jobs with environment approval     | 36     | **P0**   | Week 1   | Database migrations require explicit GitHub approval for prod |\n| Staged production deployment (`--skip-domain` â†’ manual `vercel promote`)       | 36     | **P0**   | Week 1   | Code never auto-promotes to production without smoke test     |\n| 3-minute rollback runbook (`vercel promote <last-good-id>`)                    | 36     | **P0**   | Week 1   | Any engineer can rollback production in under 3 minutes       |\n| `setup-env.sh` one-command fresh environment script                            | 36     | **P1**   | Week 2   | New developer fully running local env within 15 minutes       |\n| Database seeder with 3 demo tenants + sample leads                             | 36     | **P1**   | Week 2   | Staging always has realistic fixture data for testing         |\n| PITR (Point-in-Time Recovery) enabled on prod Supabase project                 | 36     | **P0**   | Week 1   | Data loss incident recoverable to any second in last 7 days   |\n| Concurrency cancel-in-progress for PR workflows                                | 36     | **P1**   | Week 2   | Stale PR runs auto-cancelled when new commit pushed           |\n\n---\n\n## The Complete System â€” All 36 Domains\n\n| #     | Domain                                                                     | Layer      |\n| ----- | -------------------------------------------------------------------------- | ---------- |\n| 1â€“5   | Monorepo, DB Schema, Auth, Multi-Tenant Routing, Site Config               | Foundation |\n| 6â€“10  | Lead Capture, Lead Notifications, Marketing Site, Phone Tracking, LLMs.txt | Revenue    |\n| 11â€“16 | Billing, Background Jobs, Observability, Accessibility, Security, CI/CD    | Platform   |\n| 17â€“22 | Onboarding Wizard, Super Admin, Booking Calendar, Email, Assets, AI Chat   | Product    |\n| 23â€“26 | SEO Engine, Realtime Lead Feed, A/B Testing, E2E Testing                   | Growth     |\n| 27â€“30 | Service Area Pages, Blog/CMS, Portal Settings, Domain Management           | Scale      |\n| 31â€“34 | PWA/Offline, Report Generation, GDPR Tools, White-Label Portal             | Enterprise |\n| 35â€“36 | Performance Budget, Deployment Runbook                                     | Operations |\n\nEvery domain is implemented, every cross-domain invariant is documented, and every priority table gives you a week-by-week execution order. The system is complete. [vercel](https://vercel.com/kb/guide/set-up-a-staging-environment-on-vercel)\n",
            "domainNumber": 36
          }
        }
      ]
    }
  ]
}
